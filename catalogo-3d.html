<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Catalogo Smartphone 3D | Re Long</title>
<style>
  :root{
    --bg:#0a0a0a; --card:#141414; --stroke:#2a2a2a;
    --grad:linear-gradient(90deg,#ff0000,#ff7b00);
    --muted:rgba(255,255,255,.72);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Inter,Roboto,sans-serif;background:var(--bg);color:#fff}
  header{padding:18px 16px;text-align:center}
  h1{font-size:22px;letter-spacing:-.02em;margin:0 0 6px;font-weight:900}
  .sub{font-size:13px;color:var(--muted)}
  .wrap{max-width:1100px;margin:0 auto;padding:10px 14px 40px}

  /* filtri */
  .filters{display:flex;gap:10px;overflow-x:auto;padding:10px 2px 2px}
  .filters button{
    background:#111;border:1px solid #333;color:#fff;padding:8px 14px;border-radius:999px;
    font-weight:700;white-space:nowrap;cursor:pointer
  }
  .filters button.active{background:var(--grad);color:#000;border-color:transparent}

  /* griglia */
  .grid{display:grid;gap:18px;margin-top:16px;grid-template-columns:repeat(auto-fill,minmax(240px,1fr))}
  .card{
    background:linear-gradient(150deg,rgba(20,20,20,.92),rgba(0,0,0,.65));
    border:1px solid var(--stroke);border-radius:16px;padding:14px;box-shadow:0 20px 50px rgba(0,0,0,.85);
    transition:transform .18s ease,box-shadow .18s ease;border-top:1px solid rgba(255,255,255,.06);position:relative
  }
  .card:hover{transform:translateY(-4px);box-shadow:0 28px 70px rgba(0,0,0,.9)}
  .img{width:100%;aspect-ratio:4/5;border-radius:12px;background:#000;object-fit:cover;margin-bottom:10px}

  .badge{position:absolute;top:-10px;right:12px;padding:6px 10px;border-radius:999px;font-size:11px;font-weight:900;color:#000}
  .badge.novita{background:linear-gradient(90deg,#ff006e,#ffbe0b)}
  .badge.promo {background:linear-gradient(90deg,#00b4d8,#0077b6)}
  .badge.top   {background:linear-gradient(90deg,#7209b7,#4361ee)}

  .name{font-weight:800;margin-top:2px}
  .brand{font-size:12px;color:var(--muted);margin-bottom:6px}
  .price{font-size:20px;font-weight:900;background:var(--grad);-webkit-background-clip:text;color:transparent;margin:6px 0 0}

  .rate{margin-top:10px;background:#101010;border:1px solid #2b2b2b;border-radius:12px;padding:10px}
  .rate label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  .rate select{width:100%;padding:8px;border-radius:10px;border:1px solid #3a3a3a;background:#000;color:#fff}
  .rata{font-size:14px;margin-top:8px}

  .wa{
    display:block;margin-top:12px;text-align:center;padding:12px;border-radius:12px;
    font-weight:900;text-decoration:none;color:#000;
    background:radial-gradient(circle at 0% 0%,#25D366,#128C7E)
  }

  /* avvisi */
  .status{margin-top:8px;font-size:13px;color:var(--muted);text-align:center}
  .error{max-width:800px;margin:16px auto 0;background:#161616;border:1px solid #333;padding:14px;border-radius:12px}
  .error b{color:#fff}
</style>
</head>
<body>
<header>
  <h1>Catalogo Smartphone 3D</h1>
  <div class="sub">Scegli, calcola la rata e invia il preventivo su WhatsApp</div>
</header>

<div class="wrap">
  <div id="status" class="status">Carico i prodottiâ€¦</div>
  <div id="filters" class="filters"></div>
  <div id="grid" class="grid"></div>
</div>

<script>
const WA = "https://wa.me/3908119578844?text=";

/* util */
const money = n => Number(n).toLocaleString('it-IT',{minimumFractionDigits:2,maximumFractionDigits:2});

/* render card */
function renderCard(p, idx){
  const badge =
    p.novita ? 'novita' :
    p.promo  ? 'promo'  :
    p.top    ? 'top'    : '';

  const selId = `rate-${idx}`;
  const waId  = `wa-${idx}`;

  // messaggio base (senza rate)
  const baseMsg = `Preventivo per ${p.nome}%0A`+
                  `Prezzo totale: â‚¬ ${money(p.prezzo)}`;

  return `
  <article class="card" data-brand="${p.brand}">
    ${badge ? `<span class="badge ${badge}">${badge.toUpperCase()}</span>` : ``}
    <img class="img" src="${p.img}" alt="${p.nome}" onerror="this.style.opacity=.35;this.title='Immagine non trovata: ${p.img}'">
    <div class="name">${p.nome}</div>
    <div class="brand">${p.brand}</div>
    <div class="price">â‚¬ ${money(p.prezzo)}</div>

    <div class="rate">
      <label for="${selId}">Rate mensili</label>
      <select id="${selId}" onchange="onRateChange(this, ${Number(p.prezzo)}, '${encodeURIComponent(p.nome)}', '${waId}')">
        <option value="">â€” seleziona â€”</option>
        <option value="12">12 mesi</option>
        <option value="24">24 mesi</option>
        <option value="30">30 mesi</option>
        <option value="36">36 mesi</option>
        <option value="48">48 mesi</option>
      </select>
      <div class="rata"></div>
    </div>

    <a id="${waId}" class="wa" href="${WA + baseMsg}" target="_blank" rel="noopener">
      Invia preventivo ðŸ“²
    </a>
  </article>`;
}

/* update rata + link WA */
function onRateChange(sel, prezzo, nomeEnc, waId){
  const mesi = parseInt(sel.value || 0, 10);
  const box  = sel.parentElement.querySelector('.rata');
  const btn  = document.getElementById(waId);
  const nome = decodeURIComponent(nomeEnc);

  // base
  let msg = `Preventivo per ${nome}\nPrezzo totale: â‚¬ ${money(prezzo)}`;

  if(!mesi){
    box.textContent = '';
    btn.href = WA + encodeURIComponent(msg);
    return;
  }

  const rata = prezzo / mesi;
  box.textContent = `Rata mensile: â‚¬ ${money(rata)} / mese (${mesi} mesi)`;

  msg += `\n\nRate: ${mesi} mesi`;
  msg += `\nRata mensile: â‚¬ ${money(rata)}/mese`;
  msg += `\n\nRichiedo un preventivo dettagliato.`;

  btn.href = WA + encodeURIComponent(msg);
}

/* load prodotti.json */
(async function init(){
  const status = document.getElementById('status');
  const grid   = document.getElementById('grid');
  const filters= document.getElementById('filters');

  try{
    const res = await fetch('./prodotti.json?v=' + Date.now(), {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const prodotti = await res.json();

    // render grid
    grid.innerHTML = prodotti.map((p,i)=>renderCard(p,i)).join('');
    status.textContent = `Prodotti: ${prodotti.length}`;

    // filtri brand
    const brands = ['all', ...new Set(prodotti.map(p=>p.brand))];
    filters.innerHTML = brands.map(b=>`
      <button data-b="${b}" onclick="filterBrand('${b}')">${b==='all'?'Tutti':b}</button>
    `).join('');
    document.querySelector('.filters button').classList.add('active');

    // salva elenco per filtro
    window.__ALL_CARDS__ = Array.from(document.querySelectorAll('.card'));
  }catch(err){
    document.querySelector('.wrap').insertAdjacentHTML('afterbegin',
      `<div class="error"><b>Impossibile caricare i prodotti.</b><br>
       Assicurati che <code>prodotti.json</code> sia nello stesso percorso e che le immagini esistano in <code>/imgcatalogo/</code>.<br>
       Errore: ${err.message}</div>`
    );
    status.textContent = 'Errore caricamento';
  }
})();

/* filtro brand */
function filterBrand(b){
  (window.__ALL_CARDS__||[]).forEach(card=>{
    const show = (b==='all' || card.dataset.brand===b);
    card.style.display = show ? '' : 'none';
  });
  document.querySelectorAll('.filters button').forEach(btn=>btn.classList.remove('active'));
  const cur = document.querySelector(`.filters button[data-b="${b}"]`);
  if(cur) cur.classList.add('active');
}
</script>
</body>
</html>
