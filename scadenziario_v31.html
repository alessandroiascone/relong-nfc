<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ReLong â€¢ Scadenzario v32d (WA Fix)</title>
  <meta name="theme-color" content="#0a0a0a" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0;-webkit-font-smoothing:antialiased}
    :root{
      --bg1:#0b0d12; --bg2:#06070b;
      --card:rgba(14,16,22,.92); --stroke:rgba(255,255,255,.08);
      --muted:rgba(210,220,255,.70);
      --elec:#0aa2ff; --elec2:#66d1ff; --elec3:#008cff;
      --ok:#25D366; --danger:#ff4d4f; --warn:#ffb020;
    }
    body{min-height:100svh;font-family:system-ui,-apple-system,Inter,Roboto,sans-serif;color:#eef3ff;
      background:radial-gradient(65% 65% at 25% 15%, var(--bg1), var(--bg2));
      padding:24px;display:flex;flex-direction:column;gap:16px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:22px;box-shadow:0 10px 40px rgba(0,140,255,.18)}
    .card h2{font-size:18px;font-weight:800;padding:18px 18px 0;letter-spacing:.3px}
    .card .content{padding:18px}
    header.title{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    header .subtitle{color:var(--muted);font-size:14px}
    .status{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{border:1px solid rgba(0,140,255,.22);color:#dbeaff;padding:8px 12px;border-radius:999px;font-size:12px;background:linear-gradient(180deg,rgba(0,140,255,.08),rgba(0,140,255,.02))}
    .pill.good{background:linear-gradient(135deg,#1fae60,var(--ok));color:#071b10;border-color:transparent}
    .pill.bad{background:linear-gradient(135deg,#ff6b6b,var(--danger));color:#2b0a0a;border-color:transparent}
    .btn{appearance:none;border:1px solid var(--stroke);border-radius:14px;padding:10px 14px;font-weight:800;letter-spacing:.25px;cursor:pointer;background:transparent;color:#eef3ff}
    .btn.primary{background:linear-gradient(135deg,var(--elec3),var(--elec2));color:#04121f;border:0;box-shadow:0 8px 26px rgba(0,140,255,.35)}
    .btn.ok{background:linear-gradient(135deg,#1fae60,var(--ok));color:#071b10;border:0}
    .btn.warn{background:linear-gradient(135deg,#ffb020,#ffd36e);color:#2b1a00;border:0}
    .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width:980px){ .grid2{grid-template-columns:1fr} }
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{margin-top:6px;background:#0a0d14;border:1px solid var(--stroke);color:#eef3ff;border-radius:14px;padding:12px 14px;font-size:15px}
    textarea{min-height:84px;resize:vertical}
    .toggle-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-top:8px}
    @media (max-width:980px){.toggle-grid{grid-template-columns:repeat(2,1fr)}}
    .tbtn{display:flex;align-items:center;justify-content:center;min-height:46px;padding:10px 12px;border-radius:14px;border:1px solid rgba(0,140,255,.22);background:linear-gradient(180deg,rgba(0,140,255,.10),rgba(0,140,255,.03));color:#dbeaff;font-weight:700;letter-spacing:.2px;cursor:pointer;transition:.2s ease}
    .tbtn.active{background:linear-gradient(135deg,var(--elec3),var(--elec2));color:#04121f;border-color:transparent;box-shadow:0 10px 30px rgba(0,140,255,.35)}
    .item{border:1px solid var(--stroke);border-radius:16px;background:#0a0d14;margin-bottom:10px;overflow:hidden}
    .item .head{width:100%; display:flex; gap:10px; align-items:center;padding:12px 14px;background:transparent;color:#eaf2ff;border:0;cursor:pointer;font-weight:800;letter-spacing:.2px;text-align:left;justify-content:space-between}
    .details{padding:12px 14px; border-top:1px solid var(--stroke)}
    .r-line{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .wa-btn{font-size:12px;padding:6px 8px;border-radius:9px;border:1px solid rgba(0,140,255,.22);background:linear-gradient(180deg,rgba(0,140,255,.08),rgba(0,140,255,.02));color:#dbeaff;text-decoration:none;display:inline-flex;gap:6px;align-items:center}
    .wa-btn.ok{background:linear-gradient(135deg,#1fae60,var(--ok));color:#071b10;border-color:transparent}
    .hint{font-size:12px;color:#cfe3ff;opacity:.9}
    #toast{position:fixed;right:20px;bottom:20px;display:grid;gap:8px;z-index:100000}
    .toast{background:linear-gradient(180deg,rgba(0,140,255,.12),rgba(0,140,255,.05));border:1px solid rgba(0,140,255,.25);color:#e6f1ff;padding:10px 14px;border-radius:12px;box-shadow:0 10px 28px rgba(0,0,0,.35);animation:toastIn .2s ease, toastOut .2s ease 3.3s forwards;font-size:13px;letter-spacing:.2px}
    .toast.ok{background:linear-gradient(180deg,rgba(37,211,102,.18),rgba(37,211,102,.06));border-color:rgba(37,211,102,.25)}
    .toast.err{background:linear-gradient(180deg,rgba(255,77,79,.18),rgba(255,77,79,.06));border-color:rgba(255,77,79,.25)}
    @keyframes toastIn{from{transform:translateY(10px);opacity:0}to{transform:translateY(0);opacity:1}}
    @keyframes toastOut{to{transform:translateY(6px);opacity:0}}
  </style>
</head>
<body>
  <div id="toast"></div>
  <header class="title">
    <div>
      <h1>ReLong â€¢ Scadenzario v32d</h1>
      <div class="subtitle">Fix WhatsApp: link affidabili + copia automatica; Pacchi planner + Riparazioni</div>
    </div>
    <div class="status">
      <span id="syncState" class="pill bad">Sync: Disconnesso</span>
      <button id="cfgSync" class="btn">Imposta Sync GitHub</button>
    </div>
  </header>

  <section class="card">
    <h2>Dati Cliente</h2>
    <div class="content grid2">
      <div><label>Nome e Cognome</label><input id="c_name" placeholder="Mario Rossi"></div>
      <div><label>Telefono</label><input id="c_phone" placeholder="3331234567" inputmode="numeric"></div>
      <div style="grid-column:1/-1">
        <label>Seleziona operazione</label>
        <div class="toggle-grid" id="toggles">
          <button type="button" class="tbtn" data-key="riparazione">Riparazione</button>
          <button type="button" class="tbtn" data-key="preventivi">Preventivo</button>
          <button type="button" class="tbtn" data-key="pacchi">Pacchi</button>
          <button type="button" class="tbtn" data-key="sim">SIM</button>
          <button type="button" class="tbtn" data-key="fisso">Fisso</button>
          <button type="button" class="tbtn" data-key="energia">Energia</button>
        </div>
      </div>
      <div style="grid-column:1/-1;display:none" id="acceptWrap">
        <div class="grid2">
          <div><label>Tipo</label><select id="a_type"><option>Smartphone</option><option>Computer</option><option>Stampante</option><option>Console</option></select></div>
          <div><label>Marca</label><input id="a_brand" placeholder="Apple/Samsungâ€¦"></div>
          <div style="grid-column:1/-1"><label>Modello</label><input id="a_model" placeholder="iPhone 17 Pro Maxâ€¦"></div>
          <div style="grid-column:1/-1"><label>Difetto</label><textarea id="a_issue" placeholder="Descrivi il problemaâ€¦"></textarea></div>
        </div>
      </div>
      <div><button id="insertBtn" class="btn primary">Inserisci</button></div>
    </div>
  </section>

  <section class="card">
    <h2>Elenco</h2>
    <div class="content">
      <div id="list"></div>
      <p class="hint">Suggerimento: su desktop assicurati di essere loggato su <b>WhatsApp Web</b> nello stesso browser.</p>
    </div>
  </section>

  <template id="tpl">
    <div class="item">
      <button class="head" type="button">
        <div class="title"></div>
        <div>â–¶</div>
      </button>
      <div class="details" hidden>
        <div class="r-line info"></div>
        <div class="r-line actions"></div>
        <div class="r-line review"></div>
      </div>
    </div>
  </template>

  <script>
    /* Utils & UI */
    const $=s=>document.querySelector(s), $$=s=>[...document.querySelectorAll(s)];
    const STORE_KEY='relong-scadenzario-v32d';
    const GH_CFG_KEY='relong-gh-config-v31', GH_TOKEN_KEY='relong-gh-token-v31';
    const HUB_URL='https://alessandroiascone.github.io/relong-nfc/relong-hub-v2.html';
    const MAPS_URL='https://maps.app.goo.gl/s4ytGUBeGDAEaFG59';
    const REVIEW_URL='http://g.page/r/CeN076xNHzDmEAE/review';
    const RELONG_PHONE='08119578844';
    const PACCHI_TYPES=['energia','sim','fisso','rate','memo'];

    function showToast(t, type='ok'){
      const w=$('#toast'); const el=document.createElement('div'); el.className='toast '+(type==='ok'?'ok':type==='err'?'err':''); el.textContent=t; w.appendChild(el); setTimeout(()=>el.remove(), 3600);
    }
    const normalizePhone = raw => {
      let p=String(raw||'').trim().replace(/\D/g,'');
      if(p.startsWith('0039')) p=p.slice(4);
      else if(p.startsWith('39')) p=p.slice(2);
      return p;
    };
    const fmt = d => new Date(d).toLocaleDateString('it-IT',{year:'numeric',month:'2-digit',day:'2-digit'});
    const addDays=(d,n)=>{const x=new Date(d); x.setDate(x.getDate()+n); return x};
    const hash = s => [...String(s||'')].reduce((a,c)=>(a*31 + c.charCodeAt(0))>>>0, 7);

    /* WhatsApp link builder (more compatible) */
    function waLink(phone, text){
      const num = '39' + normalizePhone(phone);
      return `https://api.whatsapp.com/send?phone=${num}&text=${encodeURIComponent(text)}`;
    }

    /* GitHub Sync */
    const syncState=$('#syncState'), cfgBtn=$('#cfgSync');
    const GH={
      cfg(){ try{ return JSON.parse(localStorage.getItem(GH_CFG_KEY)||'null'); }catch{return null} },
      token(){ return localStorage.getItem(GH_TOKEN_KEY)||'' },
      headers(){ return { 'Accept':'application/vnd.github+json', 'Authorization':'Bearer '+this.token() } },
      async get(path){
        const c=this.cfg(); const url=`https://api.github.com/repos/${c.owner}/${c.repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(c.branch||'main')}`;
        const res=await fetch(url,{headers:this.headers()}); if(!res.ok) throw new Error('GET '+res.status); return res.json();
      },
      async put(path, text, msg){
        const c=this.cfg(); const url=`https://api.github.com/repos/${c.owner}/${c.repo}/contents/${encodeURIComponent(path)}`;
        let sha=null; try{ const meta=await this.get(path); sha=meta.sha; }catch(e){}
        const body={ message:msg||'Update v32d', content:btoa(unescape(encodeURIComponent(text))), branch:c.branch||'main' };
        if(sha) body.sha=sha;
        const res=await fetch(url,{method:'PUT',headers:{...this.headers(),'Content-Type':'application/json'},body:JSON.stringify(body)});
        if(!res.ok){
          if(res.status===409){
            const meta=await this.get(path); const body2={...body,sha:meta.sha};
            const r2=await fetch(url,{method:'PUT',headers:{...this.headers(),'Content-Type':'application/json'},body:JSON.stringify(body2)});
            if(!r2.ok) throw new Error('PUT '+r2.status);
            return r2.json();
          }
          throw new Error('PUT '+res.status);
        }
        return res.json();
      }
    };
    function syncBadge(ok){ syncState.textContent= ok?'Sync: Connesso':'Sync: Disconnesso'; syncState.classList.toggle('good',ok); syncState.classList.toggle('bad',!ok); }
    cfgBtn.addEventListener('click', async ()=>{
      const owner=prompt('Owner GitHub','alessandroiascone')||'';
      const repo=prompt('Repository','relong-nfc')||'';
      const branch=prompt('Branch','main')||'main';
      const path=prompt('Percorso file dati','data/items.json')||'data/items.json';
      const token=prompt('Token (classic, scope repo)','')||'';
      if(!owner||!repo||!token) return alert('Compila owner/repo/token');
      localStorage.setItem(GH_CFG_KEY, JSON.stringify({owner,repo,branch,path,tokenStored:true}));
      localStorage.setItem(GH_TOKEN_KEY, token);
      syncBadge(true); showToast('Sync configurato âœ…');
      await saveToGitHub(); // prova un primo push
    });

    let items=[];
    function loadLocal(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY)||'[]') }catch{return []} }
    function saveLocal(){ localStorage.setItem(STORE_KEY, JSON.stringify(items||[])); }

    async function loadFromGitHubOrLocal(){
      const cfg=GH.cfg(); const tk=GH.token();
      if(cfg && tk){
        try{
          const meta=await GH.get(cfg.path||'data/items.json');
          const json=JSON.parse(decodeURIComponent(escape(atob(meta.content))));
          items=Array.isArray(json)? json:[]; saveLocal(); syncBadge(true); return;
        }catch(e){ syncBadge(false); showToast('Lettura GitHub KO, uso locale','err'); }
      }
      items=loadLocal();
    }
    async function saveToGitHub(){
      const cfg=GH.cfg(); const tk=GH.token(); const p=cfg?.path||'data/items.json';
      if(cfg && tk){
        try{ await GH.put(p, JSON.stringify(items||[]), 'Scadenzario v32d sync'); syncBadge(true); return true; }catch(e){ syncBadge(false); return false; }
      }
      return false;
    }

    /* WA templates */
    function waPacchiEnergia(name, phone){ const t=`Ciao ${name}, sono Alessandro di Re Long (${RELONG_PHONE}).\nTi va una simulazione Luce & Gas davvero conveniente? âš¡ï¸\nIn negozio o via WhatsApp, come preferisci.`; return waLink(phone,t); }
    function waPacchiSIM(name, phone){ const t=`Ciao ${name}, sono Alessandro di Re Long (${RELONG_PHONE}).\nSe vuoi, ti preparo una proposta SIM dedicata (Vodafone/Wind3) con minuti e Giga top. ðŸ“¶`; return waLink(phone,t); }
    function waPacchiFisso(name, phone){ const t=`Ciao ${name}, sono Alessandro di Re Long (${RELONG_PHONE}).\nFibra veloce per casa/ufficio: posso verificare la copertura e una promo dedicata. ðŸ ðŸ“¡`; return waLink(phone,t); }
    function waPacchiRate(name, phone){ const t=`Ciao ${name}, sono Alessandro di Re Long (${RELONG_PHONE}).\nSmartphone a rate senza busta paga: vuoi vedere le offerte attuali? ðŸ“±ðŸ”¥`; return waLink(phone,t); }
    function waPacchiMemo(name, phone){ const t=`Ciao ${name}, sono Alessandro di Re Long (${RELONG_PHONE}).\nPassa quando vuoi in negozio o scrivimi qui su WhatsApp: ti seguo io personalmente ðŸ˜‰`; return waLink(phone,t); }

    function waPickup(name, phone){ const t=`Ciao ${name}, sono Alessandro di Re Long (${RELONG_PHONE}).\nIl tuo prodotto Ã¨ PRONTO, puoi passare a ritirarlo.\nSiamo qui: ${MAPS_URL}`; return waLink(phone,t); }
    function waReview(name, phone){ const t=`Ciao ${name}, grazie per averci preferito! ðŸ™Œ\nSe ti va, lascia una recensione su Google: ${REVIEW_URL}`; return waLink(phone,t); }

    /* PACCHI planner */
    const PACCHI_TYPES=['energia','sim','fisso','rate','memo'];
    const currentTypeLabel = tp => ({energia:'Energia',sim:'SIM',fisso:'Fisso',rate:'Smartphone a rate',memo:'Promemoria'})[tp]||'Promemoria';
    const nextType = tp => PACCHI_TYPES[(PACCHI_TYPES.indexOf(tp)>=0? PACCHI_TYPES.indexOf(tp)+1:0)%PACCHI_TYPES.length];
    const ensurePaccoPlanning = it => {
      if(!it.paccoPlan) it.paccoPlan = {};
      if(!it.paccoPlan.type) it.paccoPlan.type = PACCHI_TYPES[ hash(it.phone)%PACCHI_TYPES.length ];
      if(!it.paccoPlan.nextReminderAt){
        const offset = hash(it.phone)%PACCHI_TYPES.length;
        it.paccoPlan.nextReminderAt = addDays(new Date(), offset).toISOString();
      }
    };

    /* Insert logic */
    const activeSet=new Set(); const toggles=$('#toggles');
    toggles.addEventListener('click', e=>{ const b=e.target.closest('.tbtn'); if(!b) return; const k=b.dataset.key; const on=!b.classList.contains('active'); if(k==='riparazione') $('#acceptWrap').style.display = on? 'block':'none'; b.classList.toggle('active',on); if(on) activeSet.add(k); else activeSet.delete(k); });

    $('#insertBtn').addEventListener('click', async ()=>{
      const name=($('#c_name').value||'').trim(); let phone=($('#c_phone').value||'').trim();
      if(!name || !/\s/.test(name)) return alert('Inserisci Nome e Cognome');
      if(!normalizePhone(phone) || normalizePhone(phone).length<7) return alert('Telefono non valido');
      const act=[...activeSet];

      const isRepair=activeSet.has('riparazione');
      let newItem={ id:Date.now()+Math.random().toString(16).slice(2), name, phone, createdAt:new Date().toISOString(), updatedAt:new Date().toISOString(), activated:act, acceptance:false, fromPacchi:false, done:false };

      if(isRepair){
        const model=($('#a_model').value||'').trim(); if(!model) return alert('Inserisci il modello');
        newItem.acceptance=true; newItem.device={ type:$('#a_type').value, brand:$('#a_brand').value, model, issue:($('#a_issue').value||'').trim() };
        newItem.repairStatus='diagnostica'; newItem.quoteStatus=null; newItem.quotePrice=null;
      }

      if(activeSet.has('pacchi')){
        newItem.fromPacchi=true;
        newItem.paccoPlan = { type: PACCHI_TYPES[ hash(newItem.phone)%PACCHI_TYPES.length ], nextReminderAt: addDays(new Date(), hash(newItem.phone)%PACCHI_TYPES.length).toISOString() };
      }

      // merge by phone if exists
      const prev=items.find(x=>normalizePhone(x.phone)===normalizePhone(phone));
      if(prev){ Object.assign(prev, newItem, { updatedAt:new Date().toISOString(), activated:[...(new Set([...(prev.activated||[]), ...act]))] }); }
      else { items.unshift(newItem); }

      saveLocal(); const ok=await saveToGitHub(); if(!ok) showToast('Salvato in locale (sync KO)','err');
      $('#c_name').value=''; $('#c_phone').value=''; activeSet.clear(); $$('#toggles .tbtn').forEach(b=>b.classList.remove('active')); $('#acceptWrap').style.display='none';
      render(); showToast('Cliente inserito âœ…');
    });

    /* Render helpers */
    function makeAnchor(label, href, onClick){
      const a=document.createElement('a'); a.className='wa-btn ok'; a.href=href; a.target='_blank'; a.rel='noopener'; a.textContent=label;
      if(onClick){ a.addEventListener('click', async (e)=>{ try{ await onClick(e, a) }catch{} }); }
      return a;
    }
    async function copyText(txt){
      try{ await navigator.clipboard.writeText(txt); showToast('Testo copiato negli appunti âœ…'); }catch{}
    }

    /* Render */
    function render(){
      const list=$('#list'); list.innerHTML='';
      items.forEach(it=>{
        const el=$('#tpl').content.firstElementChild.cloneNode(true);
        el.querySelector('.title').innerHTML = `${it.name} â€¢ <b>${it.phone}</b>` + (it.acceptance? ` â€¢ <i>${it.device?.brand||''} ${it.device?.model||''}</i>`:'');
        const head=el.querySelector('.head'), details=el.querySelector('.details'), info=el.querySelector('.info'), actions=el.querySelector('.actions'), review=el.querySelector('.review');
        head.addEventListener('click', ()=>{ details.hidden=!details.hidden; });

        // INFO line (for pacchi reminders)
        info.innerHTML='';
        if(it.fromPacchi && !it.acceptance){
          ensurePaccoPlanning(it);
          const dt = new Date(it.paccoPlan.nextReminderAt);
          const now = new Date();
          const state = (dt < now) ? 'Scaduto' : 'Prossimo';
          const span = document.createElement('span'); span.textContent = `${state}: ${fmt(dt)} â€¢ Tipo: ${currentTypeLabel(it.paccoPlan.type)}`;
          info.append(span);
        }

        // ACTIONS
        actions.innerHTML='';
        if(it.fromPacchi && !it.acceptance){
          // Planner + invio
          ensurePaccoPlanning(it);
          const tpSel=document.createElement('select');
          ['energia','sim','fisso','rate','memo'].forEach(tp=>{
            const o=document.createElement('option'); o.value=tp; o.textContent=currentTypeLabel(tp); tpSel.append(o);
          });
          tpSel.value = it.paccoPlan.type;
          tpSel.addEventListener('change', async ()=>{ it.paccoPlan.type=tpSel.value; it.updatedAt=new Date().toISOString(); saveLocal(); await saveToGitHub(); render(); });

          // Build WA URL for current type
          const name=it.name, phone=it.phone;
          const messages={
            energia: `Ciao ${name}, sono Alessandro di Re Long (${RELONG_PHONE}).\nTi va una simulazione Luce & Gas davvero conveniente? âš¡ï¸\nIn negozio o via WhatsApp, come preferisci.`,
            sim: `Ciao ${name}, sono Alessandro di Re Long (${RELONG_PHONE}).\nSe vuoi, ti preparo una proposta SIM dedicata (Vodafone/Wind3) con minuti e Giga top. ðŸ“¶`,
            fisso: `Ciao ${name}, sono Alessandro di Re Long (${RELONG_PHONE}).\nFibra veloce per casa/ufficio: posso verificare la copertura e una promo dedicata. ðŸ ðŸ“¡`,
            rate: `Ciao ${name}, sono Alessandro di Re Long (${RELONG_PHONE}).\nSmartphone a rate senza busta paga: vuoi vedere le offerte attuali? ðŸ“±ðŸ”¥`,
            memo: `Ciao ${name}, sono Alessandro di Re Long (${RELONG_PHONE}).\nPassa quando vuoi in negozio o scrivimi qui su WhatsApp: ti seguo io personalmente ðŸ˜‰`
          };
          const buildUrl=(tp)=> waLink(phone, messages[tp]||messages.memo);

          const invia = makeAnchor('Invia ora', buildUrl(it.paccoPlan.type), async (e,a)=>{
            // Update planning first, then navigate
            e.preventDefault();
            const url = buildUrl(it.paccoPlan.type);
            // rotate + schedule
            it.paccoPlan.type = nextType(it.paccoPlan.type);
            it.paccoPlan.nextReminderAt = addDays(new Date(), 7).toISOString();
            it.updatedAt=new Date().toISOString();
            saveLocal(); await saveToGitHub(); render();
            // try navigate
            window.open(url,'_blank','noopener');
            // copy text as fallback
            await copyText(messages[tpSel.value]);
          });
          const post = document.createElement('button'); post.className='btn'; post.textContent='Posticipa +3g';
          post.addEventListener('click', async (e)=>{ e.stopPropagation(); it.paccoPlan.nextReminderAt = addDays(new Date(it.paccoPlan.nextReminderAt), 3).toISOString(); it.updatedAt=new Date().toISOString(); saveLocal(); await saveToGitHub(); render(); });
          const del = document.createElement('button'); del.className='btn'; del.textContent='Elimina';
          del.addEventListener('click', async (e)=>{ e.stopPropagation(); items=items.filter(x=>x.id!==it.id); saveLocal(); await saveToGitHub(); render(); });

          actions.append(tpSel, invia, post, del);
        } else if(it.acceptance){
          // RIPARAZIONI
          if(it.repairStatus==='diagnostica'){
            const ip=document.createElement('input'); ip.type='number'; ip.step='0.01'; ip.min='0'; ip.placeholder='Preventivo (â‚¬)';
            if(it.quotePrice!=null) ip.value=it.quotePrice;
            const name=it.name, phone=it.phone;
            const buildMsg = (price) => `Ciao ${name}, sono Alessandro di Re Long (${RELONG_PHONE}).\nEcco il preventivo per la tua riparazione.\nDispositivo: ${it?.device?.type||'-'}\nMarca: ${it?.device?.brand||'-'}\nModello: ${it?.device?.model||'-'}\nDifetto dichiarato: ${it?.device?.issue||'-'}\n\nTotale preventivato: ${price}\n\nSe ACCETTI rispondi â€œACCETTOâ€, altrimenti â€œRIFIUTOâ€.\n\nI nostri servizi: ${HUB_URL}`;
            const sendWA = makeAnchor('Invia preventivo WA', '#', async (e,a)=>{
              e.preventDefault();
              const val=parseFloat((ip.value||'0').replace(',', '.')); if(!(val>=0)) return alert('Importo non valido');
              it.quotePrice=val; it.updatedAt=new Date().toISOString(); saveLocal(); await saveToGitHub();
              const price = new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(val||0);
              const url = waLink(phone, buildMsg(price));
              window.open(url,'_blank','noopener');
              await copyText(buildMsg(price));
            });
            const acc=btn('Segna preventivo ACCETTATO', ()=>{ it.quoteStatus='accepted'; it.repairStatus='inriparazione'; it.updatedAt=new Date().toISOString(); saveLocal(); saveToGitHub(); render(); });
            const ref=btn('Segna preventivo RIFIUTATO', ()=>{ it.quoteStatus='refused'; it.updatedAt=new Date().toISOString(); saveLocal(); saveToGitHub(); render(); });
            actions.append(ip, sendWA, acc, ref, btnDelete(it));
          } else {
            if(it.quoteStatus==='accepted' && it.repairStatus!=='pronto' && it.repairStatus!=='consegnato'){
              const name=it.name, phone=it.phone;
              const sendReady = makeAnchor('Da consegnare (avvisa cliente)', '#', async (e,a)=>{
                e.preventDefault();
                it.repairStatus='pronto'; it.updatedAt=new Date().toISOString(); saveLocal(); await saveToGitHub(); render();
                const url = waLink(phone, `Ciao ${name}, sono Alessandro di Re Long (${RELONG_PHONE}).\nIl tuo prodotto Ã¨ PRONTO, puoi passare a ritirarlo.\nSiamo qui: ${MAPS_URL}`);
                window.open(url,'_blank','noopener');
              });
              sendReady.classList.add('wa-btn','ok'); // ensure style
              actions.append(sendReady);
            }
            if(it.repairStatus==='pronto'){
              actions.append(btn('Ritirato (chiudi pratica)', ()=>{
                it.repairStatus='consegnato'; it.deliveredAt=new Date().toISOString();
                it.postReviewAt = addDays(new Date(), 3).toISOString();
                it.postReviewSent = false;
                it.updatedAt=new Date().toISOString();
                saveLocal(); saveToGitHub(); render();
              }));
            }
            actions.append(btnDelete(it));
          }
        } else {
          actions.append(btn('Completato', ()=>{ it.done=true; it.doneAt=new Date().toISOString(); it.updatedAt=new Date().toISOString(); saveLocal(); saveToGitHub(); render(); }));
          actions.append(btnDelete(it));
        }

        // REVIEW ready
        review.innerHTML='';
        if(it.postReviewAt && !it.postReviewSent && new Date(it.postReviewAt)<=new Date()){
          const name=it.name, phone=it.phone;
          const a = makeAnchor('WhatsApp: ringrazia + recensione', waLink(phone, `Ciao ${name}, grazie per averci preferito! ðŸ™Œ\nSe ti va, lascia una recensione su Google: ${REVIEW_URL}`), async (e)=>{
            it.postReviewSent=true; it.updatedAt=new Date().toISOString(); saveLocal(); await saveToGitHub(); render();
          });
          review.append(a);
        }

        const headBtn=el.querySelector('.head'); headBtn.addEventListener('click', ()=>{ details.hidden=!details.hidden; });
        list.append(el);
      });
    }

    function btn(lbl, fn){ const b=document.createElement('button'); b.className='btn'; b.textContent=lbl; b.addEventListener('click', e=>{ e.stopPropagation(); fn(); }); return b; }
    function btnDelete(it){ return btn('Elimina', ()=>{ items=items.filter(x=>x.id!==it.id); saveLocal(); saveToGitHub(); render(); }); }

    /* Boot */
    (async function(){
      await loadFromGitHubOrLocal();
      render();
      showToast('v32d (WA Fix) pronta âœ…');
    })();
  </script>
</body>
</html>
