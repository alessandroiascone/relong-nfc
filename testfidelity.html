<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ReLong ‚Ä¢ Fidelity Card</title>
  <meta name="theme-color" content="#0a0a0a" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0;-webkit-font-smoothing:antialiased}
    :root{
      --bg1:#05060a; --bg2:#020308;
      --card:rgba(12,14,22,.96); --stroke:rgba(255,255,255,.08);
      --muted:rgba(210,220,255,.75);
      --elec:#0aa2ff; --elec2:#66d1ff; --elec3:#008cff;
      --gold:#ffd700;
      --danger:#ff4d4f;
    }
    body{
      min-height:100svh;
      font-family:system-ui,-apple-system,Inter,Roboto,sans-serif;
      color:#eef3ff;
      background:
        radial-gradient(60% 60% at 20% 0%,rgba(0,140,255,.32),transparent),
        radial-gradient(80% 80% at 110% 90%,rgba(255,215,0,.16),transparent),
        linear-gradient(160deg,var(--bg1),var(--bg2));
      padding:20px 14px 26px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }
    .wrap{
      width:min(520px,100%);
      margin:0 auto;
    }
    .card{
      background:var(--card);
      border-radius:22px;
      border:1px solid var(--stroke);
      box-shadow:
        0 20px 60px rgba(0,0,0,.75),
        0 0 0 1px rgba(0,0,0,.6) inset;
      padding:18px 18px 20px;
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(circle at 0% 0%,rgba(0,140,255,.22),transparent 55%),
        radial-gradient(circle at 120% 10%,rgba(255,215,0,.22),transparent 55%);
      opacity:.6;
      pointer-events:none;
      mix-blend-mode:screen;
    }
    .card-inner{position:relative;z-index:1}

    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:12px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .brand-title{
      font-weight:900;
      letter-spacing:.14em;
      text-transform:uppercase;
      font-size:12px;
      color:#9fb7ff;
    }
    .brand-main{
      font-size:18px;
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .chip{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:radial-gradient(circle at 0 0,rgba(255,255,255,.15),rgba(5,6,14,.95));
      font-size:11px;
      text-align:right;
      max-width:170px;
    }
    .chip span{
      display:block;
    }
    .chip-strong{
      font-weight:700;
      letter-spacing:.05em;
    }

    .holder{
      margin:12px 0 6px;
    }
    .holder-label{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.16em;
      margin-bottom:3px;
    }
    .holder-name{
      font-size:17px;
      font-weight:800;
    }
    .holder-sub{
      margin-top:2px;
      font-size:12px;
      color:var(--muted);
    }

    .grid{
      display:grid;
      grid-template-columns:2fr 1.4fr;
      gap:12px;
      margin-top:14px;
    }
    @media (max-width:520px){
      .grid{grid-template-columns:1fr}
    }

    .block{
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(3,6,18,.9);
      padding:10px 12px;
    }
    .block-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:var(--muted);
      margin-bottom:4px;
    }
    .points-main{
      font-size:30px;
      font-weight:900;
      letter-spacing:.06em;
    }
    .points-note{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }

    .badge-tier{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      font-size:11px;
      margin-top:4px;
      background:linear-gradient(135deg,rgba(0,0,0,.7),rgba(255,255,255,.04));
    }
    .badge-tier span.emoji{
      font-size:13px;
    }

    .next-goal{
      font-size:12px;
      margin-top:4px;
      color:var(--muted);
    }

    .benefits-list{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
    }
    .benefits-list li{
      margin-left:14px;
      margin-bottom:2px;
    }

    .history{
      margin-top:14px;
    }
    .history-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      cursor:pointer;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(90deg,rgba(0,140,255,.20),rgba(0,140,255,.05));
      font-size:13px;
    }
    .history-header span.label{
      text-transform:uppercase;
      letter-spacing:.16em;
      font-size:11px;
      color:#e3f1ff;
    }
    .history-header span.chevron{
      font-size:11px;
      opacity:.85;
    }
    .history-body{
      margin-top:8px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(2,5,18,.98);
      max-height:260px;
      overflow:auto;
      padding:8px 10px;
    }
    .history-empty{
      font-size:12px;
      color:var(--muted);
      padding:4px 2px;
    }

    .movement{
      display:flex;
      align-items:flex-start;
      gap:8px;
      padding:6px 2px;
      border-bottom:1px dashed rgba(255,255,255,.06);
    }
    .movement:last-child{
      border-bottom:none;
      padding-bottom:0;
    }
    .mv-dot{
      width:7px;
      height:7px;
      border-radius:999px;
      margin-top:6px;
      background:linear-gradient(135deg,var(--elec3),var(--elec2));
      box-shadow:0 0 0 3px rgba(0,140,255,.25);
      flex-shrink:0;
    }
    .mv-main{
      flex:1;
      min-width:0;
    }
    .mv-label{
      font-size:12px;
      font-weight:600;
    }
    .mv-meta{
      font-size:11px;
      color:var(--muted);
      margin-top:2px;
    }
    .mv-points{
      font-size:12px;
      font-weight:700;
      white-space:nowrap;
    }
    .mv-points.positive{
      color:#7CFFB2;
    }
    .mv-points.negative{
      color:#ff9b9b;
    }

    .footer-note{
      margin-top:12px;
      font-size:11px;
      color:var(--muted);
      text-align:center;
    }

    .error{
      text-align:center;
      font-size:14px;
      padding:18px 12px;
      border-radius:18px;
      border:1px solid rgba(255,80,80,.45);
      background:radial-gradient(circle at 0 0,rgba(255,80,80,.18),rgba(15,4,4,.95));
      box-shadow:0 20px 60px rgba(0,0,0,.85);
      max-width:420px;
      margin:0 auto;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="loading" class="card">
      <div class="card-inner">
        <header>
          <div class="brand">
            <div class="brand-title">Re Long Informatica</div>
            <div class="brand-main">Fidelity Card</div>
          </div>
          <div class="chip">
            <span class="chip-strong">Caricamento‚Ä¶</span>
            <span style="font-size:11px;color:var(--muted)">Stiamo aprendo la tua Fidelity</span>
          </div>
        </header>
        <div style="margin-top:18px;font-size:13px;color:var(--muted)">
          Attendi qualche istante, stiamo recuperando il saldo punti.
        </div>
      </div>
    </div>

    <div id="cardContainer" style="display:none"></div>
    <div id="errorContainer" style="display:none"></div>
  </div>

  <script>
    const RELONG_PHONE = '08119578844';
    const RAW_URL = 'https://raw.githubusercontent.com/alessandroiascone/relong-nfc/main/data/items.json';

    const fmtDate = iso => {
      if(!iso) return '';
      const d = new Date(iso);
      if(isNaN(d)) return '';
      return d.toLocaleDateString('it-IT',{
        day:'2-digit',month:'2-digit',year:'numeric'
      });
    };
    const fmtDateTime = iso => {
      if(!iso) return '';
      const d = new Date(iso);
      if(isNaN(d)) return '';
      return d.toLocaleString('it-IT',{
        day:'2-digit',month:'2-digit',year:'numeric',
        hour:'2-digit',minute:'2-digit'
      });
    };

    function getLevel(points){
      const p = Number(points||0);
      if(p>=1000) return {name:'BLACK', emoji:'üñ§', min:1000, next:null};
      if(p>=500)  return {name:'GOLD',  emoji:'ü•á', min:500,  next:1000};
      if(p>=150)  return {name:'SILVER',emoji:'ü•à', min:150,  next:500};
      return {name:'BRONZE',emoji:'ü•â', min:0,    next:150};
    }

    function parseId(){
      const params = new URLSearchParams(location.search);
      return params.get('id') || '';
    }

    async function loadItems(){
      const res = await fetch(RAW_URL,{cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }

    function buildCard(it){
      const container = document.getElementById('cardContainer');
      container.innerHTML = '';

      const card = document.createElement('div');
      card.className = 'card';
      const inner = document.createElement('div');
      inner.className = 'card-inner';

      // HEADER
      const header = document.createElement('header');

      const brand = document.createElement('div');
      brand.className='brand';
      brand.innerHTML = `
        <div class="brand-title">Re Long Informatica</div>
        <div class="brand-main">Fidelity Card</div>
      `;

      const chip = document.createElement('div');
      chip.className='chip';
      const masked = String(it.phone || '').slice(-4).padStart(4,'‚Ä¢');
      chip.innerHTML = `
        <span class="chip-strong">Cliente Re Long</span>
        <span>‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${masked}</span>
      `;

      header.appendChild(brand);
      header.appendChild(chip);

      // TITOLARE
      const holder = document.createElement('div');
      holder.className='holder';
      holder.innerHTML = `
        <div class="holder-label">Intestata a</div>
        <div class="holder-name">${it.name || 'Cliente Re Long'}</div>
        <div class="holder-sub">Fidelity attiva dal ${fmtDate(it.createdAt || new Date())}</div>
      `;

      // GRID SALDO + VANTAGGI
      const grid = document.createElement('div');
      grid.className='grid';

      const blockPoints = document.createElement('div');
      blockPoints.className='block';
      const lvl = getLevel(it.points || 0);
      const nextText = lvl.next
        ? `Ti mancano ${Math.max(lvl.next - (it.points||0),0)} punti per il livello ${lvl.name === 'BRONZE' ? 'SILVER' : lvl.name === 'SILVER' ? 'GOLD' : 'BLACK'}.`
        : `Hai raggiunto il livello massimo.`;

      blockPoints.innerHTML = `
        <div class="block-title">Saldo punti</div>
        <div class="points-main">${Number(it.points||0)} pt</div>
        <div class="badge-tier">
          <span class="emoji">${lvl.emoji}</span>
          <span>Livello ${lvl.name}</span>
        </div>
        <div class="next-goal">${nextText}</div>
        <div class="points-note">Ogni operazione in negozio pu√≤ generare nuovi punti Fidelity.</div>
      `;

      const blockBenefits = document.createElement('div');
      blockBenefits.className='block';
      blockBenefits.innerHTML = `
        <div class="block-title">Vantaggi</div>
        <ul class="benefits-list">
          <li>Omaggi e bonus al raggiungimento soglie punti.</li>
          <li>Proposte dedicate su smartphone, fibra, SIM ed energia.</li>
          <li>Assistenza prioritaria tramite WhatsApp ${RELONG_PHONE}.</li>
        </ul>
      `;

      grid.appendChild(blockPoints);
      grid.appendChild(blockBenefits);

      // STORICO PUNTI
      const historyWrap = document.createElement('div');
      historyWrap.className='history';

      const headerHist = document.createElement('div');
      headerHist.className='history-header';
      headerHist.innerHTML = `
        <div>
          <span class="label">Storico punti</span>
          <div style="font-size:12px;">Quando e perch√© hai ricevuto (o utilizzato) punti.</div>
        </div>
        <span class="chevron" id="chevHist">‚ñæ</span>
      `;

      const bodyHist = document.createElement('div');
      bodyHist.className='history-body';

      const movements = Array.isArray(it.pointsMovements) ? [...it.pointsMovements] : [];
      if(!movements.length){
        const empty = document.createElement('div');
        empty.className='history-empty';
        empty.textContent = 'Ancora nessun movimento registrato sulla tua Fidelity. Ogni operazione in negozio aggiorner√† automaticamente questa sezione.';
        bodyHist.appendChild(empty);
      } else {
        movements.sort((a,b)=>{
          const da = new Date(a.at || 0).getTime();
          const db = new Date(b.at || 0).getTime();
          return db - da;
        });

        movements.forEach(m=>{
          const row = document.createElement('div');
          row.className='movement';

          const dot = document.createElement('div');
          dot.className='mv-dot';

          const main = document.createElement('div');
          main.className='mv-main';

          const lab = document.createElement('div');
          lab.className='mv-label';
          lab.textContent = m.label || 'Movimento punti';

          const meta = document.createElement('div');
          meta.className='mv-meta';
          const when = fmtDateTime(m.at);
          meta.textContent = when ? `Data: ${when}` : '';

          main.appendChild(lab);
          main.appendChild(meta);

          const pts = document.createElement('div');
          pts.className='mv-points';
          const d = Number(m.delta || 0);
          if(d >= 0){
            pts.classList.add('positive');
            pts.textContent = `+${d} pt`;
          } else {
            pts.classList.add('negative');
            pts.textContent = `${d} pt`;
          }

          row.appendChild(dot);
          row.appendChild(main);
          row.appendChild(pts);

          bodyHist.appendChild(row);
        });
      }

      let open = true;
      headerHist.addEventListener('click', ()=>{
        open = !open;
        bodyHist.style.display = open ? 'block' : 'none';
        headerHist.querySelector('#chevHist').textContent = open ? '‚ñæ' : '‚ñ¥';
      });

      historyWrap.appendChild(headerHist);
      historyWrap.appendChild(bodyHist);

      const footer = document.createElement('div');
      footer.className='footer-note';
      footer.innerHTML = `
        Per aggiornare i tuoi dati Fidelity o richiedere il saldo dettagliato, contatta direttamente
        <strong>Re Long Informatica</strong> su WhatsApp al <strong>${RELONG_PHONE}</strong>.
      `;

      inner.appendChild(header);
      inner.appendChild(holder);
      inner.appendChild(grid);
      inner.appendChild(historyWrap);
      inner.appendChild(footer);

      card.appendChild(inner);
      container.appendChild(card);
    }

    function showError(msg){
      document.getElementById('loading').style.display='none';
      const errC = document.getElementById('errorContainer');
      errC.style.display='block';
      errC.innerHTML = `
        <div class="error">
          <strong>Fidelity non trovata</strong><br/><br/>
          ${msg}<br/><br/>
          Contatta Re Long Informatica e chiedi la verifica della tua Fidelity Card.
        </div>
      `;
    }

    (async function init(){
      const id = parseId();
      if(!id){
        showError('Il link non contiene un codice Fidelity valido.');
        return;
      }
      try{
        const all = await loadItems();
        const arr = Array.isArray(all) ? all : [];
        const hit = arr.find(x => String(x.id||'') === String(id));
        if(!hit){
          showError('Non √® stato possibile trovare la tua Fidelity con il codice fornito.');
          return;
        }
        document.getElementById('loading').style.display='none';
        const cardC = document.getElementById('cardContainer');
        cardC.style.display='block';
        buildCard(hit);
      }catch(e){
        console.error(e);
        showError('Si √® verificato un problema nel recupero dei dati. Riprova pi√π tardi.');
      }
    })();
  </script>
</body>
</html>
