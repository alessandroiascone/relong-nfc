<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ReLong â€¢ Ritiro & Consegna Pacchi</title>
  <meta name="theme-color" content="#0a0a0a" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0;-webkit-font-smoothing:antialiased}
    :root{
      --bg1:#0b0d12; --bg2:#06070b;
      --card:rgba(14,16,22,.92); --stroke:rgba(255,255,255,.08);
      --muted:rgba(210,220,255,.70);
      --elec:#0aa2ff; --elec2:#66d1ff; --elec3:#008cff;
      --ok:#25D366; --danger:#ff4d4f; --warn:#ff8f3b;
      --shadow:0 8px 28px rgba(0,140,255,.16), inset 0 1px 0 rgba(255,255,255,.04);
    }
    html,body{min-height:100%;background:radial-gradient(65% 65% at 25% 15%, var(--bg1), var(--bg2));color:#eef3ff}
    body{font-family:system-ui,-apple-system,Inter,Roboto,sans-serif; padding:28px 18px 40px; display:flex; flex-direction:column; gap:20px}
    .wrap{max-width:1240px; margin:0 auto; width:100%; display:grid; gap:20px}
    header.wrap{gap:8px}
    .title h1{font-size:26px;letter-spacing:.2px}
    .subtitle{color:var(--muted);font-size:14px}

    .card{background:var(--card);border:1px solid var(--stroke);border-radius:22px;box-shadow:var(--shadow)}
    .card h2{font-size:18px;font-weight:800;padding:18px 18px 0;letter-spacing:.3px}
    .card .content{padding:18px}

    .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .full{grid-column:1/-1}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{margin-top:6px;background:#0a0d14;border:1px solid var(--stroke);color:#eef3ff;border-radius:14px;padding:12px 14px;font-size:15px}
    textarea{min-height:84px;resize:vertical}

    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{appearance:none;border:0;border-radius:16px;padding:12px 16px;font-weight:800;letter-spacing:.25px;cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--elec3),var(--elec2));color:#04121f;box-shadow:0 8px 26px rgba(0,140,255,.30)}
    .btn.ghost{background:transparent;border:1px solid var(--stroke);color:#eef3ff}
    .btn.ok{background:linear-gradient(135deg,#1fae60,var(--ok));color:#071b10}
    .btn.warn{background:linear-gradient(135deg,#ff8f3b,#ffbd6b);color:#301a00}
    .btn.danger{background:linear-gradient(135deg,#ff6b6b,var(--danger));color:#230a0a}

    .toggle{display:flex;gap:8px;flex-wrap:wrap}
    .pill{border:1px solid rgba(0,140,255,.22);color:#dbeaff;padding:8px 12px;border-radius:999px;font-size:13px;cursor:pointer;background:linear-gradient(180deg,rgba(0,140,255,.08),rgba(0,140,255,.02))}
    .pill.active{background:linear-gradient(135deg,var(--elec3),var(--elec2));color:#04121f;border-color:transparent;box-shadow:0 8px 24px rgba(0,140,255,.25)}

    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap}
    .search{display:flex;gap:8px;align-items:center}
    .search input{min-width:220px}

    .list .row{border:1px solid var(--stroke);border-radius:16px;padding:12px;background:#0a0d14;margin-bottom:10px}
    .rowhead{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .tag{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#04121f;background:linear-gradient(135deg,var(--elec3),var(--elec2));padding:4px 8px;border-radius:999px}
    .tag.ritiro{background:linear-gradient(135deg,#7ffbe6,#14d8c4);color:#052b25}
    .tag.consegna{background:linear-gradient(135deg,#ffe37a,#ffc14d);color:#3b2a00}
    .tag.done{background:linear-gradient(135deg,#1fae60,var(--ok));color:#071b10}
    .tag.late{background:linear-gradient(135deg,#ff7a7a,#ff4d4f);color:#250909}

    /* PIN */
    #pinGate{position:fixed;inset:0;background:linear-gradient(180deg,rgba(0,10,20,.9),rgba(0,0,0,.95));backdrop-filter:blur(6px);display:grid;place-items:center;z-index:9999}
    #pinCard{background:var(--card);border:1px solid var(--stroke);border-radius:20px;box-shadow:var(--shadow);padding:20px 18px;max-width:360px;width:92%;display:grid;gap:12px}
    #pinCard h3{margin:0;font-size:18px}
    #pinCard p{color:var(--muted);font-size:13px}
    #pinInput{letter-spacing:6px;text-align:center;font-weight:800}
    #pinError{color:#ff7676;min-height:18px;font-size:12px}

    #errBar{position:fixed;left:0;right:0;bottom:0;background:#c0392b;color:#fff;padding:8px 12px;font-size:12px;display:none;z-index:99999}
  </style>
</head>
<body>
  <!-- PIN -->
  <div id="pinGate" hidden>
    <div id="pinCard">
      <h3>Accesso protetto</h3>
      <p>Inserisci il PIN.</p>
      <input id="pinInput" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="â€¢â€¢â€¢â€¢" />
      <div class="actions"><button id="pinOk" class="btn primary" style="flex:1">Sblocca</button></div>
      <div id="pinError"></div>
      <p style="font-size:11px">Blocco base lato client.</p>
    </div>
  </div>

  <div id="errBar"></div>

  <header class="wrap">
    <div class="title">
      <h1>ReLong â€¢ Ritiro & Consegna Pacchi</h1>
      <div class="subtitle">Registro rapido con WhatsApp + Sync automatico verso Scadenziario.</div>
    </div>
  </header>

  <!-- Nuovo record -->
  <section class="wrap card">
    <h2>Nuova registrazione</h2>
    <div class="content grid2">
      <div>
        <label>Tipo</label>
        <div class="toggle" id="kind">
          <button class="pill active" data-v="ritiro">Ritiro in negozio</button>
          <button class="pill" data-v="consegna">Consegna/spedizione</button>
        </div>
      </div>
      <div>
        <label>Data</label>
        <input id="p_date" type="date" />
      </div>

      <div><label>Nome e Cognome</label><input id="p_name" placeholder="Mario Rossi" /></div>
      <div><label>Telefono (solo cifre)</label><input id="p_phone" placeholder="3331234567" inputmode="numeric" pattern="[0-9]+" /></div>

      <div><label>Corriere</label><input id="p_corriere" placeholder="GLS / SDA / Bartolini / -" /></div>
      <div><label>Tracking</label><input id="p_tracking" placeholder="es. 123456789" /></div>

      <div class="full"><label>Note</label><textarea id="p_note" placeholder="Dettagli, riferimento ordine, ecc." ></textarea></div>

      <div class="full actions" style="margin-top:8px">
        <button id="save" class="btn primary">Salva</button>
        <button id="waNotify" class="btn ok">WhatsApp notifica</button>
        <button id="publish" class="btn ghost" title="Forza la visibilitÃ  nello Scadenziario (trigger evento storage)">ðŸ”„ Pubblica su Scadenziario</button>
        <button id="lockNow" class="btn warn">ðŸ”’ Blocca adesso</button>
      </div>
    </div>
  </section>

  <!-- Elenco -->
  <section class="wrap card">
    <h2>Elenco pacchi</h2>
    <div class="content">
      <div class="toolbar">
        <div class="toggle">
          <button class="pill active" data-f="all">Tutti</button>
          <button class="pill" data-f="ritiro">Solo ritiri</button>
          <button class="pill" data-f="consegna">Solo consegne</button>
          <button class="pill" data-f="today">Oggi</button>
          <button class="pill" data-f="late">In ritardo</button>
          <button class="pill" data-f="done">Completati</button>
        </div>
        <div class="search">
          <label style="margin-right:4px">Cerca</label>
          <input id="q" placeholder="Nome, telefono, tracking, corriereâ€¦" />
        </div>
        <div class="actions">
          <button id="exportBtn" class="btn ghost">Export JSON</button>
          <label class="btn ghost" style="cursor:pointer">Import JSON
            <input id="importFile" type="file" accept="application/json" style="display:none" />
          </label>
        </div>
      </div>

      <div class="list" id="list"></div>
    </div>
  </section>

  <script>
    /* ====== CONFIG PIN ====== */
    const PIN_ENABLED = true;
    const PIN_ALWAYS  = true;
    const PIN_CODE    = '1990';

    const $  = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => [...r.querySelectorAll(s)];
    const ERR = $('#errBar');

    // Storage chiave (v2 con contenitore .items[])
    const PACCHI_KEY = 'relong-pacchi-v2';

    const fmtDate = (d) => d.toLocaleDateString('it-IT',{year:'numeric',month:'2-digit',day:'2-digit'});
    const isoDay = (d)=> d.toISOString().slice(0,10);
    const today = () => { const d=new Date(); d.setHours(0,0,0,0); return d; }
    const normalizePhone = (p)=>{ let ph=String(p||'').trim().replace(/\D/g,''); if(ph.startsWith('0')) ph=ph.slice(1); return ph; };

    function load(){
      try{
        const raw = localStorage.getItem(PACCHI_KEY);
        if(!raw) return {items:[]};
        const obj = JSON.parse(raw);
        if(Array.isArray(obj)) return {items:obj};
        if(!obj.items) obj.items = [];
        return obj;
      }catch(e){ console.warn('Storage pacchi corrotto',e); localStorage.removeItem(PACCHI_KEY); return {items:[]}; }
    }
    function save(obj){
      localStorage.setItem(PACCHI_KEY, JSON.stringify(obj));
      // Trigger evento per lo Scadenziario in altre tab
      localStorage.setItem(PACCHI_KEY, JSON.stringify(obj)); // doppio set per sicurezza
    }

    let state = load();
    let filter = 'all';

    // Data oggi
    (function setToday(){
      const d=new Date(); const pad=n=>String(n).padStart(2,'0');
      const input=$('#p_date');
      if('valueAsDate' in input) input.valueAsDate = d;
      else input.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    })();

    // Toggle tipo
    const kindWrap = $('#kind');
    function getKind(){ const a=$$('.pill', kindWrap).find(x=>x.classList.contains('active')); return a?.dataset.v || 'ritiro'; }
    kindWrap.addEventListener('click',(e)=>{ const b=e.target.closest('.pill'); if(!b) return; $$('.pill',kindWrap).forEach(x=>x.classList.remove('active')); b.classList.add('active'); });

    // Anti doppio salvataggio: memorizza hash ultimi 5s
    let lastHash = null, lastHashAt = 0;
    function sameJustSaved(hash){
      const now=Date.now();
      if(lastHash===hash && now - lastHashAt < 5000) return true;
      lastHash = hash; lastHashAt = now; return false;
    }

    // WhatsApp
    function waNotifyFor(rec){
      const name = rec.name || 'cliente';
      const base = `Ciao ${name}, sono Alessandro di Re Long (08119578844).`;
      if(rec.kind==='ritiro'){
        const msg = `${base}
Il tuo pacco Ã¨ ARRIVATO in negozio. Puoi passare a ritirarlo quando vuoi.
Se serve info: Corriere ${rec.corriere||'-'}${rec.tracking?` â€¢ Tracking ${rec.tracking}`:''}.`;
        return `https://wa.me/39${rec.phone}?text=${encodeURIComponent(msg)}`;
      } else {
        const msg = `${base}
Abbiamo CONSEGNATO/SPEDITO il tuo pacco.
Corriere ${rec.corriere||'-'}${rec.tracking?` â€¢ Tracking ${rec.tracking}`:''}. Grazie!`;
        return `https://wa.me/39${rec.phone}?text=${encodeURIComponent(msg)}`;
      }
    }

    // Salva
    $('#save').addEventListener('click', ()=>{
      const name = $('#p_name').value.trim();
      const phone = normalizePhone($('#p_phone').value);
      const date = $('#p_date').value ? new Date($('#p_date').value) : new Date();
      const corriere = $('#p_corriere').value.trim();
      const tracking = $('#p_tracking').value.trim();
      const note = $('#p_note').value.trim();
      const kind = getKind();

      if(!name || !phone){ alert('Inserisci Nome e Telefono'); return; }

      const hash = [kind, phone, isoDay(date), corriere.toLowerCase(), tracking.toLowerCase()].join('|');
      if(sameJustSaved(hash)){ alert('GiÃ  salvato adesso, evita duplicati ðŸ‘Œ'); return; }

      const rec = {
        id: Date.now()+Math.random().toString(16).slice(2),
        name, phone, kind,
        corriere, tracking, note,
        createdAt: new Date().toISOString(),
        date: date.toISOString(),
        done:false
      };

      state.items.unshift(rec);
      save(state);
      render();
      // pulizia soft (mantengo nome/phone comodi al banco)
      $('#p_corriere').value=''; $('#p_tracking').value=''; $('#p_note').value='';
    });

    // Notifica WhatsApp
    $('#waNotify').addEventListener('click', ()=>{
      const name = $('#p_name').value.trim();
      const phone = normalizePhone($('#p_phone').value);
      if(!name || !phone){ alert('Prima inserisci Nome e Telefono'); return; }
      const rec = {
        name, phone, kind:getKind(),
        corriere: $('#p_corriere').value.trim(),
        tracking: $('#p_tracking').value.trim()
      };
      const href = waNotifyFor(rec);
      try{ window.open(href,'_blank','noopener'); }catch{}
    });

    // Forza publish (re-scrive storage -> scadenziario ingesta)
    $('#publish').addEventListener('click', ()=>{ save(state); alert('Pubblicato su Scadenziario âœ”ï¸'); });

    // Filtri
    $$('.toggle .pill').forEach(p=> p.addEventListener('click',()=>{
      if(!p.dataset.f) return;
      $$('.toggle .pill').filter(x=>x.dataset.f).forEach(x=>x.classList.remove('active'));
      p.classList.add('active'); filter=p.dataset.f; render();
    }));

    $('#q').addEventListener('input', render);

    function render(){
      const box = $('#list'); box.innerHTML='';
      const q = ($('#q').value||'').toLowerCase();
      const tStr = fmtDate(today());

      const rows = state.items.filter(rec=>{
        if(filter==='ritiro' && rec.kind!=='ritiro') return false;
        if(filter==='consegna' && rec.kind!=='consegna') return false;
        if(filter==='done' && !rec.done) return false;
        if(filter==='today' && fmtDate(new Date(rec.date))!==tStr) return false;
        if(filter==='late' && !rec.done && new Date(rec.date) < today()) return true;
        if(filter==='late' && rec.done) return false;
        return true;
      }).filter(rec=>{
        if(!q) return true;
        return (
          (rec.name||'').toLowerCase().includes(q) ||
          (rec.phone||'').toLowerCase().includes(q) ||
          (rec.tracking||'').toLowerCase().includes(q) ||
          (rec.corriere||'').toLowerCase().includes(q) ||
          (rec.kind||'').toLowerCase().includes(q)
        );
      });

      rows.forEach(rec=>{
        const row = document.createElement('div'); row.className='row';
        const head = document.createElement('div'); head.className='rowhead';
        const left = document.createElement('div');
        left.innerHTML = `<b>${rec.name}</b> â€¢ ${rec.phone} â€¢ ${rec.tracking?rec.tracking:'â€”'}<br>
          <small style="color:var(--muted)">${rec.corriere||'â€”'} â€¢ ${fmtDate(new Date(rec.date))}</small>`;
        const tags = document.createElement('div'); tags.className='tags';
        const t1 = document.createElement('span'); t1.className='tag '+rec.kind; t1.textContent = rec.kind==='ritiro'?'Ritiro':'Consegna';
        tags.appendChild(t1);
        if(rec.done){ const td=document.createElement('span'); td.className='tag done'; td.textContent='Completato'; tags.appendChild(td); }
        if(!rec.done && new Date(rec.date) < today()){ const tl=document.createElement('span'); tl.className='tag late'; tl.textContent='In ritardo'; tags.appendChild(tl); }
        head.append(left, tags);

        const body = document.createElement('div'); body.style.marginTop='8px';
        if(rec.note){ body.innerHTML = `<div style="opacity:.85">${rec.note}</div>`; }

        const actions = document.createElement('div'); actions.className='actions'; actions.style.marginTop='10px';
        const wa = document.createElement('a'); wa.className='btn ok'; wa.textContent='WhatsApp'; wa.href=waNotifyFor(rec); wa.target='_blank'; wa.rel='noopener';
        const done = document.createElement('button'); done.className='btn ghost'; done.textContent= rec.done?'Segna come non fatto':'Segna completato';
        done.addEventListener('click', ()=>{ rec.done=!rec.done; save(state); render(); });
        const del = document.createElement('button'); del.className='btn danger'; del.textContent='Elimina';
        del.addEventListener('click', ()=>{ state.items = state.items.filter(x=>x.id!==rec.id); save(state); render(); });

        actions.append(wa, done, del);

        row.append(head, body, actions);
        box.appendChild(row);
      });
    }

    // Export / Import
    $('#exportBtn').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`relong-pacchi-backup-${Date.now()}.json`; a.click();
      URL.revokeObjectURL(url);
    });
    $('#importFile').addEventListener('change', (e)=>{
      const f=e.target.files[0]; if(!f) return;
      const fr=new FileReader();
      fr.onload=()=>{
        try{
          const obj=JSON.parse(fr.result);
          if(Array.isArray(obj)) state={items:obj};
          else if(obj && Array.isArray(obj.items)) state=obj; else throw new Error('Formato non valido');
          save(state); render(); alert('Import riuscito âœ”ï¸');
        }catch(err){ alert('Import fallito: '+err.message); }
      };
      fr.readAsText(f);
    });

    // PIN gate
    (function pinGateInit(){
      const gate=$('#pinGate'), ok=$('#pinOk'), input=$('#pinInput'), err=$('#pinError');
      const lockBtn = $('#lockNow');

      function show(el){ el && el.removeAttribute('hidden'); }
      function hide(el){ el && el.setAttribute('hidden',''); }
      function setAppHidden(h){ document.querySelectorAll('[aria-hidden]').forEach(n=> n.setAttribute('aria-hidden', h?'true':'false')); }

      function locked(){
        if(!PIN_ENABLED) return false;
        if(PIN_ALWAYS) return true;
        return sessionStorage.getItem('relong-pacchi-pin-ok')!=='1';
      }

      function enforce(){
        if(PIN_ENABLED && locked()){
          show(gate); setAppHidden(true);
          setTimeout(()=>input?.focus(),50);
        } else {
          hide(gate); setAppHidden(false);
        }
      }

      function tryUnlock(){
        const val=(input.value||'').trim();
        if(val===PIN_CODE){
          sessionStorage.setItem('relong-pacchi-pin-ok','1');
          setAppHidden(false); hide(gate); gate.parentNode && gate.parentNode.removeChild(gate);
        } else { err.textContent='PIN errato. Riprova.'; input.value=''; input.focus(); }
      }

      ok.addEventListener('click', tryUnlock);
      input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ tryUnlock(); } });
      lockBtn.addEventListener('click', ()=>{
        sessionStorage.removeItem('relong-pacchi-pin-ok');
        if(!document.body.contains(gate)){ location.reload(); return; }
        show(gate); setAppHidden(true); setTimeout(()=>input?.focus(),60);
      });

      if(PIN_ENABLED){ show(gate); }
      enforce();
    })();

    // Prima render
    render();

    // Error bar
    window.addEventListener('error', e=>{ ERR.textContent='Errore JavaScript: '+(e.message||'sconosciuto'); ERR.style.display='block'; });
  </script>
</body>
</html>
