<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ReLong ‚Ä¢ Scadenzario + Accettazione + Pacchi (NO PIN)</title>
  <meta name="theme-color" content="#0a0a0a" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0;-webkit-font-smoothing:antialiased}
    :root{
      --bg1:#0b0d12; --bg2:#06070b;
      --card:rgba(14,16,22,.92); --stroke:rgba(255,255,255,.08);
      --muted:rgba(210,220,255,.70);
      --elec:#0aa2ff; --elec2:#66d1ff; --elec3:#008cff;
      --ok:#25D366; --danger:#ff4d4f;
      --shadow:0 10px 40px rgba(0,140,255,.18), inset 0 1px 0 rgba(255,255,255,.04);
      --st-diagnostica:#ffd666; --st-inrip:#69c0ff; --st-pronto:#95de64; --st-consegnato:#bfbfbf;
      --pacchi:#00d1b2;
    }
    body{min-height:100svh;font-family:system-ui,-apple-system,Inter,Roboto,sans-serif;color:#eef3ff;
      background:radial-gradient(65% 65% at 25% 15%, var(--bg1), var(--bg2));
      padding:24px;display:flex;flex-direction:column;gap:24px}
    .shell{
      max-width:1200px;margin:0 auto;
      display:grid;grid-template-columns:minmax(480px, 640px) 1fr;gap:20px;align-items:start
    }
    @media (max-width:980px){ .shell{grid-template-columns:1fr} }

    .card{background:var(--card);border:1px solid var(--stroke);border-radius:22px;box-shadow:var(--shadow)}
    .card h2{font-size:18px;font-weight:800;padding:18px 18px 0;letter-spacing:.3px}
    .card .content{padding:18px}
    .title{display:flex;align-items:flex-start;gap:14px;justify-content:space-between}
    .title h1{font-size:26px;letter-spacing:.2px}
    .subtitle{color:var(--muted);font-size:14px}

    .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .full{grid-column:1/-1}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{margin-top:6px;background:#0a0d14;border:1px solid var(--stroke);color:#eef3ff;border-radius:14px;padding:12px 14px;font-size:15px}
    textarea{min-height:84px;resize:vertical}

    .toggle-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-top:8px}
    @media (max-width:980px){.toggle-grid{grid-template-columns:repeat(2,1fr)}}
    .tbtn{display:flex;align-items:center;justify-content:center;min-height:46px;padding:10px 12px;border-radius:14px;border:1px solid rgba(0,140,255,.22);background:linear-gradient(180deg,rgba(0,140,255,.10),rgba(0,140,255,.03));color:#dbeaff;font-weight:700;letter-spacing:.2px;cursor:pointer;transition:.2s ease}
    .tbtn:hover{transform:translateY(-1px);box-shadow:inset 0 0 0 1px rgba(0,140,255,.25)}
    .tbtn.active{background:linear-gradient(135deg,var(--elec3),var(--elec2));color:#04121f;border-color:transparent;box-shadow:0 10px 30px rgba(0,140,255,.35)}

    .actions{display:flex;gap:10px;flex-wrap:wrap}
    #insertBtn{width:100%;display:block}
    .btn{appearance:none;border:0;border-radius:16px;padding:12px 16px;font-weight:800;letter-spacing:.25px;cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--elec3),var(--elec2));color:#04121f;box-shadow:0 8px 26px rgba(0,140,255,.35)}
    .btn.ghost{background:transparent;border:1px solid var(--stroke);color:#eef3ff}
    .btn.ok{background:linear-gradient(135deg,#1fae60,var(--ok));color:#071b10}
    .btn.danger{background:linear-gradient(135deg,#ff6b6b,var(--danger));color:#2b0a0a}

    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap}
    .filters{display:flex;gap:8px;flex-wrap:wrap}
    .pill{border:1px solid rgba(0,140,255,.22);color:#dbeaff;padding:8px 12px;border-radius:999px;font-size:13px;cursor:pointer;background:linear-gradient(180deg,rgba(0,140,255,.08),rgba(0,140,255,.02))}
    .pill.active{background:linear-gradient(135deg,var(--elec3),var(--elec2));color:#04121f;border-color:transparent;box-shadow:0 8px 24px rgba(0,140,255,.25)}
    .search{display:flex;gap:8px;align-items:center}
    .search input{min-width:220px}

    .item{border:1px solid var(--stroke);border-radius:16px;background:#0a0d14;margin-bottom:10px;overflow:hidden}
    .item .head{
      width:100%; display:flex; gap:10px; align-items:center;
      padding:12px 14px; background:transparent; color:#eaf2ff; border:0; cursor:pointer;
      font-weight:800; letter-spacing:.2px; text-align:left; justify-content:space-between
    }
    .head-left{display:flex;align-items:center;gap:10px;min-width:0}
    .item .h{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .mini-badges{display:flex;gap:6px;align-items:center;flex-shrink:0}
    .mini{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border-radius:999px;font-size:11px;font-weight:700;color:#0a0a0a;opacity:.95}
    .mini.diagnostica{background:var(--st-diagnostica)}
    .mini.inriparazione{background:var(--st-inrip)}
    .mini.pronto{background:var(--st-pronto)}
    .mini.consegnato{background:var(--st-consegnato)}
    .item .chev{transition:transform .18s ease; opacity:.9; flex-shrink:0}
    .item.open .chev{transform:rotate(90deg)}

    .details{padding:12px 14px; border-top:1px solid var(--stroke)}
    .tags{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
    .tag{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#04121f;background:linear-gradient(135deg,var(--elec3),var(--elec2));padding:4px 8px;border-radius:999px}
    .muted{background:linear-gradient(135deg,#7aa3c7,#a7c6df)!important;color:#0b1b29}
    .activeChat{background:linear-gradient(135deg,#1fae60,var(--ok))!important;color:#071b10}
    .pacchi{background:linear-gradient(135deg,var(--pacchi),#7ffbe6)!important;color:#05312a}
    .dup{background:linear-gradient(135deg,#ff9f43,#ffd56b)!important;color:#3b2700}
    .q-acc{background:linear-gradient(135deg,#0bd66f,#7ef7b6)!important;color:#052a1e}
    .q-rif{background:linear-gradient(135deg,#ffa6a6,#ffd6d6)!important;color:#3a0606}

    .st-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700;color:#0a0a0a}
    .st-diagnostica{background:var(--st-diagnostica)}
    .st-inrip{background:var(--st-inrip)}
    .st-pronto{background:var(--st-pronto)}
    .st-consegnato{background:var(--st-consegnato)}

    .summary{display:grid;gap:8px}
    .accept-brief{background:#091019;border:1px solid rgba(0,140,255,.2);border-radius:10px;padding:8px;display:grid;gap:8px}
    .r-line{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .r-badge{border:1px solid rgba(0,140,255,.25);background:linear-gradient(180deg,rgba(0,140,255,.10),rgba(0,140,255,.02));color:#dbeaff;font-size:12px;border-radius:999px;padding:6px 10px;display:inline-flex;gap:6px;align-items:center}
    .wa-btn{font-size:12px;padding:6px 8px;border-radius:9px;border:1px solid rgba(0,140,255,.22);background:linear-gradient(180deg,rgba(0,140,255,.08),rgba(0,140,255,.02));color:#dbeaff;text-decoration:none;display:inline-flex;gap:6px;align-items:center}
    .wa-btn.ok{background:linear-gradient(135deg,#1fae60,var(--ok));color:#071b10;border-color:transparent}

    #activationCard{grid-column:1}
    #acceptWrap,#pacchiWrap{grid-column:2}
    #acceptWrap,#pacchiWrap{display:none;opacity:0;transform:translateX(8px);transition:opacity .18s ease, transform .18s ease;position:relative}
    #acceptWrap.show,#pacchiWrap.show{display:block;opacity:1;transform:translateX(0)}
    .sticky-panel{position:sticky; top:16px}

    #listSection[hidden]{display:none}
    .openListCard{max-width:1200px;margin:0 auto}

    .subsection{margin:6px 0 12px}
    .subsection h3{font-size:15px;opacity:.9;margin-bottom:8px}

    #errBar{position:fixed;left:0;right:0;bottom:0;background:#c0392b;color:#fff;padding:8px 12px;font-size:12px;display:none;z-index:99999}

    .flash{animation:flash 1.4s ease}
    @keyframes flash{0%{box-shadow:0 0 0 0 rgba(0,140,255,.0)}30%{box-shadow:0 0 0 4px rgba(0,140,255,.35)}100%{box-shadow:0 0 0 0 rgba(0,140,255,.0)}}
  </style>
</head>
<body>
  <div id="errBar"></div>
  <div id="toast" aria-live="polite"></div>

  <!-- Header -->
  <header class="title">
    <div>
      <h1>ReLong ‚Ä¢ Scadenzario + Accettazione</h1>
      <div class="subtitle">Attivazioni, Riparazioni & Gestione Pacchi.</div>
    </div>
  </header>

  <!-- Dati cliente -->
  <section class="card" style="max-width:1200px;margin:0 auto">
    <h2>Dati cliente (unici)</h2>
    <div class="content grid2">
      <div><label>Nome e Cognome</label><input required id="c_name" placeholder="Mario Rossi" /></div>
      <div><label>Telefono (solo cifre)</label><input required id="c_phone" placeholder="3331234567" inputmode="numeric" pattern="[0-9]+" /></div>
    </div>
  </section>

  <div class="shell">
    <!-- Attivazioni -->
    <section class="card" id="activationCard">
      <h2>Attivazioni</h2>
      <div class="content">
        <div class="grid2">
          <div>
            <label>Data attivazione</label>
            <input id="start" type="date" disabled aria-readonly="true" title="Impostata automaticamente alla data di oggi" />
          </div>
          <div class="full">
            <label>Cosa hai attivato ORA</label>
            <div class="toggle-grid" id="toggles">
              <button type="button" class="tbtn" data-key="sim">SIM Mobile</button>
              <button type="button" class="tbtn" data-key="fisso">Linea Fissa</button>
              <button type="button" class="tbtn" data-key="energia">Energia</button>
              <button type="button" class="tbtn" data-key="smartphone">Smartphone a rate</button>
              <button type="button" class="tbtn" data-key="preventivi">Preventivi acquisti</button>
              <button type="button" class="tbtn" data-key="riparazione">Riparazione</button>
              <button type="button" class="tbtn" data-key="pacchi">Pacchi</button>
            </div>
          </div>
        </div>
        <div class="actions" style="margin-top:12px"><button class="btn primary" id="insertBtn">Inserisci cliente</button></div>
      </div>
    </section>

    <!-- Accettazione (Assistenza) -->
    <aside class="card sticky-panel" id="acceptWrap">
      <h2>Accettazione dispositivo (Assistenza)</h2>
      <div class="content">
        <form id="acceptForm" class="grid2" onsubmit="return false;">
          <div>
            <label>Tipo dispositivo</label>
            <select id="a_type">
              <option>Smartphone</option>
              <option>Computer</option>
              <option>Stampante</option>
              <option>Console & Accessori</option>
            </select>
          </div>
          <div>
            <label>Marca</label>
            <select id="a_brand">
              <option>Apple</option><option>Samsung</option><option>Oppo</option>
              <option>Redmi</option><option>Xiaomi</option><option>Honor</option><option>Other</option>
            </select>
          </div>
          <div><label>Modello</label><input id="a_model" placeholder="iPhone 17ProMax, Galaxy S25 Ultra‚Ä¶" /></div>
          <div class="full"><label>Difetto / Problema</label><textarea id="a_issue" placeholder="Descrivi il problema segnalato‚Ä¶"></textarea></div>
          <p class="subtitle full" style="margin-top:4px">Al termine clicca su ‚ÄúAccetta & Inserisci‚Äù.</p>
        </form>
      </div>
    </aside>

    <!-- Pacchi -->
    <aside class="card sticky-panel" id="pacchiWrap">
      <h2>Pacchi (Ricezione/Ritiro)</h2>
      <div class="content">
        <div class="grid2 full">
          <div class="actions full" style="gap:12px">
            <button class="btn ok" id="p_received">üì¶ Pacco RICEVUTO</button>
            <button class="btn ghost" id="p_picked">üì¶ Pacco RITIRATO</button>
          </div>
          <p class="subtitle full" style="margin-top:4px">
            Al clic: parte WhatsApp con messaggio precompilato e il contatto viene inserito in elenco.
          </p>
        </div>
      </div>
    </aside>
  </div>

  <!-- Apri elenco -->
  <section class="card openListCard">
    <div class="content" style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div>
        <h2 style="padding:0">Clienti & Promemoria</h2>
        <div class="subtitle">Elenco completo con filtri essenziali.</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="toggleListBtn" class="btn ghost">Apri elenco</button>
      </div>
    </div>
  </section>

  <!-- Elenco -->
  <section class="card" id="listSection" style="max-width:1200px;margin:0 auto" hidden>
    <div class="content">
      <div class="toolbar">
        <div class="filters">
          <button class="pill active" data-filter="all">Tutti</button>
          <button class="pill" data-filter="pacchi">Da Pacchi</button>
          <button class="pill" data-filter="desk">Acquisizioni al banco</button>
        </div>
        <div class="search">
          <label>Cerca</label>
          <input id="q" placeholder="Nome, telefono, ID pratica, modello‚Ä¶" />
        </div>
      </div>

      <div class="subsection" id="subStandard">
        <h3>Clienti</h3>
        <div id="listStandard"></div>
      </div>

      <div class="subsection" id="subPacchi">
        <h3>Da Pacchi</h3>
        <div id="listPacchi"></div>
      </div>
    </div>
  </section>

  <template id="tpl-item">
    <div class="item">
      <button class="head" type="button">
        <div class="head-left">
          <div class="h"></div>
        </div>
        <div class="mini-badges"></div>
        <div class="chev">‚ñ∂</div>
      </button>
      <div class="details" hidden>
        <div class="tags"></div>
        <div class="summary"></div>
      </div>
    </div>
  </template>

  <script>
    /* ---- CONFIGURABILI ---- */
    const HUB_URL   = 'https://alessandroiascone.github.io/relong-nfc/relong-hub-v2.html';
    const MAPS_URL  = 'https://maps.app.goo.gl/s4ytGUBeGDAEaFG59';
    const REVIEW_URL= 'http://g.page/r/CeN076xNHzDmEAE/review';

    /* Error bar */
    (function(){ const bar=document.getElementById('errBar'); window.addEventListener('error',e=>{bar.textContent='Errore JavaScript: '+(e.message||'sconosciuto'); bar.style.display='block';}); })();

    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => [...r.querySelectorAll(s)];

    const STORE_KEY = 'relong-scadenzario-v31-nopin';

    const load = () => { try { const raw = localStorage.getItem(STORE_KEY); return raw ? JSON.parse(raw) : []; } catch(e){ console.warn('Storage danneggiato:', e); localStorage.removeItem(STORE_KEY); return []; } };
    const save = (arr) => localStorage.setItem(STORE_KEY, JSON.stringify(arr));

    const fmtDate = (d) => d.toLocaleDateString('it-IT',{year:'numeric',month:'2-digit',day:'2-digit'});
    const fmtDateShort = (d) => d.toLocaleDateString('it-IT',{month:'2-digit',day:'2-digit'});
    const today = () => { const d=new Date(); d.setHours(0,0,0,0); return d }
    const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x }
    const addHours = (d,n)=>{ const x=new Date(d); x.setHours(x.getHours()+n); return x }
    const avoidWeekend = (d)=>{ const x=new Date(d); const day=x.getDay(); if(day===0) x.setDate(x.getDate()+1); if(day===6) x.setDate(x.getDate()+2); return x }
    const normalizePhone = (p)=>{ let ph=String(p||'').trim().replace(/\D/g,''); if(ph.startsWith('0')) ph=ph.slice(1); return ph; };

    const BASE_RANGES = { energia:[9,16], fisso:[12,20], sim:[6,12], smartphone:[10,18], preventivi:[3,7] };
    function hashStr(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }
    function rngInt(seedStr,min,max){ const h=hashStr(seedStr); const span=Math.max(0,(max-min)); return min + (h % (span+1)); }
    function offsetDaysFor(type, ctx){
      let [lo,hi]=BASE_RANGES[type]||[12,18];
      if(ctx.kind==='repair' || ctx.kind==='pacchi'){ lo=Math.max(10,Math.min(lo,13)); hi=Math.max(16,Math.min(hi+2,19)); }
      if(ctx.prior.has(type)){ lo+=5; hi+=9; }
      if(ctx.prior.has('fisso') && type==='sim'){ lo+=3; hi+=4; }
      if(ctx.prior.has('sim') && type==='fisso'){ lo+=3; }
      if(ctx.prior.has('smartphone') && type==='energia'){ lo+=2; }
      if(ctx.prior.has('energia') && type==='smartphone'){ lo+=1; }
      lo=Math.max(3,Math.min(lo,28)); hi=Math.max(lo,Math.min(hi,35));
      const seed=`${ctx.phone}|${type}`; return rngInt(seed,lo,hi);
    }
    function computeMixedTasks({ startDate, phone, priorActivated, includePreventivi=false, contextKind=null, activatedNow=[] }){
      const upsellTargets = ['energia','fisso','sim','smartphone'];
      const excludeSet = new Set((activatedNow||[]).map(x=>String(x).toLowerCase()).filter(x=>upsellTargets.includes(x)));
      const ctx = { phone: normalizePhone(phone||''), prior:new Set(priorActivated||[]), kind:contextKind };
      const baseTasks = upsellTargets.filter(t=>!excludeSet.has(t)).map(type=>{ let due=addDays(startDate, offsetDaysFor(type, ctx)); due=avoidWeekend(due); return {type, due:due.toISOString()}; });
      if(includePreventivi){ let due=addDays(startDate, offsetDaysFor('preventivi', ctx)); due=avoidWeekend(due); baseTasks.push({type:'preventivi', due:due.toISOString()}); }
      return baseTasks;
    }

    let items = load();

    function nextPraticaId(){
      const key='relong-pratica-seq';
      const y=new Date().getFullYear();
      let seq; try{ seq=JSON.parse(localStorage.getItem(key)||'[]'); }catch{ seq=[]; }
      let rec = seq.find(r=>r.year===y);
      if(!rec){ rec={year:y,n:0}; seq.push(rec); }
      rec.n += 1; localStorage.setItem(key, JSON.stringify(seq));
      return `RL-${y}-${String(rec.n).padStart(4,'0')}`;
    }

    function normalizeName(s){ return String(s||'').toLowerCase().replace(/\s+/g,' ').trim(); }
    let idxByPhone = new Map();
    let idxByName  = new Map();
    function buildIndexes(){
      idxByPhone.clear(); idxByName.clear();
      for(const it of items){
        const ph = normalizePhone(it.phone);
        const nm = normalizeName(it.name);
        const ts = new Date(it.updatedAt||it.createdAt||it.start||0).getTime();
        const a = idxByPhone.get(ph);
        if(ph && (!a || ts > new Date(a.updatedAt||a.createdAt||a.start||0).getTime())) idxByPhone.set(ph, it);
        const b = idxByName.get(nm);
        if(nm && (!b || ts > new Date(b.updatedAt||b.createdAt||b.start||0).getTime())) idxByName.set(nm, it);
      }
    }
    buildIndexes();

    const c_name = $('#c_name'); const c_phone = $('#c_phone');
    const acceptWrap = $('#acceptWrap'); const pacchiWrap = $('#pacchiWrap');
    const toggles = $('#toggles'); const activeSet = new Set();

    function showToast(text,type='ok'){
      const wrap=$('#toast'); if(!wrap)return;
      const el=document.createElement('div');
      el.className=`toast ${type==='ok'?'ok':type==='err'?'err':''}`;
      el.textContent=text; wrap.appendChild(el);
      setTimeout(()=>{el.remove();},3600);
    }

    function updateAcceptanceUI(){
      let isRepair = activeSet.has('riparazione');
      let isPacchi = activeSet.has('pacchi');
      if(isRepair && isPacchi){
        const otherKey='pacchi'; activeSet.delete(otherKey);
        const ob = document.querySelector('.tbtn[data-key="pacchi"]'); ob && ob.classList.remove('active');
        isPacchi=false;
      }
      acceptWrap.classList.toggle('show', isRepair);
      pacchiWrap.classList.toggle('show', isPacchi);
      $('#insertBtn').textContent = isRepair ? 'Accetta & Inserisci' : 'Inserisci cliente';
      const target = isRepair ? acceptWrap : (isPacchi ? pacchiWrap : null);
      if(target){ target.scrollIntoView({behavior:'smooth', block:'start'}); }
    }

    toggles.addEventListener('click', (e)=>{
      const b = e.target.closest('.tbtn'); if(!b) return;
      const key=b.dataset.key;
      const toActive = !b.classList.contains('active');
      if(toActive && (key==='riparazione' || key==='pacchi')){
        const otherKey = key==='riparazione' ? 'pacchi' : 'riparazione';
        activeSet.delete(otherKey);
        const ob = document.querySelector(`.tbtn[data-key="${otherKey}"]`); ob && ob.classList.remove('active');
      }
      b.classList.toggle('active', toActive);
      if(toActive) activeSet.add(key); else activeSet.delete(key);
      updateAcceptanceUI();
    });

    const startI = $('#start');
    function setStartToToday(){
      const d=new Date(); const pad=n=>String(n).padStart(2,'0');
      if(startI){ if('valueAsDate' in startI) startI.valueAsDate = d; else startI.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
    }
    setStartToToday();

    function autofillFromPhone(){
      const ph = normalizePhone(c_phone.value||''); if(!ph) return;
      const hit = idxByPhone.get(ph);
      if(hit && (!c_name.value || c_name.value.trim().length===0)){ c_name.value = hit.name || ''; showToast('Auto-compilato da archivio'); }
    }
    function autofillFromName(){
      const nm  = normalizeName(c_name.value||''); if(!nm || nm.split(' ').length<2) return;
      const hit = idxByName.get(nm);
      if(hit && (!c_phone.value || normalizePhone(c_phone.value).length===0)){ c_phone.value = hit.phone || ''; showToast('Auto-compilato da archivio'); }
    }
    c_phone.addEventListener('blur', autofillFromPhone);
    c_phone.addEventListener('input', ()=>{ const v=normalizePhone(c_phone.value); if(v.length>=7) autofillFromPhone(); });
    c_name.addEventListener('blur', autofillFromName);
    c_name.addEventListener('input', ()=>{ const nm=normalizeName(c_name.value||''); if(nm.split(' ').length>=2) autofillFromName(); });

    function waForUpsell(it, type){
      const base = `Ciao ${it.name}, sono Alessandro di Re Long (08119578844).`;
      const map = {
        energia: `${base}\nHai diritto ad uno sconto Energia dedicato. Vuoi risparmiare sulla bolletta?\nHub: ${HUB_URL}`,
        fisso:   `${base}\nOfferte Internet Casa FTTC/FTTH riservate. Vuoi verifica copertura + simulazione?\nHub: ${HUB_URL}`,
        sim:     `${base}\nSIM con Giga/Min illimitati e promo dedicate. Vuoi i dettagli?\nHub: ${HUB_URL}`,
        smartphone:`${base}\nSmartphone a rate (anche senza busta paga). Valutiamo il tuo usato. Vuoi una proposta?\nHub: ${HUB_URL}`,
        preventivi:`${base}\nPromemoria preventivo. Vuoi che ti invii ora una simulazione?\nHub: ${HUB_URL}`
      };
      const txt = map[(type||'').toLowerCase()] || `${base}\nHo una promo per te. Ti va se te la spiego?\nHub: ${HUB_URL}`;
      return `https://wa.me/39${it.phone}?text=${encodeURIComponent(txt)}`;
    }
    function waForRepairIntake(name, phone, dev){
      const base = `Ciao ${name}, sono Alessandro di Re Long (08119578844).`;
      const devTxt = dev ? `\nDispositivo: ${dev.type||'-'} ‚Ä¢ ${dev.brand||''} ${dev.model||''}` : '';
      const txt = `${base}\nAbbiamo ritirato il tuo dispositivo per diagnosi.${devTxt}\nTi contatteremo a breve con il preventivo.\nHub: ${HUB_URL}`;
      return `https://wa.me/39${phone}?text=${encodeURIComponent(txt)}`;
    }
    function waForPickupReady(name, phone){
      const base = `Ciao ${name}, sono Alessandro di Re Long (08119578844).`;
      const txt = `${base}\nIl tuo prodotto √® PRONTO, puoi passare a ritirarlo.\nCi trovi qui: ${MAPS_URL}`;
      return `https://wa.me/39${phone}?text=${encodeURIComponent(txt)}`;
    }
    function waForThankReview(name, phone){
      const base = `Ciao ${name}, grazie per averci preferito! üôå`;
      const txt = `${base}\nSe ti va, lascia una recensione su Google: ${REVIEW_URL}`;
      return `https://wa.me/39${phone}?text=${encodeURIComponent(txt)}`;
    }

    function clearClientInputs(){ c_name.value=''; c_phone.value=''; c_name.focus(); }
    function resetSelections(){
      activeSet.clear(); $$('#toggles .tbtn').forEach(b=>b.classList.remove('active'));
      $('#acceptWrap').classList.remove('show'); $('#pacchiWrap').classList.remove('show');
      try{ $('#acceptForm')?.reset(); }catch{};
      $('#insertBtn').textContent='Inserisci cliente';
    }

    let idxByPhoneCache = new Map(); // simple cache for merge

    function mergeItems(existing, pending){
      const actSet = new Set([...(existing.activated||[]), ...((pending.activated)||[])]);
      existing.activated = [...actSet];

      const byType = {}; (existing.tasks||[]).forEach(t=>{ byType[t.type] = t; });
      (pending.tasks||[]).forEach(t=>{ const cur = byType[t.type]; if(!cur){ byType[t.type]=t; } else { const d1=new Date(cur.due), d2=new Date(t.due); if(d2 < d1) byType[t.type]=t; } });
      existing.tasks = Object.values(byType);

      if(pending.fromPacchi){ existing.fromPacchi = true; }
      if(pending.pacchiCount){ existing.pacchiCount = (existing.pacchiCount||0) + pending.pacchiCount; }
      if(pending.pacchiKinds){ const kinds=new Set([...(existing.pacchiKinds||[]), ...(pending.pacchiKinds||[])]); existing.pacchiKinds=[...kinds]; }

      if(pending.acceptance){
        existing.acceptance = true;
        existing.device = pending.device;
        existing.repairStatus = existing.repairStatus || pending.repairStatus || 'diagnostica';
        existing.quotePrice = existing.quotePrice ?? pending.quotePrice ?? null;
        existing.quoteStatus = existing.quoteStatus ?? pending.quoteStatus ?? null;
        if(!existing.praticaId) existing.praticaId = pending.praticaId;
      }

      existing.name = pending.name || existing.name;
      existing.phone = existing.phone || pending.phone;
      existing.updatedAt = new Date().toISOString();

      if(pending.postReviewAt) existing.postReviewAt = pending.postReviewAt;
      if(typeof pending.postReviewSent === 'boolean') existing.postReviewSent = pending.postReviewSent;

      return existing;
    }

    const insertBtn = $('#insertBtn');
    insertBtn.addEventListener('click', ()=>{
      const name=(c_name.value||'').trim();
      let phone=normalizePhone(c_phone.value||'');
      if(!name || !phone) return alert('Inserisci nome e telefono');

      const start=new Date();
      const activatedNow=new Set(activeSet);

      const prev=idxByPhone.get(phone);
      const priorActivated=prev?.activated||[];

      const baseObj={
        name,phone,start:start.toISOString(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),
        activated:[...activatedNow],done:false,optWeekend:true,optEvening:true,muteDate:null,activeChatUntil:null,doneAt:null,
        acceptance:false,praticaId:null,fromPacchi:false,pacchiCount:0,pacchiKinds:[],postReviewAt:null,postReviewSent:false
      };

      let pending;
      if(activatedNow.has('riparazione')){
        const tasks=computeMixedTasks({startDate:new Date(),phone,priorActivated,includePreventivi:activatedNow.has('preventivi'),contextKind:'repair',activatedNow:[...activatedNow]});
        const device={type:$('#a_type').value,brand:$('#a_brand').value,model:($('#a_model').value||'').trim(),issue:($('#a_issue').value||'').trim()};
        pending={...baseObj,id:Date.now()+Math.random().toString(16).slice(2),tasks,acceptance:true,praticaId:nextPraticaId(),device,repairStatus:'diagnostica',quotePrice:null,quoteStatus:null};
        try{ window.open(waForRepairIntake(pending.name,pending.phone,pending.device),'_blank','noopener'); }catch{}
      }else{
        const tasks=computeMixedTasks({startDate:start,phone,priorActivated,includePreventivi:activatedNow.has('preventivi'),contextKind:null,activatedNow:[...activatedNow]});
        pending={...baseObj,id:Date.now()+Math.random().toString(16).slice(2),tasks};
      }

      // sposta i task se SIM/FISSO: review a +5gg feriali, poi buffer +2gg -> ma review di riparazioni √® separata
      if(activatedNow.has('sim')||activatedNow.has('fisso')){
        const reviewBase=avoidWeekend(addDays(start,5));
        const startAfter=avoidWeekend(addDays(reviewBase,2));
        pending.postReviewAt=reviewBase.toISOString();
        pending.postReviewSent=false;
        const delta=Math.ceil((startAfter-start)/(24*60*60*1000));
        if(Array.isArray(pending.tasks)){
          pending.tasks=pending.tasks.map(tsk=>{
            const nd=avoidWeekend(addDays(new Date(tsk.due),delta));
            return {...tsk,due:nd.toISOString()};
          });
        }
      }

      const idx=items.findIndex(x=> normalizePhone(x.phone)===phone);
      if(idx>-1){ items[idx]=mergeItems(items[idx],pending);} else { items.unshift(pending); }
      save(items); buildIndexes(); setListOpen(true); render(); highlightByPhone(phone);

      clearClientInputs(); resetSelections(); showToast('Cliente inserito ‚úÖ','ok');
    });

    $('#p_received').addEventListener('click',()=>handlePacchi('Ricevuto'));
    $('#p_picked').addEventListener('click',()=>handlePacchi('Ritirato'));
    function handlePacchi(kind){
      const name=(c_name.value||'').trim();
      let phone=normalizePhone(c_phone.value||'');
      if(!name||!phone) return alert('Inserisci nome e telefono');
      const prev=idxByPhone.get(phone);
      const priorActivated=prev?.activated||[];
      const tasks=computeMixedTasks({startDate:new Date(),phone,priorActivated,includePreventivi:false,contextKind:'pacchi',activatedNow:[]});
      const pending={name,phone,start:new Date().toISOString(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),activated:[],done:false,optWeekend:true,optEvening:true,muteDate:null,activeChatUntil:null,doneAt:null,acceptance:false,praticaId:null,fromPacchi:true,pacchiCount:1,pacchiKinds:[kind],tasks,id:Date.now()+Math.random().toString(16).slice(2),postReviewAt:null,postReviewSent:false};
      const idx=items.findIndex(x=> normalizePhone(x.phone)===phone);
      if(idx>-1){ items[idx]=mergeItems(items[idx],pending);} else { items.unshift(pending); }
      save(items); buildIndexes(); setListOpen(true); render(); highlightByPhone(phone);
      clearClientInputs(); resetSelections(); showToast('Cliente inserito ‚úÖ','ok');
      try{
        const base=`Ciao ${name}, sono Alessandro di Re Long (08119578844).`;
        const msg=`${base}\nAggiornamento pacco: ${kind.toUpperCase()}.\n\nHub: ${HUB_URL}`;
        window.open(`https://wa.me/39${phone}?text=${encodeURIComponent(msg)}`,'_blank','noopener');
      }catch{}
    }

    let filter='all'; const qI=$('#q');
    $$('.pill').forEach(p=>p.addEventListener('click',()=>{ $$('.pill').forEach(x=>x.classList.remove('active')); p.classList.add('active'); filter=p.dataset.filter; render(); }));
    qI?.addEventListener('input', render);

    function iconName(type){ return ({energia:'Energia',fisso:'Internet Casa',sim:'SIM',smartphone:'Smartphone a rate',preventivi:'Preventivi acquisti',riparazione:'Riparazione'})[type]||type; }
    function tag(txt, cls=''){ const s=document.createElement('span'); s.className='tag'; if(cls) s.classList.add(cls); s.textContent=txt; return s }
    function statusChip(status){
      const mapCls={diagnostica:'st-diagnostica',inriparazione:'st-inrip',pronto:'st-pronto',consegnato:'st-consegnato'};
      const label={diagnostica:'Diagnostica',inriparazione:'In riparazione',pronto:'Pronto',consegnato:'Consegnato'}[status]||status;
      const span=document.createElement('span'); span.className=`st-chip ${mapCls[status]||''}`; span.textContent=label; return span;
    }
    function miniBadge(status){
      const s=(status||'').toLowerCase();
      const span=document.createElement('span');
      span.className=`mini ${s}`;
      span.textContent=({diagnostica:'Diagnostica',inriparazione:'In riparazione',pronto:'Pronto',consegnato:'Consegnato'})[s]||s||'';
      return span;
    }

    const expandedIds=new Set();
    function setListOpen(open){
      const listSection=$('#listSection'); const toggleListBtn=$('#toggleListBtn');
      listSection.hidden=!open; toggleListBtn.textContent=open?'Chiudi elenco':'Apri elenco';
      if(open) render();
    }
    $('#toggleListBtn').addEventListener('click',()=> setListOpen($('#listSection').hidden));

    function highlightByPhone(phone){
      const ph=(phone||'').replace(/\D/g,'');
      requestAnimationFrame(()=>{
        const nodes=$$('#listStandard .item, #listPacchi .item');
        const node=nodes.find(n=>(n.querySelector('.h')?.textContent||'').includes(ph));
        (node||$('#listSection')).classList.add('flash');
        setTimeout(()=> (node||$('#listSection')).classList.remove('flash'),1400);
      });
    }

    function scheduleReviewAfterDays(it,days){
      it.postReviewAt=addDays(new Date(),days).toISOString();
      it.postReviewSent=false;
      it.updatedAt=new Date().toISOString();
      save(items);
      const ms=new Date(it.postReviewAt)-new Date();
      if(ms>0 && ms<7*24*60*60*1000){
        setTimeout(()=>{
          const hit=items.find(x=>x.id===it.id);
          if(hit && hit.postReviewAt && !hit.postReviewSent && new Date(hit.postReviewAt)<=new Date()){
            showToast(`Pronto il messaggio di ringraziamento per ${hit.name}.`, 'ok');
            setListOpen(true); render();
          }
        }, ms);
      }
    }

    function render(){
      if($('#listSection').hidden)return;
      const listStd=$('#listStandard'); listStd.innerHTML='';
      const listPac=$('#listPacchi'); listPac.innerHTML='';

      const q=(qI?.value||'').trim().toLowerCase();

      const filtered=items
        .filter(it=>{ if(filter==='pacchi')return it.fromPacchi===true; if(filter==='desk')return it.fromPacchi!==true; return true; })
        .filter(it=>{
          if(!q)return true;
          return (it.name.toLowerCase().includes(q) ||
                  (it.phone||'').toLowerCase().includes(q) ||
                  (it.praticaId||'').toLowerCase().includes(q) ||
                  (it.device?.brand||'').toLowerCase().includes(q) ||
                  (it.device?.model||'').toLowerCase().includes(q) ||
                  (it.repairStatus||'').toLowerCase().includes(q) ||
                  (it.fromPacchi?'pacchi':'').includes(q) ||
                  (it.pacchiKinds||[]).join(' ').toLowerCase().includes(q));
        });

      const counts={}; items.forEach(it=>{ const ph=normalizePhone(it.phone); counts[ph]=(counts[ph]||0)+1; });

      filtered.filter(it=>it.fromPacchi!==true).forEach(it=>listStd.appendChild(renderItem(it,counts)));
      filtered.filter(it=>it.fromPacchi===true).forEach(it=>listPac.appendChild(renderItem(it,counts)));
    }

    function renderItem(it,counts){
      const t=$('#tpl-item').content.firstElementChild.cloneNode(true);
      const headBtn=t.querySelector('.head'), details=t.querySelector('.details');

      t.querySelector('.h').textContent=`${it.name} ‚Ä¢ ${it.phone}${it.praticaId?' ‚Ä¢ '+it.praticaId:''}`;

      const miniWrap=t.querySelector('.mini-badges'); miniWrap.innerHTML='';
      if(it.acceptance && it.repairStatus) miniWrap.append(miniBadge(it.repairStatus));

      const open=expandedIds.has(it.id);
      if(open){ t.classList.add('open'); details.hidden=false; }
      headBtn.addEventListener('click',()=>{
        const isOpen=t.classList.toggle('open');
        details.hidden=!isOpen;
        if(isOpen)expandedIds.add(it.id);else expandedIds.delete(it.id);
      });

      const tags=t.querySelector('.tags'); tags.innerHTML='';
      if((counts[normalizePhone(it.phone)]||0)>1) tags.append(tag('Doppione','dup'));
      if(it.fromPacchi){ tags.append(tag(`Pacchi${it.pacchiCount?' √ó'+it.pacchiCount:''}`,'pacchi')); if((it.pacchiKinds||[]).length){ tags.append(tag((it.pacchiKinds||[]).join(', '),'pacchi')); } }
      if(it.acceptance){ tags.append(tag(`${it.device?.brand||''} ${it.device?.model||''}`.trim()||'Accettazione')); tags.append(statusChip(it.repairStatus||'diagnostica')); }
      if(it.quoteStatus==='accepted') tags.append(tag('Preventivo accettato','q-acc'));
      if(it.quoteStatus==='refused')  tags.append(tag('Preventivo rifiutato','q-rif'));
      it.activated?.forEach(a=> tags.append(tag('Attivato: '+iconName(a))));

      const sum=t.querySelector('.summary'); sum.innerHTML='';

      /* --- SEZIONE RIPARAZIONE: 4 step con WA e lock a consegna --- */
      if(it.acceptance){
        const box=document.createElement('div'); box.className='accept-brief';
        const top=document.createElement('div'); top.className='r-line';
        top.innerHTML = `<div style="flex:1">
            <b>${it.device?.type||''}</b> ‚Ä¢ ${it.device?.brand||''} ${it.device?.model||''}
            <br><small>Difetto: ${it.device?.issue||'-'}${it.deliveredAt?` ‚Ä¢ Consegnato: ${fmtDate(new Date(it.deliveredAt))}`:''}</small>
          </div>`;

        const controls=document.createElement('div'); controls.className='r-line';
        const sel=document.createElement('select');
        sel.innerHTML=`<option value="diagnostica">Diagnostica</option><option value="inriparazione">In riparazione</option><option value="pronto">Pronto al ritiro</option><option value="consegnato">Consegnato</option>`;
        sel.value=it.repairStatus||'diagnostica';
        if(it.repairStatus==='consegnato') sel.disabled = true; // LOCK dopo consegna
        sel.addEventListener('click', ev=>ev.stopPropagation());
        sel.addEventListener('change',()=>{
          if(it.repairStatus==='consegnato') { sel.value='consegnato'; return; } // ulteriore protezione
          const prev=it.repairStatus;
          it.repairStatus=sel.value;
          if (it.repairStatus === 'pronto' && prev!=='pronto'){
            try{ window.open(waForPickupReady(it.name,it.phone),'_blank','noopener'); }catch{}
          }
          if (it.repairStatus === 'consegnato'){
            it.deliveredAt=new Date().toISOString();
            sel.disabled = true;
            scheduleReviewAfterDays(it,3); // +3 giorni dalla consegna
          }
          it.updatedAt=new Date().toISOString();
          save(items); render();
        });
        controls.append(sel);
        box.append(top,controls);

        if((it.repairStatus||'diagnostica')==='diagnostica'){
          const pv=document.createElement('div'); pv.className='r-line'; pv.style.marginTop='8px';
          pv.innerHTML=`
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
              <label style="min-width:120px">Preventivo (‚Ç¨)</label>
              <input type="number" step="0.01" min="0" id="q_${it.id}" placeholder="0,00" style="width:140px">
              <button class="wa-btn ok" id="qsend_${it.id}">Invia preventivo WA</button>
            </div>
            <div class="r-line">
              <button class="btn ok" id="qacc_${it.id}">Segna ACCETTATO ‚Üí In riparazione</button>
              <button class="btn danger" id="qref_${it.id}">Segna RIFIUTATO</button>
            </div>`;
          box.append(pv);
          setTimeout(()=>{
            const ip=document.getElementById(`q_${it.id}`);
            if(ip && it.quotePrice!=null){ ip.value = Number(it.quotePrice); }
            const bSend=document.getElementById(`qsend_${it.id}`);
            const bAcc=document.getElementById(`qacc_${it.id}`);
            const bRef=document.getElementById(`qref_${it.id}`);
            [ip,bSend,bAcc,bRef].forEach(el=> el && el.addEventListener('click', ev=>ev.stopPropagation()));

            function waForPreventivo(priceEuro){
              const price=new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(priceEuro||0);
              const base=`Ciao ${it.name}, sono Alessandro di Re Long (08119578844).\nEcco il preventivo per la tua riparazione.`;
              const dev=`\nDispositivo: ${it?.device?.type||'-'}\nMarca: ${it?.device?.brand||'-'}\nModello: ${it?.device?.model||'-'}\nDifetto dichiarato: ${it?.device?.issue||'-'}`;
              const prx=`\n\nTotale preventivato: ${price}\n\nSe ACCETTI rispondi ‚ÄúACCETTO‚Äù, altrimenti ‚ÄúRIFIUTO‚Äù.`;
              const hub=`\n\nI nostri servizi: ${HUB_URL}`;
              return `https://wa.me/39${it.phone}?text=${encodeURIComponent(base+dev+prx+hub)}`;
            }

            bSend?.addEventListener('click',()=>{
              const val=parseFloat(ip?.value?.replace(',','.')||'0');
              if(!(val>=0)) return alert('Inserisci un importo valido');
              it.quotePrice=val; it.quoteStatus='sent'; it.updatedAt=new Date().toISOString(); save(items);
              try{ window.open(waForPreventivo(val),'_blank','noopener'); }catch{}
              showToast('Preventivo inviato ‚úÖ','ok');
            });
            bAcc?.addEventListener('click',()=>{
              it.quoteStatus='accepted'; it.repairStatus='inriparazione'; it.updatedAt=new Date().toISOString(); save(items); render();
            });
            bRef?.addEventListener('click',()=>{
              it.quoteStatus='refused'; it.updatedAt=new Date().toISOString(); save(items); render();
            });
          },0);
        }

        if((it.repairStatus||'')==='inriparazione'){
          const actions=document.createElement('div'); actions.className='r-line'; actions.style.marginTop='6px';
          const ready=document.createElement('button'); ready.className='btn ok'; ready.textContent='Dispositivo PRONTO ‚Üí invia WA';
          ready.addEventListener('click',ev=>{
            ev.stopPropagation();
            try{ window.open(waForPickupReady(it.name,it.phone),'_blank','noopener'); }catch{}
            it.repairStatus='pronto'; it.updatedAt=new Date().toISOString(); save(items); render();
          });
          actions.append(ready); box.append(actions);
        }

        if((it.repairStatus||'')==='consegnato'){
          const lock=document.createElement('div'); lock.className='subtitle'; lock.style.marginTop='6px';
          lock.textContent='Pratica chiusa. Modifiche disabilitate.'; box.append(lock);
        }
        sum.append(box);
      }

      // prossimi task + pulsanti WA
      const next3=[...(it.tasks||[])].sort((a,b)=> new Date(a.due)-new Date(b.due)).filter(tsk=>!it.done).slice(0,3);
      if(next3.length){
        const line=document.createElement('div'); line.className='r-line';
        next3.forEach(tsk=>{
          const due=new Date(tsk.due); const late=due<today();
          const badge=document.createElement('span'); badge.className='r-badge'; badge.innerHTML=`${iconName(tsk.type)} ‚Ä¢ <b${late?' style="color:#ffb3b3"':''}>${fmtDateShort(due)}</b>`;
          const a=document.createElement('a'); a.href=waForUpsell(it, tsk.type); a.target='_blank'; a.rel='noopener'; a.className='wa-btn ok'; a.textContent='WhatsApp'; a.dataset.wa='1'; a.dataset.id=it.id;
          a.addEventListener('click',ev=>ev.stopPropagation());
          line.append(badge,a);
        });
        sum.append(line);
      }

      const actions=document.createElement('div'); actions.className='r-line';
      const snooze=document.createElement('button'); snooze.className='wa-btn'; snooze.textContent='Snooze +1g';
      snooze.addEventListener('click',(ev)=>{ev.stopPropagation(); (it.tasks||[]).forEach(tsk=>{ let nd=avoidWeekend(addDays(new Date(tsk.due),1)); tsk.due=nd.toISOString();}); save(items); render();});
      const done=document.createElement('button'); done.className='wa-btn'; done.textContent='Completato';
      done.addEventListener('click',(ev)=>{ev.stopPropagation(); it.done=true; it.doneAt=new Date().toISOString(); save(items); render();});
      const del=document.createElement('button'); del.className='wa-btn'; del.textContent='Elimina';
      del.addEventListener('click',(ev)=>{ev.stopPropagation(); items=items.filter(x=>x.id!==it.id); save(items); render(); buildIndexes();});
      actions.append(snooze,done,del); sum.append(actions);

      // reminder recensione dopo +3 giorni dalla consegna
      if(it.postReviewAt && !it.postReviewSent && new Date(it.postReviewAt) <= new Date()){
        const rev=document.createElement('div'); rev.className='r-line';
        const btn=document.createElement('a'); btn.className='wa-btn ok'; btn.textContent='WhatsApp: ringrazia + recensione';
        btn.href=waForThankReview(it.name,it.phone); btn.target='_blank'; btn.rel='noopener';
        btn.addEventListener('click',(ev)=>{ev.stopPropagation(); it.postReviewSent=true; it.updatedAt=new Date().toISOString(); save(items); render();});
        rev.append(btn); sum.append(rev);
      }

      return t;
    }

    document.body.addEventListener('click',e=>{
      const a=e.target.closest('a[data-wa="1"]'); if(!a)return;
      const id=a.dataset.id; const it=items.find(x=>x.id===id); if(!it)return;
      const until=new Date(Date.now()+45*60*1000); it.activeChatUntil=until.toISOString(); it.muteDate=fmtDate(new Date()); save(items); render();
    });

    function isMutedToday(it){ return it.muteDate && it.muteDate===fmtDate(new Date()); }
    function isActiveChat(it){ return it.activeChatUntil && new Date(it.activeChatUntil) > new Date(); }

    function highlightByPhone(phone){ /* gi√† definita sopra */ }

    // Quando segni "consegnato", programma review a +3 giorni
    // (gi√† gestito nel cambio stato e in lock selettore)

    function boot(){ setListOpen(false); }
    boot();
  </script>
</body>
</html>
