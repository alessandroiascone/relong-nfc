<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ReLong • Scadenziario + Accettazione + Pacchi</title>
  <meta name="theme-color" content="#0a0a0a" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0;-webkit-font-smoothing:antialiased}
    :root{
      --bg1:#0b0d12; --bg2:#06070b;
      --card:rgba(14,16,22,.92); --stroke:rgba(255,255,255,.08);
      --muted:rgba(210,220,255,.70);
      --elec:#0aa2ff; --elec2:#66d1ff; --elec3:#008cff;
      --ok:#25D366; --danger:#ff4d4f;
      --shadow:0 10px 40px rgba(0,140,255,.18), inset 0 1px 0 rgba(255,255,255,.04);
      --st-diagnostica:#ffd666; --st-ricambi:#ffa940; --st-lavorazione:#69c0ff; --st-pronto:#95de64; --st-consegnato:#bfbfbf;
      --pacchi:#00d1b2;
    }
    body{min-height:100svh;font-family:system-ui,-apple-system,Inter,Roboto,sans-serif;color:#eef3ff;
      background:radial-gradient(65% 65% at 25% 15%, var(--bg1), var(--bg2));
      padding:24px;display:flex;flex-direction:column;gap:24px}
    .shell{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1.2fr .8fr;gap:20px}
    @media (max-width:980px){.shell{grid-template-columns:1fr;}}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:22px;box-shadow:var(--shadow)}
    .card h2{font-size:18px;font-weight:800;padding:18px 18px 0;letter-spacing:.3px}
    .card .content{padding:18px}
    .title{display:flex;align-items:flex-start;gap:14px}
    .title h1{font-size:26px;letter-spacing:.2px}
    .subtitle{color:var(--muted);font-size:14px}
    .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .full{grid-column:1/-1}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{margin-top:6px;background:#0a0d14;border:1px solid var(--stroke);color:#eef3ff;border-radius:14px;padding:12px 14px;font-size:15px}
    textarea{min-height:84px;resize:vertical}

    .toggle-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-top:8px}
    @media (max-width:980px){.toggle-grid{grid-template-columns:repeat(2,1fr)}}
    .tbtn{display:flex;align-items:center;justify-content:center;min-height:46px;padding:10px 12px;border-radius:14px;border:1px solid rgba(0,140,255,.22);background:linear-gradient(180deg,rgba(0,140,255,.10),rgba(0,140,255,.03));color:#dbeaff;font-weight:700;letter-spacing:.2px;cursor:pointer;transition:.2s ease}
    .tbtn:hover{transform:translateY(-1px);box-shadow:inset 0 0 0 1px rgba(0,140,255,.25)}
    .tbtn.active{background:linear-gradient(135deg,var(--elec3),var(--elec2));color:#04121f;border-color:transparent;box-shadow:0 10px 30px rgba(0,140,255,.35)}

    .actions{display:flex;gap:10px;flex-wrap:wrap}
    #insertBtn{width:100%;display:block}
    .btn{appearance:none;border:0;border-radius:16px;padding:12px 16px;font-weight:800;letter-spacing:.25px;cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--elec3),var(--elec2));color:#04121f;box-shadow:0 8px 26px rgba(0,140,255,.35)}
    .btn.ghost{background:transparent;border:1px solid var(--stroke);color:#eef3ff}
    .btn.ok{background:linear-gradient(135deg,#1fae60,var(--ok));color:#071b10}

    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap}
    .filters{display:flex;gap:8px;flex-wrap:wrap}
    .pill{border:1px solid rgba(0,140,255,.22);color:#dbeaff;padding:8px 12px;border-radius:999px;font-size:13px;cursor:pointer;background:linear-gradient(180deg,rgba(0,140,255,.08),rgba(0,140,255,.02))}
    .pill.active{background:linear-gradient(135deg,var(--elec3),var(--elec2));color:#04121f;border-color:transparent;box-shadow:0 8px 24px rgba(0,140,255,.25)}
    .search{display:flex;gap:8px;align-items:center}
    .search input{min-width:220px}

    .item{display:grid;grid-template-columns:1fr;gap:10px;border:1px solid var(--stroke);border-radius:16px;padding:12px;margin-bottom:10px;background:#0a0d14}
    .meta{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .h{font-weight:800}
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .tag{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#04121f;background:linear-gradient(135deg,var(--elec3),var(--elec2));padding:4px 8px;border-radius:999px}
    .muted{background:linear-gradient(135deg,#7aa3c7,#a7c6df)!important;color:#0b1b29}
    .activeChat{background:linear-gradient(135deg,#1fae60,var(--ok))!important;color:#071b10}
    .pacchi{background:linear-gradient(135deg,var(--pacchi),#7ffbe6)!important;color:#05312a}
    .dup{background:linear-gradient(135deg,#ff9f43,#ffd56b)!important;color:#3b2700}
    /* Badge preventivo + stati */
    .quote{background:linear-gradient(135deg,#b388ff,#7aa3ff)!important;color:#0a0a0a}
    .quote-ok{background:linear-gradient(135deg,#5be37a,#26d07c)!important;color:#082012}
    .quote-ko{background:linear-gradient(135deg,#ff7a7a,#ff4d4f)!important;color:#250909}

    .st-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700;color:#0a0a0a}
    .st-diagnostica{background:var(--st-diagnostica)}
    .st-attesa-ricambi{background:var(--st-ricambi)}
    .st-lavorazione{background:var(--st-lavorazione)}
    .st-pronto{background:var(--st-pronto)}
    .st-consegnato{background:var(--st-consegnato)}

    .summary{display:grid;gap:8px}
    .accept-brief{background:#091019;border:1px solid rgba(0,140,255,.2);border-radius:10px;padding:8px;display:grid;gap:8px}
    .row-slim{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
    .accept-brief small{color:var(--muted)}
    .r-line{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .r-badge{border:1px solid rgba(0,140,255,.25);background:linear-gradient(180deg,rgba(0,140,255,.10),rgba(0,140,255,.02));color:#dbeaff;font-size:12px;border-radius:999px;padding:6px 10px;display:inline-flex;gap:6px;align-items:center}
    .wa-btn{font-size:12px;padding:6px 8px;border-radius:9px;border:1px solid rgba(0,140,255,.22);background:linear-gradient(180deg,rgba(0,140,255,.08),rgba(0,140,255,.02));color:#dbeaff;text-decoration:none;display:inline-flex;gap:6px;align-items:center}
    .wa-btn.ok{background:linear-gradient(135deg,#1fae60,var(--ok));color:#071b10;border-color:transparent}
    .wa-btn.danger{background:linear-gradient(135deg,#ff6b6b,var(--danger));color:#230a0a;border-color:transparent}
    .wa-btn[disabled]{opacity:.55;pointer-events:none;filter:saturate(.35)}

    #acceptWrap{display:none}
    #acceptWrap.show{display:block}
    #listSection[hidden]{display:none}
    .openListCard{max-width:1200px;margin:0 auto}

    .subsection{margin:6px 0 12px}
    .subsection h3{font-size:15px;opacity:.9;margin-bottom:8px}

    #pinGate{position:fixed;inset:0;background:linear-gradient(180deg,rgba(0,10,20,.9),rgba(0,0,0,.95));backdrop-filter:blur(6px);display:grid;place-items:center;z-index:9999}
    #pinCard{background:var(--card);border:1px solid var(--stroke);border-radius:20px;box-shadow:var(--shadow);padding:20px 18px;max-width:360px;width:92%;display:grid;gap:12px}
    #pinCard h3{margin:0;font-size:18px}
    #pinCard p{color:var(--muted);font-size:13px}
    #pinInput{letter-spacing:6px;text-align:center;font-weight:800}
    #pinError{color:#ff7676;min-height:18px;font-size:12px}
    #errBar{position:fixed;left:0;right:0;bottom:0;background:#c0392b;color:#fff;padding:8px 12px;font-size:12px;display:none;z-index:99999}

    #dupGate{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);display:none;place-items:center;z-index:9998}
    #dupCard{background:var(--card);border:1px solid var(--stroke);border-radius:18px;box-shadow:var(--shadow);padding:18px;max-width:520px;width:92%;display:grid;gap:12px}
    #dupCard h3{margin:0;font-size:18px}
    #dupCard p{color:var(--muted);font-size:13px}
    #dupList{background:#0a0d14;border:1px solid var(--stroke);border-radius:12px;padding:10px;max-height:200px;overflow:auto}
    #dupActions{display:flex;gap:8px;flex-wrap:wrap}
    .flash{animation:flash 1.4s ease}
    @keyframes flash{0%{box-shadow:0 0 0 0 rgba(0,140,255,.0)}30%{box-shadow:0 0 0 4px rgba(0,140,255,.35)}100%{box-shadow:0 0 0 0 rgba(0,140,255,.0)}}
  </style>
</head>
<body>
  <!-- PIN -->
  <div id="pinGate" hidden>
    <div id="pinCard">
      <h3>Accesso protetto</h3>
      <p>Inserisci il PIN.</p>
      <input id="pinInput" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="••••" />
      <div class="actions"><button id="pinOk" class="btn primary" style="flex:1">Sblocca</button></div>
      <div id="pinError"></div>
      <p style="font-size:11px">Nota: blocco base lato client (per blocco serio serve lato server).</p>
    </div>
  </div>
  <div id="errBar"></div>

  <!-- Modal Doppioni -->
  <div id="dupGate" role="dialog" aria-modal="true" aria-labelledby="dupTitle">
    <div id="dupCard">
      <h3 id="dupTitle">Numero già presente</h3>
      <p id="dupMsg">Abbiamo trovato contatti con lo stesso numero. Scegli cosa fare:</p>
      <div id="dupList"></div>
      <div id="dupActions">
        <button id="dupOpen" class="btn ghost">Apri scheda esistente</button>
        <button id="dupMerge" class="btn ok">Unisci</button>
        <button id="dupInsertAnyway" class="btn primary">Inserisci comunque</button>
        <button id="dupCancel" class="btn ghost">Annulla</button>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="title" aria-hidden="true">
    <div>
      <h1>ReLong • Scadenziario + Accettazione</h1>
      <div class="subtitle">Gestionale → reminder smart con WhatsApp.</div>
    </div>
  </header>

  <!-- Dati cliente -->
  <section class="card" style="max-width:1200px;margin:0 auto" aria-hidden="true">
    <h2>Dati cliente (unici)</h2>
    <div class="content grid2">
      <div><label>Nome e Cognome</label><input required id="c_name" placeholder="Mario Rossi" /></div>
      <div><label>Telefono (solo cifre)</label><input required id="c_phone" placeholder="3331234567" inputmode="numeric" pattern="[0-9]+" /></div>
    </div>
  </section>

  <div class="shell" aria-hidden="true">
    <!-- Attivazioni -->
    <section class="card">
      <h2>Attivazioni</h2>
      <div class="content">
        <div class="grid2">
          <div>
            <label>Data</label>
            <input id="start" type="date" />
          </div>
          <div class="full">
            <label>Cosa vuoi inserire</label>
            <div class="toggle-grid" id="toggles">
              <button type="button" class="tbtn" data-key="sim">SIM Mobile</button>
              <button type="button" class="tbtn" data-key="fisso">Linea Fissa</button>
              <button type="button" class="tbtn" data-key="energia">Energia</button>
              <button type="button" class="tbtn" data-key="smartphone">Smartphone a rate</button>
              <button type="button" class="tbtn" data-key="preventivi">Preventivi acquisti</button>
              <button type="button" class="tbtn" data-key="riparazione">Riparazione</button>
            </div>
          </div>
        </div>
        <div class="actions" style="margin-top:12px"><button class="btn primary" id="insertBtn">Inserisci cliente</button></div>
      </div>
    </section>

    <!-- Accettazione (solo con riparazione) -->
    <aside class="card" id="acceptWrap">
      <h2>Accettazione dispositivo (Assistenza)</h2>
      <div class="content">
        <form id="acceptForm" class="grid2" onsubmit="return false;">
          <div>
            <label>Tipo dispositivo</label>
            <select id="a_type">
              <option>Smartphone</option>
              <option>Computer</option>
              <option>Stampante</option>
              <option>Console & Accessori</option>
            </select>
          </div>
          <div>
            <label>Marca</label>
            <select id="a_brand">
              <option>Apple</option><option>Samsung</option><option>Oppo</option>
              <option>Redmi</option><option>Xiaomi</option><option>Honor</option><option>Other</option>
            </select>
          </div>
          <div><label>Modello</label><input id="a_model" placeholder="iPhone 17ProMax, Galaxy S25…" /></div>
          <div class="full"><label>Difetto / Problema</label><textarea id="a_issue" placeholder="Descrivi il problema segnalato…"></textarea></div>
          <p class="subtitle full" style="margin-top:4px">Con Riparazione attiva il tasto principale diventa “Accetta & Inserisci”.</p>
        </form>
      </div>
    </aside>
  </div>

  <!-- Apri elenco -->
  <section class="card openListCard" aria-hidden="true">
    <div class="content" style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div>
        <h2 style="padding:0">Clienti</h2>
        <div class="subtitle">Elenco completo visibile solo su richiesta.</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="syncPacchiBtn" class="btn ghost" title="Importa subito eventuali nuovi contatti da Ritiro/Consegna Pacchi">Forza Sync Pacchi</button>
        <button id="toggleListBtn" class="btn ghost">Apri elenco</button>
      </div>
    </div>
  </section>

  <!-- Elenco (nascosto finché non aperto) -->
  <section class="card" id="listSection" style="max-width:1200px;margin:0 auto" hidden aria-hidden="true">
    <div class="content">
      <div class="toolbar">
        <div class="filters">
          <button class="pill active" data-filter="all">Tutti</button>
          <button class="pill" data-filter="today">Oggi</button>
          <button class="pill" data-filter="late">In ritardo</button>
          <button class="pill" data-filter="done">Completati</button>
          <button class="pill" data-filter="only-acc">Solo accettazioni</button>
          <button class="pill" data-filter="pacchi">Da Pacchi</button>
          <button class="pill" data-filter="preventivi">Solo preventivi acquisti</button>
        </div>
        <div class="search">
          <label>Cerca</label>
          <input id="q" placeholder="Nome, telefono, ID pratica, modello…" />
        </div>
      </div>

      <div class="subsection" id="subStandard">
        <h3>Clienti</h3>
        <div id="listStandard"></div>
      </div>

      <div class="subsection" id="subPacchi">
        <h3>Da Pacchi</h3>
        <div id="listPacchi"></div>
      </div>
    </div>
  </section>

  <template id="tpl-item">
    <div class="item">
      <div class="meta">
        <div class="h"></div>
        <div class="tags"></div>
      </div>
      <div class="summary"></div>
    </div>
  </template>

  <script>
    /* Error bar */
    (function(){ const bar=document.getElementById('errBar'); window.addEventListener('error',e=>{bar.textContent='Errore JavaScript: '+(e.message||'sconosciuto'); bar.style.display='block';}); })();

    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => [...r.querySelectorAll(s)];

    const storeKey = 'relong-scadenzario-v29';
    const backupPrefix = 'relong-backup-';
    const PACCHI_KEYS = ['relong-pacchi-v1','relong-pacchi-v2'];
    const PACCHI_INGESTED_KEY = 'relong-pacchi-ingested';

    const load = () => { try { const raw = localStorage.getItem(storeKey); return raw ? JSON.parse(raw) : []; } catch(e){ console.warn('Storage danneggiato:', e); localStorage.removeItem(storeKey); return []; } };
    const save = (arr) => localStorage.setItem(storeKey, JSON.stringify(arr));

    const fmtDate = (d) => d.toLocaleDateString('it-IT',{year:'numeric',month:'2-digit',day:'2-digit'});
    const fmtDateShort = (d) => d.toLocaleDateString('it-IT',{month:'2-digit',day:'2-digit'});
    const fmtDateTimeShort = (d) => { try { return d.toLocaleString('it-IT', { day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit' }); } catch { return fmtDate(d); } };
    const isoDay = (d)=> d.toISOString().slice(0,10);
    const today = () => { const d=new Date(); d.setHours(0,0,0,0); return d }
    const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x }
    const avoidWeekend = (d)=>{ const x=new Date(d); const day=x.getDay(); if(day===0) x.setDate(x.getDate()+1); if(day===6) x.setDate(x.getDate()+2); return x }
    const normalizePhone = (p)=>{ let ph=String(p||'').trim().replace(/\D/g,''); if(ph.startsWith('0')) ph=ph.slice(1); return ph; };

    const DEFAULT_DAYS = { energia:10, fisso:17, sim:9, smartphone:12, preventivi:5 };
    const ACCEPT_DAYS   = { energia:15, fisso:20, sim:12, smartphone:15 };

    let items = load();

    function nextPraticaId(){
      const key='relong-pratica-seq';
      const y=new Date().getFullYear();
      let seq; try{ seq=JSON.parse(localStorage.getItem(key)||'[]'); }catch{ seq=[]; }
      let rec = seq.find(r=>r.year===y);
      if(!rec){ rec={year:y,n:0}; seq.push(rec); }
      rec.n += 1; localStorage.setItem(key, JSON.stringify(seq));
      return `RL-${y}-${String(rec.n).padStart(4,'0')}`;
    }

    /* ====== Normalizza Nome Cognome + Indici ====== */
    function normalizeName(s){ return String(s||'').toLowerCase().replace(/\s+/g,' ').trim(); }
    let idxByPhone = new Map();
    let idxByName  = new Map();
    function buildIndexes(){
      idxByPhone.clear(); idxByName.clear();
      for(const it of items){
        const ph = normalizePhone(it.phone);
        const nm = normalizeName(it.name);
        const ts = new Date(it.createdAt||it.start||0).getTime();
        const a = idxByPhone.get(ph);
        if(ph && (!a || ts > new Date(a.createdAt||a.start||0).getTime())) idxByPhone.set(ph, it);
        const b = idxByName.get(nm);
        if(nm && (!b || ts > new Date(b.createdAt||b.start||0).getTime())) idxByName.set(nm, it);
      }
    }
    buildIndexes();

    // Inputs
    const c_name = $('#c_name');
    const c_phone = $('#c_phone');

    const acceptWrap = $('#acceptWrap');
    const aForm = $('#acceptForm');
    const a_type = $('#a_type');
    const a_brand = $('#a_brand');
    const a_model = $('#a_model');
    const a_issue = $('#a_issue');

    const toggles = $('#toggles');
    const activeSet = new Set();

    function updateAcceptanceUI(){
      const isRepair = activeSet.has('riparazione');
      acceptWrap.classList.toggle('show', isRepair);
      $('#insertBtn').textContent = isRepair ? 'Accetta & Inserisci' : 'Inserisci cliente';
      if(!isRepair){ aForm.reset(); }
    }

    toggles.addEventListener('click', (e)=>{
      const b = e.target.closest('.tbtn'); if(!b) return;
      const key=b.dataset.key;
      b.classList.toggle('active');
      if(b.classList.contains('active')) activeSet.add(key); else activeSet.delete(key);
      updateAcceptanceUI();
    });

    // Inserisci
    const insertBtn = $('#insertBtn');
    const startI = $('#start');

    // Data = oggi
    try{
      const d=new Date(); const pad=n=>String(n).padStart(2,'0');
      if(startI && 'valueAsDate' in startI) startI.valueAsDate = d;
      else if(startI){ startI.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
    }catch{}

    /* ====== AUTO-COMPILAZIONE ====== */
    function autofillFromPhone(){
      const ph = normalizePhone(c_phone.value||'');
      if(!ph) return;
      const hit = idxByPhone.get(ph);
      if(hit && (!c_name.value || c_name.value.trim().length===0)){
        c_name.value = hit.name || '';
      }
    }
    function autofillFromName(){
      const nm  = normalizeName(c_name.value||'');
      if(!nm) return;
      const parts = nm.split(' ');
      if(parts.length < 2) return;
      const hit = idxByName.get(nm);
      if(hit && (!c_phone.value || normalizePhone(c_phone.value).length===0)){
        c_phone.value = hit.phone || '';
      }
    }
    c_phone.addEventListener('blur', autofillFromPhone);
    c_phone.addEventListener('input', ()=>{ const v=normalizePhone(c_phone.value); if(v.length>=7) autofillFromPhone(); });
    c_name.addEventListener('blur', autofillFromName);
    c_name.addEventListener('input', ()=>{ const nm=normalizeName(c_name.value||''); if(nm.split(' ').length>=2) autofillFromName(); });

    /* ====== Doppioni: modal ====== */
    const dupGate = $('#dupGate');
    const dupList = $('#dupList');
    const dupOpen = $('#dupOpen');
    const dupMerge = $('#dupMerge');
    const dupInsertAnyway = $('#dupInsertAnyway');
    const dupCancel = $('#dupCancel');
    let dupContext = null;

    function openDupModal(existingItems, pendingNew){
      dupContext = {
        existingItems,
        primary: existingItems.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt))[0],
        pendingNew
      };
      dupList.innerHTML = existingItems.map(it=>(
        `<div style="padding:8px;border-bottom:1px solid var(--stroke)">
          <b>${it.name||'-'}</b> • ${it.phone}${it.praticaId? ' • '+it.praticaId:''}
          <div style="font-size:12px;color:var(--muted)">Creato: ${fmtDate(new Date(it.createdAt||it.start))}${it.acceptance?' • Accettazione':''}${it.source==='pacchi'?' • Da pacchi':''}</div>
        </div>`
      )).join('') || '<div>Nessun dettaglio</div>';
      dupGate.style.display='grid';
    }
    function closeDupModal(){ dupGate.style.display='none'; dupContext=null; }

    function mergeItems(existing, pending){
      const actSet = new Set([...(existing.activated||[]), ...((pending.activated)||[])]); existing.activated = [...actSet];

      const byType = {};
      (existing.tasks||[]).forEach(t=>{ byType[t.type] = t; });
      (pending.tasks||[]).forEach(t=>{
        const cur = byType[t.type];
        if(!cur){ byType[t.type]=t; }
        else {
          const d1=new Date(cur.due), d2=new Date(t.due);
          if(d2 < d1) byType[t.type]=t;
        }
      });
      existing.tasks = Object.values(byType];

      if(pending.acceptance){
        existing.acceptance = true;
        existing.device = pending.device;
        existing.repairStatus = pending.repairStatus || existing.repairStatus || 'diagnostica';
        if(!existing.praticaId) existing.praticaId = pending.praticaId || nextPraticaId();
      }

      existing.name = pending.name || existing.name;
      existing.phone = existing.phone || pending.phone;
      existing.updatedAt = new Date().toISOString();

      return existing;
    }

    function setListOpen(open){
      const listSection = $('#listSection');
      const toggleListBtn = $('#toggleListBtn');
      listSection.hidden = !open;
      listSection.setAttribute('aria-hidden', open?'false':'true');
      toggleListBtn.textContent = open ? 'Chiudi elenco' : 'Apri elenco';
      if(open) render();
    }

    dupOpen.addEventListener('click', ()=>{ if(!dupContext) return; closeDupModal(); setListOpen(true); });
    dupMerge.addEventListener('click', ()=>{
      if(!dupContext) return;
      const { primary, pendingNew } = dupContext;
      const idx = items.findIndex(x=>x.id===primary.id);
      if(idx>-1){
        items[idx] = mergeItems(items[idx], pendingNew);
        save(items); buildIndexes(); render();
        closeDupModal();
        setListOpen(true);
        if(pendingNew.acceptance){
          const site='https://alessandroiascone.github.io/relong-nfc/relong-hub-v2.html';
          const msg=`Ciao, ${pendingNew.name}, abbiamo accettato il tuo prodotto in assistenza.
Marchio: ${pendingNew.device.brand}
Modello: ${pendingNew.device.model || '-'}
Difetto dichiarato: ${pendingNew.device.issue || '-'}

Ti aggiorneremo noi per il ritiro. Grazie!
Nel frattempo puoi visionare qui i nostri servizi:
${site}`;
          try{ window.open(`https://wa.me/39${normalizePhone(pendingNew.phone)}?text=${encodeURIComponent(msg)}`,'_blank'); }catch{}
        }
      }
    });
    dupInsertAnyway.addEventListener('cli
