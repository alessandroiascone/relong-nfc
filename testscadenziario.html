<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ReLong ‚Ä¢ Scadenzario v32b (Pacchi + Reminder + Dashboard)</title>
  <meta name="theme-color" content="#0a0a0a" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0;-webkit-font-smoothing:antialiased}
    :root{
      --bg1:#0b0d12; --bg2:#06070b;
      --card:rgba(14,16,22,.92); --stroke:rgba(255,255,255,.08);
      --muted:rgba(210,220,255,.70);
      --elec:#0aa2ff; --elec2:#66d1ff; --elec3:#008cff;
      --ok:#25D366; --danger:#ff4d4f;
    }
    body{min-height:100svh;font-family:system-ui,-apple-system,Inter,Roboto,sans-serif;color:#eef3ff;
      background:radial-gradient(65% 65% at 25% 15%, var(--bg1), var(--bg2));
      padding:24px;display:flex;flex-direction:column;gap:16px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:22px;box-shadow:0 10px 40px rgba(0,140,255,.18)}
    .card h2{
      font-size:18px;font-weight:800;
      padding:18px 90px 0 18px;
      letter-spacing:.3px;
      position:relative;
    }
    .card .content{padding:18px}
    header.title{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    header .subtitle{color:var(--muted);font-size:14px}
    .status{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{border:1px solid rgba(0,140,255,.22);color:#dbeaff;padding:8px 12px;border-radius:999px;font-size:12px;background:linear-gradient(180deg,rgba(0,140,255,.08),rgba(0,140,255,.02))}
    .pill.good{background:linear-gradient(135deg,#1fae60,var(--ok));color:#071b10;border-color:transparent}
    .pill.bad{background:linear-gradient(135deg,#ff6b6b,var(--danger));color:#2b0a0a;border-color:transparent}
    .btn{
      appearance:none;border:1px solid var(--stroke);border-radius:14px;
      padding:10px 14px;font-weight:800;letter-spacing:.25px;cursor:pointer;
      background:transparent;color:#eef3ff;
      transition:.18s ease;
    }
    .btn[disabled]{
      opacity:.4;
      cursor:not-allowed;
      pointer-events:none;
      background:#141821;
      border:1px solid rgba(255,255,255,.08);
      box-shadow:none;
      color:var(--muted);
    }
    .btn.primary{
      background:linear-gradient(135deg,var(--elec3),var(--elec2));
      color:#04121f;border:0;box-shadow:0 8px 26px rgba(0,140,255,.35);
    }
    .btn.ok{background:linear-gradient(135deg,#1fae60,var(--ok));color:#071b10;border:0}
    .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width:980px){ .grid2{grid-template-columns:1fr} }
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{margin-top:6px;background:#0a0d14;border:1px solid var(--stroke);color:#eef3ff;border-radius:14px;padding:12px 14px;font-size:15px}
    textarea{min-height:84px;resize:vertical}
    .toggle-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-top:8px}
    @media (max-width:980px){.toggle-grid{grid-template-columns:repeat(2,1fr)}}
    .fidelity-pill{
      grid-column:1 / -1;
      margin-top:4px;
      padding:10px 14px;
      border-radius:14px;
      border:1px solid rgba(255,215,0,.8);
      background:linear-gradient(135deg, #ffd600, #ffae00);
      color:#3a2600;
      font-size:12px;
      font-weight:800;
      letter-spacing:.2px;
      text-align:center;
      box-shadow:0 10px 24px rgba(0,0,0,.45);
    }

    /* ANIMAZIONI NEON PER INSERISCI + FIDELITY */
    #insertBtn{
      width:100%;
      padding:16px 18px;
      font-size:16px;
      border-radius:18px;
      margin-top:4px;
    }
    .btn.primary.btn-ready{
      animation:btnPulse 1.4s ease-in-out infinite;
    }
    @keyframes btnPulse{
      0%,100%{
        box-shadow:0 0 0 rgba(0,140,255,0);
        transform:translateY(0);
      }
      50%{
        box-shadow:0 0 32px rgba(0,140,255,.75);
        transform:translateY(-1px);
      }
    }
    .fidelity-pill.glow{
      animation:neonPulse 1.6s ease-in-out infinite;
    }
    @keyframes neonPulse{
      0%,100%{
        box-shadow:0 0 0 rgba(255,215,0,0);
        filter:brightness(1);
      }
      50%{
        box-shadow:0 0 26px rgba(255,215,0,1);
        filter:brightness(1.08);
      }
    }

    .tbtn{display:flex;align-items:center;justify-content:center;min-height:46px;padding:10px 12px;border-radius:14px;border:1px solid rgba(0,140,255,.22);background:linear-gradient(180deg,rgba(0,140,255,.10),rgba(0,140,255,.03));color:#dbeaff;font-weight:700;letter-spacing:.2px;cursor:pointer;transition:.2s ease}
    .tbtn.active{background:linear-gradient(135deg,var(--elec3),var(--elec2));color:#04121f;border-color:transparent;box-shadow:0 10px 30px rgba(0,140,255,.35)}
    .item{border:1px solid var(--stroke);border-radius:16px;background:#0a0d14;margin-bottom:10px;overflow:hidden}
    .item .head{width:100%; display:flex; gap:10px; align-items:center;padding:12px 14px;background:transparent;color:#eaf2ff;border:0;cursor:pointer;font-weight:800;letter-spacing:.2px;text-align:left;justify-content:space-between}
    .details{padding:12px 14px; border-top:1px solid var(--stroke)}
    .r-line{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:6px}
    .wa-btn{font-size:12px;padding:6px 8px;border-radius:999px;border:1px solid rgba(0,140,255,.22);background:linear-gradient(180deg,rgba(0,140,255,.08),rgba(0,140,255,.02));color:#dbeaff;text-decoration:none;display:inline-flex;gap:6px;align-items:center}
    .wa-btn.ok{background:linear-gradient(135deg,#1fae60,var(--ok));color:#071b10;border-color:transparent}
    .wa-btn.sent{opacity:.6;filter:grayscale(1);pointer-events:none}
    #toast{position:fixed;right:20px;bottom:20px;display:grid;gap:8px;z-index:100000}
    .toast{background:linear-gradient(180deg,rgba(0,140,255,.12),rgba(0,140,255,.05));border:1px solid rgba(0,140,255,.25);color:#e6f1ff;padding:10px 14px;border-radius:12px;box-shadow:0 10px 28px rgba(0,0,0,.35);animation:toastIn .2s ease, toastOut .2s ease 3.3s forwards;font-size:13px;letter-spacing:.2px}
    .toast.ok{background:linear-gradient(180deg,rgba(37,211,102,.18),rgba(37,211,102,.06));border-color:rgba(37,211,102,.25)}
    .toast.err{background:linear-gradient(180deg,rgba(255,77,79,.18),rgba(255,77,79,.06));border-color:rgba(255,77,79,.25)}
    @keyframes toastIn{from{transform:translateY(10px);opacity:0}to{transform:translateY(0);opacity:1}}
    @keyframes toastOut{to{transform:translateY(6px);opacity:0}}
    .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
    .toolbar-filters{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .toggle{border:1px solid rgba(0,140,255,.22);background:linear-gradient(180deg,rgba(0,140,255,.10),rgba(0,140,255,.03));color:#dbeaff;border-radius:999px;padding:8px 12px;font-weight:700;cursor:pointer;font-size:13px}
    .toggle.active{background:linear-gradient(135deg,var(--elec3),var(--elec2));color:#04121f;border-color:transparent}
    .label{font-size:12px;color:var(--muted);padding:8px 10px;border:1px solid var(--stroke);border-radius:10px;background:#0a0d14}

    .badge-mini{
      margin-left:8px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,215,0,.7);
      background:linear-gradient(135deg,rgba(255,215,0,.22),rgba(255,215,0,.05));
      font-size:11px;
      color:#fff9d6;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .badge-top{
      margin-left:8px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,140,0,.8);
      background:linear-gradient(135deg,rgba(255,140,0,.35),rgba(255,69,0,.15));
      font-size:11px;
      color:#ffeede;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }

    /* Badge livello cliente */
    .lvl-badge{
      margin-left:8px;
      padding:2px 9px;
      border-radius:999px;
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:4px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.55);
    }
    .lvl-bronze{
      border-color:#cd7f32;
      background:linear-gradient(135deg,rgba(205,127,50,.28),rgba(0,0,0,.9));
      color:#ffe9d0;
    }
    .lvl-silver{
      border-color:#c0c0c0;
      background:linear-gradient(135deg,rgba(192,192,192,.28),rgba(0,0,0,.9));
      color:#f5f7ff;
    }
    .lvl-gold{
      border-color:#ffd700;
      background:linear-gradient(135deg,rgba(255,215,0,.32),rgba(0,0,0,.9));
      color:#fff9d6;
    }
    .lvl-black{
      border-color:#ffffff;
      background:linear-gradient(135deg,#000000,#272727);
      color:#ffffff;
    }

    .svc-row{display:flex;flex-wrap:wrap;gap:8px;margin:4px 0 6px}
    .svc-btn{
      border-radius:999px;
      border:1px solid rgba(0,140,255,.35);
      background:radial-gradient(circle at 0 0,rgba(0,140,255,.18),rgba(0,0,0,.96));
      padding:8px 14px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:13px;
      font-weight:700;
      color:#eaf2ff;
      cursor:pointer;
      box-shadow:0 0 0 1px rgba(0,0,0,.8) inset;
    }
    .svc-btn span.icon{font-size:15px}
    .svc-btn--energia{border-color:rgba(255,215,0,.8);}
    .svc-btn--sim{border-color:rgba(255,165,0,.8);}
    .svc-btn--fisso{border-color:rgba(135,206,250,.9);}
    .svc-btn--rate{border-color:rgba(173,216,230,.9);}
    .svc-btn--card{border-color:rgba(255,215,0,.9);}

    /* Radar servizi */
    .svc-radar{
      font-size:12px;
      color:var(--muted);
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
    }
    .svc-radar-label{
      font-weight:600;
      margin-right:4px;
    }
    .svc-radar-tag{
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.6);
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:11px;
    }
    .svc-radar-tag.off{
      opacity:.45;
      filter:grayscale(.7);
      border-style:dashed;
    }
    .svc-radar-tag.on{
      border-color:rgba(0,140,255,.8);
      background:radial-gradient(circle at 0 0,rgba(0,140,255,.32),rgba(0,0,0,.9));
      color:#eaf4ff;
    }

    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);backdrop-filter:blur(6px);z-index:100001}
    .modal.on{display:grid}
    .dash{width:min(1100px,96vw);background:var(--card);border:1px solid var(--stroke);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.45);overflow:hidden}
    .dash header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--stroke)}
    .dash header h3{font-size:16px;font-weight:800;letter-spacing:.3px}
    .dash header .x{border:1px solid var(--stroke);border-radius:12px;padding:8px 12px;cursor:pointer;background:#0a0d14;color:#eaf2ff}
    .dash .wrap{padding:16px}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
    .kpi{border:1px solid var(--stroke);border-radius:16px;padding:14px;background:#0a0d14}
    .kpi .k{font-size:12px;color:var(--muted);letter-spacing:.2px}
    .kpi .v{margin-top:6px;font-size:28px;font-weight:900;letter-spacing:.3px}
    .kpi .e{margin-top:4px;font-size:13px;color:var(--muted);letter-spacing:.2px}
    .kpi.pacchi{box-shadow:0 10px 28px rgba(255,221,87,.10)}
    .kpi.sim{box-shadow:0 10px 28px rgba(0,200,255,.10)}
    .kpi.fisso{box-shadow:0 10px 28px rgba(120,180,255,.10)}
    .kpi.energia{box-shadow:0 10px 28px rgba(0,255,180,.10)}
    .kpi.rate{box-shadow:0 10px 28px rgba(255,140,0,.10)}
    .kpi.rip{box-shadow:0 10px 28px rgba(255,120,180,.10)}
    .kpi.prev{box-shadow:0 10px 28px rgba(180,160,255,.10)}

    .dash-period-bar{margin-bottom:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .range-wrap{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .range-wrap label{font-size:11px;color:var(--muted)}
    .range-wrap input[type="date"]{
      background:#0a0d14;border:1px solid var(--stroke);color:#eef3ff;
      border-radius:999px;padding:6px 10px;font-size:11px;min-width:130px
    }

    #searchInput{
      background:#0a0d14;
      border:1px solid var(--stroke);
      color:#eef3ff;
      border-radius:999px;
      padding:8px 12px;
      font-size:13px;
      min-width:180px;
      flex:1;
    }

    /* Pulsante Nascondi elenco piccolo, discreto */
    #toggleElenco{
      position:absolute;
      right:18px;
      top:50%;
      transform:translateY(-50%);
      font-size:11px;
      padding:4px 9px;
      border-radius:999px;
      opacity:.8;
    }
    #toggleElenco:hover{opacity:1;}
  </style>
</head>
<body>
  <div id="toast"></div>
  <header class="title">
    <div>
      <h1>ReLong ‚Ä¢ Gestionale</h1>
      <div class="subtitle">Ogni cliente che entra √® un‚Äôoccasione: trasformala in valore, supera le aspettative, domina la giornata</div>
    </div>
    <div class="status">
      <span id="syncState" class="pill bad">Sync: Disconnesso</span>
      <button id="openDash" class="btn ok">Dashboard</button>
      <button id="cfgSync" class="btn">Imposta Sync GitHub</button>
    </div>
  </header>

  <section class="card">
    <h2>Dati Cliente</h2>
    <div class="content grid2">
      <div><label>Nome e Cognome</label><input id="c_name" placeholder="Mario Rossi"></div>
      <div><label>Telefono</label><input id="c_phone" placeholder="3331234567" inputmode="numeric"></div>

      <div style="grid-column:1/-1">
        <label>Seleziona operazione</label>
        <div class="toggle-grid" id="toggles">
          <button type="button" class="tbtn" data-key="riparazione">Riparazione</button>
          <button type="button" class="tbtn" data-key="pacchi">Pacchi</button>
          <button type="button" class="tbtn" data-key="sim">Sim</button>
          <button type="button" class="tbtn" data-key="fisso">Fisso</button>
          <button type="button" class="tbtn" data-key="energia">Energia</button>
          <button type="button" class="tbtn" data-key="rate">Smartphone a Rate</button>

          <div class="fidelity-pill" id="fidelityPill">
            üí≥ Fidelity Card INCLUSA ‚Ä¢ 20 punti di benvenuto per ogni nuovo cliente registrato
          </div>
        </div>
      </div>

      <div style="grid-column:1/-1;display:none" id="acceptWrap">
        <div class="grid2">
          <div>
            <label>Tipo</label>
            <select id="a_type">
              <option>Smartphone</option>
              <option>Computer</option>
              <option>Stampante</option>
              <option>Console</option>
            </select>
          </div>

          <div>
            <label>Marca</label>
            <input id="a_brand" placeholder="Apple/Samsung‚Ä¶" />
            <div id="brandSmartWrap" style="display:none">
              <select id="a_brand_sel">
                <option value="Apple">Apple</option>
                <option value="Samsung">Samsung</option>
                <option value="Oppo">Oppo</option>
                <option value="Xiaomi">Xiaomi</option>
                <option value="Honor">Honor</option>
                <option value="Altro">Altro</option>
              </select>
              <input id="a_brand_other" placeholder="Inserisci marca‚Ä¶" style="display:none;margin-top:6px" />
            </div>
          </div>

          <div style="grid-column:1/-1"><label>Modello</label><input id="a_model" placeholder="iPhone 17 Pro Max, S25 Ultra‚Ä¶"></div>
          <div style="grid-column:1/-1"><label>Difetto</label><textarea id="a_issue" placeholder="Descrivi il problema‚Ä¶"></textarea></div>
        </div>
      </div>

      <div style="grid-column:1/-1">
        <button id="insertBtn" class="btn primary" disabled>Inserisci</button>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Elenco</h2>
    <div class="content" id="elencoContent">

      <!-- Barra filtri + ricerca -->
      <div class="toolbar">
        <button id="toggleFilters" class="toggle">Filtri</button>
        <input id="searchInput" placeholder="Cerca nome o telefono" />
      </div>

      <!-- Barra Fidelity: Gift sopra e sotto i due bottoni -->
      <div class="toolbar" style="justify-content:flex-end">
        <div style="display:flex;flex-direction:column;gap:6px;max-width:380px;width:100%">
          <button
            id="giftFidelity"
            class="toggle"
            style="width:100%;justify-content:center;text-align:center"
          >
            üéÅ Gift Fidelity
          </button>

          <div style="display:flex;gap:8px;flex-wrap:wrap;width:100%">
            <button
              id="bonusAll"
              class="toggle"
              style="flex:1 1 0"
            >
              Bonus Fidelity (tutti)
            </button>

            <button
              id="generateMissing"
              class="toggle"
              style="flex:1 1 0"
            >
              Genera Fidelity mancanti
            </button>
          </div>
        </div>
      </div>

      <div id="filtersRow" class="toolbar-filters" style="display:none">
        <button class="toggle" data-filter="remindtoday">Remind oggi</button>
        <button class="toggle" data-filter="pacchi">Pacchi</button>
        <button class="toggle" data-filter="sim">SIM</button>
        <button class="toggle" data-filter="fisso">Fisso</button>
        <button class="toggle" data-filter="energia">Energia</button>
        <button class="toggle" data-filter="rate">Rate</button>
        <button class="toggle" data-filter="riparazioni">Riparazioni</button>
        <button class="toggle" data-filter="preventivi">Preventivi</button>
      </div>

      <div id="counter" class="label" style="margin-bottom:6px">Clienti: 0</div>
      <div id="filterSummary" class="label" style="margin-bottom:10px;display:none"></div>
      <div id="list"></div>
    </div>
  </section>

  <template id="tpl">
    <div class="item">
      <button class="head" type="button">
        <div class="title"></div>
        <div>‚ñ∂</div>
      </button>
      <div class="details" hidden>
        <div class="r-line services"></div>
        <div class="r-line actions"></div>
        <div class="r-line points"></div>
        <div class="r-line reminders"></div>
        <div class="r-line review"></div>
      </div>
    </div>
  </template>

  <div id="dashModal" class="modal" aria-hidden="true">
    <div class="dash" role="dialog" aria-modal="true" aria-labelledby="dashTitle">
      <header>
        <h3 id="dashTitle">Dashboard ‚Ä¢ Panoramica</h3>
        <button class="x" id="closeDash" type="button">Chiudi</button>
      </header>
      <div class="wrap">
        <div class="dash-period-bar">
          <span class="label">Periodo</span>
          <button type="button" class="toggle dash-period active" data-period="all">Tutto</button>
          <button type="button" class="toggle dash-period" data-period="today">Oggi</button>
          <button type="button" class="toggle dash-period" data-period="month">Mese</button>
          <button type="button" class="toggle dash-period" data-period="range">Intervallo</button>
          <div class="range-wrap" id="rangeWrap" style="display:none">
            <label for="rangeFrom">Dal</label>
            <input type="date" id="rangeFrom">
            <label for="rangeTo">Al</label>
            <input type="date" id="rangeTo">
          </div>
        </div>
        <div class="kpis">
          <div class="kpi pacchi">
            <div class="k">üì¶ Pacchi</div>
            <div class="v" id="k_pacchi">0</div>
            <div class="e" id="e_pacchi">‚Ç¨ 0</div>
          </div>
          <div class="kpi sim">
            <div class="k">üì∂ SIM</div>
            <div class="v" id="k_sim">0</div>
            <div class="e" id="e_sim">‚Ç¨ 0</div>
          </div>
          <div class="kpi fisso">
            <div class="k">üè†üì° Fisso</div>
            <div class="v" id="k_fisso">0</div>
            <div class="e" id="e_fisso">‚Ç¨ 0</div>
          </div>
          <div class="kpi energia">
            <div class="k">‚ö° Energia</div>
            <div class="v" id="k_energia">0</div>
            <div class="e" id="e_energia">‚Ç¨ 0</div>
          </div>
          <div class="kpi rate">
            <div class="k">üì± Rate</div>
            <div class="v" id="k_rate">0</div>
            <div class="e" id="e_rate">‚Ç¨ 0</div>
          </div>
          <div class="kpi rip">
            <div class="k">üîß Riparazioni</div>
            <div class="v" id="k_rip">0</div>
            <div class="e" id="e_rip">‚Ç¨ 0</div>
          </div>
          <div class="kpi prev">
            <div class="k">üßæ Preventivi</div>
            <div class="v" id="k_prev">0</div>
          </div>
        </div>
        <div style="margin-top:14px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <span class="label" id="k_total">Totale clienti: 0</span>
          <span class="label" id="k_total_gain">Guadagno totale: ‚Ç¨ 0</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $=s=>document.querySelector(s), $$=s=>[...document.querySelectorAll(s)];
    const STORE_KEY='relong-scadenzario-v32b';
    const GH_CFG_KEY='relong-gh-config-v31', GH_TOKEN_KEY='relong-gh-token-v31';
    const HUB_URL='https://alessandroiascone.github.io/relong-nfc/relong-hub-v2.html';
    const FIDELITY_URL='https://alessandroiascone.github.io/relong-nfc/fidelity.html';
    const MAPS_URL='https://maps.app.goo.gl/s4ytGUBeGDAEaFG59';
    const REVIEW_URL='http://g.page/r/CeN076xNHzDmEAE/review';
    const RELONG_PHONE='08119578844';

    const GAIN_PACCHI  = 0.5;
    const GAIN_SIM     = 30;
    const GAIN_FISSO   = 110;
    const GAIN_ENERGIA = 150;
    const GAIN_RATE    = 45;

    // Punti Fidelity automatici per servizi conclusi
    const POINTS_REPAIR_PC     = 50;  // Riparazione computer
    const POINTS_REPAIR_PHONE  = 25;  // Riparazione smartphone
    const POINTS_SIM           = 30;  // SIM mobile
    const POINTS_FISSO         = 80;  // Linea fissa
    const POINTS_ENERGIA       = 100; // Luce & Gas
    const POINTS_RATE          = 40;  // Smartphone a rate

    // Movimento punti Fidelity (evita doppi accrediti con "code")
    function addFidelityMovement(it, code, label, delta){
      delta = Number(delta || 0);
      if(!delta) return;
      if(!it) return;

      if(!Array.isArray(it.pointsMovements)) it.pointsMovements = [];
      // Se esiste gi√† un movimento con lo stesso code, non ricarico i punti
      if(it.pointsMovements.some(m => m.code === code)) return;

      let curr = Number(it.points || 0);
      if(isNaN(curr)) curr = 0;
      curr += delta;
      if(curr < 0) curr = 0;
      it.points = curr;

      it.pointsMovements.push({
        code,
        label,
        delta,
        at: new Date().toISOString()
      });
    }

    let lastBonusRecipients = [];

    function showToast(t, type='ok'){
      const w=$('#toast'); const el=document.createElement('div'); el.className='toast '+(type==='ok'?'ok':type==='err'?'err':''); el.textContent=t; w.appendChild(el); setTimeout(()=>el.remove(), 3600);
    }
    const normalizePhone = p => String(p||'').trim().replace(/\D/g,'');
    const normalizeName  = n => String(n||'').trim().replace(/\s+/g,' ').toLowerCase();
    const fmt = d => new Date(d).toLocaleDateString('it-IT',{year:'numeric',month:'2-digit',day:'2-digit'});
    const addDays=(d,n)=>{const x=new Date(d); x.setDate(x.getDate()+n); return x};
    const startOfDay = d => { const x=new Date(d); x.setHours(0,0,0,0); return x; };

    // Livelli Fidelity
    function getLevel(points){
      const p = Number(points||0);
      if(p>=1000) return {name:'BLACK', emoji:'üñ§', class:'lvl-black', min:1000, next:null};
      if(p>=500)  return {name:'GOLD',  emoji:'ü•á', class:'lvl-gold',  min:500,  next:1000};
      if(p>=150)  return {name:'SILVER',emoji:'ü•à', class:'lvl-silver',min:150,  next:500};
      return {name:'BRONZE',emoji:'ü•â', class:'lvl-bronze',min:0,    next:150};
    }

    const syncState=$('#syncState'), cfgBtn=$('#cfgSync');
    const GH={
      cfg(){ try{ return JSON.parse(localStorage.getItem(GH_CFG_KEY)||'null'); }catch{return null} },
      token(){ return localStorage.getItem(GH_TOKEN_KEY)||'' },
      headers(){ return { 'Accept':'application/vnd.github+json', 'Authorization':'Bearer '+this.token() } },
      async get(path){
        const c=this.cfg(); if(!c) throw new Error('Nessuna configurazione GitHub');
        const url=`https://api.github.com/repos/${c.owner}/${c.repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(c.branch||'main')}`;
        const res=await fetch(url,{
          headers:{
            'Accept':'application/vnd.github+json',
            'Authorization':'Bearer '+this.token()
          }
        });
        if(!res.ok) throw new Error('GET '+res.status);
        return res.json();
      },
      async put(path, text, msg){
        const c=this.cfg(); if(!c) throw new Error('Nessuna configurazione GitHub');
        const url=`https://api.github.com/repos/${c.owner}/${c.repo}/contents/${encodeURIComponent(path)}`;
        let sha=null;
        try{
          const meta=await this.get(path);
          sha=meta.sha;
        }catch(e){}
        const body={
          message: msg || 'Update v32b',
          content: btoa(unescape(encodeURIComponent(text))),
          branch: c.branch || 'main'
        };
        if(sha) body.sha=sha;
        const headers={
          'Accept':'application/vnd.github+json',
          'Authorization':'Bearer '+this.token(),
          'Content-Type':'application/json'
        };
        let res=await fetch(url,{method:'PUT',headers,body:JSON.stringify(body)});
        if(res.status===409){
          const meta=await this.get(path);
          body.sha=meta.sha;
          res=await fetch(url,{method:'PUT',headers,body:JSON.stringify(body)});
        }
        if(!res.ok) throw new Error('PUT '+res.status);
        return res.json();
      }
    };
    function syncBadge(ok){ syncState.textContent= ok?'Sync: Connesso':'Sync: Disconnesso'; syncState.classList.toggle('good',ok); syncState.classList.toggle('bad',!ok); }
    cfgBtn.addEventListener('click', async ()=>{
      const owner=prompt('Owner GitHub','alessandroiascone')||'';
      const repo=prompt('Repository','relong-nfc')||'';
      const branch=prompt('Branch','main')||'main';
      const path=prompt('Percorso file dati','data/items.json')||'data/items.json';
      const token=prompt('Token (classic, scope repo)','')||'';
      if(!owner||!repo||!token) return alert('Compila owner/repo/token');
      localStorage.setItem(GH_CFG_KEY, JSON.stringify({owner,repo,branch,path,tokenStored:true}));
      localStorage.setItem(GH_TOKEN_KEY, token);
      syncBadge(true); showToast('Sync configurato ‚úÖ');
      await saveToGitHub();
    });

    let items=[];
    function loadLocal(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY)||'[]') }catch{return []} }
    function saveLocal(){ localStorage.setItem(STORE_KEY, JSON.stringify(items||[])); }

    async function loadFromGitHubOrLocal(){
      const cfg=GH.cfg(); const tk=GH.token();
      if(cfg && tk){
        try{
          const meta=await GH.get(cfg.path||'data/items.json');
          const json=JSON.parse(decodeURIComponent(escape(atob(meta.content))));
          items=Array.isArray(json)? json:[]; saveLocal(); syncBadge(true); return;
        }catch(e){ syncBadge(false); showToast('Lettura GitHub KO, uso locale','err'); }
      }
      items=loadLocal();
    }
    async function saveToGitHub(){
      const cfg=GH.cfg(); const tk=GH.token(); const p=cfg?.path||'data/items.json';
      if(cfg && tk){
        try{ await GH.put(p, JSON.stringify(items||[]), 'Scadenzario v32b sync'); syncBadge(true); return true; }catch(e){ syncBadge(false); return false; }
      }
      return false;
    }

    function walink(phone, text){ return `https://wa.me/39${phone}?text=${encodeURIComponent(text)}`; }

    function waPacchiEnergia(name, phone){
      const t=`Ciao ${name}, sono Alessandro di Re Long (${RELONG_PHONE}).\nPosso proporti una simulazione Luce & Gas davvero conveniente? ‚ö°Ô∏è\nIn negozio o via WhatsApp, come preferisci.`;
      return walink(phone,t);
    }
    function waPacchiSIM(name, phone){
      const t=`Ciao ${name}, sono Alessandro di Re Long (${RELONG_PHONE}).\nSe vuoi, ti preparo una proposta SIM dedicata con Minuti e Giga Top. üì∂`;
      return walink(phone,t);
    }
    function waPacchiFisso(name, phone){
      const t=`Ciao ${name}, sono Alessandro di Re Long (${RELONG_PHONE}).\nFibra veloce per casa/ufficio: posso verificare la copertura e una promo a te dedicata. üè†üì°`;
      return walink(phone,t);
    }
    function waPacchiRate(name, phone){
      const t=`Ciao ${name}, sono Alessandro di Re Long (${RELONG_PHONE}).\nSmartphone a rate Senza Busta Paga: vuoi vedere le offerte attuali? üì±üî•`;
      return walink(phone,t);
    }
    function waPacchiMemo(name, phone){
      const t=`Ciao ${name}, sono Alessandro di Re Long (${RELONG_PHONE}).\nPassa quando vuoi in negozio o scrivimi qui su WhatsApp: ti seguo io personalmente üòâ`;
      return walink(phone,t);
    }

    function waPickup(name, phone){
      const t=`Ciao ${name}, sono Alessandro di Re Long (${RELONG_PHONE}).\nIl tuo prodotto √® PRONTO, puoi passare a ritirarlo.\nSiamo qui: ${MAPS_URL}`;
      return walink(phone,t);
    }
    function waDeliveredConfirm(name, phone){
      const t=`Ciao ${name}, sono Alessandro di Re Long (${RELONG_PHONE}).\nGrazie per aver ritirato il prodotto da Re Long üôå\nPer qualsiasi necessit√† futura, scrivimi qui su WhatsApp o passa in negozio.`;
      return walink(phone,t);
    }
    function waReview(name, phone){
      const t=`Ciao ${name}, Grazie per averci preferito! üôå\nSe ti va, lasciaci una recensione su Google: ${REVIEW_URL}`;
      return walink(phone,t);
    }

    function waRepairIntakeWithCard(it){
      const cardUrl = `${FIDELITY_URL}?id=${encodeURIComponent(it.id)}`;
      const t =
`Ciao ${it.name}, sono Alessandro di Re Long (${RELONG_PHONE}).
Il tuo prodotto √® stato preso in carico dal nostro laboratorio üîß

In qualit√† di cliente ti abbiamo attivato la Fidelity Card Re Long con un bonus di benvenuto di 20 punti üéÅ
Clicca sul link per scoprire tutti i vantaggi a te dedicati:
${cardUrl}`;
      return walink(it.phone, t);
    }

    function waPacchiReceivedWithCard(it){
      const cardUrl = `${FIDELITY_URL}?id=${encodeURIComponent(it.id)}`;
      const t =
`Ciao ${it.name}, sono Alessandro di Re Long (${RELONG_PHONE}).
Grazie per aver scelto Re Long per la gestione del tuo pacco üì¶

Per ringraziarti della fiducia ti omaggiamo della Fidelity Card Re Long con un bonus di benvenuto di 20 punti üéÅ
Clicca per scoprire tutti i dettagli:
${cardUrl}`;
      return walink(it.phone, t);
    }

    function waWelcomeWithCard(it){
      const cardUrl = `${FIDELITY_URL}?id=${encodeURIComponent(it.id)}`;
      const t =
`Ciao ${it.name}, sono Alessandro di Re Long (${RELONG_PHONE}).
Da oggi sei ufficialmente cliente Re Long üíº

Ti abbiamo omaggiato la Fidelity Card Re Long con un bonus di benvenuto di 20 punti üéÅ
Clicca sul link per scoprire tutti i vantaggi e restare aggiornato sulle promo:
${cardUrl}`;
      return walink(it.phone, t);
    }

    const REMINDER_OFFSETS=[6,13,21,30];
    const REM_TYPES=['sim','energia','fissomobile','rate'];
    const typeLabel={ sim:'SIM', energia:'Energia', fissomobile:'Fisso + Mobile', rate:'Smartphone a rate', followup:'Richiamo' };

    const complementByKey={
      sim:        ['energia','fissomobile','rate'],
      energia:    ['sim','fissomobile','rate'],
      fisso:      ['sim','energia','rate'],
      rate:       ['energia','sim','fissomobile'],
      pacchi:     ['sim','energia','fissomobile','rate'],
      riparazione:['sim','energia','fissomobile','rate'],
      preventivi: []
    };

    function shuffle(arr){
      const a=[...arr]; for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a;
    }

    function getReminderTypesForItem(it){
      if(it.acceptance || it.fromPacchi) return [...REM_TYPES];
      const act = Array.isArray(it.activated)? it.activated : [];
      let set = new Set();
      if(act.length===0){ REM_TYPES.forEach(t=>set.add(t)); }
      else{
        act.forEach(k=> (complementByKey[k]||[]).forEach(t=>set.add(t)) );
        if(set.size===0){ REM_TYPES.forEach(t=>set.add(t)); }
      }
      return [...set];
    }

    function buildReminders(startDate, types){
      const base = new Date(startDate);
      return types.map((type, idx)=>{
        const off = REMINDER_OFFSETS[idx] ?? REMINDER_OFFSETS[REMINDER_OFFSETS.length-1];
        const due = addDays(base, off);
        return { type, dueAt: due.toISOString(), sent:false, sentAt:null };
      });
    }

    function ensureReminders(it){
      if(it.reminders && Array.isArray(it.reminders) && it.reminders.length) return;
      const created = new Date(it.createdAt||Date.now());
      const types = shuffle(getReminderTypesForItem(it));
      it.reminders = buildReminders(created, types);
      it.remindersCycle = 1;
      it.responded = !!it.responded;
      it.updatedAt=new Date().toISOString();
    }

    function prorogaPromemoria(it){
      if(it.responded) return;
      const types = shuffle(getReminderTypesForItem(it));
      it.reminders = buildReminders(new Date(), types);
      it.remindersCycle = (it.remindersCycle||1) + 1;
      it.updatedAt = new Date().toISOString();
    }

    function isMainCycleComplete(it){
      if(!it.reminders || !it.reminders.length) return false;
      const onlyMain = it.reminders.filter(r=> r.type!=='followup');
      if(onlyMain.length===0) return false;
      return onlyMain.every(r=>r.sent);
    }

    function reminderLink(it, rem){
      switch(rem.type){
        case 'sim':         return waPacchiSIM(it.name,it.phone);
        case 'energia':     return waPacchiEnergia(it.name,it.phone);
        case 'fissomobile': return waPacchiFisso(it.name,it.phone);
        case 'rate':        return waPacchiRate(it.name,it.phone);
        case 'followup':    return waPacchiMemo(it.name,it.phone);
        default:            return waPacchiMemo(it.name,it.phone);
      }
    }

    function addFollowup90(it){
      if(!it.reminders) it.reminders=[];
      const due = addDays(new Date(), 90).toISOString();
      it.reminders.push({ type:'followup', dueAt: due, sent:false, sentAt:null });
      it.updatedAt=new Date().toISOString();
      saveLocal(); saveToGitHub(); render();
      showToast('Promemoria unico (+90g) aggiunto ‚úÖ');
    }

    function addFollowupCustom(it){
      const val = prompt('Tra quanti giorni vuoi il promemoria unico? (es. 60, 120)');
      if(val===null) return;
      const days = parseInt(String(val).trim(),10);
      if(!Number.isFinite(days) || days<=0 || days>365){
        alert('Inserisci un numero di giorni valido (1‚Äì365).');
        return;
      }
      if(!it.reminders) it.reminders=[];
      const due = addDays(new Date(), days).toISOString();
      it.reminders.push({ type:'followup', dueAt: due, sent:false, sentAt:null });
      it.updatedAt=new Date().toISOString();
      saveLocal(); saveToGitHub(); render();
      showToast(`Promemoria unico (+${days}g) aggiunto ‚úÖ`);
    }

    const activeSet=new Set(); const toggles=$('#toggles');
    toggles.addEventListener('click', e=>{
      const b=e.target.closest('.tbtn'); if(!b) return;
      const k=b.dataset.key; const on=!b.classList.contains('active');
      if(k==='riparazione') $('#acceptWrap').style.display = on? 'block':'none';
      b.classList.toggle('active',on);
      if(on) activeSet.add(k); else activeSet.delete(k);
      updateInsertState();
    });

    const typeSel = document.getElementById('a_type');
    const brandInput = document.getElementById('a_brand');
    const brandSmartWrap = document.getElementById('brandSmartWrap');
    const brandSelect = document.getElementById('a_brand_sel');
    const brandOther = document.getElementById('a_brand_other');

    function refreshBrandUI(){
      const isPhone = (typeSel.value === 'Smartphone');
      brandInput.style.display = isPhone ? 'none' : '';
      brandSmartWrap.style.display = isPhone ? '' : 'none';
      if(isPhone){
        const isOther = brandSelect.value === 'Altro';
        brandOther.style.display = isOther ? '' : 'none';
      } else {
        brandOther.style.display = 'none';
      }
    }
    refreshBrandUI();
    typeSel.addEventListener('change', refreshBrandUI);
    brandSelect.addEventListener('change', refreshBrandUI);

    const nameInput = document.getElementById('c_name');
    const phoneInput = document.getElementById('c_phone');
    const insertBtn = document.getElementById('insertBtn');
    const fidelityPill = document.getElementById('fidelityPill');

    function findByPhone(p){ const np=normalizePhone(p); return items.find(x=>normalizePhone(x.phone)===np); }
    function findByName(n){ const nn=normalizeName(n); return items.find(x=>normalizeName(x.name)===nn); }

    function canInsert(){
      const n = (nameInput.value||'').trim();
      const p = normalizePhone(phoneInput.value||'');
      if(!n || !/\s/.test(n)) return false;
      if(!p || p.length<7) return false;
      if(activeSet.size === 0) return false;
      return true;
    }

    function updateInsertState(){
      const ok = canInsert();
      insertBtn.disabled = !ok;
      insertBtn.classList.toggle('btn-ready', ok);
      if(fidelityPill) fidelityPill.classList.toggle('glow', ok);
    }

    nameInput.addEventListener('input', updateInsertState);
    phoneInput.addEventListener('input', updateInsertState);

    nameInput.addEventListener('blur', ()=>{
      const n = nameInput.value;
      if(!n) return;
      if((phoneInput.value||'').trim()) return;
      const hit = findByName(n);
      if(hit && hit.phone){ phoneInput.value = normalizePhone(hit.phone); updateInsertState(); }
    });

    phoneInput.addEventListener('blur', ()=>{
      const p = phoneInput.value;
      if(!p) return;
      if((nameInput.value||'').trim()) return;
      const hit = findByPhone(p);
      if(hit && hit.name){ nameInput.value = hit.name; updateInsertState(); }
    });

    function ensureBaseFields(it){
      if(typeof it.points!=='number') it.points = 0;
      if(!Array.isArray(it.pointsMovements)) it.pointsMovements = [];
      if(!Array.isArray(it.activated)) it.activated = [];
      if(!it.id) it.id = String(Date.now())+'-'+Math.random().toString(16).slice(2);
    }

    function insert(){
      const name=(nameInput.value||'').trim();
      const phone=normalizePhone(phoneInput.value||'');
      if(!name || !phone || activeSet.size===0) return;

      let found=findByPhone(phone) || findByName(name);
      if(found){
        if(!found.phone) found.phone = phone;
        if(!found.name)  found.name  = name;
      } else {
        found={
          id:String(Date.now())+'-'+Math.random().toString(16).slice(2),
          name, phone,
          createdAt:new Date().toISOString(),
          updatedAt:new Date().toISOString(),
          activated:[],
          acceptance:null,
          fromPacchi:false,
          reminders:null,
          remindersCycle:0,
          responded:false,
          points:0,
          pointsMovements:[]
        };

        // 20 punti benvenuto solo primo ingresso
        addFidelityMovement(found, 'welcome-20', 'Bonus benvenuto Fidelity', 20);
        try{
          window.open(waWelcomeWithCard(found),'_blank','noopener');
        }catch{}
        items.push(found);
      }

      ensureBaseFields(found);

      activeSet.forEach(k=>{
        if(!found.activated.includes(k)) found.activated.push(k);
      });

      if(activeSet.has('riparazione')){
        const devType = typeSel.value;
        const brand = (devType==='Smartphone')
          ? (brandSelect.value==='Altro' ? (brandOther.value||'Altro') : brandSelect.value)
          : (document.getElementById('a_brand').value || '');
        const model = document.getElementById('a_model').value || '';
        const issue = document.getElementById('a_issue').value || '';

        found.acceptance = {
          type:devType, brand, model, issue,
          createdAt:new Date().toISOString()
        };
        found.repairStatus = 'in_lavorazione';
        found.quoteStatus = 'pending';

        try{
          window.open(waRepairIntakeWithCard(found),'_blank','noopener');
        }catch{}
      }

      if(activeSet.has('pacchi')){
        found.fromPacchi = true;
        try{
          window.open(waPacchiReceivedWithCard(found),'_blank','noopener');
        }catch{}
      }

      ensureReminders(found);
      found.updatedAt=new Date().toISOString();

      saveLocal(); saveToGitHub(); render();
      nameInput.value=''; phoneInput.value='';
      document.getElementById('a_model').value='';
      document.getElementById('a_issue').value='';
      activeSet.clear(); $$('#toggles .tbtn').forEach(b=>b.classList.remove('active'));
      $('#acceptWrap').style.display='none';
      updateInsertState();
      showToast('Cliente inserito e Fidelity aggiornata ‚úÖ');
    }

    insertBtn.addEventListener('click', insert);

    const filtersRow = document.getElementById('filtersRow');
    const toggleFiltersBtn = document.getElementById('toggleFilters');
    toggleFiltersBtn.addEventListener('click', ()=>{
      const vis = filtersRow.style.display!=='none';
      filtersRow.style.display = vis ? 'none':'flex';
    });

    let activeFilter = null;
    $$('#filtersRow .toggle').forEach(b=>{
      b.addEventListener('click', ()=>{
        const key = b.dataset.filter;
        if(activeFilter === key){
          activeFilter = null;
          b.classList.remove('active');
        } else {
          activeFilter = key;
          $$('#filtersRow .toggle').forEach(x=>x.classList.toggle('active', x===b));
        }
        render();
      });
    });

    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', render);

    function btn(label,fn){
      const b=document.createElement('button'); b.className='btn'; b.type='button'; b.textContent=label; b.addEventListener('click', fn); return b;
    }
    function btnOk(label,fn){
      const b=document.createElement('button'); b.className='btn ok'; b.type='button'; b.textContent=label; b.addEventListener('click', fn); return b;
    }

    function appendQuickWA(actions, it){
      const row=document.createElement('div');
      row.className='svc-row';

      const radar = document.createElement('div');
      radar.className='svc-radar';
      const lbl=document.createElement('span');
      lbl.className='svc-radar-label';
      lbl.textContent='Radar servizi:';
      radar.appendChild(lbl);

      const services = [
        { key:'sim',        label:'SIM',          icon:'üì∂' },
        { key:'fissomobile',label:'Fisso / FTTH',icon:'üè†üì°' },
        { key:'energia',    label:'Energia',      icon:'‚ö°' },
        { key:'rate',       label:'Rate',         icon:'üì±' }
      ];
      const actSet = new Set(it.activated || []);
      services.forEach(s=>{
        const t=document.createElement('span');
        t.className='svc-radar-tag ' + (actSet.has(s.key)?'on':'off');
        t.innerHTML=`<span>${s.icon}</span><span>${s.label}</span>`;
        radar.appendChild(t);
      });

      const btnSim=document.createElement('button');
      btnSim.className='svc-btn svc-btn--sim';
      btnSim.innerHTML='<span class="icon">üì∂</span><span>Proponi SIM</span>';
      btnSim.addEventListener('click',()=>{ window.open(waPacchiSIM(it.name,it.phone),'_blank','noopener'); });

      const btnFisso=document.createElement('button');
      btnFisso.className='svc-btn svc-btn--fisso';
      btnFisso.innerHTML='<span class="icon">üè†üì°</span><span>Proponi Fisso</span>';
      btnFisso.addEventListener('click',()=>{ window.open(waPacchiFisso(it.name,it.phone),'_blank','noopener'); });

      const btnEnergia=document.createElement('button');
      btnEnergia.className='svc-btn svc-btn--energia';
      btnEnergia.innerHTML='<span class="icon">‚ö°</span><span>Proponi Energia</span>';
      btnEnergia.addEventListener('click',()=>{ window.open(waPacchiEnergia(it.name,it.phone),'_blank','noopener'); });

      const btnRate=document.createElement('button');
      btnRate.className='svc-btn svc-btn--rate';
      btnRate.innerHTML='<span class="icon">üì±</span><span>Proponi Rate</span>';
      btnRate.addEventListener('click',()=>{ window.open(waPacchiRate(it.name,it.phone),'_blank','noopener'); });

      row.appendChild(btnSim);
      row.appendChild(btnFisso);
      row.appendChild(btnEnergia);
      row.appendChild(btnRate);

      actions.appendChild(radar);
      actions.appendChild(row);
    }

    function btnDelete(it){
      const b=btn('Elimina',()=>{
        if(!confirm('Vuoi eliminare questo cliente dal gestionale?')) return;
        items=items.filter(x=>x!==it); saveLocal(); saveToGitHub(); render();
      });
      return b;
    }

    const bonusAllBtn = document.getElementById('bonusAll');
    const giftFidelityBtn = document.getElementById('giftFidelity');
    const generateMissingBtn = document.getElementById('generateMissing');

    bonusAllBtn.addEventListener('click', ()=>{
      const now=new Date().toISOString();
      const updated=[];
      items.forEach(it=>{
        ensureBaseFields(it);
        if(!it.pointsMovements.some(m=>m.code==='mass-bonus-10')){
          addFidelityMovement(it,'mass-bonus-10','Bonus speciale Fidelity +10 pt',10);
          it.updatedAt=now;
          updated.push(it);
        }
      });
      if(updated.length){
        saveLocal(); saveToGitHub();
        lastBonusRecipients = updated.map(x=>x.name||x.phone||x.id);
        showToast(`Bonus assegnato a ${updated.length} clienti ‚úÖ`);
      }else{
        showToast('Tutti i clienti avevano gi√† ricevuto questo bonus','err');
      }
      render();
    });

    giftFidelityBtn.addEventListener('click', ()=>{
      const now=new Date().toISOString();
      const updated=[];
      items.forEach(it=>{
        ensureBaseFields(it);
        if(!it.pointsMovements.some(m=>m.code==='gift-20')){
          addFidelityMovement(it,'gift-20','Gift Fidelity +20 pt',20);
          it.updatedAt=now;
          updated.push(it);
        }
      });
      if(updated.length){
        saveLocal(); saveToGitHub();
        lastBonusRecipients = updated.map(x=>x.name||x.phone||x.id);
        showToast(`Gift Fidelity omaggiato a ${updated.length} clienti ‚úÖ`);
      }else{
        showToast('Tutti i clienti avevano gi√† ricevuto il gift Fidelity','err');
      }
      render();
    });

    generateMissingBtn.addEventListener('click', ()=>{
      const now=new Date().toISOString();
      const updated=[];
      items.forEach(it=>{
        ensureBaseFields(it);
        if(!it.pointsMovements.length){
          addFidelityMovement(it,'gen-missing-20','Fidelity generata (bonus iniziale)',20);
          it.updatedAt=now;
          updated.push(it);
        }
      });
      if(updated.length){
        saveLocal(); saveToGitHub();
        showToast(`Generate Fidelity e 20 pt per ${updated.length} clienti ‚úÖ`);
      }else{
        showToast('Non ci sono clienti senza Fidelity','err');
      }
      render();
    });

    function filterItems(){
      let out=[...items];
      const q=(searchInput.value||'').trim().toLowerCase();
      if(q){
        out=out.filter(it=>{
          const full=((it.name||'')+' '+(it.phone||'')).toLowerCase();
          return full.includes(q);
        });
      }

      if(!activeFilter) return out;

      const today = startOfDay(new Date());
      if(activeFilter==='remindtoday'){
        out = out.filter(it=>{
          if(!Array.isArray(it.reminders)) return false;
          return it.reminders.some(r=>{
            if(r.sent) return false;
            const d=startOfDay(new Date(r.dueAt));
            return d.getTime()===today.getTime();
          });
        });
        return out;
      }

      if(activeFilter==='pacchi'){
        out = out.filter(it=> it.fromPacchi);
        return out;
      }

      if(activeFilter==='sim' || activeFilter==='fisso' || activeFilter==='energia' || activeFilter==='rate'){
        out = out.filter(it=> (it.activated||[]).includes(activeFilter) || (activeFilter==='fisso' && (it.activated||[]).includes('fissomobile')));
        return out;
      }

      if(activeFilter==='riparazioni'){
        out = out.filter(it=> !!it.acceptance);
        return out;
      }

      if(activeFilter==='preventivi'){
        out = out.filter(it=> it.quoteStatus==='pending');
        return out;
      }

      return out;
    }

    function render(){
      const listEl=document.getElementById('list');
      const counterEl=document.getElementById('counter');
      const filterSummary=document.getElementById('filterSummary');

      const arr=filterItems();
      counterEl.textContent=`Clienti: ${arr.length}`;
      if(activeFilter){
        filterSummary.style.display='block';
        const map={
          remindtoday:'Remind in scadenza oggi',
          pacchi:'Solo da pacchi',
          sim:'Solo SIM',
          fisso:'Solo Fisso',
          energia:'Solo Energia',
          rate:'Solo Rate',
          riparazioni:'Solo Riparazioni',
          preventivi:'Solo Preventivi'
        };
        filterSummary.textContent=map[activeFilter]||'Filtro attivo';
      }else{
        filterSummary.style.display='none';
      }

      listEl.innerHTML='';
      if(!arr.length){
        listEl.innerHTML='<div class="label">Nessun cliente trovato.</div>';
        return;
      }

      arr.sort((a,b)=>{
        const da = new Date(a.updatedAt||a.createdAt||0).getTime();
        const db = new Date(b.updatedAt||b.createdAt||0).getTime();
        return db-da;
      });

      arr.forEach(it=>{
        ensureBaseFields(it);
        const clone=document.getElementById('tpl').content.firstElementChild.cloneNode(true);
        const head=clone.querySelector('.head');
        const details=clone.querySelector('.details');
        const title=clone.querySelector('.title');
        const services=clone.querySelector('.services');
        const actions=clone.querySelector('.actions');
        const points=clone.querySelector('.points');
        const reminders=clone.querySelector('.reminders');
        const review=clone.querySelector('.review');

        const lvl=getLevel(it.points||0);
        const badge=document.createElement('span');
        badge.className='lvl-badge '+lvl.class;
        badge.textContent=`${lvl.emoji} ${lvl.name}`;

        const nameSpan=document.createElement('span');
        nameSpan.textContent=it.name || 'Cliente senza nome';

        const phoneSpan=document.createElement('span');
        phoneSpan.className='badge-mini';
        phoneSpan.textContent=normalizePhone(it.phone||'');

        const pointsSpan=document.createElement('span');
        pointsSpan.className='badge-top';
        pointsSpan.textContent=`‚≠ê ${it.points||0} pt`;

        title.appendChild(nameSpan);
        title.appendChild(phoneSpan);
        title.appendChild(pointsSpan);
        title.appendChild(badge);

        const svcRow=document.createElement('div');
        svcRow.className='svc-radar';
        const lbl=document.createElement('span');
        lbl.className='svc-radar-label';
        lbl.textContent='Servizi attivi:';
        svcRow.appendChild(lbl);

        const servicesList=[
          { key:'sim',        label:'SIM',          icon:'üì∂' },
          { key:'fissomobile',label:'Fisso / FTTH',icon:'üè†üì°' },
          { key:'energia',    label:'Energia',      icon:'‚ö°' },
          { key:'rate',       label:'Rate',         icon:'üì±' }
        ];
        const actSet=new Set(it.activated||[]);
        servicesList.forEach(s=>{
          const t=document.createElement('span');
          t.className='svc-radar-tag ' + (actSet.has(s.key)?'on':'off');
          t.innerHTML=`<span>${s.icon}</span><span>${s.label}</span>`;
          svcRow.appendChild(t);
        });
        services.appendChild(svcRow);

        if(it.acceptance){
          const d=document.createElement('div');
          d.textContent=`Riparazione: ${it.acceptance.type||''} ${it.acceptance.brand||''} ${it.acceptance.model||''}`;
          services.appendChild(d);
        }

        const createdInfo=document.createElement('span');
        createdInfo.className='label';
        createdInfo.textContent=`Creato il ${fmt(it.createdAt||new Date())}`;
        services.appendChild(createdInfo);

        if(it.fromPacchi){
          const pacchiBadge=document.createElement('span');
          pacchiBadge.className='badge-mini';
          pacchiBadge.textContent='Da Pacchi';
          services.appendChild(pacchiBadge);
        }

        // --- Radar servizi + Proponi (UNA VOLTA SOLA) ---
        if(it.acceptance){
          appendQuickWA(actions, it);
        } else {
          appendQuickWA(actions, it);
        }

        if(it.acceptance){
          if(it.quoteStatus==='pending'){
            actions.append(btn('Invia preventivo', ()=>{
              it.quoteStatus='sent'; it.updatedAt=new Date().toISOString(); saveLocal(); saveToGitHub(); render();
            }));
          } else if(it.quoteStatus==='sent'){
            actions.append(btn('Accetta preventivo', ()=>{
              it.quoteStatus='accepted'; it.updatedAt=new Date().toISOString(); saveLocal(); saveToGitHub(); render();
            }));
          } else if(it.quoteStatus==='accepted'){
            const lab=document.createElement('span'); lab.className='label'; lab.textContent='Preventivo accettato'; actions.append(lab);
          }

          if(it.repairStatus!=='pronto' && it.repairStatus!=='consegnato'){
            actions.append(btnOk('Da consegnare (avvisa cliente)', ()=>{
              it.repairStatus='pronto'; it.updatedAt=new Date().toISOString(); saveLocal(); saveToGitHub(); render();
              window.open(waPickup(it.name, it.phone),'_blank','noopener');

              if(dashModal && dashModal.classList.contains('on')) updateDashboard();
            }));
          } else if(it.repairStatus==='pronto'){
            actions.append(btn('Ritirato (chiudi pratica)', ()=>{
              it.repairStatus='consegnato';
              it.deliveredAt = new Date().toISOString();
              it.postReviewAt = addDays(new Date(), 3).toISOString();
              it.postReviewSent = false;

              // Fidelity: accredito punti per riparazione conclusa
              const devType = (it.device && it.device.type ? String(it.device.type).toLowerCase() : '');
              let delta = 0;
              if(devType === 'computer'){
                delta = POINTS_REPAIR_PC;    // 50 punti
              }else if(devType === 'smartphone'){
                delta = POINTS_REPAIR_PHONE; // 25 punti
              }
              if(delta > 0){
                const code  = 'repair-' + (devType || 'altro') + '-delivered';
                const label = 'Riparazione ' + (devType || 'dispositivo') + ' completata';
                addFidelityMovement(it, code, label, delta);
              }

              it.updatedAt = new Date().toISOString();
              saveLocal();
              saveToGitHub();
              render();
              try{ window.open(waDeliveredConfirm(it.name, it.phone),'_blank','noopener'); }catch{}

              if(dashModal && dashModal.classList.contains('on')) updateDashboard();
            }));
          } else if(it.repairStatus==='consegnato'){
            const lab=document.createElement('span'); lab.className='label'; lab.textContent='Riparazione consegnata'; actions.append(lab);
          }
        } else {

          if(!it.done){
            actions.append(btn('Completato', ()=>{
              try{ window.open(waDeliveredConfirm(it.name, it.phone),'_blank','noopener'); }catch{}
              it.done = true;
              it.doneAt = new Date().toISOString();

              // Fidelity: accredito punti per pratiche concluse (no pacchi)
              const acts = new Set(it.activated || []);
              const isPacchi = !!it.fromPacchi || acts.has('pacchi');

              if(!isPacchi){
                if(acts.has('sim')){
                  addFidelityMovement(it, 'sim-done', 'Attivazione SIM completata', POINTS_SIM);
                }
                if(acts.has('fisso') || acts.has('fissomobile')){
                  addFidelityMovement(it, 'fisso-done', 'Attivazione linea fissa completata', POINTS_FISSO);
                }
                if(acts.has('energia')){
                  addFidelityMovement(it, 'energia-done', 'Attivazione energia completata', POINTS_ENERGIA);
                }
                if(acts.has('rate')){
                  addFidelityMovement(it, 'rate-done', 'Pratica smartphone a rate completata', POINTS_RATE);
                }
              }

              it.updatedAt = new Date().toISOString();
              saveLocal();
              saveToGitHub();
              render();
            }));
          } else {
            const lab = document.createElement('span');
            lab.className = 'label';
            lab.textContent = 'Pratica completata';
            actions.append(lab);
          }

          actions.append(btnDelete(it));
        }

        // --- STRUMENTI FIDELITY PER SINGOLO CLIENTE ---
        const fidRow = document.createElement('div');
        fidRow.className = 'r-line';

        const bAddPts = btn('+ Punti Fidelity', ()=>{
          const val = prompt('Quanti punti vuoi aggiungere/sottrarre? (es. 10 o -20)');
          if(val===null) return;
          const delta = parseInt(String(val).trim(),10);
          if(!Number.isFinite(delta) || delta===0){
            alert('Valore non valido.');
            return;
          }
          addFidelityMovement(it, 'manual-'+Date.now(), 'Movimento manuale Fidelity', delta);
          it.updatedAt = new Date().toISOString();
          saveLocal(); saveToGitHub(); render();
        });

        const bSendCard = btn('Invia Fidelity Card', ()=>{
          try{
            window.open(waWelcomeWithCard(it),'_blank','noopener');
          }catch{}
        });

        const bOpenCard = btn('Apri Fidelity Card', ()=>{
          const url = `${FIDELITY_URL}?id=${encodeURIComponent(it.id)}`;
          window.open(url,'_blank','noopener');
        });

        fidRow.appendChild(bAddPts);
        fidRow.appendChild(bSendCard);
        fidRow.appendChild(bOpenCard);
        actions.appendChild(fidRow);

        if(Array.isArray(it.pointsMovements) && it.pointsMovements.length){
          const wrap=document.createElement('div');
          wrap.className='r-line';
          const label=document.createElement('span');
          label.className='label';
          label.textContent='Ultimi movimenti punti:';
          wrap.appendChild(label);

          const last=it.pointsMovements.slice(-3).reverse();
          last.forEach(m=>{
            const t=document.createElement('span');
            t.className='badge-mini';
            const sign = m.delta>0?'+':'';
            t.textContent=`${sign}${m.delta} pt ‚Ä¢ ${m.label}`;
            wrap.appendChild(t);
          });
          points.appendChild(wrap);
        }

        if(it.reminders && it.reminders.length){
          const today=startOfDay(new Date());
          const dueToday=it.reminders.filter(r=>{
            if(r.sent) return false;
            const d=startOfDay(new Date(r.dueAt));
            return d.getTime()===today.getTime();
          });
          if(dueToday.length){
            const w=document.createElement('div');
            w.className='r-line';
            dueToday.forEach(rem=>{
              const b=document.createElement('a');
              b.href=reminderLink(it, rem);
              b.target='_blank';
              b.rel='noopener';
              b.className='wa-btn ok';
              b.textContent=`Invia reminder ${typeLabel[rem.type]||rem.type}`;
              b.addEventListener('click',()=>{
                rem.sent=true; rem.sentAt=new Date().toISOString();
                it.updatedAt=new Date().toISOString(); saveLocal(); saveToGitHub(); render();
              });
              w.appendChild(b);
            });
            reminders.appendChild(w);
          }
        }

        if(it.postReviewAt){
          const should = new Date(it.postReviewAt)<=new Date() && !it.postReviewSent;
          if(should){
            const b=document.createElement('a');
            b.href=waReview(it.name, it.phone);
            b.target='_blank';
            b.rel='noopener';
            b.className='wa-btn';
            b.textContent='Chiedi recensione Google';
            b.addEventListener('click',()=>{
              it.postReviewSent=true; it.updatedAt=new Date().toISOString(); saveLocal(); saveToGitHub(); render();
            });
            review.appendChild(b);
          } else if(it.postReviewSent){
            const lab=document.createElement('span'); lab.className='label'; lab.textContent='Recensione richiesta'; review.appendChild(lab);
          }
        }

        head.addEventListener('click',()=>{
          details.hidden=!details.hidden;
        });

        listEl.appendChild(clone);
      });

      updateDashboard();
    }

    const dashModal=document.getElementById('dashModal');
    const openDashBtn=document.getElementById('openDash');
    const closeDashBtn=document.getElementById('closeDash');
    openDashBtn.addEventListener('click',()=>{
      dashModal.classList.add('on');
      updateDashboard();
    });
    closeDashBtn.addEventListener('click',()=>{
      dashModal.classList.remove('on');
    });

    function summarize(period){
      const now=new Date();
      let fromDate=null, toDate=null;

      if(period==='today'){
        fromDate=startOfDay(now);
        toDate=new Date(fromDate); toDate.setDate(toDate.getDate()+1);
      } else if(period==='month'){
        fromDate=new Date(now.getFullYear(), now.getMonth(),1);
        toDate=new Date(now.getFullYear(), now.getMonth()+1,1);
      } else if(period==='range'){
        const fromVal=document.getElementById('rangeFrom').value;
        const toVal=document.getElementById('rangeTo').value;
        if(fromVal){
          fromDate=startOfDay(new Date(fromVal));
        }
        if(toVal){
          toDate=startOfDay(new Date(toVal));
          toDate.setDate(toDate.getDate()+1);
        }
      }

      const data=items.filter(it=>{
        const d=new Date(it.createdAt||it.updatedAt||Date.now());
        if(fromDate && d<fromDate) return false;
        if(toDate && d>=toDate) return false;
        return true;
      });

      let k_pacchi=0,k_sim=0,k_fisso=0,k_energia=0,k_rate=0,k_rip=0,k_prev=0;
      let e_pacchi=0,e_sim=0,e_fisso=0,e_energia=0,e_rate=0;

      data.forEach(it=>{
        if(it.fromPacchi){
          k_pacchi++; e_pacchi+=GAIN_PACCHI;
        }
        const act=new Set(it.activated||[]);
        if(act.has('sim')){ k_sim++; e_sim+=GAIN_SIM; }
        if(act.has('fisso') || act.has('fissomobile')){ k_fisso++; e_fisso+=GAIN_FISSO; }
        if(act.has('energia')){ k_energia++; e_energia+=GAIN_ENERGIA; }
        if(act.has('rate')){ k_rate++; e_rate+=GAIN_RATE; }
        if(it.acceptance){ k_rip++; }
        if(it.quoteStatus==='pending'){ k_prev++; }
      });

      return {
        count:data.length,
        k_pacchi,k_sim,k_fisso,k_energia,k_rate,k_rip,k_prev,
        e_pacchi,e_sim,e_fisso,e_energia,e_rate
      };
    }

    function updateDashboard(){
      const active = document.querySelector('.dash-period.active');
      const period = active ? active.dataset.period : 'all';
      const s=summarize(period);

      document.getElementById('k_pacchi').textContent=s.k_pacchi;
      document.getElementById('k_sim').textContent=s.k_sim;
      document.getElementById('k_fisso').textContent=s.k_fisso;
      document.getElementById('k_energia').textContent=s.k_energia;
      document.getElementById('k_rate').textContent=s.k_rate;
      document.getElementById('k_rip').textContent=s.k_rip;
      document.getElementById('k_prev').textContent=s.k_prev;

      document.getElementById('e_pacchi').textContent=`‚Ç¨ ${s.e_pacchi.toFixed(0)}`;
      document.getElementById('e_sim').textContent=`‚Ç¨ ${s.e_sim.toFixed(0)}`;
      document.getElementById('e_fisso').textContent=`‚Ç¨ ${s.e_fisso.toFixed(0)}`;
      document.getElementById('e_energia').textContent=`‚Ç¨ ${s.e_energia.toFixed(0)}`;
      document.getElementById('e_rate').textContent=`‚Ç¨ ${s.e_rate.toFixed(0)}`;

      document.getElementById('k_total').textContent=`Totale clienti: ${s.count}`;
      const gainTotal = s.e_pacchi+s.e_sim+s.e_fisso+s.e_energia+s.e_rate;
      document.getElementById('k_total_gain').textContent=`Guadagno totale: ‚Ç¨ ${gainTotal.toFixed(0)}`;
    }

    $$('.dash-period').forEach(b=>{
      b.addEventListener('click',()=>{
        $$('.dash-period').forEach(x=>x.classList.toggle('active', x===b));
        const period=b.dataset.period;
        const rangeWrap=document.getElementById('rangeWrap');
        rangeWrap.style.display = period==='range' ? 'flex':'none';
        updateDashboard();
      });
    });

    document.getElementById('rangeFrom').addEventListener('change',updateDashboard);
    document.getElementById('rangeTo').addEventListener('change',updateDashboard);

    document.addEventListener('DOMContentLoaded', async ()=>{
      await loadFromGitHubOrLocal();
      render();
    });
  </script>
</body>
</html>
