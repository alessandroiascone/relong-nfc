<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Re Long ‚Ä¢ Fidelity Card</title>
  <meta name="theme-color" content="#05060a" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0;-webkit-font-smoothing:antialiased}
    :root{
      --bg1:#05060a; --bg2:#020308;
      --card:rgba(10,12,20,.96); --stroke:rgba(255,255,255,.09);
      --muted:rgba(210,220,255,.72);
      --accent:#ffd700; --accent2:#ffb347; --accent3:#fff4c2;
      --elec:#0aa2ff; --danger:#ff4d4f;
    }
    body{
      min-height:100svh;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Inter",Roboto,sans-serif;
      color:#eef3ff;
      background:
        radial-gradient(80% 80% at 10% 0%,rgba(0,140,255,.16),transparent),
        radial-gradient(70% 80% at 90% 0%,rgba(255,215,0,.13),transparent),
        linear-gradient(180deg,var(--bg1),var(--bg2));
      padding:24px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }
    .wrap{
      width:100%;
      max-width:480px;
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    .card{
      background:var(--card);
      border-radius:22px;
      border:1px solid var(--stroke);
      box-shadow:0 20px 60px rgba(0,0,0,.65);
      padding:18px 18px 20px;
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(circle at 0 0,rgba(0,140,255,.18),transparent 60%),
        radial-gradient(circle at 100% 0,rgba(255,215,0,.18),transparent 60%);
      opacity:.6;
      pointer-events:none;
    }
    .card-inner{position:relative;z-index:1}
    .logo-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .logo-main{
      font-weight:900;
      letter-spacing:.18em;
      text-transform:uppercase;
      font-size:14px;
    }
    .logo-main span{
      padding:3px 8px;
      border-radius:999px;
      background:linear-gradient(135deg,#ff3b3b,#ff9f1a);
      margin-right:6px;
      box-shadow:0 0 12px rgba(255,120,60,.65);
    }
    .fidelity-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,215,0,.8);
      background:linear-gradient(135deg,rgba(255,215,0,.2),rgba(10,12,20,1));
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--accent3);
      position:relative;
      overflow:hidden;
    }
    .fidelity-badge::after{
      content:"";
      position:absolute;
      inset:-40%;
      background:conic-gradient(from 0deg,rgba(255,255,255,.2),transparent 40%,transparent 60%,rgba(255,255,255,.25));
      mix-blend-mode:screen;
      animation:spin 6s linear infinite;
      opacity:.7;
      pointer-events:none;
    }
    .fidelity-badge span{
      position:relative;
      z-index:1;
    }
    @keyframes spin{
      to{transform:rotate(360deg);}
    }

    h1{
      font-size:20px;
      margin-bottom:4px;
    }
    .subtitle{
      font-size:13px;
      color:var(--muted);
      margin-bottom:12px;
    }

    .code-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin:10px 0 6px;
    }

    /* CODICE INVITO MOLTO VISIBILE */
    .code-chip{
      border-radius:999px;
      border:1px solid rgba(255,215,0,1);
      padding:8px 14px;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      color:#2b1900;
      box-shadow:
        0 0 22px rgba(255,215,0,.9),
        0 0 2px rgba(0,0,0,.8);
    }
    .code-chip strong{
      letter-spacing:.20em;
      font-family:monospace;
      font-size:15px;
    }
    .code-chip small{
      font-size:10px;
      color:#2b1900;
      text-transform:uppercase;
      opacity:.9;
    }
    .code-chip:hover{
      box-shadow:
        0 0 30px rgba(255,215,0,1),
        0 0 6px rgba(0,0,0,1);
      transform:translateY(-1px);
    }

    .points-pill{
      border-radius:999px;
      border:1px solid rgba(0,140,255,.4);
      padding:4px 10px;
      font-size:12px;
      background:linear-gradient(135deg,rgba(0,140,255,.25),rgba(0,0,0,.7));
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .progress-wrap{
      margin:10px 0 14px;
    }
    .progress-label{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:11px;
      color:var(--muted);
      margin-bottom:4px;
    }
    .progress-bar{
      position:relative;
      height:10px;
      border-radius:999px;
      background:rgba(255,255,255,.04);
      overflow:hidden;
    }
    .progress-bar span{
      position:absolute;
      inset:0;
      transform-origin:left center;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      box-shadow:0 0 18px rgba(255,215,0,.75);
      transform:scaleX(0);
    }
    .tiers{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:8px;
    }
    .tier{
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      padding:4px 9px;
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:4px;
      color:var(--muted);
    }
    .tier strong{color:#fff;}
    .tier.active{
      border-color:rgba(255,215,0,.9);
      color:var(--accent3);
      background:radial-gradient(circle at 0 0,rgba(255,215,0,.35),rgba(0,0,0,.9));
      position:relative;
      overflow:hidden;
    }
    .tier.active::after{
      content:"";
      position:absolute;
      inset:-40%;
      background:conic-gradient(from 0deg,rgba(255,255,255,.4),transparent 40%,transparent 60%,rgba(255,255,255,.6));
      mix-blend-mode:screen;
      animation:spin 4s linear infinite;
      opacity:.6;
    }
    .tier span.label{position:relative;z-index:1;}

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin:14px 0 6px;
    }
    .btn{
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      padding:9px 14px;
      font-size:13px;
      font-weight:700;
      cursor:pointer;
      background:rgba(0,0,0,.7);
      color:#f5f6ff;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn-primary{
      border-color:rgba(255,215,0,.9);
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      color:#2b1900;
      box-shadow:0 10px 26px rgba(0,0,0,.7),0 0 18px rgba(255,215,0,.8);
    }
    .btn span.icon{font-size:16px}

    .section{
      background:rgba(5,7,14,.9);
      border-radius:20px;
      border:1px solid rgba(255,255,255,.06);
      padding:14px 14px 15px;
    }
    .section h2{
      font-size:15px;
      margin-bottom:6px;
    }
    .section p{
      font-size:13px;
      color:var(--muted);
      margin-bottom:6px;
      line-height:1.4;
    }
    .rewards-list{
      margin-top:6px;
      display:grid;
      gap:6px;
      font-size:13px;
    }
    .reward{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      padding:6px 8px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.6);
    }
    .reward strong{
      font-size:13px;
    }
    .reward small{
      font-size:11px;
      color:var(--muted);
    }
    .reward.unlocked{
      border-color:rgba(0,200,120,.9);
      background:linear-gradient(135deg,rgba(0,200,120,.3),rgba(0,0,0,.8));
    }
    .reward.next{
      border-color:rgba(255,215,0,.9);
      background:linear-gradient(135deg,rgba(255,215,0,.24),rgba(0,0,0,.8));
    }

    .how-grid{
      margin-top:8px;
      display:grid;
      gap:4px;
    }
    .how-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      font-size:13px;
      padding:4px 2px;
    }
    .how-row span.label{
      color:#f7f7ff;
    }
    .how-row span.points{
      font-weight:700;
      color:var(--accent3);
    }
    .how-row span.points small{
      font-size:11px;
      color:var(--muted);
      margin-left:2px;
    }

    .small-note{
      font-size:11px;
      color:var(--muted);
      margin-top:6px;
    }

    .error{
      text-align:center;
      color:var(--muted);
      font-size:14px;
      margin-top:20px;
    }

    @media (max-width:600px){
      body{padding:16px;}
      .card{padding:16px;}
      .wrap{gap:14px;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="card-inner" id="cardInner">
        <div class="logo-row">
          <div class="logo-main"><span>Re</span>LONG</div>
          <div>
            <div class="fidelity-badge">
              <span>Fidelity Premium</span>
            </div>
            <div style="
              margin-top:6px;
              font-size:11px;
              padding:6px 10px;
              border-radius:12px;
              background:rgba(255,215,0,.12);
              border:1px solid rgba(255,215,0,.35);
              color:var(--accent3);
              text-align:center;
              letter-spacing:.3px;
              backdrop-filter:blur(4px);
              max-width:260px;
            ">
              ‚≠ê Porta un amico = punti extra per entrambi ‚≠ê
            </div>
          </div>
        </div>

        <div id="headerInfo">
          <h1 id="clientName">Fidelity Card</h1>
          <div class="subtitle" id="subtitle">
            Accumula punti su ogni servizio Re Long e trasformali in premi tecnologici.
          </div>

          <div class="code-row">
            <div style="display:flex;flex-direction:column;gap:2px;">
              <button class="code-chip" id="codeChip" type="button">
                <div>
                  <small>Codice invito</small><br>
                  <strong id="codeValue">000000</strong>
                </div>
              </button>
              <small style="font-size:10px;color:var(--muted);margin-left:6px;">
                Tocca per copiare il codice
              </small>
            </div>
            <div class="points-pill">
              <span>‚≠ê Punti attuali:</span>
              <strong id="pointsValue">0</strong>
            </div>
          </div>

          <div class="progress-wrap">
            <div class="progress-label">
              <span>Progresso verso il prossimo premio</span>
              <span id="nextLabel">0 / 150 pt</span>
            </div>
            <div class="progress-bar">
              <span id="progressFill"></span>
            </div>
            <div class="tiers" id="tiersRow"></div>
          </div>

          <div class="btn-row">
            <button class="btn btn-primary" id="btnInvite" type="button">
              <span class="icon">üí¨</span>
              <span>Porta un amico</span>
            </button>
            <button class="btn" id="btnHow" type="button">
              <span class="icon">üìà</span>
              <span>Come accumulare punti</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- SEZIONE PREMI -->
    <div class="section">
      <h2>Premi disponibili</h2>
      <p>Ogni volta che raggiungi una soglia punti, puoi scegliere il premio corrispondente.</p>
      <div class="rewards-list" id="rewardsList"></div>
      <p class="small-note">
        I premi sono soggetti a disponibilit√† in negozio. In caso di mancanza di uno specifico modello,
        ti proporremo un prodotto equivalente o superiore.
      </p>
    </div>

    <!-- SEZIONE COME ACCUMULARE PUNTI (COLLASSABILE) -->
    <div class="section" id="howPoints" style="display:none">
      <h2>Come accumulare punti</h2>
      <p>
        Usa la tua Fidelity Card ogni volta che attivi un servizio o fai un acquisto da Re Long:
        i punti si sommano e ti avvicinano ai premi.
      </p>
      <div class="how-grid">
        <div class="how-row">
          <span class="label">Riparazione computer</span>
          <span class="points">+50 <small>punti</small></span>
        </div>
        <div class="how-row">
          <span class="label">Riparazione smartphone</span>
          <span class="points">+25 <small>punti</small></span>
        </div>
        <div class="how-row">
          <span class="label">Kit 4 cartucce compatibili</span>
          <span class="points">+5 <small>punti</small></span>
        </div>
        <div class="how-row">
          <span class="label">Toner compatibile</span>
          <span class="points">+10 <small>punti</small></span>
        </div>
        <div class="how-row">
          <span class="label">Linea fissa</span>
          <span class="points">+80 <small>punti</small></span>
        </div>
        <div class="how-row">
          <span class="label">SIM mobile</span>
          <span class="points">+30 <small>punti</small></span>
        </div>
        <div class="how-row">
          <span class="label">Luce & Gas</span>
          <span class="points">+100 <small>punti</small></span>
        </div>
        <div class="how-row">
          <span class="label">Porta un amico (chi presenta)</span>
          <span class="points">+80 <small>punti</small></span>
        </div>
        <div class="how-row">
          <span class="label">Nuovo cliente iscritto con codice amico</span>
          <span class="points">+40 <small>punti</small></span>
        </div>
      </div>

      <p class="small-note">
        Ricorda di far associare sempre la tua Fidelity Card (o il tuo codice) ad ogni pratica:
        pacchi, riparazioni, telefonia, energia e promozioni ‚ÄúPorta un amico‚Äù.
      </p>
    </div>

    <div id="errorBox" class="error" style="display:none">
      Impossibile trovare i dati della tua Fidelity Card.<br/>
      Contatta Re Long per attivare o verificare la tua card.
    </div>
  </div>

  <script>
    const HUB_URL = "https://alessandroiascone.github.io/relong-nfc/relong-hub-v2.html";
    const DATA_URL = "https://raw.githubusercontent.com/alessandroiascone/relong-nfc/main/data/items.json";

    const rewardsConfig = [
      { threshold:150, label:"Pellicola Gel Ultra Crystal Premium Quality" },
      { threshold:300, label:"Powerbank 5000 mAh First Rapid Charge" },
      { threshold:600, label:"Cuffie Bluetooth SGS Pods" },
      { threshold:1000, label:"Smartwatch SGS Square BT con funzione chiamata" },
      { threshold:1500, label:"Occhiali SGS Smart (musica & chiamate)" }
    ];

    const qs = new URLSearchParams(location.search);
    const idParam = qs.get("id");

    const elName = document.getElementById("clientName");
    const elSubtitle = document.getElementById("subtitle");
    const elPoints = document.getElementById("pointsValue");
    const elCode = document.getElementById("codeValue");
    const elNextLabel = document.getElementById("nextLabel");
    const elProgressFill = document.getElementById("progressFill");
    const elTiersRow = document.getElementById("tiersRow");
    const elRewardsList = document.getElementById("rewardsList");
    const errorBox = document.getElementById("errorBox");
    const cardInner = document.getElementById("cardInner");
    const howSection = document.getElementById("howPoints");

    function fallbackCodeFromId(id){
      const digits = String(id||"").replace(/\D/g,"") || String(Date.now());
      const last6 = digits.slice(-6);
      return last6.padStart(6,"0");
    }

    function computeProgress(points){
      let currentTier = null;
      let nextTier = null;
      for(const r of rewardsConfig){
        if(points >= r.threshold){
          currentTier = r;
        }else{
          nextTier = r;
          break;
        }
      }
      if(!nextTier){
        return {
          current: currentTier,
          next: null,
          ratio:1,
          label:`${points} pt ‚Ä¢ hai sbloccato tutti i premi`
        };
      }
      const base = currentTier ? currentTier.threshold : 0;
      const span = nextTier.threshold - base;
      const clamped = Math.max(0, Math.min(points - base, span));
      const ratio = span>0 ? (clamped/span) : 0;
      return {
        current: currentTier,
        next: nextTier,
        ratio,
        label:`${points} / ${nextTier.threshold} pt`
      };
    }

    function renderTiers(points){
      elTiersRow.innerHTML = "";
      rewardsConfig.forEach(r=>{
        const div = document.createElement("div");
        const unlocked = points >= r.threshold;
        div.className = "tier" + (unlocked ? " active" : "");
        div.innerHTML = `<span class="label"><strong>${r.threshold} pt</strong> ‚Ä¢ ${r.label}</span>`;
        elTiersRow.appendChild(div);
      });
    }

    function renderRewards(points){
      elRewardsList.innerHTML = "";
      let nextAssigned = false;
      rewardsConfig.forEach(r=>{
        const div = document.createElement("div");
        div.className = "reward";

        if(points >= r.threshold){
          div.classList.add("unlocked");
        }else if(!nextAssigned){
          div.classList.add("next");
          nextAssigned = true;
        }

        div.innerHTML = `
          <div>
            <strong>${r.threshold} punti</strong><br/>
            <small>${r.label}</small>
          </div>
          <div>
            ${points >= r.threshold ? "‚úÖ" : "üéØ"}
          </div>
        `;
        elRewardsList.appendChild(div);
      });
    }

    function copyToClipboard(text){
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).then(()=>{
          toast("Codice copiato negli appunti ‚úÖ");
        }).catch(()=>{});
      }
    }

    function toast(msg){
      const t = document.createElement("div");
      t.style.position="fixed";
      t.style.left="50%";
      t.style.bottom="18px";
      t.style.transform="translateX(-50%)";
      t.style.background="rgba(0,0,0,.9)";
      t.style.border="1px solid rgba(255,255,255,.25)";
      t.style.color="#fff";
      t.style.padding="8px 14px";
      t.style.borderRadius="999px";
      t.style.fontSize="12px";
      t.style.zIndex="9999";
      t.textContent=msg;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(),2400);
    }

    document.getElementById("codeChip").addEventListener("click",()=>{
      const code = elCode.textContent.trim();
      if(code) copyToClipboard(code);
    });

    // Toggle "Come accumulare punti"
    document.getElementById("btnHow").addEventListener("click",()=>{
      const isHidden = (howSection.style.display === "none" || howSection.style.display === "");
      howSection.style.display = isHidden ? "block" : "none";
      if(isHidden){
        howSection.scrollIntoView({behavior:"smooth", block:"start"});
      }
    });

    document.getElementById("btnInvite").addEventListener("click",()=>{
      const code = elCode.textContent.trim();
      const name = elName.textContent.trim() || "un amico";
      const msg = `Ciao! üëã\nSto usando la Fidelity Card Re Long.\n`+
                  `Usa il mio codice invito *${code}* quando ti registri alla Fidelity:\n`+
                  `tu ricevi 40 punti di benvenuto e io ne ricevo 80.\n\n`+
                  `Scopri Re Long e registrati dalla pagina del nostro hub:\n${HUB_URL}`;
      const url = "https://wa.me/?text="+encodeURIComponent(msg);
      window.open(url,"_blank","noopener");
    });

    async function init(){
      if(!idParam){
        errorBox.style.display="block";
        cardInner.style.opacity=".4";
        return;
      }
      try{
        const res = await fetch(DATA_URL,{cache:"no-store"});
        if(!res.ok) throw new Error("HTTP "+res.status);
        const data = await res.json();
        if(!Array.isArray(data)) throw new Error("Formato non valido");
        const item = data.find(x=> String(x.id) === String(idParam));
        if(!item){
          errorBox.style.display="block";
          cardInner.style.opacity=".4";
          return;
        }

        const name = item.name || "Cliente Re Long";
        const pts = Number(item.points || 0);
        const code = item.fidCode || fallbackCodeFromId(item.id);

        elName.textContent = name;
        elSubtitle.textContent = `Ciao ${name.split(" ")[0]}, questa √® la tua Fidelity Card Re Long.`;
        elPoints.textContent = isNaN(pts)? "0" : String(pts);
        elCode.textContent = code;

        const prog = computeProgress(isNaN(pts)?0:pts);
        elNextLabel.textContent = prog.label;
        const ratio = Math.max(0,Math.min(1,prog.ratio));
        requestAnimationFrame(()=>{
          elProgressFill.style.transform = `scaleX(${ratio})`;
        });

        renderTiers(isNaN(pts)?0:pts);
        renderRewards(isNaN(pts)?0:pts);

      }catch(e){
        console.error(e);
        errorBox.style.display="block";
        cardInner.style.opacity=".4";
      }
    }

    init();
  </script>
</body>
</html>
