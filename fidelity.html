<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Re Long • Fidelity Card Digitale</title>
  <meta name="theme-color" content="#05060a" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0;-webkit-font-smoothing:antialiased}
    :root{
      --bg1:#05060a; --bg2:#050913;
      --card:rgba(10,12,20,.96); --stroke:rgba(255,255,255,.10);
      --muted:rgba(210,220,255,.72);
      --gold:#f6c453; --plat:#c77dff; --silver:#b0bec5;
      --accent:#0aa2ff;
    }
    body{
      min-height:100svh;
      font-family:system-ui,-apple-system,Inter,Roboto,sans-serif;
      color:#eef3ff;
      background:
        radial-gradient(circle at 10% 0%, #182848 0, transparent 55%),
        radial-gradient(circle at 100% 100%, #4b6cb7 0, transparent 60%),
        radial-gradient(65% 65% at 25% 15%, var(--bg1), var(--bg2));
      padding:20px 16px 28px;
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .shell{
      width:min(480px,100%);
      margin:0 auto;
    }
    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:26px;
      box-shadow:0 18px 55px rgba(0,0,0,.65);
      padding:20px 18px 20px;
      backdrop-filter:blur(14px);
    }
    .logo-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }
    .logo-row h1{
      font-size:18px;
      font-weight:800;
      letter-spacing:.26px;
    }
    .logo-sub{font-size:12px;color:var(--muted)}
    .badge-store{
      font-size:11px;
      border-radius:999px;
      padding:6px 10px;
      border:1px solid rgba(255,255,255,.16);
      background:radial-gradient(circle at 0 0,rgba(255,255,255,.18),rgba(255,255,255,.03));
      color:#e1e8ff;
      white-space:nowrap;
    }
    .hero{
      margin-top:8px;
      display:flex;
      gap:14px;
      align-items:center;
    }
    .avatar{
      width:68px;height:68px;border-radius:24px;
      background:conic-gradient(from 210deg, #0aa2ff, #f6c453, #c77dff, #0aa2ff);
      padding:2px;
      flex-shrink:0;
    }
    .avatar-inner{
      width:100%;height:100%;border-radius:22px;
      background:radial-gradient(circle at 30% 0%, #20263a, #05060a);
      display:flex;align-items:center;justify-content:center;
      font-size:26px;font-weight:900;
    }
    .hero-main{flex:1;min-width:0}
    .hello{
      font-size:14px;
      color:var(--muted);
      margin-bottom:2px;
    }
    .name{
      font-size:18px;
      font-weight:800;
    }
    .level-pill{
      margin-top:6px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      padding:6px 10px;
      font-size:11px;
      letter-spacing:.2px;
      border:1px solid rgba(255,255,255,.16);
      background:linear-gradient(135deg,rgba(255,255,255,.18),rgba(255,255,255,.04));
    }
    .level-pill span{font-weight:800}
    .level-pill.gold{border-color:rgba(246,196,83,.7);color:var(--gold);}
    .level-pill.platinum{border-color:rgba(199,125,255,.7);color:var(--plat);}
    .level-pill.silver{border-color:rgba(176,190,197,.7);color:var(--silver);}

    .points-card{
      margin-top:18px;
      border-radius:22px;
      padding:14px 14px 16px;
      border:1px solid rgba(0,0,0,.6);
      background:
        radial-gradient(circle at 0 0,rgba(246,196,83,.28),transparent 55%),
        radial-gradient(circle at 100% 100%,rgba(10,162,255,.26),transparent 55%),
        linear-gradient(145deg,#05060a,#101321);
      display:flex;
      align-items:center;
      gap:14px;
    }
    .points-circle{
      width:80px;height:80px;border-radius:999px;
      background:radial-gradient(circle at 30% 0%,rgba(255,255,255,.35),rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.4);
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 10px 30px rgba(0,0,0,.65);
      flex-shrink:0;
    }
    .points-circle span{
      font-size:26px;
      font-weight:900;
      letter-spacing:.4px;
    }
    .points-info{
      flex:1;min-width:0;
    }
    .points-label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.18px}
    .points-main{font-size:18px;font-weight:800;margin-top:2px}
    .next-level{
      margin-top:6px;
      font-size:12px;
      color:#f1f5ff;
    }

    .section{
      margin-top:18px;
      padding-top:10px;
      border-top:1px solid rgba(255,255,255,.08);
    }
    .sec-title{
      font-size:13px;
      font-weight:800;
      text-transform:uppercase;
      letter-spacing:.16px;
      color:var(--muted);
      margin-bottom:8px;
    }

    .rewards{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px;
    }
    @media(max-width:420px){
      .rewards{grid-template-columns:1fr}
    }
    .reward{
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      padding:10px 10px 9px;
      background:linear-gradient(145deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
      font-size:12px;
    }
    .reward-title{font-weight:800;margin-bottom:2px}
    .reward-points{font-size:11px;color:var(--muted)}
    .reward-available{
      margin-top:4px;font-size:11px;
    }
    .reward-available.ok{color:#a5ffb5}
    .reward-available.no{color:#ffb3b3}

    .progress{
      margin-top:10px;
      border-radius:999px;
      height:7px;
      background:rgba(255,255,255,.08);
      overflow:hidden;
    }
    .progress-inner{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,#0aa2ff,#f6c453,#c77dff);
      transition:width .35s ease;
    }

    .history-list{
      display:grid;
      gap:6px;
      font-size:12px;
    }
    .mov{
      display:flex;
      justify-content:space-between;
      gap:6px;
      align-items:flex-start;
    }
    .mov-main{flex:1;min-width:0}
    .mov-reason{font-weight:600}
    .mov-date{font-size:11px;color:var(--muted)}
    .mov-points{
      font-weight:800;
      font-size:12px;
      white-space:nowrap;
    }
    .mov-points.plus{color:#a5ffb5}
    .mov-points.minus{color:#ffb3b3}

    .cta{
      margin-top:16px;
      display:grid;
      gap:8px;
    }
    .btn{
      appearance:none;
      border-radius:999px;
      padding:10px 14px;
      font-weight:800;
      font-size:13px;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(135deg,#0aa2ff,#66d1ff);
      color:#04111a;
      text-align:center;
      text-decoration:none;
      letter-spacing:.2px;
    }
    .btn.ghost{
      background:transparent;
      color:#eaf2ff;
      border-color:rgba(255,255,255,.24);
    }

    .hint{
      margin-top:10px;
      font-size:11px;
      color:var(--muted);
      text-align:center;
    }

    .error{
      text-align:center;
      padding:24px 12px;
      font-size:14px;
      color:#ffb3b3;
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="card" id="card">
      <div id="loading" class="error">Caricamento Fidelity…</div>
    </div>
  </div>

  <script>
    const DATA_URL = "https://raw.githubusercontent.com/alessandroiascone/relong-nfc/main/data/items.json";
    const RELONG_PHONE = "08119578844";

    function getParam(name){
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }
    function fmtDate(d){
      const dt = new Date(d);
      if(isNaN(dt)) return "";
      return dt.toLocaleDateString("it-IT",{day:"2-digit",month:"2-digit",year:"numeric"});
    }
    function ensurePoints(it){
      if(typeof it.points !== "number") it.points = 0;
      if(!Array.isArray(it.pointsHistory)) it.pointsHistory = [];
    }

    const LEVELS = [
      { name:"Silver",  min:0,    max:499,  key:"silver"   },
      { name:"Gold",    min:500,  max:1499, key:"gold"     },
      { name:"Platinum",min:1500, max:9999999, key:"platinum" }
    ];

    const REWARDS = [
      { name:"Pellicola display GRATIS", cost:200 },
      { name:"Cover 50% di sconto", cost:300 },
      { name:"Sconto 15€ su riparazione", cost:600 },
      { name:"Sconto 25€ su riparazione/smartphone", cost:1000 },
      { name:"Premio speciale Re Long", cost:1500 }
    ];

    function computeLevel(points){
      return LEVELS.find(l => points >= l.min && points <= l.max) || LEVELS[LEVELS.length-1];
    }
    function computeNextLevel(points){
      if(points < 500)  return {name:"Gold", at:500};
      if(points < 1500) return {name:"Platinum", at:1500};
      return null;
    }
    function computeNextReward(points){
      const avail = REWARDS.filter(r=>r.cost>points).sort((a,b)=>a.cost-b.cost);
      return avail[0] || null;
    }

    function renderCard(client){
      const card = document.getElementById("card");
      card.innerHTML = "";

      ensurePoints(client);

      const level = computeLevel(client.points);
      const nextLevel = computeNextLevel(client.points);
      const nextReward = computeNextReward(client.points);

      const initial = (client.name || "?").trim().charAt(0).toUpperCase();
      const phone = (client.phone || "").replace(/\D/g,"");
      const waUrl = phone ? `https://wa.me/39${phone}` : `https://wa.me/39${RELONG_PHONE}`;

      const wrap = document.createElement("div");
      wrap.innerHTML = `
        <div class="logo-row">
          <div>
            <h1>Re Long Fidelity</h1>
            <div class="logo-sub">Card punti digitale personale</div>
          </div>
          <div class="badge-store">Re Long • Marano</div>
        </div>

        <div class="hero">
          <div class="avatar">
            <div class="avatar-inner">${initial}</div>
          </div>
          <div class="hero-main">
            <div class="hello">Ciao,</div>
            <div class="name">${client.name || "Cliente Re Long"}</div>
            <div class="level-pill ${level.key}">
              <span>${level.name.toUpperCase()}</span>
              <span>• ${client.points} pt</span>
            </div>
          </div>
        </div>

        <div class="points-card">
          <div class="points-circle">
            <span>${client.points}</span>
          </div>
          <div class="points-info">
            <div class="points-label">Saldo punti</div>
            <div class="points-main">${client.points} punti accumulati</div>
            <div class="next-level" id="nextLevelText"></div>
          </div>
        </div>

        <div class="section">
          <div class="sec-title">Premi disponibili</div>
          <div class="rewards" id="rewards"></div>
        </div>

        <div class="section">
          <div class="sec-title">Il tuo percorso</div>
          <div class="progress"><div class="progress-inner" id="bar"></div></div>
        </div>

        <div class="section">
          <div class="sec-title">Ultimi movimenti</div>
          <div class="history-list" id="history"></div>
        </div>

        <div class="section">
          <div class="sec-title">Contatta Re Long</div>
          <div class="cta">
            <a class="btn" href="${waUrl}" target="_blank" rel="noopener noreferrer">
              Scrivi su WhatsApp
            </a>
            <button class="btn ghost" type="button" id="howBtn">
              Come utilizzare i tuoi punti
            </button>
          </div>
          <div class="hint" id="hint"></div>
        </div>
      `;
      card.appendChild(wrap);

      const nextTxtEl = document.getElementById("nextLevelText");
      if(nextLevel){
        const diff = nextLevel.at - client.points;
        nextTxtEl.textContent = `Ti mancano ${diff} punti per il livello ${nextLevel.name.toUpperCase()}.`;
      }else{
        nextTxtEl.textContent = `Hai raggiunto il livello massimo. Chiedi in negozio i vantaggi esclusivi.`;
      }

      const maxForBar = 1500;
      const bar = document.getElementById("bar");
      const pct = Math.max(0, Math.min(100, (client.points / maxForBar) * 100));
      bar.style.width = pct + "%";

      const rewEl = document.getElementById("rewards");
      REWARDS.forEach(r=>{
        const box = document.createElement("div");
        box.className = "reward";
        const has = client.points >= r.cost;
        const diff = r.cost - client.points;
        box.innerHTML = `
          <div class="reward-title">${r.name}</div>
          <div class="reward-points">${r.cost} punti</div>
          <div class="reward-available ${has?"ok":"no"}">
            ${has ? "Premio disponibile: chiedi in negozio di riscattarlo." : `Ti mancano ${diff} punti.`}
          </div>
        `;
        rewEl.appendChild(box);
      });

      const histEl = document.getElementById("history");
      const hist = (client.pointsHistory || []).slice().sort((a,b)=>new Date(b.at)-new Date(a.at)).slice(0,8);
      if(hist.length===0){
        histEl.innerHTML = `<div class="mov-date">Ancora nessun movimento. I punti si accumulano ad ogni attivazione o servizio Re Long.</div>`;
      }else{
        hist.forEach(m=>{
          const row = document.createElement("div");
          row.className = "mov";
          const sign = m.delta >= 0 ? "+" : "";
          const cls = m.delta >= 0 ? "plus" : "minus";
          row.innerHTML = `
            <div class="mov-main">
              <div class="mov-reason">${m.reason || "Operazione Re Long"}</div>
              <div class="mov-date">${fmtDate(m.at)}</div>
            </div>
            <div class="mov-points ${cls}">${sign}${m.delta} pt</div>
          `;
          histEl.appendChild(row);
        });
      }

      const hint = document.getElementById("hint");
      if(nextReward){
        const diff = nextReward.cost - client.points;
        hint.textContent = `Ti mancano ${diff} punti per: “${nextReward.name}”.`;
      }else{
        hint.textContent = `Hai punti sufficienti per almeno un premio. Chiedi ad Alessandro come usarli.`;
      }

      const howBtn = document.getElementById("howBtn");
      howBtn.addEventListener("click", ()=>{
        alert("I punti si accumulano con attivazioni, acquisti e riparazioni presso Re Long.\n\nPuoi usarli per sconti, pellicole, cover o premi dedicati.\nChiedi in negozio come riscattare i tuoi punti.");
      });
    }

    (async function init(){
      const card = document.getElementById("card");
      const loading = document.getElementById("loading");
      const id = getParam("id");
      if(!id){
        loading.textContent = "Nessun cliente associato a questa card. Contatta Re Long per attivare la Fidelity.";
        return;
      }
      try{
        const res = await fetch(DATA_URL,{cache:"no-store"});
        if(!res.ok) throw new Error("HTTP "+res.status);
        const json = await res.json();
        const items = Array.isArray(json)? json : [];
        let client = items.find(x=> String(x.id)===String(id));
        if(!client){
          loading.textContent = "Cliente non trovato. Potrebbe essere stata aggiornata la card. Contatta Re Long.";
          return;
        }
        renderCard(client);
      }catch(e){
        console.error(e);
        loading.textContent = "Errore nel caricamento dati Fidelity. Riprova più tardi o contatta Re Long.";
      }
    })();
  </script>
</body>
</html>
