<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Re Long ‚Ä¢ Fidelity Card</title>
  <meta name="theme-color" content="#05060a" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0;-webkit-font-smoothing:antialiased}
    :root{
      --bg1:#05060a; --bg2:#020308;
      --card:rgba(10,12,20,.96); --stroke:rgba(255,255,255,.09);
      --muted:rgba(210,220,255,.72);
      --accent:#ffd700; --accent2:#ffb347; --accent3:#fff4c2;
      --elec:#0aa2ff; --danger:#ff4d4f;
    }
    body{
      min-height:100svh;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Inter",Roboto,sans-serif;
      color:#eef3ff;
      background:
        radial-gradient(80% 80% at 10% 0%,rgba(0,140,255,.16),transparent),
        radial-gradient(70% 80% at 90% 0%,rgba(255,215,0,.13),transparent),
        linear-gradient(180deg,var(--bg1),var(--bg2));
      padding:24px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }
    .wrap{
      width:100%;
      max-width:480px;
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    .card{
      background:var(--card);
      border-radius:22px;
      border:1px solid var(--stroke);
      box-shadow:0 20px 60px rgba(0,0,0,.65);
      padding:18px 18px 20px;
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(circle at 0 0,rgba(0,140,255,.18),transparent 60%),
        radial-gradient(circle at 100% 0,rgba(255,215,0,.18),transparent 60%);
      opacity:.6;
      pointer-events:none;
    }
    .card-inner{position:relative;z-index:1}
    .logo-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .logo-main{
      font-weight:900;
      letter-spacing:.18em;
      text-transform:uppercase;
      font-size:14px;
    }
    .logo-main span{
      padding:3px 8px;
      border-radius:999px;
      background:linear-gradient(135deg,#ff3b3b,#ff9f1a);
      margin-right:6px;
      box-shadow:0 0 12px rgba(255,120,60,.65);
    }
    .fidelity-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,215,0,.8);
      background:linear-gradient(135deg,rgba(255,215,0,.2),rgba(10,12,20,1));
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--accent3);
      position:relative;
      overflow:hidden;
      margin-bottom:4px;
    }
    .fidelity-badge::after{
      content:"";
      position:absolute;
      inset:-40%;
      background:conic-gradient(from 0deg,rgba(255,255,255,.2),transparent 40%,transparent 60%,rgba(255,255,255,.25));
      mix-blend-mode:screen;
      animation:spin 6s linear infinite;
      opacity:.7;
      pointer-events:none;
    }
    .fidelity-badge span{
      position:relative;
      z-index:1;
    }

    /* Badge livello Fidelity */
    .level-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      margin-top:4px;
    }
    .lvl-bronze{
      border-color:#cd7f32;
      background:linear-gradient(135deg,rgba(205,127,50,.22),rgba(0,0,0,.9));
      color:#ffe9d0;
    }
    .lvl-silver{
      border-color:#c0c0c0;
      background:linear-gradient(135deg,rgba(192,192,192,.24),rgba(0,0,0,.9));
      color:#f5f7ff;
    }
    .lvl-gold{
      border-color:#ffd700;
      background:linear-gradient(135deg,rgba(255,215,0,.3),rgba(0,0,0,.9));
      color:#fff9d6;
    }
    .lvl-black{
      border-color:#ffffff;
      background:linear-gradient(135deg,#000000,#282828);
      color:#ffffff;
    }

    @keyframes spin{
      to{transform:rotate(360deg);}
    }

    h1{
      font-size:20px;
      margin-bottom:4px;
    }
    .subtitle{
      font-size:13px;
      color:var(--muted);
      margin-bottom:12px;
    }

    .code-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin:10px 0 6px;
    }

    /* CODICE INVITO MOLTO VISIBILE */
    .code-chip{
      border-radius:999px;
      border:1px solid rgba(255,215,0,1);
      padding:8px 14px;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      color:#2b1900;
      box-shadow:
        0 0 22px rgba(255,215,0,.9),
        0 0 2px rgba(0,0,0,.8);
    }
    .code-chip strong{
      letter-spacing:.20em;
      font-family:monospace;
      font-size:15px;
    }
    .code-chip small{
      font-size:10px;
      color:#2b1900;
      text-transform:uppercase;
      opacity:.9;
    }
    .code-chip:hover{
      box-shadow:
        0 0 30px rgba(255,215,0,1),
        0 0 6px rgba(0,0,0,1);
      transform:translateY(-1px);
    }

    .points-pill{
      border-radius:999px;
      border:1px solid rgba(0,140,255,.4);
      padding:4px 10px;
      font-size:12px;
      background:linear-gradient(135deg,rgba(0,140,255,.25),rgba(0,0,0,.7));
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .progress-wrap{
      margin:10px 0 14px;
    }
    .progress-label{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:11px;
      color:var(--muted);
      margin-bottom:4px;
    }
    .progress-bar{
      position:relative;
      height:10px;
      border-radius:999px;
      background:rgba(255,255,255,.04);
      overflow:hidden;
    }
    .progress-bar span{
      position:absolute;
      inset:0;
      transform-origin:left center;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      box-shadow:0 0 18px rgba(255,215,0,.75);
      transform:scaleX(0);
    }
    .tiers{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:8px;
    }
    .tier{
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      padding:4px 9px;
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:4px;
      color:var(--muted);
    }
    .tier strong{color:#fff;}
    .tier.active{
      border-color:rgba(255,215,0,.9);
      color:var(--accent3);
      background:radial-gradient(circle at 0 0,rgba(255,215,0,.35),rgba(0,0,0,.9));
      position:relative;
      overflow:hidden;
    }
    .tier.active::after{
      content:"";
      position:absolute;
      inset:-40%;
      background:conic-gradient(from 0deg,rgba(255,255,255,.4),transparent 40%,transparent 60%,rgba(255,255,255,.6));
      mix-blend-mode:screen;
      animation:spin 4s linear infinite;
      opacity:.6;
    }
    .tier span.label{position:relative;z-index:1;}

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin:14px 0 6px;
    }
    .btn{
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      padding:9px 14px;
      font-size:13px;
      font-weight:700;
      cursor:pointer;
      background:rgba(0,0,0,.7);
      color:#f5f6ff;
      display:inline-flex;
      align-items:center;
      gap:8px;
      flex:1 1 0;
      justify-content:center;
      text-align:center;
      min-width:0;
    }
    .btn span.icon{font-size:16px}
    .btn-primary{
      border-color:rgba(255,215,0,.9);
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      color:#2b1900;
      box-shadow:0 10px 26px rgba(0,0,0,.7),0 0 18px rgba(255,215,0,.8);
    }

    /* Effetto neon per "Porta un amico" */
    @keyframes neonPulse{
      0%{
        box-shadow:
          0 0 10px rgba(255,255,180,.7),
          0 0 24px rgba(255,215,0,.6),
          0 0 0 rgba(255,215,0,.0);
        transform:translateY(0);
      }
      100%{
        box-shadow:
          0 0 16px rgba(255,255,210,1),
          0 0 40px rgba(255,215,0,1),
          0 0 70px rgba(255,215,0,.9);
        transform:translateY(-1px);
      }
    }
    #btnInvite{
      position:relative;
      overflow:hidden;
      animation:neonPulse 1.7s ease-in-out infinite alternate;
    }
    #btnInvite::after{
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at 0 0,rgba(255,255,255,.5),transparent 55%);
      opacity:.4;
      mix-blend-mode:screen;
      pointer-events:none;
    }

    /* Effetto bordo gold lampeggiante per "Come accumulare punti" */
    @keyframes goldGlow{
      0%{
        box-shadow:0 0 0 rgba(255,215,0,0);
      }
      50%{
        box-shadow:
          0 0 10px rgba(255,215,0,.4),
          0 0 22px rgba(255,215,0,.7);
      }
      100%{
        box-shadow:0 0 0 rgba(255,215,0,0);
      }
    }
    #btnHow{
      border-color:rgba(255,215,0,.85);
      background:linear-gradient(135deg,rgba(255,215,0,.12),rgba(0,0,0,.9));
      animation:goldGlow 2.4s ease-in-out infinite;
    }

    .section{
      background:rgba(5,7,14,.9);
      border-radius:20px;
      border:1px solid rgba(255,255,255,.06);
      padding:14px 14px 15px;
    }

    /* Toggle sezioni con RADIO */
    .section-toggle{
      display:none;
    }
    .section-header{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      background:transparent;
      border:none;
      padding:2px 0 4px;
      cursor:pointer;
    }
    .section-title{
      font-size:15px;
      font-weight:600;
      text-align:left;
    }
    .section-chevron{
      font-size:14px;
      transition:transform .2s ease;
    }
    .section-body{
      margin-top:6px;
      display:none;
    }
    /* quando il radio √® checked, mostra il body */
    .section-toggle:checked + .section-header + .section-body{
      display:block;
    }
    .section-toggle:checked + .section-header .section-chevron{
      transform:rotate(180deg);
    }

    .section p{
      font-size:13px;
      color:var(--muted);
      margin-bottom:6px;
      line-height:1.4;
    }
    .rewards-list{
      margin-top:6px;
      display:grid;
      gap:6px;
      font-size:13px;
    }
    .reward{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      padding:6px 8px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.6);
    }
    .reward strong{
      font-size:13px;
    }
    .reward small{
      font-size:11px;
      color:var(--muted);
    }
    .reward.unlocked{
      border-color:rgba(0,200,120,.9);
      background:linear-gradient(135deg,rgba(0,200,120,.3),rgba(0,0,0,.8));
    }
    .reward.next{
      border-color:rgba(255,215,0,.9);
      background:linear-gradient(135deg,rgba(255,215,0,.24),rgba(0,0,0,.8));
    }

    .how-grid{
      margin-top:8px;
      display:grid;
      gap:4px;
    }
    .how-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      font-size:13px;
      padding:4px 2px;
    }
    .how-row span.label{
      color:#f7f7ff;
    }
    .how-row span.points{
      font-weight:700;
      color:var(--accent3);
    }
    .how-row span.points small{
      font-size:11px;
      color:var(--muted);
      margin-left:2px;
    }

    .small-note{
      font-size:11px;
      color:var(--muted);
      margin-top:6px;
    }

    /* Sezione missioni */
    .missions-list{
      margin-top:8px;
      display:grid;
      gap:8px;
    }
    .mission-card{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.75);
      padding:8px 10px;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .mission-icon{
      font-size:18px;
      line-height:1;
      margin-top:2px;
    }
    .mission-body{
      flex:1;
    }
    .mission-title{
      font-size:13px;
      font-weight:700;
      margin-bottom:2px;
    }
    .mission-desc{
      font-size:12px;
      color:var(--muted);
      margin-bottom:2px;
    }
    .mission-bonus{
      font-size:12px;
      font-weight:700;
      color:var(--accent3);
    }

    /* STORICO PUNTI */
    .history-list{
      margin-top:8px;
      display:grid;
      gap:6px;
      max-height:260px;
      overflow:auto;
      padding-right:3px;
    }
    .history-item{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
      padding:6px 8px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.65);
      font-size:12px;
    }
    .history-main{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .history-main strong{
      font-size:12px;
    }
    .history-main small{
      font-size:11px;
      color:var(--muted);
    }
    .history-pts{
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
      align-self:center;
    }
    .history-pts.hist-plus{
      color:#7CFFB2;
    }
    .history-pts.hist-minus{
      color:#ff8c8c;
    }

    .error{
      text-align:center;
      color:var(--muted);
      font-size:14px;
      margin-top:20px;
    }

    @media (max-width:600px){
      body{padding:16px;}
      .card{padding:16px;}
      .wrap{gap:14px;}
    }

    /* Mini banner verso hub */
    .mini-banner{
      margin-top:8px;
      font-size:11px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(0,140,255,.5);
      background:linear-gradient(135deg,rgba(0,140,255,.22),rgba(0,0,0,.9));
      color:#e4f1ff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .mini-banner a{
      font-weight:700;
      font-size:11px;
      text-decoration:none;
      color:#fff;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(0,0,0,.7);
      border:1px solid rgba(255,255,255,.2);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="card-inner" id="cardInner">
        <div class="logo-row">
          <div class="logo-main"><span>Re</span>LONG</div>
          <div>
            <div class="fidelity-badge">
              <span>Fidelity Premium</span>
            </div>
            <div id="levelPill" class="level-pill lvl-bronze">
              ü•â Livello: BRONZE
            </div>
          </div>
        </div>

        <div style="
          margin-top:6px;
          font-size:11px;
          padding:6px 10px;
          border-radius:12px;
          background:rgba(255,215,0,.12);
          border:1px solid rgba(255,215,0,.35);
          color:var(--accent3);
          text-align:center;
          letter-spacing:.3px;
          backdrop-filter:blur(4px);
          max-width:100%;
        ">
          ‚≠ê Porta un amico = punti extra per entrambi ‚≠ê
        </div>

        <div class="mini-banner">
          <span>Vuoi scoprire tutti i servizi Re Long?</span>
          <a href="https://alessandroiascone.github.io/relong-nfc/relong-hub-v2.html" target="_blank" rel="noopener">Portami al sito</a>
        </div>

        <div id="headerInfo">
          <h1 id="clientName">Fidelity Card</h1>
          <div class="subtitle" id="subtitle">
            Accumula punti per ogni servizio Re Long e trasformali in premi tecnologici.
          </div>

          <div class="code-row">
            <div style="display:flex;flex-direction:column;gap:2px;">
              <button class="code-chip" id="codeChip" type="button">
                <div>
                  <small>Codice invito</small><br>
                  <strong id="codeValue">000000</strong>
                </div>
              </button>
              <small style="font-size:10px;color:var(--muted);margin-left:6px;">
                Tocca per copiare il codice
              </small>
            </div>
            <div class="points-pill">
              <span>‚≠ê Punti attuali:</span>
              <strong id="pointsValue">0</strong>
            </div>
          </div>

          <div class="progress-wrap">
            <div class="progress-label">
              <span>Progresso verso il prossimo premio</span>
              <span id="nextLabel">0 / 150 pt</span>
            </div>
            <div class="progress-bar">
              <span id="progressFill"></span>
            </div>
            <div class="tiers" id="tiersRow"></div>
          </div>

          <div class="btn-row">
            <button class="btn btn-primary" id="btnInvite" type="button">
              <span class="icon">üí¨</span>
              <span>Porta un amico</span>
            </button>
            <button class="btn" id="btnHow" type="button">
              <span class="icon">üìà</span>
              <span>Come accumulare punti</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- SEZIONE PREMI -->
    <div class="section" id="rewardsSection">
      <input type="radio" name="fidSection" id="secRewards" class="section-toggle" checked>
      <label class="section-header" for="secRewards">
        <span class="section-title">Premi disponibili</span>
        <span class="section-chevron">‚ñæ</span>
      </label>
      <div class="section-body" id="rewardsBody">
        <p>Ogni volta che raggiungi una soglia punti, puoi scegliere il premio corrispondente.</p>
        <div class="rewards-list" id="rewardsList"></div>
        <p class="small-note">
          I premi sono soggetti a disponibilit√† in negozio. In caso di mancanza di uno specifico modello,
          ti proporremo un prodotto equivalente o superiore.
        </p>
      </div>
    </div>

    <!-- SEZIONE STORICO PUNTI -->
    <div class="section" id="historySection" style="display:none">
      <input type="radio" name="fidSection" id="secHistory" class="section-toggle">
      <label class="section-header" for="secHistory">
        <span class="section-title">Storico movimenti punti</span>
        <span class="section-chevron">‚ñæ</span>
      </label>
      <div class="section-body" id="historyBody">
        <p>
          Qui trovi tutti i punti caricati o scalati dalla tua Fidelity Card, con la motivazione associata.
        </p>
        <div class="history-list" id="historyList"></div>
        <p class="small-note">
          Lo storico √® in ordine dal movimento pi√π recente al pi√π vecchio.
        </p>
      </div>
    </div>

    <!-- SEZIONE COME ACCUMULARE PUNTI -->
    <div class="section" id="howPoints" style="display:none">
      <h2 class="section-title" style="margin-bottom:6px;">Come accumulare punti</h2>
      <p>
        Usa la tua Fidelity Card ogni volta che attivi un servizio o fai un acquisto da Re Long:
        i punti si sommano e ti avvicinano ai premi.
      </p>
      <div class="how-grid">
        <div class="how-row">
          <span class="label">Riparazione computer</span>
          <span class="points">+50 <small>punti</small></span>
        </div>
        <div class="how-row">
          <span class="label">Riparazione smartphone</span>
          <span class="points">+25 <small>punti</small></span>
        </div>
        <div class="how-row">
          <span class="label">Kit 4 cartucce compatibili</span>
          <span class="points">+5 <small>punti</small></span>
        </div>
        <div class="how-row">
          <span class="label">Toner compatibile</span>
          <span class="points">+10 <small>punti</small></span>
        </div>
        <div class="how-row">
          <span class="label">Linea fissa</span>
          <span class="points">+80 <small>punti</small></span>
        </div>
        <div class="how-row">
          <span class="label">SIM mobile</span>
          <span class="points">+30 <small>punti</small></span>
        </div>
        <div class="how-row">
          <span class="label">Luce & Gas</span>
          <span class="points">+100 <small>punti</small></span>
        </div>
        <div class="how-row">
          <span class="label">Porta un amico (chi presenta)</span>
          <span class="points">+80 <small>punti</small></span>
        </div>
        <div class="how-row">
          <span class="label">Nuovo cliente iscritto con codice amico</span>
          <span class="points">+40 <small>punti</small></span>
        </div>
      </div>

      <p class="small-note">
        Ricorda di far associare sempre la tua Fidelity Card (o il tuo codice) ad ogni pratica:
        pacchi, riparazioni, telefonia, energia e promozioni ‚ÄúPorta un amico‚Äù.
      </p>
    </div>

    <!-- SEZIONE MISSIONI -->
    <div class="section" id="missionsSection" style="display:none">
      <input type="radio" name="fidSection" id="secMissions" class="section-toggle">
      <label class="section-header" for="secMissions">
        <span class="section-title">Missioni attive per te</span>
        <span class="section-chevron">‚ñæ</span>
      </label>
      <div class="section-body" id="missionsBody">
        <p>
          Completa queste missioni per far crescere pi√π velocemente i tuoi punti Fidelity.
          Mostra questa schermata in negozio e aggiorneremo la card insieme.
        </p>
        <div class="missions-list" id="missionsList"></div>
      </div>
    </div>

    <div id="errorBox" class="error" style="display:none">
      Impossibile trovare i dati della tua Fidelity Card.<br/>
      Contatta Re Long per attivare o verificare la card.
    </div>
  </div>

  <script>
    const HUB_URL = "https://alessandroiascone.github.io/relong-nfc/relong-hub-v2.html";
    const DATA_URL = "https://raw.githubusercontent.com/alessandroiascone/relong-nfc/main/data/items.json";

    const rewardsConfig = [
      { threshold:150, label:"Pellicola Gel Ultra Crystal Premium Quality" },
      { threshold:300, label:"Powerbank 5000 mAh First Rapid Charge" },
      { threshold:600, label:"Cuffie Bluetooth Pods" },
      { threshold:1000, label:"Smartwatch Square BT con funzione chiamata" },
      { threshold:1500, label:"Occhiali Smart (musica & chiamate)" }
    ];

    const qs = new URLSearchParams(location.search);
    const idParam = qs.get("id");

    const elName = document.getElementById("clientName");
    const elSubtitle = document.getElementById("subtitle");
    const elPoints = document.getElementById("pointsValue");
    const elCode = document.getElementById("codeValue");
    const elNextLabel = document.getElementById("nextLabel");
    const elProgressFill = document.getElementById("progressFill");
    const elTiersRow = document.getElementById("tiersRow");
    const elRewardsList = document.getElementById("rewardsList");
    const errorBox = document.getElementById("errorBox");
    const cardInner = document.getElementById("cardInner");
    const howSection = document.getElementById("howPoints");
    const levelPill = document.getElementById("levelPill");
    const missionsSection = document.getElementById("missionsSection");
    const missionsList = document.getElementById("missionsList");
    const historySection = document.getElementById("historySection");
    const historyList = document.getElementById("historyList");

    function fallbackCodeFromId(id){
      const digits = String(id||"").replace(/\D/g,"") || String(Date.now());
      const last6 = digits.slice(-6);
      return last6.padStart(6,"0");
    }

    // Livello Fidelity (stessa logica del gestionale)
    function getLevel(points){
      const p = Number(points||0);
      if(p>=1000) return {name:'BLACK', emoji:'üñ§', class:'lvl-black', min:1000, next:null};
      if(p>=500)  return {name:'GOLD',  emoji:'ü•á', class:'lvl-gold',  min:500,  next:1000};
      if(p>=150)  return {name:'SILVER',emoji:'ü•à', class:'lvl-silver',min:150,  next:500};
      return {name:'BRONZE',emoji:'ü•â', class:'lvl-bronze',min:0,    next:150};
    }

    function computeProgress(points){
      let currentTier = null;
      let nextTier = null;
      for(const r of rewardsConfig){
        if(points >= r.threshold){
          currentTier = r;
        }else{
          nextTier = r;
          break;
        }
      }
      if(!nextTier){
        return {
          current: currentTier,
          next: null,
          ratio:1,
          label:`${points} pt ‚Ä¢ hai sbloccato tutti i premi`
        };
      }
      const base = currentTier ? currentTier.threshold : 0;
      const span = nextTier.threshold - base;
      const clamped = Math.max(0, Math.min(points - base, span));
      const ratio = span>0 ? (clamped/span) : 0;
      return {
        current: currentTier,
        next: nextTier,
        ratio,
        label:`${points} / ${nextTier.threshold} pt`
      };
    }

    function renderTiers(points){
      elTiersRow.innerHTML = "";
      rewardsConfig.forEach(r=>{
        const div = document.createElement("div");
        const unlocked = points >= r.threshold;
        div.className = "tier" + (unlocked ? " active" : "");
        div.innerHTML = `<span class="label"><strong>${r.threshold} pt</strong> ‚Ä¢ ${r.label}</span>`;
        elTiersRow.appendChild(div);
      });
    }

    function renderRewards(points){
      elRewardsList.innerHTML = "";
      let nextAssigned = false;
      rewardsConfig.forEach(r=>{
        const div = document.createElement("div");
        div.className = "reward";

        if(points >= r.threshold){
          div.classList.add("unlocked");
        }else if(!nextAssigned){
          div.classList.add("next");
          nextAssigned = true;
        }

        div.innerHTML = `
          <div>
            <strong>${r.threshold} punti</strong><br/>
            <small>${r.label}</small>
          </div>
          <div>
            ${points >= r.threshold ? "‚úÖ" : "üéØ"}
          </div>
        `;
        elRewardsList.appendChild(div);
      });
    }

    function copyToClipboard(text){
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).then(()=>{
          toast("Codice copiato negli appunti ‚úÖ");
        }).catch(()=>{});
      }
    }

    function toast(msg){
      const t = document.createElement("div");
      t.style.position="fixed";
      t.style.left="50%";
      t.style.bottom="18px";
      t.style.transform="translateX(-50%)";
      t.style.background="rgba(0,0,0,.9)";
      t.style.border="1px solid rgba(255,255,255,.25)";
      t.style.color="#fff";
      t.style.padding="8px 14px";
      t.style.borderRadius="999px";
      t.style.fontSize="12px";
      t.style.zIndex="9999";
      t.textContent=msg;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(),2400);
    }

    document.getElementById("codeChip").addEventListener("click",()=>{
      const code = elCode.textContent.trim();
      if(code) copyToClipboard(code);
    });

    // Toggle "Come accumulare punti"
    document.getElementById("btnHow").addEventListener("click",()=>{
      const isHidden = (howSection.style.display === "none" || howSection.style.display === "");
      howSection.style.display = isHidden ? "block" : "none";
      if(isHidden){
        howSection.scrollIntoView({behavior:"smooth", block:"start"});
      }
    });

    document.getElementById("btnInvite").addEventListener("click",()=>{
      const code = elCode.textContent.trim();
      const name = elName.textContent.trim() || "un amico";
      const msg = `Ciao! üëã\nSto usando la Fidelity Card Re Long.\n`+
                  `Usa il mio codice invito *${code}* quando ti registri alla Fidelity:\n`+
                  `tu ricevi 40 punti di benvenuto e io ne ricevo 80.\n\n`+
                  `Scopri Re Long e registrati dalla pagina del nostro hub:\n${HUB_URL}`;
      const url = "https://wa.me/?text="+encodeURIComponent(msg);
      window.open(url,"_blank","noopener");
    });

    function renderMissions(item, points){
      missionsList.innerHTML = "";
      let missions = [];

      const acts = new Set(item.activated || []);
      const hasEnergia = acts.has("energia");
      const hasSim = acts.has("sim");
      const hasRip = !!item.acceptance || acts.has("riparazione");
      const lvl = getLevel(points);

      if(!hasEnergia){
        missions.push({
          icon:"‚ö°",
          title:"Missione Energia",
          desc:"Attiva una fornitura Luce & Gas con Re Long e porta la tua Fidelity al livello successivo.",
          bonus:"+100 punti Fidelity"
        });
      }

      if(!hasSim){
        missions.push({
          icon:"üì∂",
          title:"Missione SIM",
          desc:"Attiva una SIM mobile con Re Long e abbina minuti e Giga alle tue esigenze.",
          bonus:"+30 punti Fidelity"
        });
      }

      if(!hasRip){
        missions.push({
          icon:"üîß",
          title:"Missione Assistenza",
          desc:"Porta uno smartphone o un PC in laboratorio per una diagnosi o riparazione.",
          bonus:"+25 punti Fidelity"
        });
      }

      missions.push({
        icon:"üë•",
        title:"Missione Porta un amico",
        desc:"Fai registrare un nuovo cliente usando il tuo codice invito Fidelity.",
        bonus:"+80 punti per te, +40 punti per il tuo amico"
      });

      if(lvl.name === "BRONZE" || lvl.name === "SILVER"){
        const toNext = lvl.next ? (lvl.next - points) : 0;
        if(toNext > 0){
          missions.push({
            icon:"üöÄ",
            title:`Obiettivo livello successivo`,
            desc:`Ti mancano circa ${toNext} punti per arrivare a ${lvl.name === "BRONZE" ? "SILVER" : "GOLD"}. Chiedi in negozio come accumularli pi√π velocemente.`,
            bonus:`Ancora ~${toNext} punti`
          });
        }
      }

      if(!missions.length){
        missionsSection.style.display = "none";
        return;
      }

      missionsSection.style.display = "block";
      missions.forEach(m=>{
        const div = document.createElement("div");
        div.className = "mission-card";
        div.innerHTML = `
          <div class="mission-icon">${m.icon}</div>
          <div class="mission-body">
            <div class="mission-title">${m.title}</div>
            <div class="mission-desc">${m.desc}</div>
            <div class="mission-bonus">${m.bonus}</div>
          </div>
        `;
        missionsList.appendChild(div);
      });
    }

    function formatDate(it){
      if(!it) return "";
      try{
        return new Date(it).toLocaleString("it-IT",{
          day:"2-digit",
          month:"2-digit",
          year:"numeric"
        });
      }catch(e){
        return "";
      }
    }

    function renderHistory(movements){
      if(!Array.isArray(movements) || !movements.length){
        historySection.style.display = "none";
        return;
      }
      historySection.style.display = "block";
      historyList.innerHTML = "";

      const sorted = [...movements].sort((a,b)=>{
        const da = new Date(a.at || 0).getTime();
        const db = new Date(b.at || 0).getTime();
        return db - da;
      });

      sorted.forEach(m=>{
        const row = document.createElement("div");
        row.className = "history-item";

        const main = document.createElement("div");
        main.className = "history-main";

        const label = document.createElement("strong");
        label.textContent = m.label || "Movimento punti";

        const date = document.createElement("small");
        const d = formatDate(m.at);
        date.textContent = d ? d : "";

        main.appendChild(label);
        if(d){ main.appendChild(date); }

        const pts = document.createElement("div");
        pts.className = "history-pts";
        const delta = Number(m.delta || 0);
        const sign = delta > 0 ? "+" : "";
        pts.textContent = `${sign}${delta} pt`;
        if(delta > 0) pts.classList.add("hist-plus");
        else if(delta < 0) pts.classList.add("hist-minus");

        row.appendChild(main);
        row.appendChild(pts);
        historyList.appendChild(row);
      });
    }

    async function init(){
      if(!idParam){
        errorBox.style.display="block";
        cardInner.style.opacity=".4";
        return;
      }
      try{
        const res = await fetch(DATA_URL,{cache:"no-store"});
        if(!res.ok) throw new Error("HTTP "+res.status);
        const data = await res.json();
        if(!Array.isArray(data)) throw new Error("Formato non valido");
        const item = data.find(x=> String(x.id) === String(idParam));
        if(!item){
          errorBox.style.display="block";
          cardInner.style.opacity=".4";
          return;
        }

        const name = item.name || "Cliente Re Long";
        const pts = Number(item.points || 0);
        const code = item.fidCode || fallbackCodeFromId(item.id);

        elName.textContent = name;
        elSubtitle.textContent = `Ciao ${name.split(" ")[0]}, questa √® la tua Fidelity Card Re Long.`;
        elPoints.textContent = isNaN(pts)? "0" : String(pts);
        elCode.textContent = code;

        // Livello visivo
        const lvl = getLevel(isNaN(pts)?0:pts);
        if(levelPill){
          levelPill.textContent = `${lvl.emoji} Livello: ${lvl.name}`;
          levelPill.className = "level-pill " + lvl.class;
        }

        const prog = computeProgress(isNaN(pts)?0:pts);
        elNextLabel.textContent = prog.label;
        const ratio = Math.max(0,Math.min(1,prog.ratio));
        requestAnimationFrame(()=>{
          elProgressFill.style.transform = `scaleX(${ratio})`;
        });

        renderTiers(isNaN(pts)?0:pts);
        renderRewards(isNaN(pts)?0:pts);
        renderMissions(item, isNaN(pts)?0:pts);
        renderHistory(item.pointsMovements || []);

      }catch(e){
        console.error(e);
        errorBox.style.display="block";
        cardInner.style.opacity=".4";
      }
    }

    init();
  </script>
</body>
</html>
