<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Re Long • Fidelity Premium</title>
  <meta name="theme-color" content="#05060a" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0;-webkit-font-smoothing:antialiased}
    :root{
      --bg1:#05060a; --bg2:#050712;
      --card:rgba(10,12,20,.96); --stroke:rgba(255,255,255,.08);
      --muted:rgba(210,220,255,.70);
      --elec:#0aa2ff; --elec2:#66d1ff; --elec3:#008cff;
      --gold1:#f7d774; --gold2:#f1b84a; --danger:#ff4d4f;
    }
    body{
      min-height:100svh;
      font-family:system-ui,-apple-system,Inter,Roboto,sans-serif;
      color:#eef3ff;
      background:radial-gradient(80% 80% at 20% 0%,#101523,#05060a);
      padding:18px 16px 28px;
      display:flex;
      justify-content:center;
    }
    .shell{
      width:100%;
      max-width:900px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:22px;
      box-shadow:0 12px 40px rgba(0,0,0,.65);
      padding:18px 18px 20px;
    }
    .card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:12px;
    }
    .brand-lockup{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo-badge{
      width:42px; height:42px;
      border-radius:15px;
      background:conic-gradient(from 210deg,var(--gold1),var(--gold2),#fff3b0,var(--gold2),var(--gold1));
      padding:2px;
      position:relative;
      overflow:hidden;
      animation:spinBadge 9s linear infinite;
    }
    .logo-inner{
      width:100%; height:100%;
      border-radius:13px;
      background:radial-gradient(circle at 20% 0%,#ffffff44,rgba(0,0,0,.9));
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
      font-size:15px;
      letter-spacing:.5px;
    }
    .logo-inner span{
      background:-webkit-linear-gradient(120deg,var(--gold1),var(--gold2));
      -webkit-background-clip:text;
      color:transparent;
    }
    @keyframes spinBadge{
      0%{transform:rotate(0deg)}
      100%{transform:rotate(360deg)}
    }
    .title-main{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .title-main h1{
      font-size:18px;
      font-weight:800;
      letter-spacing:.4px;
    }
    .title-main .sub{
      font-size:12px;
      color:var(--muted);
    }
    .status-chip{
      border-radius:999px;
      padding:6px 10px;
      font-size:11px;
      font-weight:700;
      border:1px solid rgba(247,215,116,.6);
      background:linear-gradient(135deg,rgba(247,215,116,.06),rgba(247,215,116,.16));
      display:flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .pulse-dot{
      width:8px;height:8px;border-radius:50%;
      background:var(--gold1);
      box-shadow:0 0 0 0 rgba(247,215,116,.7);
      animation:pulse 1.6s infinite;
    }
    @keyframes pulse{
      0%{transform:scale(.7);box-shadow:0 0 0 0 rgba(247,215,116,.7);}
      70%{transform:scale(1);box-shadow:0 0 0 8px rgba(247,215,116,0);}
      100%{transform:scale(.7);box-shadow:0 0 0 0 rgba(247,215,116,0);}
    }

    .points-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px 18px;
      align-items:flex-end;
      margin-bottom:14px;
    }
    .points-main{
      display:flex;
      align-items:baseline;
      gap:6px;
    }
    #pointsValue{
      font-size:28px;
      font-weight:900;
    }
    .points-main span{
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:.18px;
      color:var(--muted);
    }
    .mini-counter{
      font-size:12px;
      color:var(--muted);
    }

    .progress-wrap{
      margin-top:6px;
    }
    .progress-bar{
      width:100%;height:8px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      overflow:hidden;
      position:relative;
    }
    .progress-fill{
      height:100%;
      width:0%;
      border-radius:999px;
      background:linear-gradient(90deg,var(--elec3),var(--elec),var(--elec2));
      box-shadow:0 0 12px rgba(0,140,255,.8);
      transition:width .5s ease;
    }
    .progress-label{
      margin-top:4px;
      font-size:11px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
    }

    .id-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      align-items:center;
    }
    .code-pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(102,209,255,.65);
      background:linear-gradient(135deg,rgba(0,140,255,.08),rgba(0,140,255,.15));
      font-weight:700;
      letter-spacing:.2px;
      font-size:12px;
    }

    .section-title{
      font-size:14px;
      font-weight:800;
      letter-spacing:.25px;
      margin-bottom:8px;
    }
    .section-sub{
      font-size:12px;
      color:var(--muted);
      margin-bottom:12px;
    }

    .btn, .chip-btn{
      border-radius:999px;
      border:1px solid var(--stroke);
      padding:9px 13px;
      font-size:12px;
      font-weight:700;
      letter-spacing:.2px;
      background:transparent;
      color:#eef3ff;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      text-decoration:none;
    }
    .btn.primary{
      border:0;
      background:linear-gradient(135deg,var(--elec3),var(--elec2));
      box-shadow:0 8px 26px rgba(0,140,255,.4);
      color:#04121f;
    }
    .chip-btn{
      padding:7px 11px;
      font-size:11px;
      border-color:rgba(255,255,255,.16);
      background:rgba(255,255,255,.03);
    }
    .chip-btn.active{
      background:linear-gradient(135deg,var(--elec3),var(--elec2));
      color:#04121f;
      border-color:transparent;
    }

    .chips-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }

    .two-col{
      display:grid;
      grid-template-columns:2.1fr 1.4fr;
      gap:14px;
    }
    @media(max-width:780px){
      .two-col{grid-template-columns:1fr}
    }

    .friend-box{
      border-radius:18px;
      border:1px dashed rgba(247,215,116,.5);
      padding:12px 12px 12px;
      background:linear-gradient(135deg,rgba(247,215,116,.09),rgba(10,12,20,.4));
    }
    .friend-main{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:8px;
    }
    .friend-main strong{font-size:13px}
    .friend-tag{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.25px;
      color:var(--gold1);
    }

    .promo-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:10px;
    }
    .promo-card{
      border-radius:18px;
      border:1px solid rgba(0,140,255,.25);
      background:radial-gradient(circle at 0 0,rgba(0,140,255,.35),rgba(10,12,18,.95));
      padding:10px 11px 12px;
      display:flex;
      flex-direction:column;
      gap:4px;
      position:relative;
      overflow:hidden;
    }
    .promo-tag{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.2px;
      color:rgba(223,239,255,.9);
    }
    .promo-title{
      font-size:13px;
      font-weight:800;
    }
    .promo-sub{
      font-size:11px;
      color:var(--muted);
    }
    .promo-cta{
      margin-top:6px;
      align-self:flex-start;
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.0);
      background:rgba(0,0,0,.25);
      text-decoration:none;
      color:#eef3ff;
    }
    .promo-glow{
      position:absolute;
      width:140px;height:140px;
      border-radius:999px;
      background:radial-gradient(circle,rgba(255,255,255,.38),rgba(255,255,255,0));
      opacity:.09;
      right:-40px;top:-60px;
      pointer-events:none;
    }

    details{
      border-radius:16px;
      border:1px solid var(--stroke);
      padding:10px 12px;
      background:#05070d;
    }
    summary{
      list-style:none;
      cursor:pointer;
      font-size:12px;
      color:var(--muted);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    summary::marker, summary::-webkit-details-marker{display:none}
    .caret{
      font-size:11px;
      opacity:.7;
    }
    details[open] .caret{
      transform:rotate(90deg);
    }
    .how-body{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
      display:grid;
      gap:6px;
    }
    .how-body strong{color:#fff}

    .error{
      text-align:center;
      font-size:13px;
      color:var(--muted);
      padding:30px 10px;
    }

    .small-hint{
      font-size:10px;
      color:var(--muted);
      margin-top:4px;
    }

    /* Elenco premi */
    .rewards-list{
      list-style:none;
      padding-left:0;
      margin:4px 0 0;
      display:grid;
      gap:8px;
      font-size:12px;
      color:var(--muted);
    }
    .rewards-list li{
      padding:6px 8px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.04);
      background:rgba(0,0,0,.15);
      transition:.25s ease;
    }
    .rewards-list li.reachable{
      border-color:rgba(247,215,116,.65);
      background:linear-gradient(135deg,rgba(247,215,116,.14),rgba(10,12,20,.9));
    }
    .rewards-list li.locked{
      opacity:.8;
    }
    .reward-line{
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .reward-badge{
      min-width:64px;
      padding:6px 10px;
      border-radius:999px;
      font-size:11px;
      font-weight:800;
      letter-spacing:.25px;
      text-transform:uppercase;
      text-align:center;
      border:1px solid rgba(255,255,255,.18);
      background:radial-gradient(circle at 0 0,rgba(247,215,116,.4),rgba(10,10,10,1));
      color:#110b00;
      box-shadow:0 0 14px rgba(247,215,116,.55);
      animation:rewardPulse 2.4s ease-in-out infinite alternate;
    }
    .rewards-list li.locked .reward-badge{
      background:rgba(20,20,26,1);
      color:var(--muted);
      border-color:rgba(255,255,255,.18);
      box-shadow:none;
      animation:none;
    }
    .reward-body{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .reward-title{
      font-size:12px;
      color:#fff;
      font-weight:700;
    }
    .reward-desc{
      font-size:11px;
      color:var(--muted);
    }
    @keyframes rewardPulse{
      0%{transform:translateY(0px);box-shadow:0 0 6px rgba(247,215,116,.6);}
      100%{transform:translateY(-1px);box-shadow:0 0 14px rgba(247,215,116,1);}
    }
    .reward-label{
      margin-top:4px;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.22px;
      color:var(--muted);
    }
    .rewards-list li.reachable .reward-label{
      color:var(--gold1);
    }
  </style>
</head>
<body>
  <div class="shell">
    <!-- CARD PRINCIPALE -->
    <section class="card" id="cardRoot">
      <div class="card-header">
        <div class="brand-lockup">
          <div class="logo-badge">
            <div class="logo-inner">
              <span>RL</span>
            </div>
          </div>
          <div class="title-main">
            <h1>Re Long • Fidelity Premium</h1>
            <div class="sub" id="userNameSub">
              Caricamento profilo…
            </div>
          </div>
        </div>
        <div class="status-chip">
          <div class="pulse-dot"></div>
          <span>Cliente attivo</span>
        </div>
      </div>

      <!-- PUNTI + MINI COUNTER -->
      <div class="points-row">
        <div>
          <div class="points-main">
            <span>Punti</span>
            <div id="pointsValue">—</div>
          </div>
          <div class="mini-counter" id="miniCounter">
            Rilevo il tuo saldo punti…
          </div>
        </div>
        <div>
          <button id="howBtn" class="chip-btn" type="button">Come funziona</button>
        </div>
      </div>

      <div class="progress-wrap">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-label">
          <span id="progressLabelLeft">0 pt</span>
          <span id="progressLabelRight">Prossimo premio a 150 pt</span>
        </div>
      </div>

      <!-- CODICE + NOTE -->
      <div class="id-row">
        <span>Codice Fidelity (inviti & promo):</span>
        <span class="code-pill" id="codePill">••••••</span>
      </div>
      <div class="small-hint">
        Usa questo codice quando porti un amico o lo inviti a registrarti.
      </div>
    </section>

    <!-- PORTA UN AMICO + PROMO DEL GIORNO -->
    <section class="card">
      <div class="two-col">
        <!-- Porta un amico -->
        <div>
          <div class="section-title">Porta un amico</div>
          <div class="section-sub">
            Condividi il tuo codice personale:  
            <strong>tu guadagni +100 punti</strong> per ogni amico registrato,  
            il tuo amico riceve <strong>+50 punti di benvenuto</strong>.
          </div>

          <div class="friend-box">
            <div class="friend-main">
              <div>
                <div class="friend-tag">programma inviti</div>
                <strong>Invita da WhatsApp in un tap</strong>
                <div class="small-hint">
                  Il tuo codice sarà inserito nella registrazione del tuo amico.
                </div>
              </div>
            </div>
            <div class="chips-row">
              <button id="shareInviteBtn" class="btn primary" type="button">
                Copia codice + WhatsApp
              </button>
              <button id="copyCodeBtn" class="chip-btn" type="button">
                Copia il mio codice
              </button>
            </div>
          </div>
        </div>

        <!-- Promo del giorno -->
        <div>
          <div class="section-title">Promo del giorno</div>
          <div class="section-sub">
            Offerte smart scelte per te.  
            I banner cambiano in modo dinamico ogni volta che apri la card.
          </div>
          <div id="promoArea" class="promo-grid">
            <!-- riempito da JS -->
            <div class="promo-card">
              <div class="promo-glow"></div>
              <div class="promo-tag">Attendi…</div>
              <div class="promo-title">Carico le promo Re Long</div>
              <div class="promo-sub">Smartphone, energia, console e tanto altro.</div>
              <span class="promo-cta">Caricamento…</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- COME FUNZIONA -->
    <section class="card">
      <div class="section-title">Come funziona la Fidelity Re Long</div>
      <details id="howDetails">
        <summary>
          <span>Apri la guida rapida in 4 punti</span>
          <span class="caret">▶</span>
        </summary>
        <div class="how-body">
          <p><strong>1. Registrazione</strong><br/>
            Ti registriamo in negozio o tramite il link che ricevi su WhatsApp. Al primo accesso puoi ricevere punti di benvenuto.</p>
          <p><strong>2. Come accumuli punti</strong><br/>
            Ogni attivazione (SIM, fibra, energia, smartphone a rate, ecc.) genera punti. Anche alcune promo speciali possono aggiungere punti extra.</p>
          <p><strong>3. Porta un amico</strong><br/>
            Condividi il tuo <strong>codice Fidelity</strong> con amici e familiari.  
            Quando si registrano usando il tuo codice: tu prendi <strong>+100 punti</strong>, loro <strong>+50 punti</strong>.</p>
          <p><strong>4. Premi & vantaggi</strong><br/>
            Raggiunte determinate soglie potrai accedere a sconti esclusivi, gadget o promo dedicate in negozio.</p>
        </div>
      </details>
    </section>

    <!-- ELENCO PREMI -->
    <section class="card">
      <div class="section-title">Elenco premi Fidelity Re Long</div>
      <div class="section-sub">
        Riscatta i tuoi premi esclusivi quando raggiungi le soglie punti indicate.
        I premi possono variare in base alle disponibilità in negozio.
      </div>

      <div class="chips-row" style="margin-bottom:8px">
        <button id="filterReachableBtn" class="chip-btn" type="button">
          Mostra solo premi raggiungibili
        </button>
      </div>

      <ul class="rewards-list" id="rewardsList">
        <li data-points="150">
          <div class="reward-line">
            <span class="reward-badge">150 pt</span>
            <div class="reward-body">
              <div class="reward-title">Pellicola di Gel Ultra Crystal Premium Quality</div>
              <div class="reward-desc">Protezione schermo con installazione inclusa.</div>
              <div class="reward-label">Primo premio, ideale come start del percorso Fidelity.</div>
            </div>
          </div>
        </li>
        <li data-points="300">
          <div class="reward-line">
            <span class="reward-badge">300 pt</span>
            <div class="reward-body">
              <div class="reward-title">Powerbank 5000 mAh First Rapid Charge</div>
              <div class="reward-desc">Ricarica rapida per il tuo smartphone, compatto e da portare sempre con te.</div>
              <div class="reward-label">Perfetto per chi viaggia o usa molto il telefono.</div>
            </div>
          </div>
        </li>
        <li data-points="600">
          <div class="reward-line">
            <span class="reward-badge">600 pt</span>
            <div class="reward-body">
              <div class="reward-title">Cuffie Bluetooth SGS Pods</div>
              <div class="reward-desc">Ascolta musica e chiamate in comodità, senza fili.</div>
              <div class="reward-label">Premio intermedio, pensato per chi è già fedele a Re Long.</div>
            </div>
          </div>
        </li>
        <li data-points="1000">
          <div class="reward-line">
            <span class="reward-badge">1000 pt</span>
            <div class="reward-body">
              <div class="reward-title">Smartwatch SGS Square Bluetooth con funzione chiamata</div>
              <div class="reward-desc">Gestisci notifiche e chiamate direttamente dal polso.</div>
              <div class="reward-label">Premio importante, dedicato ai clienti super attivi.</div>
            </div>
          </div>
        </li>
        <li data-points="1500">
          <div class="reward-line">
            <span class="reward-badge">1500 pt</span>
            <div class="reward-body">
              <div class="reward-title">Occhiali SGS Smart</div>
              <div class="reward-desc">Ascolta la musica e rispondi al cellulare direttamente dai tuoi occhiali.</div>
              <div class="reward-label">Top reward: il massimo della Fidelity Re Long.</div>
            </div>
          </div>
        </li>
      </ul>
    </section>

    <!-- ERRORE / INFO -->
    <div id="errorBox" class="error" style="display:none">
      Non riesco a trovare la tua Fidelity Card.<br/>
      Contatta Re Long per verificare il link o la registrazione.
    </div>
  </div>

  <script>
    const DATA_URL   = 'data/items.json'; // stesso percorso usato dal gestionale
    const HUB_URL    = 'https://alessandroiascone.github.io/relong-nfc/relong-hub-v2.html';
    const CATALOG_URL= 'https://alessandroiascone.github.io/relong-nfc/catalogo-smartphone-reale-v3.html';
    const RELONG_PHONE = '08119578844';

    // soglie dei premi
    const REWARD_STEPS = [150,300,600,1000,1500];

    const $ = s => document.querySelector(s);

    function normalizePhone(p){return String(p||'').trim().replace(/\D/g,'');}

    function genCodeFromId(id){
      if(!id) return '000000';
      let h=0;
      for(let i=0;i<id.length;i++){
        h = (h*31 + id.charCodeAt(i)) >>> 0;
      }
      const code = 100000 + (h % 900000); // 6 cifre
      return String(code);
    }

    // progress in base alle soglie dei premi
    function computeProgress(points){
      const p = Math.max(0, points||0);
      const steps = REWARD_STEPS;
      let next = steps.find(s => p < s);
      if(!next) next = steps[steps.length-1];
      let prev = 0;
      for(let i=0;i<steps.length;i++){
        if(steps[i] >= next){
          prev = i===0 ? 0 : steps[i-1];
          break;
        }
      }
      const span = (next - prev) || next || 1;
      const ratio = Math.max(0, Math.min(1, (p - prev) / span));
      return {prevThreshold:prev,nextThreshold:next,ratio};
    }

    const PROMOS = [
      {
        tag:'Smartphone a rate',
        title:'Top di gamma senza busta paga',
        sub:'iPhone, Samsung, Honor e altri modelli disponibili con rate leggere.',
        link:CATALOG_URL
      },
      {
        tag:'Luce & Gas',
        title:'Simulazione energia super conveniente',
        sub:'Porta una bolletta e verifichiamo subito se puoi risparmiare.',
        link:HUB_URL
      },
      {
        tag:'Console & TV',
        title:'Offerte su console, TV e accessori',
        sub:'Chiedi in negozio le promo attive su gaming e intrattenimento.',
        link:HUB_URL
      },
      {
        tag:'Fibra & Fisso',
        title:'Fibra veloce per casa e ufficio',
        sub:'Copertura, modem e promozioni dedicate per linee fisse.',
        link:HUB_URL
      }
    ];

    function shuffle(arr){
      const a=[...arr];
      for(let i=a.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    function renderPromos(){
      const area = document.getElementById('promoArea');
      area.innerHTML='';
      const chosen = shuffle(PROMOS).slice(0,2);
      chosen.forEach(p=>{
        const card = document.createElement('article');
        card.className='promo-card';
        card.innerHTML = `
          <div class="promo-glow"></div>
          <div class="promo-tag">${p.tag}</div>
          <div class="promo-title">${p.title}</div>
          <div class="promo-sub">${p.sub}</div>
          <a class="promo-cta" href="${p.link}" target="_blank" rel="noopener">Scopri subito</a>
        `;
        area.appendChild(card);
      });
    }

    function buildInviteText(name, code){
      const safeName = name || 'Un cliente Re Long';
      return (
        safeName + ` ti invita alla Fidelity Card Re Long!\n\n` +
        `Usa il suo codice invito: ${code}\n` +
        `✔ Tu ricevi subito +50 punti di benvenuto\n` +
        `✔ Lui guadagna +100 punti\n\n` +
        `Per registrarti, scrivi a Re Long su WhatsApp indicando il codice o passa in negozio.\n` +
        `WhatsApp Re Long: ${RELONG_PHONE}`
      );
    }

    async function loadClient(){
      const params = new URLSearchParams(location.search);
      const idParam = params.get('id') || '';
      if(!idParam){
        document.getElementById('errorBox').style.display='block';
        return null;
      }
      try{
        const res = await fetch(DATA_URL + '?t=' + Date.now());
        if(!res.ok) throw new Error('HTTP '+res.status);
        const all = await res.json();
        const byId = all.find(x=> String(x.id||'')===idParam);
        const byPhone = all.find(x=> normalizePhone(x.phone)===normalizePhone(idParam));
        const client = byId || byPhone || null;
        if(!client){
          document.getElementById('errorBox').style.display='block';
          return null;
        }
        return client;
      }catch(e){
        console.error(e);
        document.getElementById('errorBox').style.display='block';
        return null;
      }
    }

    function updateRewardsUI(points){
      const list = document.getElementById('rewardsList');
      if(!list) return;
      [...list.querySelectorAll('li')].forEach(li=>{
        const need = parseInt(li.dataset.points,10) || 0;
        const reachable = points >= need;
        li.classList.toggle('reachable', reachable);
        li.classList.toggle('locked', !reachable);
      });
    }

    (async function init(){
      renderPromos();

      const client = await loadClient();
      if(!client) return;

      const name = client.name || 'Cliente Re Long';
      const points = Number(client.points||0);
      const code = genCodeFromId(String(client.id||normalizePhone(client.phone)||name));

      document.getElementById('userNameSub').textContent = name;
      document.getElementById('pointsValue').textContent = isNaN(points)? '0' : String(points);

      const prog = computeProgress(points);
      document.getElementById('progressFill').style.width = (prog.ratio*100).toFixed(1)+'%';
      document.getElementById('progressLabelLeft').textContent  = `${prog.prevThreshold} pt`;
      document.getElementById('progressLabelRight').textContent = `Prossimo premio a ${prog.nextThreshold} pt`;
      const missing = Math.max(0, prog.nextThreshold - points);
      document.getElementById('miniCounter').textContent = missing>0
        ? `Ti mancano ${missing} punti al prossimo premio.`
        : `Hai superato una soglia premio, passa in negozio per scoprire cosa puoi riscattare.`;

      document.getElementById('codePill').textContent = code;

      // aggiorna stato premi (badge animati / raggiungibili)
      updateRewardsUI(points);

      // bottone "Come funziona"
      document.getElementById('howBtn').addEventListener('click', ()=>{
        const det = document.getElementById('howDetails');
        if(det){
          det.open = true;
          det.scrollIntoView({behavior:'smooth',block:'start'});
        }
      });

      // filtro "Mostra solo premi raggiungibili"
      const filterBtn = document.getElementById('filterReachableBtn');
      if(filterBtn){
        let filterOn = false;
        filterBtn.addEventListener('click', ()=>{
          filterOn = !filterOn;
          filterBtn.classList.toggle('active', filterOn);
          const list = document.getElementById('rewardsList');
          if(!list) return;
          [...list.querySelectorAll('li')].forEach(li=>{
            const need = parseInt(li.dataset.points,10) || 0;
            if(!filterOn){
              li.style.display = '';
            }else{
              li.style.display = (points >= need) ? '' : 'none';
            }
          });
        });
      }

      // copia solo codice
      document.getElementById('copyCodeBtn').addEventListener('click', async ()=>{
        try{
          await navigator.clipboard.writeText(code);
          alert('Codice copiato: ' + code);
        }catch{
          alert('Codice: ' + code);
        }
      });

      // copia codice + apri WhatsApp (senza numero, il cliente sceglie a chi mandarlo)
      document.getElementById('shareInviteBtn').addEventListener('click', async ()=>{
        const text = buildInviteText(name, code);
        try{
          await navigator.clipboard.writeText(code);
        }catch{}
        const url  = `https://wa.me/?text=${encodeURIComponent(text)}`;
        window.open(url,'_blank','noopener');
      });
    })();
  </script>
</body>
</html>
