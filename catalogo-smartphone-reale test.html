<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Catalogo 3D â€“ Re Long</title>
<meta name="theme-color" content="#0a0a0a" />
<style>
  *{box-sizing:border-box;margin:0;padding:0;-webkit-font-smoothing:antialiased}
  :root{
    --bg1:#0a0a0a;--bg2:#000;
    --brand1:#ff0000;--brand2:#ff7b00;
    --muted:rgba(255,255,255,.72);--muted2:rgba(255,255,255,.5);
    --card:rgba(20,20,20,.94);--stroke:rgba(255,255,255,.10);
    --wa1:#25D366;--wa2:#128C7E;--focus:#ffd166
  }
  body{
    font-family:system-ui,-apple-system,Inter,Roboto,sans-serif;
    background:radial-gradient(circle at 20% 20%,var(--bg1) 0%, var(--bg2) 70%);
    color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center;
    padding:24px;position:relative
  }
  body::before{
    content:"";position:fixed;left:50%;top:40%;transform:translateX(-50%);
    width:1200px;height:1200px;border-radius:50%;
    background:radial-gradient(circle, rgba(255,120,0,.12) 0%, rgba(255,120,0,0) 60%);
    filter:blur(6px);pointer-events:none;z-index:0
  }
  .wrap{width:100%;max-width:1120px;display:grid;gap:18px;padding-bottom:40px;position:relative;z-index:1}
  .head{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between}
  .title{display:flex;gap:10px;align-items:center;font-size:20px;font-weight:900;letter-spacing:-.02em}
  .title .logo{width:22px;height:22px}
  .controls{display:flex;flex-wrap:wrap;gap:8px}
  .btn{padding:10px 14px;border-radius:14px;border:1px solid var(--stroke);
    background:rgba(255,255,255,.06);color:#fff;font-weight:800;cursor:pointer}
  .btn.active{background:linear-gradient(90deg,var(--brand1),var(--brand2));color:#000;border-color:transparent;box-shadow:0 16px 26px rgba(255,90,0,.35)}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
  @media(min-width:1100px){.grid{grid-template-columns:1fr 1fr 1fr}}
  .card{
    position:relative;background:linear-gradient(150deg,var(--card) 0%,rgba(0,0,0,.6) 100%);
    padding:16px;border-radius:18px;border:1px solid var(--stroke);
    box-shadow:0 24px 56px rgba(0,0,0,.85),0 0 60px rgba(255,0,0,.14);
    transform:perspective(800px) rotateX(0) rotateY(0);
    transition:transform .25s ease, box-shadow .25s ease, border-color .25s ease
  }
  .card:hover{
    transform:perspective(800px) rotateX(2deg) rotateY(-2deg) translateZ(6px);
    box-shadow:0 36px 84px rgba(0,0,0,.92), 0 0 90px rgba(255,59,0,.22);
    border-color:rgba(255,255,255,.18)
  }
  .badges{position:absolute;top:10px;left:10px;display:flex;flex-wrap:wrap;gap:6px}
  .tag{
    font-size:11px;font-weight:800;padding:6px 10px;border-radius:999px;
    background:linear-gradient(90deg,var(--brand1),var(--brand2));color:#000;
    box-shadow:0 10px 18px rgba(255,80,0,.45);border:1px solid rgba(0,0,0,.06)
  }
  .tag--brand{background:linear-gradient(90deg,#ff2a2a,#ffd166)}
  .tag--novita{background:linear-gradient(90deg,#8B5CF6,#EC4899)}
  .tag--offerta{background:linear-gradient(90deg,#22C55E,#16A34A)}
  .tag--best{background:linear-gradient(90deg,#06B6D4,#0EA5E9)}
  .tag--limitata{background:linear-gradient(90deg,#F59E0B,#EF4444)}
  .tag--sconto{background:linear-gradient(90deg,#000,#222);color:#ffd166;border-color:rgba(255,255,255,.22)}
  .photo{width:100%;border-radius:12px;aspect-ratio:1/1;object-fit:contain;background:#000}
  .model{font-size:18px;font-weight:900;margin-top:6px;letter-spacing:-.01em}
  .price{font-size:13px;margin-bottom:8px;color:var(--muted)}
  .sim{display:grid;gap:8px;margin-top:10px;padding:12px;border:1px solid var(--stroke);
    border-radius:12px;background:rgba(255,255,255,.05)}
  .sim .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .sim label{font-size:12px;color:var(--muted);display:flex;flex-direction:column;gap:6px}
  .sim input,.sim select{width:100%;padding:10px;border-radius:12px;background:#0f0f0f;color:#fff;border:1px solid rgba(255,255,255,.15)}
  .sim .out{font-weight:900;color:#ffd166;margin-top:4px}
  .btn-primary{
    display:block;margin-top:10px;text-align:center;padding:12px 14px;border-radius:14px;
    background:linear-gradient(90deg,var(--brand1),var(--brand2));
    color:#000;font-weight:800;text-decoration:none;box-shadow:0 16px 26px rgba(255,90,0,.35);
    transition: transform .22s ease, box-shadow .22s ease, filter .22s ease
  }
  .btn-primary:hover{transform:perspective(700px) translateZ(12px) scale(1.05) rotateX(2deg);box-shadow:0 28px 44px rgba(255,90,0,.5);filter:brightness(1.05)}
</style>
</head>
<body>
<main class="wrap">
  <header class="head">
    <div class="title">
      <svg class="logo" viewBox="0 0 24 24" aria-hidden="true">
        <defs><linearGradient id="g1" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#ff0000"/><stop offset="100%" stop-color="#ff7b00"/></linearGradient></defs>
        <path d="M4 18L12 6l8 12" fill="none" stroke="url(#g1)" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Catalogo 3D â€“ Smartphone a Rate
    </div>
    <div class="controls">
      <button class="btn active" data-filter="all">Tutti</button>
      <button class="btn" data-filter="Apple">Apple</button>
      <button class="btn" data-filter="Samsung">Samsung</button>
      <button class="btn" data-filter="OPPO">OPPO</button>
      <button class="btn" data-filter="Honor">Honor</button>
    </div>
  </header>
  <section class="grid" id="grid"></section>
</main>

<script>
const WA_NUM = "3908119578844";
const SOURCE_FILE = "./catalogo-smartphone-reale-v3-lite.html";

/* ===== Loader prodotti dallâ€™array esistente ===== */
async function loadProdotti(){
  const res = await fetch(SOURCE_FILE, {cache:'no-store'});
  const txt = await res.text();
  const m = txt.match(/const\s+prodotti\s*=\s*\[([\s\S]*?)\];/);
  if(!m) throw new Error("Array 'prodotti' non trovato");
  const body = '[' + m[1] + ']';
  const prodotti = (new Function('return ' + body))();

  // Normalizza brand
  prodotti.forEach(p=>{
    if(p.brand){
      const b = String(p.brand).toLowerCase();
      if(b==='apple'||b==='iphone') p.brand='Apple';
      else if(b==='samsung') p.brand='Samsung';
      else if(b==='oppo') p.brand='OPPO';
      else if(b==='honor') p.brand='Honor';
    }
  });
  return prodotti;
}

/* ===== Badge dinamici =====
   - p.badges: array di stringhe (es. ["NovitÃ ","Offerta","Best Seller"])
   - Oppure flag: p.novita, p.offerta, p.best, p.limitata, p.sconto (numero %)
*/
function buildBadges(p){
  const out = [];

  // Brand sempre presente
  if(p.brand){ out.push({text: p.brand, cls: 'tag--brand'}); }

  // Da array esplicito
  if (Array.isArray(p.badges)){
    p.badges.forEach(b=>{
      const key = String(b).toLowerCase();
      if(key.includes('nov')) out.push({text:'NovitÃ ', cls:'tag--novita'});
      else if(key.includes('offer')||key.includes('promo')) out.push({text:'Offerta', cls:'tag--offerta'});
      else if(key.includes('best')) out.push({text:'Best Seller', cls:'tag--best'});
      else if(key.includes('limit')) out.push({text:'Limited', cls:'tag--limitata'});
      else out.push({text:b, cls:''});
    });
  }

  // Da flag
  if (p.novita) out.push({text:'NovitÃ ', cls:'tag--novita'});
  if (p.offerta) out.push({text:'Offerta', cls:'tag--offerta'});
  if (p.best) out.push({text:'Best Seller', cls:'tag--best'});
  if (p.limitata) out.push({text:'Limited', cls:'tag--limitata'});

  // Sconto percentuale
  if (typeof p.sconto === 'number' && isFinite(p.sconto) && p.sconto>0){
    out.push({text: `-${Math.round(p.sconto)}%`, cls:'tag--sconto'});
  }

  // Deduplica mantenendo lâ€™ordine
  const seen = new Set(); 
  return out.filter(b => { const k=b.cls+'|'+b.text; if(seen.has(k)) return false; seen.add(k); return true; });
}

function cardHTML(p){
  const brand = p.brand||'â€”';
  const nome  = p.nome || p.name || 'â€”';
  const prezzo = (p.prezzo ?? p.price) || 0;
  const img   = p.img || p.immagine || p.image || "";
  const badges = buildBadges(p);
  const badgeHTML = badges.map(b=>`<span class="tag ${b.cls}">${escapeHtml(b.text)}</span>`).join('');

  // WhatsApp link (verrÃ  aggiornato con la rata scelta)
  const waBase = `https://wa.me/${WA_NUM}?text=`;
  const waMsg  = `Ciao Re Long, voglio info su ${nome}.`;
  const waUrl  = waBase + encodeURIComponent(waMsg);

  return `
  <article class="card" data-brand="${escapeHtml(brand)}" data-prezzo="${Number(prezzo)}" data-nome="${escapeHtml(nome)}">
    <div class="badges">${badgeHTML}</div>
    <img class="photo" src="${img}" alt="${escapeHtml(nome)}">
    <div class="model">${escapeHtml(nome)}</div>
    <p class="price">Prezzo totale: â‚¬ ${formatEuro(prezzo)}</p>

    <div class="sim">
      <div class="row">
        <label>Durata (mesi)
          <select class="durata">
            <option value="">â€”</option>
            <option>12</option><option>24</option><option>30</option>
            <option>36</option><option>48</option>
          </select>
        </label>
        <label>Anticipo (â‚¬)
          <input class="anticipo" type="number" min="0" step="1" placeholder="0">
        </label>
      </div>
      <div class="out">Rata mensile: <span class="rata">â€”</span></div>
    </div>

    <a class="btn-primary wa" href="${waUrl}" target="_blank" rel="noopener">ðŸ“© Invia simulazione su WhatsApp</a>
  </article>`;
}

/* ===== Calcolo rata SOLO sul prezzo totale impostato ===== */
function calcolaRata(prezzo, mesi, anticipo){
  if(!mesi||mesi<=0) return null;
  const base = Math.max(Number(prezzo) - Number(anticipo||0), 0);
  return base / mesi;
}

/* ===== Render e interazioni ===== */
function renderGrid(prodotti, filter="all"){
  const grid = document.getElementById('grid'); grid.innerHTML="";
  prodotti.filter(p=>filter==="all"||p.brand===filter)
          .forEach(p=>grid.insertAdjacentHTML('beforeend', cardHTML(p)));

  grid.querySelectorAll('.card').forEach(card=>{
    const durata = card.querySelector('.durata');
    const anticipo = card.querySelector('.anticipo');
    const rataOut = card.querySelector('.rata');
    const prezzo = Number(card.dataset.prezzo||0);
    const nome = card.dataset.nome||'';

    const update = ()=>{
      const mesi = parseInt(durata.value||"");
      const a = parseFloat(anticipo.value||"0");
      const r = calcolaRata(prezzo, mesi, a);
      rataOut.textContent = r ? ("â‚¬ " + formatEuro(r)) : "â€”";

      // aggiorna messaggio WA con la simulazione corrente
      const parts = [`Ciao Re Long, vorrei info su ${nome}.`];
      if(mesi){ parts.push(`Durata: ${mesi} mesi`); }
      if(a>0){ parts.push(`Anticipo: â‚¬ ${formatEuro(a)}`); }
      if(r){ parts.push(`Rata: â‚¬ ${formatEuro(r)}`); }
      const msg = parts.join("\n");
      const link = card.querySelector('.btn-primary.wa');
      link.href = "https://wa.me/"+WA_NUM+"?text="+encodeURIComponent(msg);
    };

    [durata, anticipo].forEach(el=>el.addEventListener('input', update));
    update();
  });
}

/* ===== Filtri brand ===== */
document.addEventListener('click',(e)=>{
  const b=e.target.closest('.btn[data-filter]'); if(!b) return;
  document.querySelectorAll('.btn[data-filter]').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); const filter=b.dataset.filter;
  if(window._PRODOTTI) renderGrid(window._PRODOTTI, filter);
});

/* ===== Utils ===== */
function formatEuro(n){ return Number(n).toLocaleString('it-IT',{minimumFractionDigits:2, maximumFractionDigits:2}); }
function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}

/* ===== Init ===== */
(async()=>{
  try{
    const prodotti=await loadProdotti(); window._PRODOTTI=prodotti; renderGrid(prodotti,"all");
  }catch(err){
    console.error(err);
    document.getElementById('grid').innerHTML="<p style='opacity:.85'>Impossibile caricare i prodotti dal file sorgente.</p>";
  }
})();
</script>
</body>
</html>
