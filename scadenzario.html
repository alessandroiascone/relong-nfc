<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ReLong • Scadenzario + Accettazione + Pacchi</title>
  <meta name="theme-color" content="#0a0a0a" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0;-webkit-font-smoothing:antialiased}
    :root{
      --bg1:#0b0d12; --bg2:#06070b;
      --card:rgba(14,16,22,.92); --stroke:rgba(255,255,255,.08);
      --muted:rgba(210,220,255,.70);
      --elec:#0aa2ff; --elec2:#66d1ff; --elec3:#008cff;
      --ok:#25D366; --danger:#ff4d4f;
      --shadow:0 10px 40px rgba(0,140,255,.18), inset 0 1px 0 rgba(255,255,255,.04);
      --st-diagnostica:#ffd666; --st-ricambi:#ffa940; --st-lavorazione:#69c0ff; --st-pronto:#95de64; --st-consegnato:#bfbfbf;
      --pacchi:#00d1b2;
    }
    body{min-height:100svh;font-family:system-ui,-apple-system,Inter,Roboto,sans-serif;color:#eef3ff;
      background:radial-gradient(65% 65% at 25% 15%, var(--bg1), var(--bg2));
      padding:24px;display:flex;flex-direction:column;gap:24px}
    .shell{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1.2fr .8fr;gap:20px}
    @media (max-width:980px){.shell{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:22px;box-shadow:var(--shadow)}
    .card h2{font-size:18px;font-weight:800;padding:18px 18px 0;letter-spacing:.3px}
    .card .content{padding:18px}
    .title{display:flex;align-items:flex-start;gap:14px}
    .title h1{font-size:26px;letter-spacing:.2px}
    .subtitle{color:var(--muted);font-size:14px}
    .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .full{grid-column:1/-1}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{margin-top:6px;background:#0a0d14;border:1px solid var(--stroke);color:#eef3ff;border-radius:14px;padding:12px 14px;font-size:15px}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap}
    .filters{display:flex;gap:8px;flex-wrap:wrap}
    .pill{border:1px solid rgba(0,140,255,.22);color:#dbeaff;padding:8px 12px;border-radius:999px;font-size:13px;cursor:pointer;background:linear-gradient(180deg,rgba(0,140,255,.08),rgba(0,140,255,.02))}
    .pill.active{background:linear-gradient(135deg,var(--elec3),var(--elec2));color:#04121f;border-color:transparent;box-shadow:0 8px 24px rgba(0,140,255,.25)}
    .search{display:flex;gap:8px;align-items:center}
    .search input{min-width:220px}
    .item{display:grid;grid-template-columns:1fr;gap:10px;border:1px solid var(--stroke);border-radius:16px;padding:12px;margin-bottom:10px;background:#0a0d14}
    .meta{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .h{font-weight:800}
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .tag{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#04121f;background:linear-gradient(135deg,var(--elec3),var(--elec2));padding:4px 8px;border-radius:999px}
    .pacchi{background:linear-gradient(135deg,var(--pacchi),#7ffbe6)!important;color:#05312a}
    .flash{animation:flash 1.2s ease}
    @keyframes flash{0%{box-shadow:0 0 0 0 rgba(0,140,255,.0)}30%{box-shadow:0 0 0 6px rgba(0,140,255,.35)}100%{box-shadow:0 0 0 0 rgba(0,140,255,.0)}}
    #errBar{position:fixed;left:0;right:0;bottom:0;background:#c0392b;color:#fff;padding:8px 12px;font-size:12px;display:none;z-index:99999}
  </style>
</head>
<body>
  <div id="errBar"></div>

  <header class="title" aria-hidden="true">
    <div>
      <h1>ReLong • Scadenzario + Accettazione</h1>
      <div class="subtitle">Attivazioni, Riparazioni & Pacchi → reminder smart con WhatsApp.</div>
    </div>
  </header>

  <!-- Dati cliente base -->
  <section class="card" style="max-width:1200px;margin:0 auto" aria-hidden="true">
    <h2>Dati cliente (unici)</h2>
    <div class="content grid2">
      <div><label>Nome e Cognome</label><input required id="c_name" placeholder="Mario Rossi" /></div>
      <div><label>Telefono (solo cifre, WhatsApp)</label><input required id="c_phone" placeholder="3331234567" inputmode="numeric" pattern="[0-9]+" /></div>
    </div>
  </section>

  <!-- Elenco -->
  <section class="card" id="listSection" style="max-width:1200px;margin:0 auto">
    <div class="content">
      <div class="toolbar">
        <div class="filters">
          <button class="pill active" data-filter="all">Tutti</button>
          <button class="pill" data-filter="pacchi">Da Pacchi</button>
        </div>
        <div class="search">
          <label>Cerca</label>
          <input id="q" placeholder="Nome, telefono…" />
        </div>
      </div>

      <div class="subsection" id="subStandard">
        <h3>Clienti</h3>
        <div id="listStandard"></div>
      </div>

      <div class="subsection" id="subPacchi">
        <h3>Da Pacchi</h3>
        <div id="listPacchi"></div>
      </div>
    </div>
  </section>

  <template id="tpl-item">
    <div class="item"><div class="meta"><div class="h"></div><div class="tags"></div></div><div class="summary"></div></div>
  </template>

  <script>
    /* Error bar */
    (function(){ const bar=document.getElementById('errBar'); window.addEventListener('error',e=>{bar.textContent='Errore JavaScript: '+(e.message||'sconosciuto'); bar.style.display='block';}); })();

    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => [...r.querySelectorAll(s)];

    /* === CHIAVE UNICA DI ARCHIVIO CONDIVISA === */
    const STORE_KEY = 'relong-scadenzario-v30';

    /* Utils */
    const normalizePhone = p => { let ph=String(p||'').trim().replace(/\D/g,''); if(ph.startsWith('0')) ph=ph.slice(1); return ph; };
    const fmtDateShort = d => new Date(d).toLocaleDateString('it-IT',{month:'2-digit',day:'2-digit'});

    /* Storage */
    const load = () => { try { const raw = localStorage.getItem(STORE_KEY); return raw? JSON.parse(raw): []; } catch(e){ console.warn('Storage corrotto',e); localStorage.removeItem(STORE_KEY); return []; } };
    const save = (arr) => localStorage.setItem(STORE_KEY, JSON.stringify(arr));

    /* Stato in memoria */
    let items = load();

    /* Filtri */
    let filter='all';
    const qI = $('#q');
    $$('.pill').forEach(p=>p.addEventListener('click',()=>{
      $$('.pill').forEach(x=>x.classList.remove('active'));
      p.classList.add('active'); filter=p.dataset.filter; render();
    }));
    qI?.addEventListener('input', render);

    function tag(txt, cls=''){ const s=document.createElement('span'); s.className='tag'; if(cls) s.classList.add(cls); s.textContent=txt; return s }

    function render(highlightPhone=null){
      const listStd = $('#listStandard'); listStd.innerHTML='';
      const listPac = $('#listPacchi'); listPac.innerHTML='';
      const q=(qI?.value||'').trim().toLowerCase();

      const filtered = items.filter(it=>{
        if(filter==='pacchi') return it.source==='pacchi';
        return true;
      }).filter(it=>{
        if(!q) return true;
        return (it.name||'').toLowerCase().includes(q) || (it.phone||'').toLowerCase().includes(q);
      });

      const std = filtered.filter(it=>it.source!=='pacchi');
      const pac = filtered.filter(it=>it.source==='pacchi');

      std.forEach(it=> listStd.appendChild(renderItem(it, highlightPhone)));
      pac.forEach(it=> listPac.appendChild(renderItem(it, highlightPhone)));
    }

    function renderItem(it, highlightPhone){
      const t = $('#tpl-item').content.firstElementChild.cloneNode(true);
      t.querySelector('.h').textContent = `${it.name} • ${it.phone}`;
      const tags = t.querySelector('.tags'); tags.innerHTML='';
      if(it.source==='pacchi'){
        const txt = `Pacchi${it.pacchiKind?`: ${String(it.pacchiKind).charAt(0).toUpperCase()+String(it.pacchiKind).slice(1)}`:''}`;
        tags.append(tag(txt,'pacchi'));
        if(it.pacchiCount) tags.append(tag(`Movimenti: ${it.pacchiCount}`,'pacchi'));
        if(it.pacchiLastAt) tags.append(tag(`Ult.: ${fmtDateShort(it.pacchiLastAt)}`,'pacchi'));
      }
      if(highlightPhone && normalizePhone(it.phone)===normalizePhone(highlightPhone)){
        t.classList.add('flash');
        setTimeout(()=>t.classList.remove('flash'),1200);
      }
      return t;
    }

    /* === Ascolto aggiornamenti in tempo reale === */

    // 1) BroadcastChannel tra schede
    let bc = null;
    try {
      bc = new BroadcastChannel('relong-scadenzario-reload');
      bc.onmessage = (ev)=>{
        if(!ev || !ev.data) return;
        if(ev.data.type==='upsert'){
          items = load();
          render(ev.data.phone || null);
        }
      };
    } catch(e){ console.warn('BroadcastChannel non disponibile', e); }

    // 2) storage event (aggiornamenti da altre schede)
    window.addEventListener('storage', (e)=>{
      if(e.key === STORE_KEY){
        items = load();
        render();
      }
    });

    /* Boot */
    render();
  </script>
</body>
</html>
