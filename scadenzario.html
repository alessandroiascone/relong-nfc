<!DOCTYPE html><html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ReLong • Scadenzario Follow‑up</title>
  <meta name="theme-color" content="#0a0a0a" />
  <style>
    /* --- Theme: Premium Dark + Electric Blue --- */
    *{box-sizing:border-box;margin:0;padding:0;-webkit-font-smoothing:antialiased}
    :root{
      --bg1:#0b0d12; --bg2:#06070b; /* deep dark */
      --card:rgba(14,16,22,.92); --stroke:rgba(255,255,255,.08);
      --muted:rgba(210,220,255,.70);
      --elec:#0aa2ff; --elec2:#66d1ff; --elec3:#008cff; /* electric blues */
      --ok:#25D366; --danger:#ff4d4f;
      --shadow:0 10px 40px rgba(0,140,255,.18), inset 0 1px 0 rgba(255,255,255,.04);
    }
    body{min-height:100svh;font-family:system-ui,-apple-system,Inter,Roboto,sans-serif;color:#eef3ff;
      background:radial-gradient(65% 65% at 25% 15%, var(--bg1), var(--bg2));
      padding:24px;display:flex;flex-direction:column;gap:24px}
    .shell{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1.2fr .8fr;gap:20px}
    @media (max-width:980px){.shell{grid-template-columns:1fr;}}.card{background:var(--card);border:1px solid var(--stroke);border-radius:22px;box-shadow:var(--shadow)}
.card h2{font-size:18px;font-weight:800;padding:18px 18px 0;letter-spacing:.3px}
.card .content{padding:18px}

/* Header */
.title{display:flex;align-items:center;gap:14px}
.title img{height:36px;aspect-ratio:auto;display:block;filter:drop-shadow(0 8px 24px rgba(0,140,255,.25))}
.title h1{font-size:26px;letter-spacing:.2px}
.subtitle{color:var(--muted);font-size:14px}

/* Form */
form{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
form .full{grid-column:1/-1}
label{font-size:12px;color:var(--muted)}
input{margin-top:6px;background:#0a0d14;border:1px solid var(--stroke);color:#eef3ff;border-radius:14px;padding:12px 14px;font-size:15px}

.brandpill{margin-top:6px;display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(0,140,255,.35);background:linear-gradient(135deg,rgba(0,140,255,.12),rgba(0,140,255,.05));padding:10px 12px;border-radius:999px;font-weight:700}
.brandpill .dot{width:8px;height:8px;border-radius:50%;background:var(--elec3);box-shadow:0 0 18px var(--elec3)}

/* Toggles (elegant buttons) */
.toggle-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:8px}
@media (max-width:980px){.toggle-grid{grid-template-columns:repeat(2,1fr)}}
.tbtn{position:relative;display:flex;align-items:center;justify-content:center;text-align:center;min-height:46px;padding:10px 12px;border-radius:14px;border:1px solid rgba(0,140,255,.22);background:linear-gradient(180deg,rgba(0,140,255,.10),rgba(0,140,255,.03));color:#dbeaff;font-weight:700;letter-spacing:.2px;cursor:pointer;transition:.2s ease;box-shadow:inset 0 0 0 0 rgba(0,140,255,.25)}
.tbtn:hover{transform:translateY(-1px);box-shadow:inset 0 0 0 1px rgba(0,140,255,.25)}
.tbtn.active{background:linear-gradient(135deg,var(--elec3),var(--elec2));color:#04121f;border-color:transparent;box-shadow:0 10px 30px rgba(0,140,255,.35)}
.tbtn small{opacity:.9;font-weight:600}

.actions{display:flex;gap:10px;flex-wrap:wrap}
.btn{appearance:none;border:0;border-radius:16px;padding:12px 16px;font-weight:800;letter-spacing:.25px;cursor:pointer}
.btn.primary{background:linear-gradient(135deg,var(--elec3),var(--elec2));color:#04121f;box-shadow:0 8px 26px rgba(0,140,255,.35)}
.btn.ghost{background:transparent;border:1px solid var(--stroke);color:#eef3ff}
.btn.ok{background:linear-gradient(135deg,#1fae60,var(--ok));color:#071b10}

/* Toolbar & list */
.toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap}
.filters{display:flex;gap:8px;flex-wrap:wrap}
.pill{border:1px solid rgba(0,140,255,.22);color:#dbeaff;padding:8px 12px;border-radius:999px;font-size:13px;cursor:pointer;background:linear-gradient(180deg,rgba(0,140,255,.08),rgba(0,140,255,.02))}
.pill.active{background:linear-gradient(135deg,var(--elec3),var(--elec2));color:#04121f;border-color:transparent;box-shadow:0 8px 24px rgba(0,140,255,.25)}

.item{display:grid;grid-template-columns:1.1fr .9fr;gap:12px;border:1px solid var(--stroke);border-radius:16px;padding:14px;margin-bottom:12px;background:#0a0d14}
@media (max-width:780px){.item{grid-template-columns:1fr}}
.meta{display:grid;gap:6px}
.meta .h{font-weight:800}
.tags{display:flex;gap:6px;flex-wrap:wrap}
.tag{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#04121f;background:linear-gradient(135deg,var(--elec3),var(--elec2));padding:6px 10px;border-radius:999px}
.tag svg{width:14px;height:14px}
.muted{background:linear-gradient(135deg,#7aa3c7,#a7c6df)!important;color:#0b1b29}
.activeChat{background:linear-gradient(135deg,#1fae60,var(--ok))!important;color:#071b10}
.over{color:#ffb3b3}

.tasks{display:grid;gap:8px}
.task{border:1px solid var(--stroke);border-radius:12px;padding:10px;background:#090c12}
.task .row{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
.cta{display:flex;gap:8px;flex-wrap:wrap}
.cta a,.cta button{font-size:13px;padding:10px 12px;border-radius:12px;border:1px solid rgba(0,140,255,.22);background:linear-gradient(180deg,rgba(0,140,255,.08),rgba(0,140,255,.02));color:#dbeaff;text-decoration:none}
.cta a.primary{background:linear-gradient(135deg,var(--elec3),var(--elec2));color:#04121f;border-color:transparent}
.cta a.ok{background:linear-gradient(135deg,#1fae60,var(--ok));color:#071b10;border-color:transparent}

/* Stats */
.stats{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
.stat{background:#090c12;border:1px solid rgba(0,140,255,.18);border-radius:14px;padding:12px;display:grid;gap:6px}
.stat .n{font-size:22px;font-weight:800}
@media (max-width:900px){.stats{grid-template-columns:repeat(2,1fr)}}

/* Glow per task in scadenza oggi */
.task.dueToday{box-shadow:0 0 0 1px rgba(0,140,255,.35), 0 0 24px rgba(0,140,255,.25)}
@keyframes pulseGlow{0%{box-shadow:0 0 0 0 rgba(0,140,255,.25)}50%{box-shadow:0 0 0 6px rgba(0,140,255,.12)}100%{box-shadow:0 0 0 0 rgba(0,140,255,.25)}}
.task.dueToday{animation:pulseGlow 2.4s ease-in-out infinite}

  </style>
</head>
<body>
  <header class="title">
    <!-- Logo: cliccabile per caricare il tuo file e salvarlo in locale -->
    <img id="brandLogo" src="https://alessandroiascone.github.io/relong-nfc/img/relong-logo.png" alt="ReLong" style="cursor:pointer" title="Clicca per cambiare logo (salvato in locale)" onerror="this.replaceWith(Object.assign(document.createElement('div'),{textContent:'ReLong',style:'font-weight:900;font-size:20px;letter-spacing:.4px'}))">
    <input id="logoPicker" type="file" accept="image/*" hidden />
    <div>
      <h1>ReLong • Scadenzario Follow‑up</h1>
      <div class="subtitle">Attivazioni & Riparazioni → reminder smart con WhatsApp + Google Calendar. (No weekend, richiamo 18:00)</div>
    </div>
  </header>  <section class="card" style="max-width:1200px;margin:0 auto">
    <h2>Statistiche di oggi</h2>
    <div class="content">
      <div class="stats">
        <div class="stat"><div>Clienti inseriti</div><div class="n" id="st-created">0</div></div>
        <div class="stat"><div>Follow‑up in scadenza</div><div class="n" id="st-due">0</div></div>
        <div class="stat"><div>Completati oggi</div><div class="n" id="st-done">0</div></div>
        <div class="stat"><div>In ritardo</div><div class="n" id="st-late">0</div></div>
        <div class="stat"><div>Riparazioni oggi</div><div class="n" id="st-repairs">0</div></div>
      </div>
    </div>
  </section>  <div class="shell">
    <section class="card">
      <h2>Nuovo cliente</h2>
      <div class="content">
        <form id="form">
          <div>
            <label>Nome e Cognome</label>
            <input required id="name" placeholder="Mario Rossi" />
          </div>
          <div>
            <label>Telefono (solo cifre, WhatsApp)</label>
            <input required id="phone" placeholder="3331234567" inputmode="numeric" pattern="[0-9]+" />
          </div>
          <div class="full">
            <label>Brand (preselezionato)</label><br>
            <span class="brandpill"><span class="dot"></span> Vodafone</span>
            <input type="hidden" id="brandFixed" value="Vodafone">
          </div>
          <div>
            <label>Data attivazione</label>
            <input id="start" type="date" />
          </div><div class="full">
        <label>Cosa hai attivato ORA</label>
        <div class="toggle-grid" id="toggles">
          <button type="button" class="tbtn" data-key="sim">
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M6 2h7l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm2 9h2v2H8v-2zm0 3h2v2H8v-2zm3-3h2v2h-2v-2zm0 3h2v2h-2v-2z"/></svg>
            SIM Mobile
          </button>
          <button type="button" class="tbtn" data-key="fisso">
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 3c4.97 0 9 4.03 9 9h-2a7 7 0 1 0-7 7v2C6.03 21 2 16.97 2 12S6.03 3 12 3zm0 6a6 6 0 0 1 6 6h-2a4 4 0 1 0-4 4v2a6 6 0 1 1 0-12z"/></svg>
            Linea Fissa
          </button>
          <button type="button" class="tbtn" data-key="energia">
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M13 2L3 14h7v8l11-14h-8z"/></svg>
            Energia
          </button>
          <button type="button" class="tbtn" data-key="smartphone">
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M7 2h10a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm5 19a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
            Smartphone a rate
          </button>
          <button type="button" class="tbtn" data-key="riparazione">
            <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M22.7 19.3l-7.9-7.9a5 5 0 1 0-3.9 3.9l7.9 7.9a1 1 0 0 0 1.4 0l2.5-2.5a1 1 0 0 0 0-1.4zM7 10a3 3 0 1 1 6 0a3 3 0 0 1-6 0z"/></svg>
            Riparazione<br><small>PC/Smartphone/Console</small>
          </button>
        </div>
      </div>

      <div class="full">
        <label>Giorni promemoria</label>
        <div class="toggle-grid" style="grid-template-columns:repeat(2,1fr)">
          <div><label>Energia</label><input id="dEnergy" type="number" value="5" min="1"></div>
          <div><label>Linea Fissa</label><input id="dFiber" type="number" value="12" min="2"></div>
          <div><label>SIM</label><input id="dSIM" type="number" value="4" min="1"></div>
          <div><label>Smartphone</label><input id="dPhone" type="number" value="7" min="1"></div>
        </div>
      </div>

      <div class="full actions">
        <button class="btn primary" type="submit" id="insertBtn">Inserisci cliente</button>
      </div>
    </form>

    <div class="toolbar">
      <div class="filters">
        <button class="pill active" data-filter="all">Tutti</button>
        <button class="pill" data-filter="today">Oggi</button>
        <button class="pill" data-filter="late">In ritardo</button>
        <button class="pill" data-filter="done">Completati</button>
      </div>
      <div class="actions">
        <button class="btn ghost" id="export">Esporta .json</button>
        <label class="btn ghost" for="importFile" style="cursor:pointer">Importa .json</label>
        <input id="importFile" type="file" accept="application/json" hidden />
      </div>
    </div>

    <div id="list"></div>
  </div>
</section>

<aside class="card">
  <h2>Logica follow‑up</h2>
  <div class="content">
    <p class="subtitle">Reminder per i servizi <b>non attivati ora</b>. Se selezioni <b>Riparazione</b> → promemoria per <b>SIM, Fisso, Smartphone, Energia</b>. Weekend evitati, secondo richiamo 18:00 pronto.</p>
    <ul style="margin-left:18px;display:grid;gap:6px">
      <li><b>Attivo SIM</b> → Energia, Fisso, Smartphone</li>
      <li><b>Attivo Fisso</b> → SIM, Energia, Smartphone</li>
      <li><b>Attivo Fisso + Mobile</b> → Energia, Smartphone</li>
      <li><b>Attivo Energia</b> → Fisso, SIM, Smartphone</li>
      <li><b>Attivo Fisso + Energia</b> → SIM, Smartphone</li>
      <li><b>Attivo SIM + Smartphone</b> → Fisso, Energia</li>
      <li><b>Riparazione</b> → SIM, Fisso, Smartphone, Energia</li>
    </ul>
  </div>
</aside>

  </div>  <template id="tpl-item">
    <div class="item">
      <div class="meta">
        <div class="h"></div>
        <div class="tags"></div>
      </div>
      <div class="tasks"></div>
    </div>
  </template>  <template id="tpl-task">
    <div class="task">
      <div class="row">
        <div>
          <b class="tname"></b>
          <span class="due"></span>
        </div>
        <div class="cta"></div>
      </div>
    </div>
  </template>  <script>
    // --- Utils ---
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => [...r.querySelectorAll(s)];

    const storeKey = 'relong-scadenzario-v7';
    const load = () => JSON.parse(localStorage.getItem(storeKey) || '[]');
    const save = (arr) => localStorage.setItem(storeKey, JSON.stringify(arr));

    const fmtDate = (d) => d.toLocaleDateString('it-IT', {year:'numeric', month:'2-digit', day:'2-digit'});
    const fmtDateTimeParam = (d) => {
      const pad = (n)=>String(n).padStart(2,'0');
      const z = new Date(d.getTime());
      return z.getUTCFullYear()+pad(z.getUTCMonth()+1)+pad(z.getUTCDate())+'T'+pad(z.getUTCHours())+pad(z.getUTCMinutes())+pad(z.getUTCSeconds())+'Z';
    }

    const today = () => { const d=new Date(); d.setHours(0,0,0,0); return d };
    const addDays = (d, n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x }
    const avoidWeekend = (d) => {
      const x = new Date(d);
      const day = x.getDay(); // 0=Dom,6=Sab
      if(day===0) x.setDate(x.getDate()+1);
      if(day===6) x.setDate(x.getDate()+2);
      return x;
    }

    // --- Stato ---
    let items = load();

    // Logo picker (salva base64 in localStorage)
    const logoImg = $('#brandLogo');
    const logoPicker = $('#logoPicker');
    const savedLogo = localStorage.getItem('relong-logo');
    if(savedLogo) logoImg.src = savedLogo;
    logoImg.addEventListener('click', ()=> logoPicker.click());
    logoPicker.addEventListener('change', (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = ()=>{ localStorage.setItem('relong-logo', r.result); logoImg.src = r.result; };
      r.readAsDataURL(f);
    });

    // Toggles behavior
    const toggles = $('#toggles');
    const activeSet = new Set();
    toggles.addEventListener('click', (e)=>{
      const b = e.target.closest('.tbtn');
      if(!b) return;
      const key = b.dataset.key;
      b.classList.toggle('active');
      if(b.classList.contains('active')) activeSet.add(key); else activeSet.delete(key);
    });

    // --- Form ---
    const form = $('#form');
    const nameI = $('#name');
    const phoneI = $('#phone');
    const brandFixed = $('#brandFixed');
    const startI = $('#start');

    const dEnergyI = $('#dEnergy');
    const dFiberI = $('#dFiber');
    const dSIMI = $('#dSIM');
    const dPhoneI = $('#dPhone');

    startI.valueAsDate = new Date();

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      // In un solo tasto: chiedi permesso notifiche (se necessario) + inserisci
      try{
        if('Notification' in window && Notification.permission==='default'){
          await Notification.requestPermission();
        }
      }catch{}

      const name = nameI.value.trim();
      const phone = phoneI.value.trim();
      if(!name || !phone) return;

      const brand = brandFixed.value; // unico brand
      const start = startI.value ? new Date(startI.value) : new Date();

      const activated = new Set(activeSet);
      const all = ['energia','fisso','sim','smartphone'];

      let targets;
      if (activated.has('riparazione')) {
        targets = all.slice();
      } else {
        targets = all.filter(t => !activated.has(t));
      }

      const days = {
        energia: parseInt(dEnergyI.value||'5',10),
        fisso: parseInt(dFiberI.value||'12',10),
        sim: parseInt(dSIMI.value||'4',10),
        smartphone: parseInt(dPhoneI.value||'7',10),
      };

      const tasks = targets.map(type=>{
        let due = addDays(start, days[type]);
        due = avoidWeekend(due); // sempre attivo
        return { type, due: due.toISOString() };
      });

      const id = Date.now()+Math.random().toString(16).slice(2);
      items.unshift({
        id, name, phone, brand,
        start: start.toISOString(),
        createdAt: new Date().toISOString(),
        activated:[...activated],
        tasks, done:false,
        optWeekend: true, optEvening: true,
        muteDate: null, activeChatUntil: null, doneAt: null
      });
      save(items);
      form.reset(); startI.valueAsDate = new Date();
      dEnergyI.value=5; dFiberI.value=12; dSIMI.value=4; dPhoneI.value=7; activeSet.clear(); $$('.tbtn.active').forEach(b=>b.classList.remove('active'));
      render();
      if('Notification' in window && Notification.permission==='granted') new Notification('Cliente inserito nello scadenzario ✅');
    });

    function maybeNotify(text){
      if('Notification' in window && Notification.permission==='granted' && document.visibilityState==='visible')
        new Notification(text);
    }

    // --- Filtro & Render + Stats ---
    let filter = 'all';
    $$('.pill').forEach(p=>p.addEventListener('click',()=>{
      $$('.pill').forEach(x=>x.classList.remove('active')); p.classList.add('active');
      filter = p.dataset.filter; render();
    }));

    function render(){
      const list = $('#list'); list.innerHTML='';
      const now = today();
      const tStr = fmtDate(now);

      const data = items.filter(it=>{
        if(filter==='done') return it.done;
        if(filter==='late') return !it.done && it.tasks.some(tsk=>new Date(tsk.due)<now);
        if(filter==='today') return !it.done && it.tasks.some(tsk=>fmtDate(new Date(tsk.due))===tStr);
        return true;
      });

      data.forEach(it=>list.appendChild(renderItem(it)));

      // Stats
      const createdToday = items.filter(it=>fmtDate(new Date(it.createdAt||it.start))===tStr).length;
      const dueToday = items.reduce((n,it)=> n + (it.done?0: it.tasks.filter(tsk=>fmtDate(new Date(tsk.due))===tStr).length), 0);
      const doneToday = items.filter(it=>it.done && fmtDate(new Date(it.doneAt||it.start))===tStr).length;
      const late = items.reduce((n,it)=> n + (it.done?0: it.tasks.filter(tsk=>new Date(tsk.due)<now).length), 0);
      const repairsToday = items.filter(it=> (it.activated||[]).includes('riparazione') && fmtDate(new Date(it.createdAt||it.start))===tStr).length;

      $('#st-created').textContent = createdToday;
      $('#st-due').textContent = dueToday;
      $('#st-done').textContent = doneToday;
      $('#st-late').textContent = late;
      $('#st-repairs').textContent = repairsToday;
    }

    function iconSVG(type){
      const map = {
        energia:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M13 2L3 14h7v8l11-14h-8z"/></svg>',
        fisso:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 3c4.97 0 9 4.03 9 9h-2a7 7 0 1 0-7 7v2C6.03 21 2 16.97 2 12S6.03 3 12 3z"/></svg>',
        sim:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M6 2h7l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"/></svg>',
        smartphone:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M7 2h10a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"/></svg>',
        riparazione:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M22.7 19.3l-7.9-7.9a5 5 0 1 0-3.9 3.9l7.9 7.9a1 1 0 0 0 1.4 0l2.5-2.5a1 1 0 0 0 0-1.4z"/></svg>'
      };
      return map[type]||'';
    }

    function renderItem(it){
      const t = $('#tpl-item').content.firstElementChild.cloneNode(true);
      if(it.done) t.classList.add('done');

      t.querySelector('.h').textContent = `${it.name} • ${it.phone}`;
      const tags = t.querySelector('.tags');
      tags.innerHTML = '';
      it.activated.forEach(a=>{
        const s = document.createElement('span');
        s.className='tag';
        s.innerHTML = iconSVG(a) + '<span>Attivato: '+labelOf(a)+'</span>';
        tags.append(s);
      });
      if(isMutedToday(it)) tags.append(tag('Silenzioso oggi','muted'));
      if(isActiveChat(it)) tags.append(tag('In chat','activeChat'));
      if(it.done) tags.append(tag('Completato'));

      const tasksWrap = t.querySelector('.tasks');
      tasksWrap.innerHTML='';
      it.tasks.forEach(task=>tasksWrap.appendChild(renderTask(it, task)));

      // Toggle silenzio oggi
      const muteBtn = document.createElement('button');
      muteBtn.className='btn ghost';
      muteBtn.textContent = isMutedToday(it)? 'Riattiva notifiche oggi' : 'Sto già chattando (silenzia oggi)';
      muteBtn.addEventListener('click',()=>{
        it.muteDate = isMutedToday(it)? null : fmtDate(new Date());
        save(items); render();
      });
      t.appendChild(muteBtn);

      return t;
    }

    function renderTask(it, task){
      const el = $('#tpl-task').content.firstElementChild.cloneNode(true);
      const due = new Date(task.due);
      const late = !it.done && due<today();
      const isToday = fmtDate(due)===fmtDate(new Date());
      if(isToday) el.classList.add('dueToday');

      el.querySelector('.tname').textContent = `Follow‑up ${labelOf(task.type)}`;
      el.querySelector('.due').innerHTML = ` • scadenza: <b class="${late?'over':''}">${fmtDate(due)}</b>`;

      const cta = el.querySelector('.cta');
      const wa = waFor(it, task.type);
      if(wa){
        const a = aBtn(wa.href, wa.text, 'ok');
        a.dataset.wa = '1';
        a.dataset.id = it.id;
        cta.append(a);
      }

      // Calendar 10:00
      const s = new Date(task.due); s.setHours(10,0,0,0);
      const e = new Date(s.getTime()+30*60000);
      const title = encodeURIComponent(`Follow‑up ${labelOf(task.type)} • ${it.name}`);
      const calUrl = `https://calendar.google.com/calendar/u/0/r/eventedit?text=${title}&dates=${fmtDateTimeParam(s)}/${fmtDateTimeParam(e)}&details=${encodeURIComponent('Promemoria generato da Scadenzario ReLong')}`;
      cta.append(aBtn(calUrl, 'Calendar 10:00', 'primary'));

      // Calendar 18:00
      const s2 = new Date(task.due); s2.setHours(18,0,0,0);
      const e2 = new Date(s2.getTime()+30*60000);
      const calUrl2 = `https://calendar.google.com/calendar/u/0/r/eventedit?text=${title}%20(Secondo%20richiamo)&dates=${fmtDateTimeParam(s2)}/${fmtDateTimeParam(e2)}&details=${encodeURIComponent('Richiamo serale (notifiche smart)')}`;
      cta.append(aBtn(calUrl2, 'Calendar 18:00', 'primary'));

      // Snooze +1 giorno (evita weekend)
      const btnSnooze = document.createElement('button');
      btnSnooze.textContent = 'Snooze +1 giorno';
      btnSnooze.addEventListener('click',()=>{
        let nd = addDays(new Date(task.due), 1);
        nd = avoidWeekend(nd);
        task.due = nd.toISOString();
        save(items); render(); maybeNotify('Spostato a domani ✔️');
      });
      cta.append(btnSnooze);

      // Stato
      const btnDone = document.createElement('button');
      btnDone.textContent = 'Segna cliente completato';
      btnDone.addEventListener('click',()=>{ it.done=true; it.doneAt=new Date().toISOString(); save(items); render(); });
      cta.append(btnDone);

      const btnDel = document.createElement('button');
      btnDel.textContent = 'Elimina cliente';
      btnDel.addEventListener('click',()=>{ items = items.filter(x=>x.id!==it.id); save(items); render(); });
      cta.append(btnDel);

      return el;
    }

    function labelOf(type){
      return ({energia:'Energia', fisso:'Internet Casa', sim:'SIM', smartphone:'Smartphone a rate', riparazione:'Riparazione'})[type] || type;
    }

    function waFor(it, type){
      const site = encodeURIComponent('https://alessandroiascone.github.io/relong-nfc/relong-hub-v2.html');
      const base = `Ciao ${it.name}, sono Alessandro di Re Long (08119578844).`;
      const map = {
        energia: `${base}
Essendo cliente ${it.brand} hai diritto allo sconto Energia dedicato. Ti va se ti spiego in 1 minuto come risparmiare sulla bolletta?
Hub: ${decodeURIComponent(site)}`,
        fisso: `${base}
Abbiamo offerte Internet Casa dedicate: FTTC/FTTH con prezzi riservati ai nostri clienti. Vuoi una verifica copertura+simulazione rapida?
Hub: ${decodeURIComponent(site)}`,
        sim: `${base}
Se ti serve una linea mobile, abbiamo SIM con Giga/Min illimitati e promo per clienti in store. Vuoi i dettagli e la portabilità?
Hub: ${decodeURIComponent(site)}`,
        smartphone: `${base}
Possiamo proporti uno smartphone a rate (anche senza busta paga). Valutiamo anche il tuo usato e Postepay Evolution è OK. Vuoi una proposta su misura?
Hub: ${decodeURIComponent(site)}`,
      };
      const txt = encodeURIComponent(map[type]);
      return { href:`https://wa.me/39${it.phone}?text=${txt}`, text:`WhatsApp ${labelOf(type)}` };
    }

    function tag(txt, extraClass=''){ const s=document.createElement('span'); s.className='tag'; if(extraClass) s.classList.add(extraClass); s.textContent=txt; return s }
    function aBtn(href, txt, cls=''){ const a=document.createElement('a'); a.href=href; a.target='_blank'; a.rel='noopener'; a.textContent=txt; if(cls) a.classList.add(cls); return a }

    // Delego click su WhatsApp per marcare "in chat"
    $('#list').addEventListener('click', (e)=>{
      const a = e.target.closest('a[data-wa="1"]');
      if(!a) return;
      const id = a.dataset.id;
      const it = items.find(x=>x.id===id);
      if(it){
        const until = new Date(Date.now()+45*60*1000);
        it.activeChatUntil = until.toISOString();
        it.muteDate = fmtDate(new Date());
        save(items); render();
      }
    });

    function isMutedToday(it){ return it.muteDate && it.muteDate===fmtDate(new Date()); }
    function isActiveChat(it){ return it.activeChatUntil && new Date(it.activeChatUntil) > new Date(); }

    // Boot
    render();

    // Notifiche intelligenti
    setTimeout(()=>{
      const now = new Date();
      const tStr = fmtDate(now);
      const dueList = items.filter(it=>!it.done && !isMutedToday(it) && !isActiveChat(it) && it.tasks.some(tsk=>fmtDate(new Date(tsk.due))===tStr));
      if(dueList.length) maybeNotify(`Follow‑up di oggi: ${dueList.length} clienti (smart)`);

      const at18 = new Date(); at18.setHours(18,0,0,0);
      const ms = at18 - now;
      if(ms>0 && ms < 14*60*60*1000){
        setTimeout(()=>{
          const pending = items.filter(it=>!it.done && !isMutedToday(it) && !isActiveChat(it) && it.tasks.some(tsk=>fmtDate(new Date(tsk.due))===fmtDate(new Date())));
          if(pending.length) maybeNotify(`Richiamo 18:00: ${pending.length} clienti ancora da contattare (smart)`);
        }, ms);
      }
    }, 800);
  </script></body>
</html>
