<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ReLong • Scadenzario + Accettazione + Pacchi Sync</title>
  <meta name="theme-color" content="#0a0a0a" />
  <style>
    /* --- Theme: Premium Dark + Electric Blue --- */
    *{box-sizing:border-box;margin:0;padding:0;-webkit-font-smoothing:antialiased}
    :root{
      --bg1:#0b0d12; --bg2:#06070b;
      --card:rgba(14,16,22,.92); --stroke:rgba(255,255,255,.08);
      --muted:rgba(210,220,255,.70);
      --elec:#0aa2ff; --elec2:#66d1ff; --elec3:#008cff;
      --ok:#25D366; --danger:#ff4d4f;
      --shadow:0 10px 40px rgba(0,140,255,.18), inset 0 1px 0 rgba(255,255,255,.04);
      /* Stato colors */
      --st-diagnostica:#ffd666;
      --st-ricambi:#ffa940;
      --st-lavorazione:#69c0ff;
      --st-pronto:#95de64;
      --st-consegnato:#bfbfbf;
      --pacchi:#00d1b2;
    }
    body{min-height:100svh;font-family:system-ui,-apple-system,Inter,Roboto,sans-serif;color:#eef3ff;
      background:radial-gradient(65% 65% at 25% 15%, var(--bg1), var(--bg2));
      padding:24px;display:flex;flex-direction:column;gap:24px}
    .shell{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1.2fr .8fr;gap:20px}
    @media (max-width:980px){.shell{grid-template-columns:1fr;}}

    .card{background:var(--card);border:1px solid var(--stroke);border-radius:22px;box-shadow:var(--shadow)}
    .card h2{font-size:18px;font-weight:800;padding:18px 18px 0;letter-spacing:.3px}
    .card .content{padding:18px}

    /* Header */
    .title{display:flex;align-items:center;gap:14px}
    .title img{height:36px;aspect-ratio:auto;display:block;filter:drop-shadow(0 8px 24px rgba(0,140,255,.25))}
    .title h1{font-size:26px;letter-spacing:.2px}
    .subtitle{color:var(--muted);font-size:14px}

    /* Form */
    .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .full{grid-column:1/-1}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{margin-top:6px;background:#0a0d14;border:1px solid var(--stroke);color:#eef3ff;border-radius:14px;padding:12px 14px;font-size:15px}
    textarea{min-height:84px;resize:vertical}

    /* Toggles */
    .toggle-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:8px}
    @media (max-width:980px){.toggle-grid{grid-template-columns:repeat(2,1fr)}}
    .tbtn{position:relative;display:flex;align-items:center;justify-content:center;text-align:center;min-height:46px;padding:10px 12px;border-radius:14px;border:1px solid rgba(0,140,255,.22);background:linear-gradient(180deg,rgba(0,140,255,.10),rgba(0,140,255,.03));color:#dbeaff;font-weight:700;letter-spacing:.2px;cursor:pointer;transition:.2s ease;box-shadow:inset 0 0 0 0 rgba(0,140,255,.25)}
    .tbtn:hover{transform:translateY(-1px);box-shadow:inset 0 0 0 1px rgba(0,140,255,.25)}
    .tbtn.active{background:linear-gradient(135deg,var(--elec3),var(--elec2));color:#04121f;border-color:transparent;box-shadow:0 10px 30px rgba(0,140,255,.35)}
    .tbtn small{opacity:.9;font-weight:600}

    .actions{display:flex;gap:10px;flex-wrap:wrap}
    #insertBtn{width:100%;display:block}
    .btn{appearance:none;border:0;border-radius:16px;padding:12px 16px;font-weight:800;letter-spacing:.25px;cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--elec3),var(--elec2));color:#04121f;box-shadow:0 8px 26px rgba(0,140,255,.35)}
    .btn.ghost{background:transparent;border:1px solid var(--stroke);color:#eef3ff}
    .btn.ok{background:linear-gradient(135deg,#1fae60,var(--ok));color:#071b10}

    /* Toolbar & list */
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap}
    .filters{display:flex;gap:8px;flex-wrap:wrap}
    .pill{border:1px solid rgba(0,140,255,.22);color:#dbeaff;padding:8px 12px;border-radius:999px;font-size:13px;cursor:pointer;background:linear-gradient(180deg,rgba(0,140,255,.08),rgba(0,140,255,.02))}
    .pill.active{background:linear-gradient(135deg,var(--elec3),var(--elec2));color:#04121f;border-color:transparent;box-shadow:0 8px 24px rgba(0,140,255,.25)}
    .search{display:flex;gap:8px;align-items:center}
    .search input{min-width:220px}

    /* Stats mini-dashboard */
    .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin:10px 0 0}
    .stat{background:#090c12;border:1px solid rgba(0,140,255,.18);border-radius:14px;padding:10px;display:grid;gap:4px}
    .stat .n{font-size:20px;font-weight:800}
    @media (max-width:680px){.stats{grid-template-columns:1fr}}

    /* Item compatto */
    .item{display:grid;grid-template-columns:1fr;gap:10px;border:1px solid var(--stroke);border-radius:16px;padding:12px;margin-bottom:10px;background:#0a0d14}
    .meta{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .h{font-weight:800}
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .tag{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#04121f;background:linear-gradient(135deg,var(--elec3),var(--elec2));padding:4px 8px;border-radius:999px}
    .muted{background:linear-gradient(135deg,#7aa3c7,#a7c6df)!important;color:#0b1b29}
    .activeChat{background:linear-gradient(135deg,#1fae60,var(--ok))!important;color:#071b10}
    .pacchi{background:linear-gradient(135deg,var(--pacchi),#7ffbe6)!important;color:#05312a}

    /* Stato chip */
    .st-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700;color:#0a0a0a}
    .st-diagnostica{background:var(--st-diagnostica)}
    .st-attesa-ricambi{background:var(--st-ricambi)}
    .st-lavorazione{background:var(--st-lavorazione)}
    .st-pronto{background:var(--st-pronto)}
    .st-consegnato{background:var(--st-consegnato)}

    /* Riepilogo reminders */
    .summary{display:grid;gap:8px}
    .accept-brief{background:#091019;border:1px solid rgba(0,140,255,.2);border-radius:10px;padding:8px;display:grid;gap:8px}
    .row-slim{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
    .accept-brief small{color:var(--muted)}
    .r-line{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .r-badge{border:1px solid rgba(0,140,255,.25);background:linear-gradient(180deg,rgba(0,140,255,.10),rgba(0,140,255,.02));color:#dbeaff;font-size:12px;border-radius:999px;padding:6px 10px;display:inline-flex;gap:6px;align-items:center}
    .wa-btn{font-size:12px;padding:6px 8px;border-radius:9px;border:1px solid rgba(0,140,255,.22);background:linear-gradient(180deg,rgba(0,140,255,.08),rgba(0,140,255,.02));color:#dbeaff;text-decoration:none;display:inline-flex;gap:6px;align-items:center}
    .wa-btn.ok{background:linear-gradient(135deg,#1fae60,var(--ok));color:#071b10;border-color:transparent}
    .wa-ico{width:14px;height:14px;display:inline-block}
    .wa-ico svg{width:14px;height:14px;display:block}

    /* Visibilità accettazione: nascosta di default */
    #acceptWrap{display:none}
    #acceptWrap.show{display:block}

    /* Sezione elenco: nascosta finché non si apre */
    #listSection[hidden]{display:none}
    .openListCard{max-width:1200px;margin:0 auto}

    /* PIN Gate */
    #pinGate{position:fixed;inset:0;background:linear-gradient(180deg,rgba(0,10,20,.9),rgba(0,0,0,.95));backdrop-filter:blur(6px);display:grid;place-items:center;z-index:9999}
    #pinCard{background:var(--card);border:1px solid var(--stroke);border-radius:20px;box-shadow:var(--shadow);padding:20px 18px;max-width:360px;width:92%;display:grid;gap:12px}
    #pinCard h3{margin:0;font-size:18px}
    #pinCard p{color:var(--muted);font-size:13px}
    #pinInput{letter-spacing:6px;text-align:center;font-weight:800}
    #pinError{color:#ff7676;min-height:18px;font-size:12px}
  </style>
</head>
<body>
  <!-- PIN Gate -->
  <div id="pinGate" hidden>
    <div id="pinCard">
      <h3>Accesso protetto</h3>
      <p>Inserisci il PIN a 4 cifre per aprire lo scadenzario.</p>
      <input id="pinInput" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="••••" />
      <div class="actions">
        <button id="pinOk" class="btn primary" style="flex:1">Sblocca</button>
      </div>
      <div id="pinError"></div>
      <p style="font-size:11px">Nota: blocco base lato client (per blocco serio serve lato server).</p>
    </div>
  </div>

  <header class="title" aria-hidden="true">
    <img id="brandLogo" src="https://alessandroiascone.github.io/relong-nfc/img/relong-logo.png" alt="ReLong" style="cursor:pointer" title="Clicca per cambiare logo (salvato in locale)" onerror="this.replaceWith(Object.assign(document.createElement('div'),{textContent:'ReLong',style:'font-weight:900;font-size:20px;letter-spacing:.4px'}))">
    <input id="logoPicker" type="file" accept="image/*" hidden />
    <div>
      <h1>ReLong • Scadenzario + Accettazione</h1>
      <div class="subtitle">Attivazioni, Riparazioni & Pacchi → reminder smart con WhatsApp + Google Calendar.</div>
    </div>
  </header>

  <section class="card" style="max-width:1200px;margin:0 auto" aria-hidden="true">
    <h2>Dati cliente (unici)</h2>
    <div class="content grid2">
      <div>
        <label>Nome e Cognome</label>
        <input required id="c_name" placeholder="Mario Rossi" />
      </div>
      <div>
        <label>Telefono (solo cifre, WhatsApp)</label>
        <input required id="c_phone" placeholder="3331234567" inputmode="numeric" pattern="[0-9]+" />
      </div>
    </div>
  </section>

  <div class="shell" aria-hidden="true">
    <section class="card">
      <h2>Attivazioni</h2>
      <div class="content">
        <div class="grid2">
          <div>
            <label>Data attivazione</label>
            <input id="start" type="date" />
          </div>
          <div class="full">
            <label>Cosa hai attivato ORA</label>
            <div class="toggle-grid" id="toggles">
              <button type="button" class="tbtn" data-key="sim">SIM Mobile</button>
              <button type="button" class="tbtn" data-key="fisso">Linea Fissa</button>
              <button type="button" class="tbtn" data-key="energia">Energia</button>
              <button type="button" class="tbtn" data-key="smartphone">Smartphone a rate</button>
              <button type="button" class="tbtn" data-key="riparazione">Riparazione</button>
            </div>
          </div>
        </div>
        <div class="actions" style="margin-top:12px">
          <button class="btn primary" id="insertBtn">Inserisci cliente</button>
        </div>
      </div>
    </section>

    <!-- Accettazione: nascosta finché non si seleziona "riparazione" -->
    <aside class="card" id="acceptWrap">
      <h2>Accettazione dispositivo (Assistenza)</h2>
      <div class="content">
        <form id="acceptForm" class="grid2" onsubmit="return false;">
          <div>
            <label>Tipo dispositivo</label>
            <select id="a_type">
              <option>Smartphone</option>
              <option>Computer</option>
              <option>Stampante</option>
              <option>Console & Accessori</option>
              <option>Richiesta Preventivo</option>
            </select>
          </div>
          <div>
            <label>Marca</label>
            <select id="a_brand">
              <option>Apple</option>
              <option>Samsung</option>
              <option>Oppo</option>
              <option>Redmi</option>
              <option>Xiaomi</option>
              <option>Honor</option>
              <option>Other</option>
            </select>
          </div>
          <div>
            <label>Modello</label>
            <input id="a_model" placeholder="iPhone 13, Galaxy S21…" />
          </div>
          <div class="full">
            <label>Difetto / Problema</label>
            <textarea id="a_issue" placeholder="Descrivi il problema segnalato…"></textarea>
          </div>
          <p class="subtitle full" style="margin-top:4px">Con Riparazione attiva il tasto principale diventa “Accetta & Inserisci”.</p>
        </form>
      </div>
    </aside>
  </div>

  <!-- Pulsante Apri/Chiudi elenco + Sync Pacchi -->
  <section class="card openListCard" aria-hidden="true">
    <div class="content" style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div>
        <h2 style="padding:0">Clienti & Promemoria</h2>
        <div class="subtitle">Apri l’elenco solo quando ti serve cercare o contattare.</div>
        <!-- Mini dashboard -->
        <div class="stats" id="stats">
          <div class="stat">
            <div class="l">Oggi da Pacchi</div>
            <div class="n" id="st-pacchi-today">0</div>
          </div>
          <div class="stat">
            <div class="l">Totale da Pacchi</div>
            <div class="n" id="st-pacchi-total">0</div>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="syncPacchiBtn" class="btn ghost" title="Importa subito eventuali nuovi contatti da Ritiro/Consegna Pacchi">Forza Sync Pacchi</button>
        <button id="toggleListBtn" class="btn ghost">Apri elenco</button>
      </div>
    </div>
  </section>

  <section class="card" id="listSection" style="max-width:1200px;margin:0 auto" hidden aria-hidden="true">
    <div class="content">
      <div class="toolbar">
        <div class="filters">
          <button class="pill active" data-filter="all">Tutti</button>
          <button class="pill" data-filter="today">Oggi</button>
          <button class="pill" data-filter="late">In ritardo</button>
          <button class="pill" data-filter="done">Completati</button>
          <button class="pill" data-filter="only-acc">Solo accettazioni</button>
        </div>
        <div class="search">
          <label>Cerca</label>
          <input id="q" placeholder="Nome, telefono, ID pratica, modello…" />
        </div>
      </div>
      <div id="list"></div>
    </div>
  </section>

  <template id="tpl-item">
    <div class="item">
      <div class="meta">
        <div class="h"></div>
        <div class="tags"></div>
      </div>
      <div class="summary"></div>
    </div>
  </template>

  <script>
    // --- Utils ---
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => [...r.querySelectorAll(s)];

    const storeKey = 'relong-scadenzario-v22';
    const backupPrefix = 'relong-backup-'; // + YYYY-MM-DD
    const PACCHI_KEYS = ['relong-pacchi-v1', 'relong-pacchi-v2'];
    const PACCHI_INGESTED_KEY = 'relong-pacchi-ingested';
    const load = () => { try { const raw = localStorage.getItem(storeKey); return raw ? JSON.parse(raw) : []; } catch(e){ console.warn('Storage danneggiato, azzero lo scadenzario:', e); localStorage.removeItem(storeKey); return []; } };
    const save = (arr) => localStorage.setItem(storeKey, JSON.stringify(arr));

    const fmtDate = (d) => d.toLocaleDateString('it-IT', {year:'numeric', month:'2-digit', day:'2-digit'});
    const fmtDateShort = (d) => d.toLocaleDateString('it-IT', {month:'2-digit', day:'2-digit'});
    const isoDay = (d)=> d.toISOString().slice(0,10);

    const today = () => { const d=new Date(); d.setHours(0,0,0,0); return d }
    const addDays = (d, n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x }
    const avoidWeekend = (d) => { const x = new Date(d); const day = x.getDay(); if(day===0) x.setDate(x.getDate()+1); if(day===6) x.setDate(x.getDate()+2); return x }

    // Giorni preimpostati
    const DEFAULT_DAYS = { energia:10, fisso:17, sim:9, smartphone:12 };
    const ACCEPT_DAYS   = { energia:15, fisso:20, sim:12, smartphone:15 };

    // --- Stato ---
    let items = load();

    // Sequenza ID pratica per anno
    function nextPraticaId(){
      const key='relong-pratica-seq';
      const y = new Date().getFullYear();
      let seq;
      try{ seq = JSON.parse(localStorage.getItem(key) || '[]'); } catch { seq = []; }
      let rec = seq.find(r=>r.year===y);
      if(!rec){ rec={year:y,n:0}; seq.push(rec); }
      rec.n += 1; localStorage.setItem(key, JSON.stringify(seq));
      return `RL-${y}-${String(rec.n).padStart(4,'0')}`;
    }

    // Logo picker
    const logoImg = $('#brandLogo');
    const logoPicker = $('#logoPicker');
    const savedLogo = localStorage.getItem('relong-logo');
    if(savedLogo) logoImg.src = savedLogo;
    logoImg.addEventListener('click', ()=> logoPicker.click());
    logoPicker.addEventListener('change', (e)=>{ const f = e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ localStorage.setItem('relong-logo', r.result); logoImg.src=r.result; }; r.readAsDataURL(f); });

    // Shared customer inputs
    const c_name = $('#c_name');
    const c_phone = $('#c_phone');

    // Accettazione UI refs
    const acceptWrap = $('#acceptWrap');
    const aForm = $('#acceptForm');
    const a_type = $('#a_type');
    const a_brand = $('#a_brand');
    const a_model = $('#a_model');
    const a_issue = $('#a_issue');

    // Toggles attivazioni
    const toggles = $('#toggles');
    const activeSet = new Set();

    function updateAcceptanceUI(){
      const isRepair = activeSet.has('riparazione');
      acceptWrap.classList.toggle('show', isRepair);
      $('#insertBtn').textContent = isRepair ? 'Accetta & Inserisci' : 'Inserisci cliente';
      if(!isRepair){ aForm.reset(); }
    }

    toggles.addEventListener('click', (e)=>{
      const b = e.target.closest('.tbtn'); if(!b) return;
      const key = b.dataset.key;
      b.classList.toggle('active');
      if(b.classList.contains('active')) activeSet.add(key); else activeSet.delete(key);
      updateAcceptanceUI();
    });

    // --- Attivazioni (Inserisci cliente) ---
    const insertBtn = $('#insertBtn');
    const startI = $('#start');

    // Data default = oggi
    try{
      const d=new Date(); const pad=n=>String(n).padStart(2,'0');
      if(startI && 'valueAsDate' in startI) startI.valueAsDate = d;
      else if(startI){ startI.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
    }catch{}

    insertBtn.addEventListener('click', async ()=>{
      try{
        const httpsOk = (typeof isSecureContext !== 'undefined' ? isSecureContext : (location.protocol === 'https:' || location.hostname === 'localhost'));
        if('Notification' in window && httpsOk && Notification.permission==='default'){ await Notification.requestPermission(); }
      }catch{}

      const name = c_name.value.trim();
      let phone = (c_phone.value||'').trim();
      phone = phone.replace(/\D/g,'');
      if(phone.startsWith('0')) phone = phone.slice(1);
      if(!name || !phone) return alert('Inserisci nome e telefono cliente (solo cifre)');

      const start = startI.value ? new Date(startI.value) : new Date();
      const activated = new Set(activeSet);

      // Se RIPARAZIONE: accetta + inserisce
      if(activated.has('riparazione')){
        const device = {
          type:a_type.value,
          brand:a_brand.value,
          model:a_model.value.trim(),
          issue:a_issue.value.trim()
        };
        if(!device.type){ return alert('Seleziona il tipo dispositivo'); }

        const id = Date.now()+Math.random().toString(16).slice(2);
        const praticaId = nextPraticaId();

        const all = ['energia','fisso','sim','smartphone'];
        const tasks = all.map(type=>{
          let due = addDays(new Date(), ACCEPT_DAYS[type]);
          due = avoidWeekend(due);
          return { type, due: due.toISOString() };
        });

        const obj = {
          id, praticaId, name, phone,
          start: new Date().toISOString(), createdAt: new Date().toISOString(),
          activated:['riparazione'], tasks, done:false,
          optWeekend:true, optEvening:true,
          muteDate:null, activeChatUntil:null, doneAt:null,
          acceptance:true, device, repairStatus:'diagnostica'
        };
        items.unshift(obj); save(items); render(); aForm.reset();

        // WhatsApp accettazione
        const site = 'https://alessandroiascone.github.io/relong-nfc/relong-hub-v2.html';
        const msg = `Ciao, ${name}, abbiamo accettato il tuo prodotto in assistenza.
Marchio: ${device.brand}
Modello: ${device.model || '-'}
Difetto dichiarato: ${device.issue || '-'}

Ti aggiorneremo noi per il ritiro. Grazie!
Nel frattempo puoi visionare qui i nostri servizi:
${site}`;
        const wa = `https://wa.me/39${phone}?text=${encodeURIComponent(msg)}`;
        try{ window.open(wa, '_blank'); }catch{}
        return;
      }

      // Attivazioni classiche (no riparazione)
      const all = ['energia','fisso','sim','smartphone'];
      const targets = all.filter(t => !activated.has(t));
      const tasks = targets.map(type=>{
        let due = addDays(start, DEFAULT_DAYS[type]);
        due = avoidWeekend(due);
        return { type, due: due.toISOString() };
      });

      const id = Date.now()+Math.random().toString(16).slice(2);
      items.unshift({
        id, name, phone, start: start.toISOString(), createdAt: new Date().toISOString(),
        activated:[...activated], tasks, done:false,
        optWeekend:true, optEvening:true,
        muteDate:null, activeChatUntil:null, doneAt:null,
        acceptance:false, praticaId:null, source:null
      });
      save(items);
      activeSet.clear(); $$('.tbtn.active').forEach(b=>b.classList.remove('active'));
      updateAcceptanceUI();
      render();
    });

    // --- Apri/Chiudi elenco ---
    const listSection = $('#listSection');
    const toggleListBtn = $('#toggleListBtn');
    function setListOpen(open){
      listSection.hidden = !open;
      listSection.setAttribute('aria-hidden', open ? 'false' : 'true');
      toggleListBtn.textContent = open ? 'Chiudi elenco' : 'Apri elenco';
      if(open) render();
    }
    toggleListBtn.addEventListener('click', ()=> setListOpen(listSection.hidden));

    function maybeNotify(text){
      const httpsOk = (typeof isSecureContext !== 'undefined' ? isSecureContext : (location.protocol === 'https:' || location.hostname === 'localhost'));
      if('Notification' in window && httpsOk && Notification.permission==='granted' && document.visibilityState==='visible') new Notification(text);
    }

    // --- Filtro, Ricerca & Render ---
    let filter = 'all';
    const qI = $('#q');
    $$('.pill').forEach(p=>p.addEventListener('click',()=>{ $$('.pill').forEach(x=>x.classList.remove('active')); p.classList.add('active'); filter = p.dataset.filter; render(); }));
    qI?.addEventListener('input', render);

    function iconName(type){ return ({energia:'Energia', fisso:'Internet Casa', sim:'SIM', smartphone:'Smartphone a rate', riparazione:'Riparazione'})[type] || type; }

    function waIcon(){
      return `<span class="wa-ico" aria-hidden="true">
        <svg viewBox="0 0 32 32" fill="none"><path d="M16 3C9.38 3 4 8.38 4 15c0 2.53.82 4.86 2.21 6.77L5 28l6.4-1.67A11.94 11.94 0 0 0 16 27c6.62 0 12-5.38 12-12S22.62 3 16 3Z" fill="#25D366"/><path d="M22.55 18.79c-.37-.18-2.18-1.07-2.52-1.19-.34-.13-.59-.18-.84.18-.25.37-.97 1.19-1.19 1.43-.22.25-.44.28-.81.09-.37-.19-1.54-.57-2.94-1.82-1.09-.97-1.83-2.18-2.05-2.55-.22-.37-.02-.57.16-.75.16-.16.37-.43.56-.65.19-.22.25-.37.37-.62.13-.25.06-.47-.03-.65-.09-.18-.84-2.02-1.15-2.76-.3-.72-.59-.62-.81-.63-.22-.01-.47-.01-.72-.01-.25 0-.65.09-.99.47-.34.37-1.3 1.28-1.3 3.12 0 1.84 1.33 3.62 1.52 3.87.19.25 2.61 3.98 6.31 5.44.88.38 1.57.6 2.11.77.88.28 1.68.24 2.31.15.71-.11 2.18-.89 2.49-1.75.31-.86.31-1.61.22-1.75-.09-.13-.34-.22-.71-.4Z" fill="#fff"/></svg>
      </span>`;
    }

    function waFor(it, type){
      const site = encodeURIComponent('https://alessandroiascone.github.io/relong-nfc/relong-hub-v2.html');
      const base = `Ciao ${it.name}, sono Alessandro di Re Long (08119578844).`;
      const map = {
        energia: `${base}\nHai diritto ad uno sconto Energia dedicato ai nostri clienti. Ti va se ti spiego in 1 minuto come risparmiare sulla bolletta?\nHub: ${decodeURIComponent(site)}`,
        fisso: `${base}\nAbbiamo offerte Internet Casa dedicate: FTTC/FTTH con prezzi riservati ai nostri clienti. Vuoi una verifica copertura+simulazione rapida?\nHub: ${decodeURIComponent(site)}`,
        sim: `${base}\nSe ti serve una linea mobile, abbiamo SIM con Giga/Min illimitati e promo per clienti in store. Vuoi i dettagli e la portabilità?\nHub: ${decodeURIComponent(site)}`,
        smartphone: `${base}\nPossiamo proporti uno smartphone a rate (anche senza busta paga). Valutiamo anche il tuo usato e Postepay Evolution è OK. Vuoi una proposta su misura?\nHub: ${decodeURIComponent(site)}`,
      };
      const txt = encodeURIComponent(map[type]);
      return { href:`https://wa.me/39${it.phone}?text=${txt}` };
    }

    // WhatsApp per stato riparazione (Smart Follow-Up)
    function waForRepairState(it){
      const name = it.name;
      const base = `Ciao ${name}, sono Alessandro di Re Long (08119578844).`;
      const suffix = `\nID pratica: ${it.praticaId || '-'}\nSe hai bisogno scrivimi qui.`;
      const map = {
        diagnostica: `${base}\nIl tuo dispositivo è in diagnostica. Ti aggiorno appena definisco il preventivo.${suffix}`,
        'attesa-ricambi': `${base}\nSiamo in attesa dei ricambi. Ti aggiorno non appena arrivano e procediamo alla riparazione.${suffix}`,
        lavorazione: `${base}\nIl tuo dispositivo è in lavorazione in questo momento. Ti avviso appena è pronto.${suffix}`,
        pronto: `${base}\nIl tuo dispositivo è PRONTO per il ritiro. Puoi passare quando vuoi. Grazie!\nRe Long Informatica – 08119578844${suffix}`,
        consegnato: `${base}\nGrazie per esserti affidato a noi! Se ti va lasciaci una recensione ⭐⭐⭐⭐⭐ su Google: cerca “Re Long Informatica Marano”.${suffix}`
      };
      const txt = encodeURIComponent(map[it.repairStatus || 'diagnostica']);
      return `https://wa.me/39${it.phone}?text=${txt}`;
    }

    /* ---------- PACCHI: lettura e ingest automatico ---------- */
    const PACCHI_KEYS = ['relong-pacchi-v1', 'relong-pacchi-v2'];
    function readPacchiRaw(){
      let all = [];
      for(const k of PACCHI_KEYS){
        try{
          const raw = localStorage.getItem(k);
          if(!raw) continue;
          const parsed = JSON.parse(raw);
          if(Array.isArray(parsed)) all = all.concat(parsed);
          else if(parsed && Array.isArray(parsed.items)) all = all.concat(parsed.items);
        }catch(e){ console.warn('Pacchi parse fail', k, e); }
      }
      return all;
    }
    function pacchiIngestedSet(){
      try{ return new Set(JSON.parse(localStorage.getItem('relong-pacchi-ingested') || '[]')); }
      catch{ return new Set(); }
    }
    function savePacchiIngested(set){
      try{ localStorage.setItem('relong-pacchi-ingested', JSON.stringify([...set])); }catch{}
    }
    function normalizePhone(p){
      let phone = String(p||'').trim().replace(/\D/g,'');
      if(phone.startsWith('0')) phone = phone.slice(1);
      return phone;
    }
    function convertPacchiRecordToItem(rec){
      const name = (rec.name||rec.nome||'Cliente Pacchi').toString().trim();
      const phone = normalizePhone(rec.phone || rec.telefono || '');
      const created = rec.createdAt ? new Date(rec.createdAt) : new Date();
      const all = ['energia','fisso','sim','smartphone'];
      const tasks = all.map(type=>{
        let due = addDays(created, DEFAULT_DAYS[type]);
        due = avoidWeekend(due);
        return { type, due: due.toISOString() };
      });
      const id = Date.now()+Math.random().toString(16).slice(2);
      return {
        id, name, phone,
        start: created.toISOString(), createdAt: new Date().toISOString(),
        activated:[], tasks, done:false,
        optWeekend:true, optEvening:true,
        muteDate:null, activeChatUntil:null, doneAt:null,
        acceptance:false, praticaId:null,
        source:'pacchi', pacchiKind:(rec.kind||rec.tipo||rec.service||'')
      };
    }
    function ingestPacchi({silent=false}={}){
      const raw = readPacchiRaw();
      if(!raw.length) return 0;
      const ing = pacchiIngestedSet();
      let added = 0;
      for(const rec of raw){
        const phone = normalizePhone(rec.phone || rec.telefono || '');
        const created = rec.createdAt ? new Date(rec.createdAt).toISOString() : isoDay(new Date());
        const kind = (rec.kind||rec.tipo||'').toLowerCase();
        const stableId = `${phone}|${created}|${kind||'na'}`;
        if(!phone) continue;
        if(ing.has(stableId)) continue;
        items.unshift(convertPacchiRecordToItem(rec));
        ing.add(stableId);
        added++;
      }
      if(added){
        save(items);
        savePacchiIngested(ing);
        if(!silent){ maybeNotify(`Import Pacchi: ${added} nuovo/i contatto/i aggiunto/i`); }
        render();
        updateStats();
      }
      return added;
    }

    // Trigger manuale + sync live
    $('#syncPacchiBtn').addEventListener('click', ()=> ingestPacchi({silent:false}));
    ingestPacchi({silent:true});
    window.addEventListener('storage', (ev)=>{ if(PACCHI_KEYS.includes(ev.key)) ingestPacchi({silent:false}); });
    setInterval(()=> ingestPacchi({silent:true}), 15000);

    /* ---------- Rendering elenco ---------- */
    function render(){
      if(listSection.hidden) return;
      const list = $('#list'); list.innerHTML='';
      const now = today(); const tStr = fmtDate(now);
      const q = (qI?.value||'').trim().toLowerCase();

      const data = items.filter(it=>{
        if(filter==='done') return it.done;
        if(filter==='late') return !it.done && it.tasks.some(tsk=>new Date(tsk.due)<now);
        if(filter==='today') return !it.done && it.tasks.some(tsk=>fmtDate(new Date(tsk.due))===tStr);
        if(filter==='only-acc') return !!it.acceptance;
        return true;
      }).filter(it=>{
        if(!q) return true;
        return (
          it.name.toLowerCase().includes(q) ||
          (it.phone||'').toLowerCase().includes(q) ||
          (it.praticaId||'').toLowerCase().includes(q) ||
          (it.device?.brand||'').toLowerCase().includes(q) ||
          (it.device?.model||'').toLowerCase().includes(q) ||
          (it.repairStatus||'').toLowerCase().includes(q) ||
          (it.source||'').toLowerCase().includes(q) ||
          (it.pacchiKind||'').toLowerCase().includes(q)
        );
      });

      data.forEach(it=>list.appendChild(renderItem(it)));
    }

    function tag(txt, extraClass=''){ const s=document.createElement('span'); s.className='tag'; if(extraClass) s.classList.add(extraClass); s.textContent=txt; return s }

    function statusChip(status){
      const mapCls = {
        diagnostica:'st-diagnostica',
        'attesa-ricambi':'st-attesa-ricambi',
        lavorazione:'st-lavorazione',
        pronto:'st-pronto',
        consegnato:'st-consegnato'
      };
      const label = {
        diagnostica:'Diagnostica',
        'attesa-ricambi':'Ricambi',
        lavorazione:'Lavorazione',
        pronto:'Pronto',
        consegnato:'Consegnato'
      }[status] || status;
      const span = document.createElement('span');
      span.className = `st-chip ${mapCls[status]||''}`;
      span.textContent = label;
      return span;
    }

    function waBtnIcon(){ return `<span class="wa-ico" aria-hidden="true"><svg viewBox="0 0 32 32" fill="none"><path d="M16 3C9.38 3 4 8.38 4 15c0 2.53.82 4.86 2.21 6.77L5 28l6.4-1.67A11.94 11.94 0 0 0 16 27c6.62 0 12-5.38 12-12S22.62 3 16 3Z" fill="#25D366"/><path d="M22.55 18.79c-.37-.18-2.18-1.07-2.52-1.19-.34-.13-.59-.18-.84.18-.25.37-.97 1.19-1.19 1.43-.22.25-.44.28-.81.09-.37-.19-1.54-.57-2.94-1.82-1.09-.97-1.83-2.18-2.05-2.55-.22-.37-.02-.57.16-.75.16-.16.37-.43.56-.65.19-.22.25-.37.37-.62.13-.25.06-.47-.03-.65-.09-.18-.84-2.02-1.15-2.76-.3-.72-.59-.62-.81-.63-.22-.01-.47-.01-.72-.01-.25 0-.65.09-.99.47-.34.37-1.3 1.28-1.3 3.12 0 1.84 1.33 3.62 1.52 3.87.19.25 2.61 3.98 6.31 5.44.88.38 1.57.6 2.11.77.88.28 1.68.24 2.31.15.71-.11 2.18-.89 2.49-1.75.31-.86.31-1.61.22-1.75-.09-.13-.34-.22-.71-.4Z" fill="#fff"/></svg></span>`; }

    function renderItem(it){
      const t = $('#tpl-item').content.firstElementChild.cloneNode(true);
      t.querySelector('.h').textContent = `${it.name} • ${it.phone}${it.praticaId? ' • '+it.praticaId:''}`;

      const tags = t.querySelector('.tags'); tags.innerHTML='';
      if(it.source==='pacchi'){
        tags.append(tag(`Pacchi${it.pacchiKind?`: ${String(it.pacchiKind).charAt(0).toUpperCase()+String(it.pacchiKind).slice(1)}`:''}`, 'pacchi'));
      }
      if(it.acceptance){
        tags.append(tag(`${it.device?.brand||''} ${it.device?.model||''}`.trim() || 'Accettazione'));
        tags.append(statusChip(it.repairStatus || 'diagnostica'));
      }
      it.activated.forEach(a=> tags.append(tag('Attivato: '+iconName(a))));
      if(isMutedToday(it)) tags.append(tag('Silenzioso oggi','muted'));
      if(isActiveChat(it)) tags.append(tag('In chat','activeChat'));
      if(it.done) tags.append(tag('Completato'));

      const sum = t.querySelector('.summary'); sum.innerHTML='';

      // Riquadro accettazione (se presente)
      if(it.acceptance){
        const div = document.createElement('div'); div.className='accept-brief';
        const top = document.createElement('div'); top.className='row-slim';
        top.innerHTML = `<div><b>${it.device?.type || ''}</b> • ${it.device?.brand || ''} ${it.device?.model || ''}<br><small>Difetto: ${it.device?.issue || '-'}</small></div>`;
        const controls = document.createElement('div'); controls.className='r-line';
        const sel = document.createElement('select');
        sel.innerHTML = `
          <option value="diagnostica">Diagnostica</option>
          <option value="attesa-ricambi">Attesa ricambi</option>
          <option value="lavorazione">Lavorazione</option>
          <option value="pronto">Pronto al ritiro</option>
          <option value="consegnato">Consegnato</option>`;
        sel.value = it.repairStatus || 'diagnostica';
        sel.addEventListener('change', ()=>{
          const prev = it.repairStatus;
          it.repairStatus = sel.value; save(items); render();
          if(prev !== 'pronto' && sel.value === 'pronto'){
            maybeNotify(`"${it.name}" è PRONTO al ritiro`);
            const href = waForRepairState(it);
            try{ window.open(href, '_blank'); }catch{}
          }
          updateStats();
        });
        const waState = document.createElement('a');
        waState.href = waForRepairState(it);
        waState.target = '_blank'; waState.rel='noopener';
        waState.className='wa-btn ok'; waState.innerHTML = `${waBtnIcon()}WA stato`;
        controls.append(sel, waState);
        top.append(controls);
        div.append(top);
        sum.append(div);
      }

      // Riepilogo 3 remind (più vicini)
      const next3 = [...(it.tasks||[])]
        .sort((a,b)=> new Date(a.due)-new Date(b.due))
        .filter(tsk=>!it.done)
        .slice(0,3);

      if(next3.length){
        const line = document.createElement('div'); line.className='r-line';
        next3.forEach(tsk=>{
          const due = new Date(tsk.due);
          const late = due < today();
          const badge = document.createElement('span');
          badge.className = 'r-badge';
          badge.innerHTML = `${iconName(tsk.type)} • <b${late?' style="color:#ffb3b3"':''}>${fmtDateShort(due)}</b>`;
          line.append(badge);

          const wa = waFor(it, tsk.type);
          if(wa){
            const a=document.createElement('a');
            a.href=wa.href; a.target='_blank'; a.rel='noopener';
            a.className='wa-btn ok'; a.innerHTML=`${waIcon()}WhatsApp`;
            a.dataset.wa='1'; a.dataset.id=it.id;
            line.append(a);
          }
        });
        sum.append(line);
      }

      // Azioni rapide
      const actions = document.createElement('div'); actions.className='r-line';
      const snooze = document.createElement('button'); snooze.className='wa-btn'; snooze.textContent='Snooze +1g';
      snooze.addEventListener('click',()=>{
        const all = (it.tasks||[]).map(tsk=>{
          let nd = addDays(new Date(tsk.due), 1); nd = avoidWeekend(nd); tsk.due = nd.toISOString(); return tsk;
        });
        it.tasks = all; save(items); render(); maybeNotify('Spostato tutto di 1 giorno ✔️');
      });
      const done = document.createElement('button'); done.className='wa-btn'; done.textContent='Completato';
      done.addEventListener('click',()=>{ it.done=true; it.doneAt=new Date().toISOString(); save(items); render(); updateStats(); });
      const del = document.createElement('button'); del.className='wa-btn'; del.textContent='Elimina';
      del.addEventListener('click',()=>{ items = items.filter(x=>x.id!==it.id); save(items); render(); updateStats(); });
      actions.append(snooze, done, del);
      sum.append(actions);

      return t;
    }

    // Click su WhatsApp per marcare in chat
    document.body.addEventListener('click', (e)=>{
      const a = e.target.closest('a[data-wa="1"]'); if(!a) return;
      const id = a.dataset.id; const it = items.find(x=>x.id===id); if(!it) return;
      const until = new Date(Date.now()+45*60*1000);
      it.activeChatUntil = until.toISOString(); it.muteDate = fmtDate(new Date()); save(items); render();
    });

    function isMutedToday(it){ return it.muteDate && it.muteDate===fmtDate(new Date()); }
    function isActiveChat(it){ return it.activeChatUntil && new Date(it.activeChatUntil) > new Date(); }

    /* ---------- PIN Gate ---------- */
    (function pinGateInit(){
      const gate = document.getElementById('pinGate');
      const ok = document.getElementById('pinOk');
      const input = document.getElementById('pinInput');
      const err = document.getElementById('pinError');

      const unlocked = sessionStorage.getItem('relong-pin-ok') === '1';
      function show(el){ el && el.removeAttribute('hidden'); }
      function hide(el){ el && el.setAttribute('hidden',''); }
      function setAppHidden(h){
        document.querySelectorAll('[aria-hidden]').forEach(n=> n.setAttribute('aria-hidden', h?'true':'false'));
      }

      if(unlocked){ hide(gate); setAppHidden(false); }
      else { show(gate); setAppHidden(true); setTimeout(()=>input?.focus(),50); }

      function tryUnlock(){
        const val = (input.value||'').trim();
        if(val === '1990'){
          sessionStorage.setItem('relong-pin-ok', '1');
          setAppHidden(false);
          hide(gate);
          gate.parentNode && gate.parentNode.removeChild(gate);
        }else{
          err.textContent = 'PIN errato. Riprova.';
          input.value = '';
          input.focus();
        }
      }

      ok.addEventListener('click', tryUnlock);
      input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ tryUnlock(); } });
    })();

    /* ---------- Push intelligenti 10:00 & 18:00 ---------- */
    (function smartPush(){
      const httpsOk = (typeof isSecureContext !== 'undefined' ? isSecureContext : (location.protocol === 'https:' || location.hostname === 'localhost'));
      if('Notification' in window && httpsOk && Notification.permission==='default'){ try{ Notification.requestPermission(); }catch{} }

      function scheduleAt(hour){
        const now = new Date();
        const when = new Date(); when.setHours(hour,0,0,0);
        if(when <= now) when.setDate(when.getDate()+1);
        setTimeout(()=>{ fire(hour); scheduleAt(hour); }, when - now);
      }

      function fire(hour){
        const tStr = fmtDate(new Date());
        const dueToday = items.reduce((n,it)=> n + (it.done?0: it.tasks.filter(tsk=>fmtDate(new Date(tsk.due))===tStr).length), 0);
        if(hour===10){
          if(dueToday) maybeNotify(`Alle 10: hai ${dueToday} follow-up da fare oggi`);
        }else if(hour===18){
          const pending = items.filter(it=>!it.done && !isMutedToday(it) && !isActiveChat(it) && it.tasks.some(tsk=>fmtDate(new Date(tsk.due))===tStr)).length;
          if(pending) maybeNotify(`Ore 18: ${pending} clienti ancora da contattare`);
        }
      }

      scheduleAt(10);
      scheduleAt(18);
    })();

    /* ---------- Backup automatico giornaliero ---------- */
    (function autoBackup(){
      function schedule(){
        const now = new Date();
        const when = new Date(); when.setHours(23,59,0,0);
        if(when <= now) when.setDate(when.getDate()+1);
        setTimeout(()=>{ doBackup(); schedule(); }, when - now);
      }
      function doBackup(){
        try{
          const key = backupPrefix + isoDay(new Date());
          localStorage.setItem(key, JSON.stringify({ when:new Date().toISOString(), items }));
          maybeNotify('Backup giornaliero salvato ✔️');
        }catch(e){ console.warn('Backup failed', e); }
      }
      schedule();
    })();

    /* ---------- Mini dashboard Pacchi ---------- */
    function updateStats(){
      try{
        const tStr = fmtDate(new Date());
        const pacchiAll = items.filter(it=>it.source==='pacchi');
        const pacchiToday = items.filter(it=>it.source==='pacchi' && fmtDate(new Date(it.createdAt||it.start))===tStr);
        $('#st-pacchi-total').textContent = String(pacchiAll.length);
        $('#st-pacchi-today').textContent = String(pacchiToday.length);
      }catch(e){}
    }

    // Boot
    function boot(){
      setListOpen(false);
      updateStats();
    }
    boot();
  </script>
</body>
</html>
