<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ReLong â€¢ Scadenzario + Accettazione Riparazioni</title>
  <meta name="theme-color" content="#0a0a0a" />
  <style>
    /* --- Theme: Premium Dark + Electric Blue --- */
    *{box-sizing:border-box;margin:0;padding:0;-webkit-font-smoothing:antialiased}
    :root{
      --bg1:#0b0d12; --bg2:#06070b;
      --card:rgba(14,16,22,.92); --stroke:rgba(255,255,255,.08);
      --muted:rgba(210,220,255,.70);
      --elec:#0aa2ff; --elec2:#66d1ff; --elec3:#008cff;
      --ok:#25D366; --danger:#ff4d4f;
      --shadow:0 10px 40px rgba(0,140,255,.18), inset 0 1px 0 rgba(255,255,255,.04);
    }
    body{min-height:100svh;font-family:system-ui,-apple-system,Inter,Roboto,sans-serif;color:#eef3ff;
      background:radial-gradient(65% 65% at 25% 15%, var(--bg1), var(--bg2));
      padding:24px;display:flex;flex-direction:column;gap:24px}
    .shell{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1.2fr .8fr;gap:20px}
    @media (max-width:980px){.shell{grid-template-columns:1fr;}}

    .card{background:var(--card);border:1px solid var(--stroke);border-radius:22px;box-shadow:var(--shadow)}
    .card h2{font-size:18px;font-weight:800;padding:18px 18px 0;letter-spacing:.3px}
    .card .content{padding:18px}

    /* Header */
    .title{display:flex;align-items:center;gap:14px}
    .title img{height:36px;aspect-ratio:auto;display:block;filter:drop-shadow(0 8px 24px rgba(0,140,255,.25))}
    .title h1{font-size:26px;letter-spacing:.2px}
    .subtitle{color:var(--muted);font-size:14px}

    /* Form */
    .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .full{grid-column:1/-1}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{margin-top:6px;background:#0a0d14;border:1px solid var(--stroke);color:#eef3ff;border-radius:14px;padding:12px 14px;font-size:15px}
    textarea{min-height:84px;resize:vertical}

    /* Toggles */
    .toggle-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:8px}
    @media (max-width:980px){.toggle-grid{grid-template-columns:repeat(2,1fr)}}
    .tbtn{position:relative;display:flex;align-items:center;justify-content:center;text-align:center;min-height:46px;padding:10px 12px;border-radius:14px;border:1px solid rgba(0,140,255,.22);background:linear-gradient(180deg,rgba(0,140,255,.10),rgba(0,140,255,.03));color:#dbeaff;font-weight:700;letter-spacing:.2px;cursor:pointer;transition:.2s ease;box-shadow:inset 0 0 0 0 rgba(0,140,255,.25)}
    .tbtn:hover{transform:translateY(-1px);box-shadow:inset 0 0 0 1px rgba(0,140,255,.25)}
    .tbtn.active{background:linear-gradient(135deg,var(--elec3),var(--elec2));color:#04121f;border-color:transparent;box-shadow:0 10px 30px rgba(0,140,255,.35)}
    .tbtn small{opacity:.9;font-weight:600}

    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{appearance:none;border:0;border-radius:16px;padding:12px 16px;font-weight:800;letter-spacing:.25px;cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--elec3),var(--elec2));color:#04121f;box-shadow:0 8px 26px rgba(0,140,255,.35)}
    .btn.ghost{background:transparent;border:1px solid var(--stroke);color:#eef3ff}
    .btn.ok{background:linear-gradient(135deg,#1fae60,var(--ok));color:#071b10}

    /* Toolbar & list */
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap}
    .filters{display:flex;gap:8px;flex-wrap:wrap}
    .pill{border:1px solid rgba(0,140,255,.22);color:#dbeaff;padding:8px 12px;border-radius:999px;font-size:13px;cursor:pointer;background:linear-gradient(180deg,rgba(0,140,255,.08),rgba(0,140,255,.02))}
    .pill.active{background:linear-gradient(135deg,var(--elec3),var(--elec2));color:#04121f;border-color:transparent;box-shadow:0 8px 24px rgba(0,140,255,.25)}

    .search{display:flex;gap:8px;align-items:center}
    .search input{min-width:220px}

    .item{display:grid;grid-template-columns:1.1fr .9fr;gap:12px;border:1px solid var(--stroke);border-radius:16px;padding:14px;margin-bottom:12px;background:#0a0d14}
    @media (max-width:780px){.item{grid-template-columns:1fr}}
    .meta{display:grid;gap:6px}
    .meta .h{font-weight:800}
    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .tag{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#04121f;background:linear-gradient(135deg,var(--elec3),var(--elec2));padding:6px 10px;border-radius:999px}
    .tag svg{width:14px;height:14px}
    .muted{background:linear-gradient(135deg,#7aa3c7,#a7c6df)!important;color:#0b1b29}
    .activeChat{background:linear-gradient(135deg,#1fae60,var(--ok))!important;color:#071b10}
    .over{color:#ffb3b3}

    .tasks{display:grid;gap:8px}
    .task{border:1px solid var(--stroke);border-radius:12px;padding:10px;background:#090c12}
    .task .row{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .cta{display:flex;gap:8px;flex-wrap:wrap}
    .cta a,.cta button, .status select{font-size:13px;padding:10px 12px;border-radius:12px;border:1px solid rgba(0,140,255,.22);background:linear-gradient(180deg,rgba(0,140,255,.08),rgba(0,140,255,.02));color:#dbeaff;text-decoration:none}
    .cta a.primary{background:linear-gradient(135deg,var(--elec3),var(--elec2));color:#04121f;border-color:transparent}
    .cta a.ok{background:linear-gradient(135deg,#1fae60,var(--ok));color:#071b10;border-color:transparent}

    /* Stats (se li vuoi mostrare, aggiungi i 5 span con questi id) */
    .stats{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    .stat{background:#090c12;border:1px solid rgba(0,140,255,.18);border-radius:14px;padding:12px;display:grid;gap:6px}
    .stat .n{font-size:22px;font-weight:800}
    @media (max-width:900px){.stats{grid-template-columns:repeat(2,1fr)}}

    /* Glow per task in scadenza oggi */
    .task.dueToday{box-shadow:0 0 0 1px rgba(0,140,255,.35), 0 0 24px rgba(0,140,255,.25)}
    @keyframes pulseGlow{0%{box-shadow:0 0 0 0 rgba(0,140,255,.25)}50%{box-shadow:0 0 0 6px rgba(0,140,255,.12)}100%{box-shadow:0 0 0 0 rgba(0,140,255,.25)}}
    .task.dueToday{animation:pulseGlow 2.4s ease-in-out infinite}
  </style>
</head>
<body>
  <header class="title">
    <img id="brandLogo" src="https://alessandroiascone.github.io/relong-nfc/img/relong-logo.png" alt="ReLong" style="cursor:pointer" title="Clicca per cambiare logo (salvato in locale)" onerror="this.replaceWith(Object.assign(document.createElement('div'),{textContent:'ReLong',style:'font-weight:900;font-size:20px;letter-spacing:.4px'}))">
    <input id="logoPicker" type="file" accept="image/*" hidden />
    <div>
      <h1>ReLong â€¢ Scadenzario + Accettazione</h1>
      <div class="subtitle">Attivazioni & Riparazioni â†’ reminder smart con WhatsApp + Google Calendar. (No weekend, richiamo 18:00)</div>
    </div>
  </header>

  <section class="card" style="max-width:1200px;margin:0 auto">
    <h2>Dati cliente (unici)</h2>
    <div class="content grid2">
      <div>
        <label>Nome e Cognome</label>
        <input required id="c_name" placeholder="Mario Rossi" />
      </div>
      <div>
        <label>Telefono (solo cifre, WhatsApp)</label>
        <input required id="c_phone" placeholder="3331234567" inputmode="numeric" pattern="[0-9]+" />
      </div>
    </div>
  </section>

  <div class="shell">
    <section class="card">
      <h2>Attivazioni</h2>
      <div class="content">
        <div class="grid2">
          <div>
            <label>Data attivazione</label>
            <input id="start" type="date" />
          </div>
          <div class="full">
            <label>Cosa hai attivato ORA</label>
            <div class="toggle-grid" id="toggles">
              <button type="button" class="tbtn" data-key="sim">SIM Mobile</button>
              <button type="button" class="tbtn" data-key="fisso">Linea Fissa</button>
              <button type="button" class="tbtn" data-key="energia">Energia</button>
              <button type="button" class="tbtn" data-key="smartphone">Smartphone a rate</button>
              <button type="button" class="tbtn" data-key="riparazione">Riparazione</button>
            </div>
          </div>
        </div>
        <div class="actions" style="margin-top:12px">
          <button class="btn primary" id="insertBtn">Inserisci cliente</button>
        </div>
      </div>
    </section>

    <aside class="card">
      <h2>Accettazione dispositivo (Assistenza)</h2>
      <div class="content">
        <form id="acceptForm" class="grid2">
          <div>
            <label>Tipo dispositivo</label>
            <select id="a_type">
              <option>Smartphone</option>
              <option>Computer</option>
              <option>Stampante</option>
              <option>Console & Accessori</option>
              <option>Richiesta Preventivo</option>
            </select>
          </div>
          <div>
            <label>Marca</label>
            <input id="a_brand" placeholder="Apple, Samsung, HPâ€¦" />
          </div>
          <div>
            <label>Modello</label>
            <input id="a_model" placeholder="iPhone 13, Galaxy S21â€¦" />
          </div>
          <div class="full">
            <label>Difetto / Problema</label>
            <textarea id="a_issue" placeholder="Descrivi il problema segnalatoâ€¦"></textarea>
          </div>
          <div class="full actions">
            <button class="btn primary" type="submit" id="acceptBtn">Accetta dispositivo</button>
          </div>
        </form>
        <p class="subtitle" style="margin-top:12px">Alla conferma: WhatsApp di accettazione + inserimento automatico nello scadenzario con follow-up piÃ¹ lunghi.</p>
      </div>
    </aside>
  </div>

  <section class="card" style="max-width:1200px;margin:0 auto">
    <h2>Clienti & Promemoria</h2>
    <div class="content">
      <div class="toolbar">
        <div class="filters">
          <button class="pill active" data-filter="all">Tutti</button>
          <button class="pill" data-filter="today">Oggi</button>
          <button class="pill" data-filter="late">In ritardo</button>
          <button class="pill" data-filter="done">Completati</button>
          <button class="pill" data-filter="only-acc">Solo accettazioni</button>
        </div>
        <div class="search">
          <label>Cerca</label>
          <input id="q" placeholder="Nome, telefono o ID praticaâ€¦" />
        </div>
      </div>
      <div id="list"></div>
    </div>
  </section>

  <template id="tpl-item">
    <div class="item">
      <div class="meta">
        <div class="h"></div>
        <div class="tags"></div>
      </div>
      <div class="tasks"></div>
    </div>
  </template>

  <template id="tpl-task">
    <div class="task">
      <div class="row">
        <div>
          <b class="tname"></b>
          <span class="due"></span>
        </div>
        <div class="cta"></div>
      </div>
      <div class="status" style="margin-top:8px;display:none">
        <label style="font-size:12px;color:var(--muted);margin-right:6px">Stato riparazione</label>
        <select class="statusSel">
          <option value="diagnostica">In diagnostica</option>
          <option value="attesa-ricambi">In attesa ricambi</option>
          <option value="lavorazione">In lavorazione</option>
          <option value="pronto">Pronto al ritiro</option>
          <option value="consegnato">Consegnato/Chiuso</option>
        </select>
      </div>
    </div>
  </template>

  <script>
    // --- Utils ---
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => [...r.querySelectorAll(s)];

    const storeKey = 'relong-scadenzario-v12';
    const load = () => { try { const raw = localStorage.getItem(storeKey); return raw ? JSON.parse(raw) : []; } catch(e){ console.warn('Storage danneggiato, azzero lo scadenzario:', e); localStorage.removeItem(storeKey); return []; } };
    const save = (arr) => localStorage.setItem(storeKey, JSON.stringify(arr));

    const fmtDate = (d) => d.toLocaleDateString('it-IT', {year:'numeric', month:'2-digit', day:'2-digit'});
    const fmtDateTimeParam = (d) => {
      const pad = (n)=>String(n).padStart(2,'0');
      const z = new Date(d.getTime());
      return z.getUTCFullYear()+pad(z.getUTCMonth()+1)+pad(z.getUTCDate())+'T'+pad(z.getUTCHours())+pad(z.getUTCMinutes())+pad(z.getUTCSeconds())+'Z';
    }

    const today = () => { const d=new Date(); d.setHours(0,0,0,0); return d };
    const addDays = (d, n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x }
    const avoidWeekend = (d) => { const x = new Date(d); const day = x.getDay(); if(day===0) x.setDate(x.getDate()+1); if(day===6) x.setDate(x.getDate()+2); return x };

    // Giorni preimpostati (+5 rispetto ai precedenti)
    const DEFAULT_DAYS = { energia:10, fisso:17, sim:9, smartphone:12 };
    const ACCEPT_DAYS   = { energia:15, fisso:20, sim:12, smartphone:15 };

    // --- Stato ---
    let items = load();

    // Sequenza ID pratica per anno (robusta)
    function nextPraticaId(){
      const key='relong-pratica-seq';
      const y = new Date().getFullYear();
      let seq;
      try{ seq = JSON.parse(localStorage.getItem(key) || '[]'); } catch { seq = []; }
      let rec = seq.find(r=>r.year===y);
      if(!rec){ rec={year:y,n:0}; seq.push(rec); }
      rec.n += 1; localStorage.setItem(key, JSON.stringify(seq));
      return `RL-${y}-${String(rec.n).padStart(4,'0')}`;
    }

    // Logo picker
    const logoImg = $('#brandLogo');
    const logoPicker = $('#logoPicker');
    const savedLogo = localStorage.getItem('relong-logo');
    if(savedLogo) logoImg.src = savedLogo;
    logoImg.addEventListener('click', ()=> logoPicker.click());
    logoPicker.addEventListener('change', (e)=>{ const f = e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ localStorage.setItem('relong-logo', r.result); logoImg.src=r.result; }; r.readAsDataURL(f); });

    // Shared customer inputs
    const c_name = $('#c_name');
    const c_phone = $('#c_phone');

    // Toggles attivazioni
    const toggles = $('#toggles');
    const activeSet = new Set();
    toggles.addEventListener('click', (e)=>{ const b = e.target.closest('.tbtn'); if(!b) return; const key = b.dataset.key; b.classList.toggle('active'); if(b.classList.contains('active')) activeSet.add(key); else activeSet.delete(key); });

    // --- Attivazioni (Inserisci cliente) ---
    const insertBtn = $('#insertBtn');
    const startI = $('#start');
    // Fallback per browser senza valueAsDate
    try{ if(startI && 'valueAsDate' in startI) startI.valueAsDate = new Date();
         else if(startI){ const d=new Date(); const pad=n=>String(n).padStart(2,'0'); startI.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; } }catch{}

    // Accettazione form inputs (riusati nel flusso unico)
    const aForm = $('#acceptForm');
    const a_type = $('#a_type');
    const a_brand = $('#a_brand');
    const a_model = $('#a_model');
    const a_issue = $('#a_issue');

    insertBtn.addEventListener('click', async ()=>{
      try{
        const httpsOk = (typeof isSecureContext !== 'undefined' ? isSecureContext : (location.protocol === 'https:' || location.hostname === 'localhost'));
        if('Notification' in window && httpsOk && Notification.permission==='default'){ await Notification.requestPermission(); }
      }catch{}

      const name = c_name.value.trim();
      let phone = (c_phone.value||'').trim();
      phone = phone.replace(/\D/g,''); // solo cifre
      if(phone.startsWith('0')) phone = phone.slice(1);
      if(!name || !phone) return alert('Inserisci nome e telefono cliente (solo cifre)');

      const start = startI.value ? new Date(startI.value) : new Date();
      const activated = new Set(activeSet);

      // Se Ã¨ selezionata "riparazione", il tasto Ã¨ UNICO: accetta + inserisce
      if(activated.has('riparazione')){
        const device = { type:a_type.value, brand:a_brand.value.trim(), model:a_model.value.trim(), issue:a_issue.value.trim() };
        if(!device.type){ return alert('Seleziona il tipo dispositivo'); }
        const id = Date.now()+Math.random().toString(16).slice(2);
        const praticaId = nextPraticaId();
        const all = ['energia','fisso','sim','smartphone'];
        const tasks = all.map(type=>{ let due = addDays(new Date(), ACCEPT_DAYS[type]); due = avoidWeekend(due); return { type, due: due.toISOString() } });
        const obj = {
          id, praticaId, name, phone, start: new Date().toISOString(), createdAt: new Date().toISOString(),
          activated:['riparazione'], tasks, done:false,
          optWeekend:true, optEvening:true,
          muteDate:null, activeChatUntil:null, doneAt:null,
          acceptance:true, device, repairStatus:'diagnostica'
        };
        items.unshift(obj); save(items); render(); aForm.reset();

        // WhatsApp accettazione
        const site = 'https://alessandroiascone.github.io/relong-nfc/relong-hub-v2.html';
        const msg = `âœ… Accettazione prodotto registrata
ID pratica: ${praticaId}
Ciao ${name}, abbiamo preso in carico:
${device.brand?device.brand+' ':''}${device.model||''}
Difetto: ${device.issue||'-'}

Ti aggiorniamo appena pronto.
Hub: ${site}
ðŸ“ž Re Long Informatica â€“ 08119578844`;
        const wa = `https://wa.me/39${phone}?text=${encodeURIComponent(msg)}`;
        try{ window.open(wa, '_blank'); }catch{}
        return; // esce: non esegue il flusso "attivazioni"
      }

      // Flusso attivazioni classico (no riparazione)
      const all = ['energia','fisso','sim','smartphone'];
      const targets = all.filter(t => !activated.has(t));
      const tasks = targets.map(type=>{ let due = addDays(start, DEFAULT_DAYS[type]); due = avoidWeekend(due); return { type, due: due.toISOString() } });

      const id = Date.now()+Math.random().toString(16).slice(2);
      items.unshift({
        id, name, phone, start: start.toISOString(), createdAt: new Date().toISOString(),
        activated:[...activated], tasks, done:false,
        optWeekend:true, optEvening:true,
        muteDate:null, activeChatUntil:null, doneAt:null,
        acceptance:false, praticaId:null
      });
      save(items);
      activeSet.clear(); $$('.tbtn.active').forEach(b=>b.classList.remove('active'));
      render();
      try{
        const httpsOk = (typeof isSecureContext !== 'undefined' ? isSecureContext : (location.protocol === 'https:' || location.hostname === 'localhost'));
        if('Notification' in window && httpsOk && Notification.permission==='granted') new Notification('Cliente inserito nello scadenzario âœ…');
      }catch{}
    });

    // --- Accettazione (pulsante separato resta disponibile se vuoi usarlo) ---
    aForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const name = c_name.value.trim();
      let phone = (c_phone.value||'').trim();
      phone = phone.replace(/\D/g,'');
      if(phone.startsWith('0')) phone = phone.slice(1);
      if(!name || !phone) return alert('Inserisci nome e telefono cliente (solo cifre)');

      const device = { type:a_type.value, brand:a_brand.value.trim(), model:a_model.value.trim(), issue:a_issue.value.trim() };

      const start = new Date();
      const all = ['energia','fisso','sim','smartphone'];
      const tasks = all.map(type=>{ let due = addDays(start, ACCEPT_DAYS[type]); due = avoidWeekend(due); return { type, due: due.toISOString() } });

      const id = Date.now()+Math.random().toString(16).slice(2);
      const praticaId = nextPraticaId();
      const obj = {
        id, praticaId, name, phone, start: start.toISOString(), createdAt: new Date().toISOString(),
        activated:['riparazione'], tasks, done:false,
        optWeekend:true, optEvening:true,
        muteDate:null, activeChatUntil:null, doneAt:null,
        acceptance:true, device, repairStatus:'diagnostica'
      };
      items.unshift(obj); save(items); render(); aForm.reset();

      const site = 'https://alessandroiascone.github.io/relong-nfc/relong-hub-v2.html';
      const msg = `âœ… Accettazione prodotto registrata
ID pratica: ${praticaId}
Ciao ${name}, abbiamo preso in carico:
${device.brand?device.brand+' ':''}${device.model||''}
Difetto: ${device.issue||'-'}

Ti aggiorniamo appena pronto.
Hub: ${site}
ðŸ“ž Re Long Informatica â€“ 08119578844`;
      const wa = `https://wa.me/39${phone}?text=${encodeURIComponent(msg)}`;
      try{ window.open(wa, '_blank'); }catch{}
    });

    function maybeNotify(text){
      const httpsOk = (typeof isSecureContext !== 'undefined' ? isSecureContext : (location.protocol === 'https:' || location.hostname === 'localhost'));
      if('Notification' in window && httpsOk && Notification.permission==='granted' && document.visibilityState==='visible') new Notification(text);
    }

    // --- Filtro, Ricerca & Render + Stats ---
    let filter = 'all';
    const qI = $('#q');
    $$('.pill').forEach(p=>p.addEventListener('click',()=>{ $$('.pill').forEach(x=>x.classList.remove('active')); p.classList.add('active'); filter = p.dataset.filter; render(); }));
    qI.addEventListener('input', render);

    function render(){
      const list = $('#list'); list.innerHTML='';
      const now = today(); const tStr = fmtDate(now);
      const q = (qI?.value||'').trim().toLowerCase();

      const data = items.filter(it=>{
        if(filter==='done') return it.done;
        if(filter==='late') return !it.done && it.tasks.some(tsk=>new Date(tsk.due)<now);
        if(filter==='today') return !it.done && it.tasks.some(tsk=>fmtDate(new Date(tsk.due))===tStr);
        if(filter==='only-acc') return !!it.acceptance;
        return true;
      }).filter(it=>{
        if(!q) return true;
        return (
          it.name.toLowerCase().includes(q) ||
          (it.phone||'').toLowerCase().includes(q) ||
          (it.praticaId||'').toLowerCase().includes(q)
        );
      });

      data.forEach(it=>list.appendChild(renderItem(it)));

      // Stats (sezione opzionale)
      const createdToday = items.filter(it=>fmtDate(new Date(it.createdAt||it.start))===tStr).length;
      const dueToday = items.reduce((n,it)=> n + (it.done?0: it.tasks.filter(tsk=>fmtDate(new Date(tsk.due))===tStr).length), 0);
      const doneToday = items.filter(it=>it.done && fmtDate(new Date(it.doneAt||it.start))===tStr).length;
      const late = items.reduce((n,it)=> n + (it.done?0: it.tasks.filter(tsk=>new Date(tsk.due)<now).length), 0);
      const repairsToday = items.filter(it=> (it.acceptance || (it.activated||[]).includes('riparazione')) && fmtDate(new Date(it.createdAt||it.start))===tStr).length;

      document.getElementById('st-created')?.(createdToday);
      document.getElementById('st-due')?.(dueToday);
      document.getElementById('st-done')?.(doneToday);
      document.getElementById('st-late')?.(late);
      document.getElementById('st-repairs')?.(repairsToday);
    }

    function iconSVG(type){
      const map = {
        energia:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M13 2L3 14h7v8l11-14h-8z"/></svg>',
        fisso:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 3c4.97 0 9 4.03 9 9h-2a7 7 0 1 0-7 7v2C6.03 21 2 16.97 2 12S6.03 3 12 3z"/></svg>',
        sim:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M6 2h7l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"/></svg>',
        smartphone:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M7 2h10a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"/></svg>',
        riparazione:'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M22.7 19.3l-7.9-7.9a5 5 0 1 0-3.9 3.9l7.9 7.9a1 1 0 0 0 1.4 0l2.5-2.5a1 1 0 0 0 0-1.4z"/></svg>'
      };
      return map[type]||'';
    }

    function renderItem(it){
      const t = $('#tpl-item').content.firstElementChild.cloneNode(true);
      if(it.done) t.classList.add('done');

      const titleRight = it.praticaId ? ` â€¢ ${it.praticaId}` : '';
      t.querySelector('.h').textContent = `${it.name} â€¢ ${it.phone}${titleRight}`;
      const tags = t.querySelector('.tags'); tags.innerHTML = '';
      it.activated.forEach(a=>{ const s=document.createElement('span'); s.className='tag'; s.innerHTML = iconSVG(a) + '<span>Attivato: '+labelOf(a)+'</span>'; tags.append(s); });
      if(it.acceptance){ const s=document.createElement('span'); s.className='tag'; s.innerHTML = iconSVG('riparazione') + `<span>Accettazione dispositivo${it.praticaId? ' â€¢ '+it.praticaId:''}</span>`; tags.append(s); }
      if(isMutedToday(it)) tags.append(tag('Silenzioso oggi','muted'));
      if(isActiveChat(it)) tags.append(tag('In chat','activeChat'));
      if(it.done) tags.append(tag('Completato'));

      const tasksWrap = t.querySelector('.tasks'); tasksWrap.innerHTML='';

      if(it.acceptance){
        const card = document.createElement('div'); card.className='task';
        card.innerHTML = `<div class="row"><div><b>Dispositivo</b> â€¢ ${it.device?.type||''} â€” ${it.device?.brand||''} ${it.device?.model||''}</div><div class="cta"><button class="btn ghost" type="button" data-waacc="${it.id}">WhatsApp accettazione</button><button class="btn ghost" type="button" data-copyid="${it.praticaId||''}">Copia ID</button></div></div><div style="margin-top:8px;color:var(--muted)">Difetto: ${it.device?.issue||'-'}</div>`;
        tasksWrap.appendChild(card);
        const statusWrap = document.createElement('div'); statusWrap.className='status'; statusWrap.style.display='block';
        statusWrap.innerHTML = '<label style="font-size:12px;color:var(--muted);margin-right:6px">Stato riparazione</label><select class="statusSel"><option value="diagnostica">In diagnostica</option><option value="attesa-ricambi">In attesa ricambi</option><option value="lavorazione">In lavorazione</option><option value="pronto">Pronto al ritiro</option><option value="consegnato">Consegnato/Chiuso</option></select>';
        tasksWrap.appendChild(statusWrap);
        const sel = statusWrap.querySelector('select'); sel.value = it.repairStatus || 'diagnostica'; sel.addEventListener('change',()=>{ it.repairStatus = sel.value; save(items); });
      }

      it.tasks.forEach(task=>tasksWrap.appendChild(renderTask(it, task)));

      const muteBtn = document.createElement('button'); muteBtn.className='btn ghost';
      muteBtn.textContent = isMutedToday(it)? 'Riattiva notifiche oggi' : 'Sto giÃ  chattando (silenzia oggi)';
      muteBtn.addEventListener('click',()=>{ it.muteDate = isMutedToday(it)? null : fmtDate(new Date()); save(items); render(); });
      t.appendChild(muteBtn);

      t.addEventListener('click',(ev)=>{
        const b1 = ev.target.closest('button[data-waacc]');
        if(b1){
          const id=b1.getAttribute('data-waacc');
          const itx = items.find(x=>x.id===id); if(!itx) return;
          const site = 'https://alessandroiascone.github.io/relong-nfc/relong-hub-v2.html';
          const msg = `âœ… Accettazione prodotto registrata
ID pratica: ${itx.praticaId||'-'}
Ciao ${itx.name}, abbiamo preso in carico:
${itx.device?.brand?itx.device.brand+' ':''}${itx.device?.model||''}
Difetto: ${itx.device?.issue||'-'}

Ti aggiorniamo appena pronto.
Hub: ${site}
ðŸ“ž Re Long Informatica â€“ 08119578844`;
          const wa = `https://wa.me/39${itx.phone}?text=${encodeURIComponent(msg)}`;
          try{ window.open(wa, '_blank'); }catch{}
          return;
        }
        const b2 = ev.target.closest('button[data-copyid]');
        if(b2){
          const id = b2.getAttribute('data-copyid');
          if(id){ navigator.clipboard?.writeText(id); b2.textContent='ID copiato'; setTimeout(()=>b2.textContent='Copia ID',1200); }
        }
      });

      return t;
    }

    function renderTask(it, task){
      const el = $('#tpl-task').content.firstElementChild.cloneNode(true);
      const due = new Date(task.due);
      const late = !it.done && due<today();
      const isToday = fmtDate(due)===fmtDate(new Date());
      if(isToday) el.classList.add('dueToday');

      el.querySelector('.tname').textContent = `Follow-up ${labelOf(task.type)}`;
      el.querySelector('.due').innerHTML = ` â€¢ scadenza: <b class="${late?'over':''}">${fmtDate(due)}</b>`;

      const cta = el.querySelector('.cta');
      const wa = waFor(it, task.type);
      if(wa){ const a=aBtn(wa.href, wa.text, 'ok'); a.dataset.wa='1'; a.dataset.id=it.id; cta.append(a); }

      const s = new Date(task.due); s.setHours(10,0,0,0);
      const e = new Date(s.getTime()+30*60000);
      const title = encodeURIComponent(`Follow-up ${labelOf(task.type)} â€¢ ${it.name}`);
      const calUrl = `https://calendar.google.com/calendar/u/0/r/eventedit?text=${title}&dates=${fmtDateTimeParam(s)}/${fmtDateTimeParam(e)}&details=${encodeURIComponent('Promemoria generato da Scadenzario ReLong')}`;
      cta.append(aBtn(calUrl, 'Calendar 10:00', 'primary'));

      const s2 = new Date(task.due); s2.setHours(18,0,0,0);
      const e2 = new Date(s2.getTime()+30*60000);
      const calUrl2 = `https://calendar.google.com/calendar/u/0/r/eventedit?text=${title}%20(Secondo%20richiamo)&dates=${fmtDateTimeParam(s2)}/${fmtDateTimeParam(e2)}&details=${encodeURIComponent('Richiamo serale (notifiche smart)')}`;
      cta.append(aBtn(calUrl2, 'Calendar 18:00', 'primary'));

      const btnSnooze = document.createElement('button'); btnSnooze.textContent = 'Snooze +1 giorno';
      btnSnooze.addEventListener('click',()=>{ let nd = addDays(new Date(task.due), 1); nd = avoidWeekend(nd); task.due = nd.toISOString(); save(items); render(); maybeNotify('Spostato a domani âœ”ï¸'); });
      cta.append(btnSnooze);

      const btnDone = document.createElement('button'); btnDone.textContent = 'Segna cliente completato';
      btnDone.addEventListener('click',()=>{ it.done=true; it.doneAt=new Date().toISOString(); save(items); render(); });
      cta.append(btnDone);

      const btnDel = document.createElement('button'); btnDel.textContent = 'Elimina cliente';
      btnDel.addEventListener('click',()=>{ items = items.filter(x=>x.id!==it.id); save(items); render(); });
      cta.append(btnDel);

      return el;
    }

    function labelOf(type){ return ({energia:'Energia', fisso:'Internet Casa', sim:'SIM', smartphone:'Smartphone a rate', riparazione:'Riparazione'})[type] || type; }

    function waFor(it, type){
      const site = encodeURIComponent('https://alessandroiascone.github.io/relong-nfc/relong-hub-v2.html');
      const base = `Ciao ${it.name}, sono Alessandro di Re Long (08119578844).`;
      const map = {
        energia: `${base}\nHai diritto ad uno sconto Energia dedicato ai nostri clienti. Ti va se ti spiego in 1 minuto come risparmiare sulla bolletta?\nHub: ${decodeURIComponent(site)}`,
        fisso: `${base}\nAbbiamo offerte Internet Casa dedicate: FTTC/FTTH con prezzi riservati ai nostri clienti. Vuoi una verifica copertura+simulazione rapida?\nHub: ${decodeURIComponent(site)}`,
        sim: `${base}\nSe ti serve una linea mobile, abbiamo SIM con Giga/Min illimitati e promo per clienti in store. Vuoi i dettagli e la portabilitÃ ?\nHub: ${decodeURIComponent(site)}`,
        smartphone: `${base}\nPossiamo proporti uno smartphone a rate (anche senza busta paga). Valutiamo anche il tuo usato e Postepay Evolution Ã¨ OK. Vuoi una proposta su misura?\nHub: ${decodeURIComponent(site)}`,
      };
      const txt = encodeURIComponent(map[type]);
      return { href:`https://wa.me/39${it.phone}?text=${txt}`, text:`WhatsApp ${labelOf(type)}` };
    }

    function tag(txt, extraClass=''){ const s=document.createElement('span'); s.className='tag'; if(extraClass) s.classList.add(extraClass); s.textContent=txt; return s }
    function aBtn(href, txt, cls=''){ const a=document.createElement('a'); a.href=href; a.target='_blank'; a.rel='noopener'; a.textContent=txt; if(cls) a.classList.add(cls); return a }

    // Click su WhatsApp per marcare in chat
    document.getElementById('list').addEventListener('click', (e)=>{
      const a = e.target.closest('a[data-wa="1"]'); if(!a) return;
      const id = a.dataset.id; const it = items.find(x=>x.id===id); if(!it) return;
      const until = new Date(Date.now()+45*60*1000);
      it.activeChatUntil = until.toISOString(); it.muteDate = fmtDate(new Date()); save(items); render();
    });

    function isMutedToday(it){ return it.muteDate && it.muteDate===fmtDate(new Date()); }
    function isActiveChat(it){ return it.activeChatUntil && new Date(it.activeChatUntil) > new Date(); }

    // Boot
    render();

    // Notifiche intelligenti (HTTPS only)
    setTimeout(()=>{
      const now = new Date(); const tStr = fmtDate(now);
      const dueList = items.filter(it=>!it.done && !isMutedToday(it) && !isActiveChat(it) && it.tasks.some(tsk=>fmtDate(new Date(tsk.due))===tStr));
      if(dueList.length) maybeNotify(`Follow-up di oggi: ${dueList.length} clienti (smart)`);
      const at18 = new Date(); at18.setHours(18,0,0,0); const ms = at18 - now;
      if(ms>0 && ms < 14*60*60*1000){
        setTimeout(()=>{
          const pending = items.filter(it=>!it.done && !isMutedToday(it) && !isActiveChat(it) && it.tasks.some(tsk=>fmtDate(new Date(tsk.due))===fmtDate(new Date())));
          if(pending.length) maybeNotify(`Richiamo 18:00: ${pending.length} clienti ancora da contattare (smart)`);
        }, ms);
      }
    }, 800);
  </script>
</body>
</html>
